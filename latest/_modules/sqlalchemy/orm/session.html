<!DOCTYPE html>
<html lang="en" data-accent-color="amber" data-content_root="../../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>sqlalchemy.orm.session - Advanced Alchemy</title><link rel="shortcut icon" href="../../../_static/favicon.svg"/><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/shibuya.css?v=83eaa723" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_paramlinks.css" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../../../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/litestar-sphinx-theme.css?v=e9f54662" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sqlalchemy.orm.session"/>
<meta name="twitter:card" content="summary"/>
<meta property="og:image" content="_static/logo-light.png"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="/">
      <img class="light-logo" src="../../../_static/logo-light.png" alt="advanced_alchemy" height="28" loading="lazy" />
      <img class="dark-logo" src="../../../_static/logo-dark.png" alt="advanced_alchemy" height="28" loading="lazy" />
      <strong>advanced_alchemy</strong>
    </a>
    <div class="sy-head-nav" id="HeadNav">
      <nav class="sy-head-links"><ul><li class="link"><a href="../../../index.html">Home</a></li>
      <li class="link"><button type="button">
            <span>Community</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="../../../contribution-guide.html">
                <span>Contributing</span>
                <small>Learn how to contribute to the Advanced Alchemy project</small>
              </a></li><li><a href="https://github.com/litestar-org/.github?tab=coc-ov-file">
                <span>Code of Conduct</span>
                <small>Review the etiquette for interacting with the Advanced Alchemy community</small>
              </a></li><li><a href="https://github.com/litestar-org/.github?tab=coc-ov-file#security-ov-file">
                <span>Security</span>
                <small>Overview of Advanced Alchemy's security protocols</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>About</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://litestar.dev/about/organization">
                <span>Litestar Organization</span>
                <small>Details about the Litestar organization</small>
              </a></li><li><a href="../../../releases.html">
                <span>Releases</span>
                <small>Explore the release process, versioning, and deprecation policy for Advanced Alchemy</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>Release notes</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="../../../changelog.html">
                <span>Changelog</span>
                <small>All changes for Advanced Alchemy</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>Help</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://discord.gg/litestar">
                <span>Discord Help Forum</span>
                <small>Dedicated Discord help forum</small>
              </a></li><li><a href="https://github.com/litestar-org/advanced-alchemy/discussions">
                <span>GitHub Discussions</span>
                <small>GitHub Discussions</small>
              </a></li><li><a href="https://stackoverflow.com/questions/tagged/litestar">
                <span>Stack Overflow</span>
                <small>We monitor the <code><b>litestar</b></code> tag on Stack Overflow</small>
              </a></li></ul>
      </li><li class="link">
          <a href="https://github.com/sponsors/Litestar-Org">
            <span>Sponsor</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials">
  <a href="https://github.com/litestar-org/advanced-alchemy" aria-label="GitHub">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </a>
<a href="https://twitter.com/LitestarAPI" aria-label="X (Twitter)">
  <iconify-icon icon="prime:twitter"></iconify-icon>
</a>
  <a href="https://discord.gg/litestar" aria-label="Discord">
    <iconify-icon icon="simple-icons:discord"></iconify-icon>
  </a></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="HeadNav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6"><div class="sidebar-links">
  <ul>
    <li><a class="icon-link" href="https://github.com/orgs/litestar-org/discussions">
  <span class="icon">
    <svg viewBox="0 0 24 24" fill="none">
      <path fill="var(--accent-9)" fill-rule="evenodd" clip-rule="evenodd" d="M11 5a6 6 0 0 0-4.687 9.746c.215.27.315.62.231.954l-.514 2.058a1 1 0 0 0 1.485 1.1l2.848-1.71c.174-.104.374-.15.576-.148H13a6 6 0 0 0 0-12h-2Z"/>
      <circle fill="white" cx="12" cy="11" r="1"/>
      <circle fill="white" cx="9" cy="11" r="1"/>
      <circle fill="white" cx="15" cy="11" r="1"/>
    </svg>
  </span>
  <span class="text">Discussion</span>
</a></li>
  </ul>
</div>
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/index.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/modeling.html">Modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/repositories.html">Repositories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/services.html">Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/utilities.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/frameworks/litestar.html">Litestar Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/frameworks/fastapi.html">FastAPI Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/base.html">base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/mixins/index.html">mixins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/mixins/unique.html">unique</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/config/index.html">config</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/asyncio.html">asyncio</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/common.html">common</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/engine.html">engine</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/sync.html">sync</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/types.html">types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/operations.html">operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/types.html">types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/exceptions.html">exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/utils.html">utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/repository.html">repositories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/filters.html">filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/service.html">services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/extensions/index.html">extensions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/litestar/index.html">litestar</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/alembic.html">alembic</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/dto.html">dto</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/plugins.html">plugin</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/sanic.html">sanic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/starlette.html">starlette</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/alembic/index.html">alembic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/alembic/commands.html">commands</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribution-guide.html">Contribution guide</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/search?q=user%3Alitestar-org+state%3Aopen+label%3A%22good+first+issue%22+++no%3Aassignee+repo%3A%22advanced-alchemy%22&amp;type=issues">Available Issues</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/litestar-org/.github?tab=coc-ov-file#readme">Code of Conduct</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/litestar-org/advanced-alchemy"
  data-type="github" data-user="litestar-org" data-repo="advanced-alchemy">
  <span class="w-8 flex items-center justify-around shrink-0 text-3xl">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </span>
  <span class="flex-grow px-2 break-all">
    <span>litestar-org/advanced-alchemy</span>
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <iconify-icon icon="lucide:star"></iconify-icon>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <iconify-icon icon="lucide:git-fork"></iconify-icon>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6"><div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../../index.html"><span itemprop="name">advanced_alchemy</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">sqlalchemy.orm.session</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sqlalchemy.orm.session</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="c1"># orm/session.py</span>
</span><span data-line="2"><span class="c1"># Copyright (C) 2005-2024 the SQLAlchemy authors and contributors</span>
</span><span data-line="3"><span class="c1"># &lt;see AUTHORS file&gt;</span>
</span><span data-line="4"><span class="c1">#</span>
</span><span data-line="5"><span class="c1"># This module is part of SQLAlchemy and is released under</span>
</span><span data-line="6"><span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
</span><span data-line="7">
</span><span data-line="8"><span class="sd">&quot;&quot;&quot;Provides the Session class and related utilities.&quot;&quot;&quot;</span>
</span><span data-line="9">
</span><span data-line="10"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="11">
</span><span data-line="12"><span class="kn">import</span> <span class="nn">contextlib</span>
</span><span data-line="13"><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span><span data-line="14"><span class="kn">import</span> <span class="nn">itertools</span>
</span><span data-line="15"><span class="kn">import</span> <span class="nn">sys</span>
</span><span data-line="16"><span class="kn">import</span> <span class="nn">typing</span>
</span><span data-line="17"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span><span data-line="18"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
</span><span data-line="19"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>
</span><span data-line="20"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</span><span data-line="21"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generic</span>
</span><span data-line="22"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
</span><span data-line="23"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span>
</span><span data-line="24"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</span><span data-line="25"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NoReturn</span>
</span><span data-line="26"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span><span data-line="27"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">overload</span>
</span><span data-line="28"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
</span><span data-line="29"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Set</span>
</span><span data-line="30"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
</span><span data-line="31"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
</span><span data-line="32"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span data-line="33"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>
</span><span data-line="34"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
</span><span data-line="35"><span class="kn">import</span> <span class="nn">weakref</span>
</span><span data-line="36">
</span><span data-line="37"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">attributes</span>
</span><span data-line="38"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">bulk_persistence</span>
</span><span data-line="39"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">context</span>
</span><span data-line="40"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">descriptor_props</span>
</span><span data-line="41"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">exc</span>
</span><span data-line="42"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">identity</span>
</span><span data-line="43"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">loading</span>
</span><span data-line="44"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">query</span>
</span><span data-line="45"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">state</span> <span class="k">as</span> <span class="n">statelib</span>
</span><span data-line="46"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_O</span>
</span><span data-line="47"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">insp_is_mapper</span>
</span><span data-line="48"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">is_composite_class</span>
</span><span data-line="49"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">is_orm_option</span>
</span><span data-line="50"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">is_user_defined_option</span>
</span><span data-line="51"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_class_to_mapper</span>
</span><span data-line="52"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_none_set</span>
</span><span data-line="53"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_state_mapper</span>
</span><span data-line="54"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">instance_str</span>
</span><span data-line="55"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">LoaderCallableStatus</span>
</span><span data-line="56"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">object_mapper</span>
</span><span data-line="57"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">object_state</span>
</span><span data-line="58"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">PassiveFlag</span>
</span><span data-line="59"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">state_str</span>
</span><span data-line="60"><span class="kn">from</span> <span class="nn">.context</span> <span class="kn">import</span> <span class="n">FromStatement</span>
</span><span data-line="61"><span class="kn">from</span> <span class="nn">.context</span> <span class="kn">import</span> <span class="n">ORMCompileState</span>
</span><span data-line="62"><span class="kn">from</span> <span class="nn">.identity</span> <span class="kn">import</span> <span class="n">IdentityMap</span>
</span><span data-line="63"><span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">Query</span>
</span><span data-line="64"><span class="kn">from</span> <span class="nn">.state</span> <span class="kn">import</span> <span class="n">InstanceState</span>
</span><span data-line="65"><span class="kn">from</span> <span class="nn">.state_changes</span> <span class="kn">import</span> <span class="n">_StateChange</span>
</span><span data-line="66"><span class="kn">from</span> <span class="nn">.state_changes</span> <span class="kn">import</span> <span class="n">_StateChangeState</span>
</span><span data-line="67"><span class="kn">from</span> <span class="nn">.state_changes</span> <span class="kn">import</span> <span class="n">_StateChangeStates</span>
</span><span data-line="68"><span class="kn">from</span> <span class="nn">.unitofwork</span> <span class="kn">import</span> <span class="n">UOWTransaction</span>
</span><span data-line="69"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">engine</span>
</span><span data-line="70"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">sa_exc</span>
</span><span data-line="71"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">sql</span>
</span><span data-line="72"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">util</span>
</span><span data-line="73"><span class="kn">from</span> <span class="nn">..engine</span> <span class="kn">import</span> <span class="n">Connection</span>
</span><span data-line="74"><span class="kn">from</span> <span class="nn">..engine</span> <span class="kn">import</span> <span class="n">Engine</span>
</span><span data-line="75"><span class="kn">from</span> <span class="nn">..engine.util</span> <span class="kn">import</span> <span class="n">TransactionalContext</span>
</span><span data-line="76"><span class="kn">from</span> <span class="nn">..event</span> <span class="kn">import</span> <span class="n">dispatcher</span>
</span><span data-line="77"><span class="kn">from</span> <span class="nn">..event</span> <span class="kn">import</span> <span class="n">EventTarget</span>
</span><span data-line="78"><span class="kn">from</span> <span class="nn">..inspection</span> <span class="kn">import</span> <span class="n">inspect</span>
</span><span data-line="79"><span class="kn">from</span> <span class="nn">..inspection</span> <span class="kn">import</span> <span class="n">Inspectable</span>
</span><span data-line="80"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">coercions</span>
</span><span data-line="81"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">dml</span>
</span><span data-line="82"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">roles</span>
</span><span data-line="83"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">Select</span>
</span><span data-line="84"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">TableClause</span>
</span><span data-line="85"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">visitors</span>
</span><span data-line="86"><span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">_NoArg</span>
</span><span data-line="87"><span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">CompileState</span>
</span><span data-line="88"><span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">Table</span>
</span><span data-line="89"><span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">ForUpdateArg</span>
</span><span data-line="90"><span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">LABEL_STYLE_TABLENAME_PLUS_COL</span>
</span><span data-line="91"><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">IdentitySet</span>
</span><span data-line="92"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">Literal</span>
</span><span data-line="93"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">Protocol</span>
</span><span data-line="94">
</span><span data-line="95"><span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="96">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_EntityType</span>
</span><span data-line="97">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_IdentityKeyType</span>
</span><span data-line="98">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_InstanceDict</span>
</span><span data-line="99">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">OrmExecuteOptionsParameter</span>
</span><span data-line="100">    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">ORMOption</span>
</span><span data-line="101">    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">UserDefinedOption</span>
</span><span data-line="102">    <span class="kn">from</span> <span class="nn">.mapper</span> <span class="kn">import</span> <span class="n">Mapper</span>
</span><span data-line="103">    <span class="kn">from</span> <span class="nn">.path_registry</span> <span class="kn">import</span> <span class="n">PathRegistry</span>
</span><span data-line="104">    <span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">RowReturningQuery</span>
</span><span data-line="105">    <span class="kn">from</span> <span class="nn">..engine</span> <span class="kn">import</span> <span class="n">CursorResult</span>
</span><span data-line="106">    <span class="kn">from</span> <span class="nn">..engine</span> <span class="kn">import</span> <span class="n">Result</span>
</span><span data-line="107">    <span class="kn">from</span> <span class="nn">..engine</span> <span class="kn">import</span> <span class="n">Row</span>
</span><span data-line="108">    <span class="kn">from</span> <span class="nn">..engine</span> <span class="kn">import</span> <span class="n">RowMapping</span>
</span><span data-line="109">    <span class="kn">from</span> <span class="nn">..engine.base</span> <span class="kn">import</span> <span class="n">Transaction</span>
</span><span data-line="110">    <span class="kn">from</span> <span class="nn">..engine.base</span> <span class="kn">import</span> <span class="n">TwoPhaseTransaction</span>
</span><span data-line="111">    <span class="kn">from</span> <span class="nn">..engine.interfaces</span> <span class="kn">import</span> <span class="n">_CoreAnyExecuteParams</span>
</span><span data-line="112">    <span class="kn">from</span> <span class="nn">..engine.interfaces</span> <span class="kn">import</span> <span class="n">_CoreSingleExecuteParams</span>
</span><span data-line="113">    <span class="kn">from</span> <span class="nn">..engine.interfaces</span> <span class="kn">import</span> <span class="n">_ExecuteOptions</span>
</span><span data-line="114">    <span class="kn">from</span> <span class="nn">..engine.interfaces</span> <span class="kn">import</span> <span class="n">CoreExecuteOptionsParameter</span>
</span><span data-line="115">    <span class="kn">from</span> <span class="nn">..engine.result</span> <span class="kn">import</span> <span class="n">ScalarResult</span>
</span><span data-line="116">    <span class="kn">from</span> <span class="nn">..event</span> <span class="kn">import</span> <span class="n">_InstanceLevelDispatch</span>
</span><span data-line="117">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_ColumnsClauseArgument</span>
</span><span data-line="118">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_InfoType</span>
</span><span data-line="119">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T0</span>
</span><span data-line="120">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T1</span>
</span><span data-line="121">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T2</span>
</span><span data-line="122">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T3</span>
</span><span data-line="123">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T4</span>
</span><span data-line="124">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T5</span>
</span><span data-line="125">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T6</span>
</span><span data-line="126">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T7</span>
</span><span data-line="127">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_TypedColumnClauseArgument</span> <span class="k">as</span> <span class="n">_TCCA</span>
</span><span data-line="128">    <span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">Executable</span>
</span><span data-line="129">    <span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">ExecutableOption</span>
</span><span data-line="130">    <span class="kn">from</span> <span class="nn">..sql.dml</span> <span class="kn">import</span> <span class="n">UpdateBase</span>
</span><span data-line="131">    <span class="kn">from</span> <span class="nn">..sql.elements</span> <span class="kn">import</span> <span class="n">ClauseElement</span>
</span><span data-line="132">    <span class="kn">from</span> <span class="nn">..sql.roles</span> <span class="kn">import</span> <span class="n">TypedColumnsClauseRole</span>
</span><span data-line="133">    <span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">ForUpdateParameter</span>
</span><span data-line="134">    <span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">TypedReturnsRows</span>
</span><span data-line="135">
</span><span data-line="136"><span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="137">
</span><span data-line="138"><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="139">    <span class="s2">&quot;Session&quot;</span><span class="p">,</span>
</span><span data-line="140">    <span class="s2">&quot;SessionTransaction&quot;</span><span class="p">,</span>
</span><span data-line="141">    <span class="s2">&quot;sessionmaker&quot;</span><span class="p">,</span>
</span><span data-line="142">    <span class="s2">&quot;ORMExecuteState&quot;</span><span class="p">,</span>
</span><span data-line="143">    <span class="s2">&quot;close_all_sessions&quot;</span><span class="p">,</span>
</span><span data-line="144">    <span class="s2">&quot;make_transient&quot;</span><span class="p">,</span>
</span><span data-line="145">    <span class="s2">&quot;make_transient_to_detached&quot;</span><span class="p">,</span>
</span><span data-line="146">    <span class="s2">&quot;object_session&quot;</span><span class="p">,</span>
</span><span data-line="147"><span class="p">]</span>
</span><span data-line="148">
</span><span data-line="149"><span class="n">_sessions</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="150">    <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
</span><span data-line="151"><span class="p">)</span>
</span><span data-line="152"><span class="sd">&quot;&quot;&quot;Weak-referencing dictionary of :class:`.Session` objects.</span>
</span><span data-line="153"><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="154">
</span><span data-line="155"><span class="n">statelib</span><span class="o">.</span><span class="n">_sessions</span> <span class="o">=</span> <span class="n">_sessions</span>
</span><span data-line="156">
</span><span data-line="157"><span class="n">_PKIdentityArgument</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>
</span><span data-line="158">
</span><span data-line="159"><span class="n">_BindArguments</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="160">
</span><span data-line="161"><span class="n">_EntityBindKey</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="s2">&quot;Mapper[_O]&quot;</span><span class="p">]</span>
</span><span data-line="162"><span class="n">_SessionBindKey</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="s2">&quot;Mapper[Any]&quot;</span><span class="p">,</span> <span class="s2">&quot;TableClause&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
</span><span data-line="163"><span class="n">_SessionBind</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Engine&quot;</span><span class="p">,</span> <span class="s2">&quot;Connection&quot;</span><span class="p">]</span>
</span><span data-line="164">
</span><span data-line="165"><span class="n">JoinTransactionMode</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
</span><span data-line="166">    <span class="s2">&quot;conditional_savepoint&quot;</span><span class="p">,</span>
</span><span data-line="167">    <span class="s2">&quot;rollback_only&quot;</span><span class="p">,</span>
</span><span data-line="168">    <span class="s2">&quot;control_fully&quot;</span><span class="p">,</span>
</span><span data-line="169">    <span class="s2">&quot;create_savepoint&quot;</span><span class="p">,</span>
</span><span data-line="170"><span class="p">]</span>
</span><span data-line="171">
</span><span data-line="172">
</span><span data-line="173"><span class="k">class</span> <span class="nc">_ConnectionCallableProto</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
</span><span data-line="174"><span class="w">    </span><span class="sd">&quot;&quot;&quot;a callable that returns a :class:`.Connection` given an instance.</span>
</span><span data-line="175">
</span><span data-line="176"><span class="sd">    This callable, when present on a :class:`.Session`, is called only from the</span>
</span><span data-line="177"><span class="sd">    ORM&#39;s persistence mechanism (i.e. the unit of work flush process) to allow</span>
</span><span data-line="178"><span class="sd">    for connection-per-instance schemes (i.e. horizontal sharding) to be used</span>
</span><span data-line="179"><span class="sd">    as persistence time.</span>
</span><span data-line="180">
</span><span data-line="181"><span class="sd">    This callable is not present on a plain :class:`.Session`, however</span>
</span><span data-line="182"><span class="sd">    is established when using the horizontal sharding extension.</span>
</span><span data-line="183">
</span><span data-line="184"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="185">
</span><span data-line="186">    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
</span><span data-line="187">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="188">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="189">        <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="190">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="191">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="192">
</span><span data-line="193">
</span><span data-line="194"><span class="k">def</span> <span class="nf">_state_session</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]:</span>
</span><span data-line="195"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Given an :class:`.InstanceState`, return the :class:`.Session`</span>
</span><span data-line="196"><span class="sd">    associated, if any.</span>
</span><span data-line="197"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="198">    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">session</span>
</span><span data-line="199">
</span><span data-line="200">
</span><span data-line="201"><span class="k">class</span> <span class="nc">_SessionClassMethods</span><span class="p">:</span>
</span><span data-line="202"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class-level methods for :class:`.Session`, :class:`.sessionmaker`.&quot;&quot;&quot;</span>
</span><span data-line="203">
</span><span data-line="204">    <span class="nd">@classmethod</span>
</span><span data-line="205">    <span class="nd">@util</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
</span><span data-line="206">        <span class="s2">&quot;1.3&quot;</span><span class="p">,</span>
</span><span data-line="207">        <span class="s2">&quot;The :meth:`.Session.close_all` method is deprecated and will be &quot;</span>
</span><span data-line="208">        <span class="s2">&quot;removed in a future release.  Please refer to &quot;</span>
</span><span data-line="209">        <span class="s2">&quot;:func:`.session.close_all_sessions`.&quot;</span><span class="p">,</span>
</span><span data-line="210">    <span class="p">)</span>
</span><span data-line="211">    <span class="k">def</span> <span class="nf">close_all</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="212"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close *all* sessions in memory.&quot;&quot;&quot;</span>
</span><span data-line="213">
</span><span data-line="214">        <span class="n">close_all_sessions</span><span class="p">()</span>
</span><span data-line="215">
</span><span data-line="216">    <span class="nd">@classmethod</span>
</span><span data-line="217">    <span class="nd">@util</span><span class="o">.</span><span class="n">preload_module</span><span class="p">(</span><span class="s2">&quot;sqlalchemy.orm.util&quot;</span><span class="p">)</span>
</span><span data-line="218">    <span class="k">def</span> <span class="nf">identity_key</span><span class="p">(</span>
</span><span data-line="219">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="220">        <span class="n">class_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="221">        <span class="n">ident</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="222">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="223">        <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="224">        <span class="n">row</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Row</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">RowMapping</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="225">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="226">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_IdentityKeyType</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="227"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an identity key.</span>
</span><span data-line="228">
</span><span data-line="229"><span class="sd">        This is an alias of :func:`.util.identity_key`.</span>
</span><span data-line="230">
</span><span data-line="231"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="232">        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">preloaded</span><span class="o">.</span><span class="n">orm_util</span><span class="o">.</span><span class="n">identity_key</span><span class="p">(</span>
</span><span data-line="233">            <span class="n">class_</span><span class="p">,</span>
</span><span data-line="234">            <span class="n">ident</span><span class="p">,</span>
</span><span data-line="235">            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
</span><span data-line="236">            <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
</span><span data-line="237">            <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span data-line="238">        <span class="p">)</span>
</span><span data-line="239">
</span><span data-line="240">    <span class="nd">@classmethod</span>
</span><span data-line="241">    <span class="k">def</span> <span class="nf">object_session</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]:</span>
</span><span data-line="242"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the :class:`.Session` to which an object belongs.</span>
</span><span data-line="243">
</span><span data-line="244"><span class="sd">        This is an alias of :func:`.object_session`.</span>
</span><span data-line="245">
</span><span data-line="246"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="247">
</span><span data-line="248">        <span class="k">return</span> <span class="n">object_session</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="249">
</span><span data-line="250">
</span><span data-line="251"><span class="k">class</span> <span class="nc">SessionTransactionState</span><span class="p">(</span><span class="n">_StateChangeState</span><span class="p">):</span>
</span><span data-line="252">    <span class="n">ACTIVE</span> <span class="o">=</span> <span class="mi">1</span>
</span><span data-line="253">    <span class="n">PREPARED</span> <span class="o">=</span> <span class="mi">2</span>
</span><span data-line="254">    <span class="n">COMMITTED</span> <span class="o">=</span> <span class="mi">3</span>
</span><span data-line="255">    <span class="n">DEACTIVE</span> <span class="o">=</span> <span class="mi">4</span>
</span><span data-line="256">    <span class="n">CLOSED</span> <span class="o">=</span> <span class="mi">5</span>
</span><span data-line="257">    <span class="n">PROVISIONING_CONNECTION</span> <span class="o">=</span> <span class="mi">6</span>
</span><span data-line="258">
</span><span data-line="259">
</span><span data-line="260"><span class="c1"># backwards compatibility</span>
</span><span data-line="261"><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">PREPARED</span><span class="p">,</span> <span class="n">COMMITTED</span><span class="p">,</span> <span class="n">DEACTIVE</span><span class="p">,</span> <span class="n">CLOSED</span><span class="p">,</span> <span class="n">PROVISIONING_CONNECTION</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span data-line="262">    <span class="n">SessionTransactionState</span>
</span><span data-line="263"><span class="p">)</span>
</span><span data-line="264">
</span><span data-line="265">
</span><span data-line="266"><span class="k">class</span> <span class="nc">ORMExecuteState</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">MemoizedSlots</span><span class="p">):</span>
</span><span data-line="267"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a call to the :meth:`_orm.Session.execute` method, as passed</span>
</span><span data-line="268"><span class="sd">    to the :meth:`.SessionEvents.do_orm_execute` event hook.</span>
</span><span data-line="269">
</span><span data-line="270"><span class="sd">    .. versionadded:: 1.4</span>
</span><span data-line="271">
</span><span data-line="272"><span class="sd">    .. seealso::</span>
</span><span data-line="273">
</span><span data-line="274"><span class="sd">        :ref:`session_execute_events` - top level documentation on how</span>
</span><span data-line="275"><span class="sd">        to use :meth:`_orm.SessionEvents.do_orm_execute`</span>
</span><span data-line="276">
</span><span data-line="277"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="278">
</span><span data-line="279">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="280">        <span class="s2">&quot;session&quot;</span><span class="p">,</span>
</span><span data-line="281">        <span class="s2">&quot;statement&quot;</span><span class="p">,</span>
</span><span data-line="282">        <span class="s2">&quot;parameters&quot;</span><span class="p">,</span>
</span><span data-line="283">        <span class="s2">&quot;execution_options&quot;</span><span class="p">,</span>
</span><span data-line="284">        <span class="s2">&quot;local_execution_options&quot;</span><span class="p">,</span>
</span><span data-line="285">        <span class="s2">&quot;bind_arguments&quot;</span><span class="p">,</span>
</span><span data-line="286">        <span class="s2">&quot;identity_token&quot;</span><span class="p">,</span>
</span><span data-line="287">        <span class="s2">&quot;_compile_state_cls&quot;</span><span class="p">,</span>
</span><span data-line="288">        <span class="s2">&quot;_starting_event_idx&quot;</span><span class="p">,</span>
</span><span data-line="289">        <span class="s2">&quot;_events_todo&quot;</span><span class="p">,</span>
</span><span data-line="290">        <span class="s2">&quot;_update_execution_options&quot;</span><span class="p">,</span>
</span><span data-line="291">    <span class="p">)</span>
</span><span data-line="292">
</span><span data-line="293">    <span class="n">session</span><span class="p">:</span> <span class="n">Session</span>
</span><span data-line="294"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The :class:`_orm.Session` in use.&quot;&quot;&quot;</span>
</span><span data-line="295">
</span><span data-line="296">    <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span>
</span><span data-line="297"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The SQL statement being invoked.</span>
</span><span data-line="298">
</span><span data-line="299"><span class="sd">    For an ORM selection as would</span>
</span><span data-line="300"><span class="sd">    be retrieved from :class:`_orm.Query`, this is an instance of</span>
</span><span data-line="301"><span class="sd">    :class:`_sql.select` that was generated from the ORM query.</span>
</span><span data-line="302"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="303">
</span><span data-line="304">    <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span>
</span><span data-line="305"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Dictionary of parameters that was passed to</span>
</span><span data-line="306"><span class="sd">    :meth:`_orm.Session.execute`.&quot;&quot;&quot;</span>
</span><span data-line="307">
</span><span data-line="308">    <span class="n">execution_options</span><span class="p">:</span> <span class="n">_ExecuteOptions</span>
</span><span data-line="309"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The complete dictionary of current execution options.</span>
</span><span data-line="310">
</span><span data-line="311"><span class="sd">    This is a merge of the statement level options with the</span>
</span><span data-line="312"><span class="sd">    locally passed execution options.</span>
</span><span data-line="313">
</span><span data-line="314"><span class="sd">    .. seealso::</span>
</span><span data-line="315">
</span><span data-line="316"><span class="sd">        :attr:`_orm.ORMExecuteState.local_execution_options`</span>
</span><span data-line="317">
</span><span data-line="318"><span class="sd">        :meth:`_sql.Executable.execution_options`</span>
</span><span data-line="319">
</span><span data-line="320"><span class="sd">        :ref:`orm_queryguide_execution_options`</span>
</span><span data-line="321">
</span><span data-line="322"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="323">
</span><span data-line="324">    <span class="n">local_execution_options</span><span class="p">:</span> <span class="n">_ExecuteOptions</span>
</span><span data-line="325"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Dictionary view of the execution options passed to the</span>
</span><span data-line="326"><span class="sd">    :meth:`.Session.execute` method.</span>
</span><span data-line="327">
</span><span data-line="328"><span class="sd">    This does not include options that may be associated with the statement</span>
</span><span data-line="329"><span class="sd">    being invoked.</span>
</span><span data-line="330">
</span><span data-line="331"><span class="sd">    .. seealso::</span>
</span><span data-line="332">
</span><span data-line="333"><span class="sd">        :attr:`_orm.ORMExecuteState.execution_options`</span>
</span><span data-line="334">
</span><span data-line="335"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="336">
</span><span data-line="337">    <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">_BindArguments</span>
</span><span data-line="338"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The dictionary passed as the</span>
</span><span data-line="339"><span class="sd">    :paramref:`_orm.Session.execute.bind_arguments` dictionary.</span>
</span><span data-line="340">
</span><span data-line="341"><span class="sd">    This dictionary may be used by extensions to :class:`_orm.Session` to pass</span>
</span><span data-line="342"><span class="sd">    arguments that will assist in determining amongst a set of database</span>
</span><span data-line="343"><span class="sd">    connections which one should be used to invoke this statement.</span>
</span><span data-line="344">
</span><span data-line="345"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="346">
</span><span data-line="347">    <span class="n">_compile_state_cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">ORMCompileState</span><span class="p">]]</span>
</span><span data-line="348">    <span class="n">_starting_event_idx</span><span class="p">:</span> <span class="nb">int</span>
</span><span data-line="349">    <span class="n">_events_todo</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="350">    <span class="n">_update_execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ExecuteOptions</span><span class="p">]</span>
</span><span data-line="351">
</span><span data-line="352">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="353">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="354">        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span>
</span><span data-line="355">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span data-line="356">        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">],</span>
</span><span data-line="357">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">_ExecuteOptions</span><span class="p">,</span>
</span><span data-line="358">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">_BindArguments</span><span class="p">,</span>
</span><span data-line="359">        <span class="n">compile_state_cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">ORMCompileState</span><span class="p">]],</span>
</span><span data-line="360">        <span class="n">events_todo</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_InstanceLevelDispatch</span><span class="p">[</span><span class="n">Session</span><span class="p">]],</span>
</span><span data-line="361">    <span class="p">):</span>
</span><span data-line="362"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a new :class:`_orm.ORMExecuteState`.</span>
</span><span data-line="363">
</span><span data-line="364"><span class="sd">        this object is constructed internally.</span>
</span><span data-line="365">
</span><span data-line="366"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="367">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
</span><span data-line="368">        <span class="bp">self</span><span class="o">.</span><span class="n">statement</span> <span class="o">=</span> <span class="n">statement</span>
</span><span data-line="369">        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
</span><span data-line="370">        <span class="bp">self</span><span class="o">.</span><span class="n">local_execution_options</span> <span class="o">=</span> <span class="n">execution_options</span>
</span><span data-line="371">        <span class="bp">self</span><span class="o">.</span><span class="n">execution_options</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
</span><span data-line="372">            <span class="n">execution_options</span>
</span><span data-line="373">        <span class="p">)</span>
</span><span data-line="374">        <span class="bp">self</span><span class="o">.</span><span class="n">bind_arguments</span> <span class="o">=</span> <span class="n">bind_arguments</span>
</span><span data-line="375">        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_state_cls</span> <span class="o">=</span> <span class="n">compile_state_cls</span>
</span><span data-line="376">        <span class="bp">self</span><span class="o">.</span><span class="n">_events_todo</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">events_todo</span><span class="p">)</span>
</span><span data-line="377">
</span><span data-line="378">    <span class="k">def</span> <span class="nf">_remaining_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_InstanceLevelDispatch</span><span class="p">[</span><span class="n">Session</span><span class="p">]]:</span>
</span><span data-line="379">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events_todo</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_starting_event_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
</span><span data-line="380">
</span><span data-line="381">    <span class="k">def</span> <span class="nf">invoke_statement</span><span class="p">(</span>
</span><span data-line="382">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="383">        <span class="n">statement</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Executable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="384">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="385">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OrmExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="386">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="387">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="388"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the statement represented by this</span>
</span><span data-line="389"><span class="sd">        :class:`.ORMExecuteState`, without re-invoking events that have</span>
</span><span data-line="390"><span class="sd">        already proceeded.</span>
</span><span data-line="391">
</span><span data-line="392"><span class="sd">        This method essentially performs a re-entrant execution of the current</span>
</span><span data-line="393"><span class="sd">        statement for which the :meth:`.SessionEvents.do_orm_execute` event is</span>
</span><span data-line="394"><span class="sd">        being currently invoked.    The use case for this is for event handlers</span>
</span><span data-line="395"><span class="sd">        that want to override how the ultimate</span>
</span><span data-line="396"><span class="sd">        :class:`_engine.Result` object is returned, such as for schemes that</span>
</span><span data-line="397"><span class="sd">        retrieve results from an offline cache or which concatenate results</span>
</span><span data-line="398"><span class="sd">        from multiple executions.</span>
</span><span data-line="399">
</span><span data-line="400"><span class="sd">        When the :class:`_engine.Result` object is returned by the actual</span>
</span><span data-line="401"><span class="sd">        handler function within :meth:`_orm.SessionEvents.do_orm_execute` and</span>
</span><span data-line="402"><span class="sd">        is propagated to the calling</span>
</span><span data-line="403"><span class="sd">        :meth:`_orm.Session.execute` method, the remainder of the</span>
</span><span data-line="404"><span class="sd">        :meth:`_orm.Session.execute` method is preempted and the</span>
</span><span data-line="405"><span class="sd">        :class:`_engine.Result` object is returned to the caller of</span>
</span><span data-line="406"><span class="sd">        :meth:`_orm.Session.execute` immediately.</span>
</span><span data-line="407">
</span><span data-line="408"><span class="sd">        :param statement: optional statement to be invoked, in place of the</span>
</span><span data-line="409"><span class="sd">         statement currently represented by :attr:`.ORMExecuteState.statement`.</span>
</span><span data-line="410">
</span><span data-line="411"><span class="sd">        :param params: optional dictionary of parameters or list of parameters</span>
</span><span data-line="412"><span class="sd">         which will be merged into the existing</span>
</span><span data-line="413"><span class="sd">         :attr:`.ORMExecuteState.parameters` of this :class:`.ORMExecuteState`.</span>
</span><span data-line="414">
</span><span data-line="415"><span class="sd">         .. versionchanged:: 2.0 a list of parameter dictionaries is accepted</span>
</span><span data-line="416"><span class="sd">            for executemany executions.</span>
</span><span data-line="417">
</span><span data-line="418"><span class="sd">        :param execution_options: optional dictionary of execution options</span>
</span><span data-line="419"><span class="sd">         will be merged into the existing</span>
</span><span data-line="420"><span class="sd">         :attr:`.ORMExecuteState.execution_options` of this</span>
</span><span data-line="421"><span class="sd">         :class:`.ORMExecuteState`.</span>
</span><span data-line="422">
</span><span data-line="423"><span class="sd">        :param bind_arguments: optional dictionary of bind_arguments</span>
</span><span data-line="424"><span class="sd">         which will be merged amongst the current</span>
</span><span data-line="425"><span class="sd">         :attr:`.ORMExecuteState.bind_arguments`</span>
</span><span data-line="426"><span class="sd">         of this :class:`.ORMExecuteState`.</span>
</span><span data-line="427">
</span><span data-line="428"><span class="sd">        :return: a :class:`_engine.Result` object with ORM-level results.</span>
</span><span data-line="429">
</span><span data-line="430"><span class="sd">        .. seealso::</span>
</span><span data-line="431">
</span><span data-line="432"><span class="sd">            :ref:`do_orm_execute_re_executing` - background and examples on the</span>
</span><span data-line="433"><span class="sd">            appropriate usage of :meth:`_orm.ORMExecuteState.invoke_statement`.</span>
</span><span data-line="434">
</span><span data-line="435">
</span><span data-line="436"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="437">
</span><span data-line="438">        <span class="k">if</span> <span class="n">statement</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="439">            <span class="n">statement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span>
</span><span data-line="440">
</span><span data-line="441">        <span class="n">_bind_arguments</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_arguments</span><span class="p">)</span>
</span><span data-line="442">        <span class="k">if</span> <span class="n">bind_arguments</span><span class="p">:</span>
</span><span data-line="443">            <span class="n">_bind_arguments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bind_arguments</span><span class="p">)</span>
</span><span data-line="444">        <span class="n">_bind_arguments</span><span class="p">[</span><span class="s2">&quot;_sa_skip_events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="445">
</span><span data-line="446">        <span class="n">_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span>
</span><span data-line="447">        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
</span><span data-line="448">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_executemany</span><span class="p">:</span>
</span><span data-line="449">                <span class="n">_params</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="450">                <span class="n">exec_many_parameters</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="451">                    <span class="s2">&quot;List[Dict[str, Any]]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
</span><span data-line="452">                <span class="p">)</span>
</span><span data-line="453">                <span class="k">for</span> <span class="n">_existing_params</span><span class="p">,</span> <span class="n">_new_params</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span>
</span><span data-line="454">                    <span class="n">exec_many_parameters</span><span class="p">,</span>
</span><span data-line="455">                    <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;List[Dict[str, Any]]&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span>
</span><span data-line="456">                <span class="p">):</span>
</span><span data-line="457">                    <span class="k">if</span> <span class="n">_existing_params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">_new_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="458">                        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="459">                            <span class="sa">f</span><span class="s2">&quot;Can&#39;t apply executemany parameters to &quot;</span>
</span><span data-line="460">                            <span class="sa">f</span><span class="s2">&quot;statement; number of parameter sets passed to &quot;</span>
</span><span data-line="461">                            <span class="sa">f</span><span class="s2">&quot;Session.execute() (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">exec_many_parameters</span><span class="p">)</span><span class="si">}</span><span class="s2">) &quot;</span>
</span><span data-line="462">                            <span class="sa">f</span><span class="s2">&quot;does not match number of parameter sets given &quot;</span>
</span><span data-line="463">                            <span class="sa">f</span><span class="s2">&quot;to ORMExecuteState.invoke_statement() &quot;</span>
</span><span data-line="464">                            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span data-line="465">                        <span class="p">)</span>
</span><span data-line="466">                    <span class="n">_existing_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_existing_params</span><span class="p">)</span>
</span><span data-line="467">                    <span class="n">_existing_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_new_params</span><span class="p">)</span>
</span><span data-line="468">                    <span class="n">_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_existing_params</span><span class="p">)</span>
</span><span data-line="469">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="470">                <span class="n">_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Dict[str, Any]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">))</span>
</span><span data-line="471">                <span class="n">_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Dict[str, Any]&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
</span><span data-line="472">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="473">            <span class="n">_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
</span><span data-line="474">
</span><span data-line="475">        <span class="n">_execution_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_execution_options</span>
</span><span data-line="476">        <span class="k">if</span> <span class="n">execution_options</span><span class="p">:</span>
</span><span data-line="477">            <span class="n">_execution_options</span> <span class="o">=</span> <span class="n">_execution_options</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">execution_options</span><span class="p">)</span>
</span><span data-line="478">
</span><span data-line="479">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_execute_internal</span><span class="p">(</span>
</span><span data-line="480">            <span class="n">statement</span><span class="p">,</span>
</span><span data-line="481">            <span class="n">_params</span><span class="p">,</span>
</span><span data-line="482">            <span class="n">execution_options</span><span class="o">=</span><span class="n">_execution_options</span><span class="p">,</span>
</span><span data-line="483">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">_bind_arguments</span><span class="p">,</span>
</span><span data-line="484">            <span class="n">_parent_execute_state</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span data-line="485">        <span class="p">)</span>
</span><span data-line="486">
</span><span data-line="487">    <span class="nd">@property</span>
</span><span data-line="488">    <span class="k">def</span> <span class="nf">bind_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="489"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the :class:`_orm.Mapper` that is the primary &quot;bind&quot; mapper.</span>
</span><span data-line="490">
</span><span data-line="491"><span class="sd">        For an :class:`_orm.ORMExecuteState` object invoking an ORM</span>
</span><span data-line="492"><span class="sd">        statement, that is, the :attr:`_orm.ORMExecuteState.is_orm_statement`</span>
</span><span data-line="493"><span class="sd">        attribute is ``True``, this attribute will return the</span>
</span><span data-line="494"><span class="sd">        :class:`_orm.Mapper` that is considered to be the &quot;primary&quot; mapper</span>
</span><span data-line="495"><span class="sd">        of the statement.   The term &quot;bind mapper&quot; refers to the fact that</span>
</span><span data-line="496"><span class="sd">        a :class:`_orm.Session` object may be &quot;bound&quot; to multiple</span>
</span><span data-line="497"><span class="sd">        :class:`_engine.Engine` objects keyed to mapped classes, and the</span>
</span><span data-line="498"><span class="sd">        &quot;bind mapper&quot; determines which of those :class:`_engine.Engine` objects</span>
</span><span data-line="499"><span class="sd">        would be selected.</span>
</span><span data-line="500">
</span><span data-line="501"><span class="sd">        For a statement that is invoked against a single mapped class,</span>
</span><span data-line="502"><span class="sd">        :attr:`_orm.ORMExecuteState.bind_mapper` is intended to be a reliable</span>
</span><span data-line="503"><span class="sd">        way of getting this mapper.</span>
</span><span data-line="504">
</span><span data-line="505"><span class="sd">        .. versionadded:: 1.4.0b2</span>
</span><span data-line="506">
</span><span data-line="507"><span class="sd">        .. seealso::</span>
</span><span data-line="508">
</span><span data-line="509"><span class="sd">            :attr:`_orm.ORMExecuteState.all_mappers`</span>
</span><span data-line="510">
</span><span data-line="511">
</span><span data-line="512"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="513">        <span class="n">mp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mapper&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="514">        <span class="k">return</span> <span class="n">mp</span>
</span><span data-line="515">
</span><span data-line="516">    <span class="nd">@property</span>
</span><span data-line="517">    <span class="k">def</span> <span class="nf">all_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="518"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a sequence of all :class:`_orm.Mapper` objects that are</span>
</span><span data-line="519"><span class="sd">        involved at the top level of this statement.</span>
</span><span data-line="520">
</span><span data-line="521"><span class="sd">        By &quot;top level&quot; we mean those :class:`_orm.Mapper` objects that would</span>
</span><span data-line="522"><span class="sd">        be represented in the result set rows for a :func:`_sql.select`</span>
</span><span data-line="523"><span class="sd">        query, or for a :func:`_dml.update` or :func:`_dml.delete` query,</span>
</span><span data-line="524"><span class="sd">        the mapper that is the main subject of the UPDATE or DELETE.</span>
</span><span data-line="525">
</span><span data-line="526"><span class="sd">        .. versionadded:: 1.4.0b2</span>
</span><span data-line="527">
</span><span data-line="528"><span class="sd">        .. seealso::</span>
</span><span data-line="529">
</span><span data-line="530"><span class="sd">            :attr:`_orm.ORMExecuteState.bind_mapper`</span>
</span><span data-line="531">
</span><span data-line="532">
</span><span data-line="533">
</span><span data-line="534"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="535">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_orm_statement</span><span class="p">:</span>
</span><span data-line="536">            <span class="k">return</span> <span class="p">[]</span>
</span><span data-line="537">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="p">,</span> <span class="p">(</span><span class="n">Select</span><span class="p">,</span> <span class="n">FromStatement</span><span class="p">)):</span>
</span><span data-line="538">            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="539">            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="540">            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">column_descriptions</span><span class="p">:</span>
</span><span data-line="541">                <span class="n">ent</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">]</span>
</span><span data-line="542">                <span class="k">if</span> <span class="n">ent</span><span class="p">:</span>
</span><span data-line="543">                    <span class="n">insp</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">raiseerr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="544">                    <span class="k">if</span> <span class="n">insp</span> <span class="ow">and</span> <span class="n">insp</span><span class="o">.</span><span class="n">mapper</span> <span class="ow">and</span> <span class="n">insp</span><span class="o">.</span><span class="n">mapper</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
</span><span data-line="545">                        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">insp</span><span class="o">.</span><span class="n">mapper</span><span class="p">)</span>
</span><span data-line="546">                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">insp</span><span class="o">.</span><span class="n">mapper</span><span class="p">)</span>
</span><span data-line="547">            <span class="k">return</span> <span class="n">result</span>
</span><span data-line="548">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_dml</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_mapper</span><span class="p">:</span>
</span><span data-line="549">            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_mapper</span><span class="p">]</span>
</span><span data-line="550">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="551">            <span class="k">return</span> <span class="p">[]</span>
</span><span data-line="552">
</span><span data-line="553">    <span class="nd">@property</span>
</span><span data-line="554">    <span class="k">def</span> <span class="nf">is_orm_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="555"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if the operation is an ORM statement.</span>
</span><span data-line="556">
</span><span data-line="557"><span class="sd">        This indicates that the select(), insert(), update(), or delete()</span>
</span><span data-line="558"><span class="sd">        being invoked contains ORM entities as subjects.   For a statement</span>
</span><span data-line="559"><span class="sd">        that does not have ORM entities and instead refers only to</span>
</span><span data-line="560"><span class="sd">        :class:`.Table` metadata, it is invoked as a Core SQL statement</span>
</span><span data-line="561"><span class="sd">        and no ORM-level automation takes place.</span>
</span><span data-line="562">
</span><span data-line="563"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="564">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_state_cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="565">
</span><span data-line="566">    <span class="nd">@property</span>
</span><span data-line="567">    <span class="k">def</span> <span class="nf">is_executemany</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="568"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if the parameters are a multi-element list of</span>
</span><span data-line="569"><span class="sd">        dictionaries with more than one dictionary.</span>
</span><span data-line="570">
</span><span data-line="571"><span class="sd">        .. versionadded:: 2.0</span>
</span><span data-line="572">
</span><span data-line="573"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="574">        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
</span><span data-line="575">
</span><span data-line="576">    <span class="nd">@property</span>
</span><span data-line="577">    <span class="k">def</span> <span class="nf">is_select</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="578"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if this is a SELECT operation.</span>
</span><span data-line="579">
</span><span data-line="580"><span class="sd">        .. versionchanged:: 2.0.30 - the attribute is also True for a</span>
</span><span data-line="581"><span class="sd">           :meth:`_sql.Select.from_statement` construct that is itself against</span>
</span><span data-line="582"><span class="sd">           a :class:`_sql.Select` construct, such as</span>
</span><span data-line="583"><span class="sd">           ``select(Entity).from_statement(select(..))``</span>
</span><span data-line="584">
</span><span data-line="585"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="586">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_select</span>
</span><span data-line="587">
</span><span data-line="588">    <span class="nd">@property</span>
</span><span data-line="589">    <span class="k">def</span> <span class="nf">is_from_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="590"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if this operation is a</span>
</span><span data-line="591"><span class="sd">        :meth:`_sql.Select.from_statement` operation.</span>
</span><span data-line="592">
</span><span data-line="593"><span class="sd">        This is independent from :attr:`_orm.ORMExecuteState.is_select`, as a</span>
</span><span data-line="594"><span class="sd">        ``select().from_statement()`` construct can be used with</span>
</span><span data-line="595"><span class="sd">        INSERT/UPDATE/DELETE RETURNING types of statements as well.</span>
</span><span data-line="596"><span class="sd">        :attr:`_orm.ORMExecuteState.is_select` will only be set if the</span>
</span><span data-line="597"><span class="sd">        :meth:`_sql.Select.from_statement` is itself against a</span>
</span><span data-line="598"><span class="sd">        :class:`_sql.Select` construct.</span>
</span><span data-line="599">
</span><span data-line="600"><span class="sd">        .. versionadded:: 2.0.30</span>
</span><span data-line="601">
</span><span data-line="602"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="603">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_from_statement</span>
</span><span data-line="604">
</span><span data-line="605">    <span class="nd">@property</span>
</span><span data-line="606">    <span class="k">def</span> <span class="nf">is_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="607"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if this is an INSERT operation.</span>
</span><span data-line="608">
</span><span data-line="609"><span class="sd">        .. versionchanged:: 2.0.30 - the attribute is also True for a</span>
</span><span data-line="610"><span class="sd">           :meth:`_sql.Select.from_statement` construct that is itself against</span>
</span><span data-line="611"><span class="sd">           a :class:`_sql.Insert` construct, such as</span>
</span><span data-line="612"><span class="sd">           ``select(Entity).from_statement(insert(..))``</span>
</span><span data-line="613">
</span><span data-line="614"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="615">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_dml</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_insert</span>
</span><span data-line="616">
</span><span data-line="617">    <span class="nd">@property</span>
</span><span data-line="618">    <span class="k">def</span> <span class="nf">is_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="619"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if this is an UPDATE operation.</span>
</span><span data-line="620">
</span><span data-line="621"><span class="sd">        .. versionchanged:: 2.0.30 - the attribute is also True for a</span>
</span><span data-line="622"><span class="sd">           :meth:`_sql.Select.from_statement` construct that is itself against</span>
</span><span data-line="623"><span class="sd">           a :class:`_sql.Update` construct, such as</span>
</span><span data-line="624"><span class="sd">           ``select(Entity).from_statement(update(..))``</span>
</span><span data-line="625">
</span><span data-line="626"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="627">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_dml</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_update</span>
</span><span data-line="628">
</span><span data-line="629">    <span class="nd">@property</span>
</span><span data-line="630">    <span class="k">def</span> <span class="nf">is_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="631"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if this is a DELETE operation.</span>
</span><span data-line="632">
</span><span data-line="633"><span class="sd">        .. versionchanged:: 2.0.30 - the attribute is also True for a</span>
</span><span data-line="634"><span class="sd">           :meth:`_sql.Select.from_statement` construct that is itself against</span>
</span><span data-line="635"><span class="sd">           a :class:`_sql.Delete` construct, such as</span>
</span><span data-line="636"><span class="sd">           ``select(Entity).from_statement(delete(..))``</span>
</span><span data-line="637">
</span><span data-line="638"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="639">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_dml</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_delete</span>
</span><span data-line="640">
</span><span data-line="641">    <span class="nd">@property</span>
</span><span data-line="642">    <span class="k">def</span> <span class="nf">_is_crud</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="643">        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="p">,</span> <span class="p">(</span><span class="n">dml</span><span class="o">.</span><span class="n">Update</span><span class="p">,</span> <span class="n">dml</span><span class="o">.</span><span class="n">Delete</span><span class="p">))</span>
</span><span data-line="644">
</span><span data-line="645">    <span class="k">def</span> <span class="nf">update_execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="646"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the local execution options with new values.&quot;&quot;&quot;</span>
</span><span data-line="647">        <span class="bp">self</span><span class="o">.</span><span class="n">local_execution_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_execution_options</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span><span data-line="648">
</span><span data-line="649">    <span class="k">def</span> <span class="nf">_orm_compile_options</span><span class="p">(</span>
</span><span data-line="650">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="651">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span>
</span><span data-line="652">        <span class="n">Union</span><span class="p">[</span>
</span><span data-line="653">            <span class="n">context</span><span class="o">.</span><span class="n">ORMCompileState</span><span class="o">.</span><span class="n">default_compile_options</span><span class="p">,</span>
</span><span data-line="654">            <span class="n">Type</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">ORMCompileState</span><span class="o">.</span><span class="n">default_compile_options</span><span class="p">],</span>
</span><span data-line="655">        <span class="p">]</span>
</span><span data-line="656">    <span class="p">]:</span>
</span><span data-line="657">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_select</span><span class="p">:</span>
</span><span data-line="658">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="659">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="660">            <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">_compile_options</span>
</span><span data-line="661">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span data-line="662">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="663">
</span><span data-line="664">        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">isinstance</span><span class="p">(</span>
</span><span data-line="665">            <span class="n">context</span><span class="o">.</span><span class="n">ORMCompileState</span><span class="o">.</span><span class="n">default_compile_options</span>
</span><span data-line="666">        <span class="p">):</span>
</span><span data-line="667">            <span class="k">return</span> <span class="n">opts</span>  <span class="c1"># type: ignore</span>
</span><span data-line="668">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="669">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="670">
</span><span data-line="671">    <span class="nd">@property</span>
</span><span data-line="672">    <span class="k">def</span> <span class="nf">lazy_loaded_from</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="673"><span class="w">        </span><span class="sd">&quot;&quot;&quot;An :class:`.InstanceState` that is using this statement execution</span>
</span><span data-line="674"><span class="sd">        for a lazy load operation.</span>
</span><span data-line="675">
</span><span data-line="676"><span class="sd">        The primary rationale for this attribute is to support the horizontal</span>
</span><span data-line="677"><span class="sd">        sharding extension, where it is available within specific query</span>
</span><span data-line="678"><span class="sd">        execution time hooks created by this extension.   To that end, the</span>
</span><span data-line="679"><span class="sd">        attribute is only intended to be meaningful at **query execution</span>
</span><span data-line="680"><span class="sd">        time**, and importantly not any time prior to that, including query</span>
</span><span data-line="681"><span class="sd">        compilation time.</span>
</span><span data-line="682">
</span><span data-line="683"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="684">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_options</span><span class="o">.</span><span class="n">_lazy_loaded_from</span>
</span><span data-line="685">
</span><span data-line="686">    <span class="nd">@property</span>
</span><span data-line="687">    <span class="k">def</span> <span class="nf">loader_strategy_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PathRegistry</span><span class="p">]:</span>
</span><span data-line="688"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the :class:`.PathRegistry` for the current load path.</span>
</span><span data-line="689">
</span><span data-line="690"><span class="sd">        This object represents the &quot;path&quot; in a query along relationships</span>
</span><span data-line="691"><span class="sd">        when a particular object or collection is being loaded.</span>
</span><span data-line="692">
</span><span data-line="693"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="694">        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orm_compile_options</span><span class="p">()</span>
</span><span data-line="695">        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="696">            <span class="k">return</span> <span class="n">opts</span><span class="o">.</span><span class="n">_current_path</span>
</span><span data-line="697">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="698">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="699">
</span><span data-line="700">    <span class="nd">@property</span>
</span><span data-line="701">    <span class="k">def</span> <span class="nf">is_column_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="702"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the operation is refreshing column-oriented</span>
</span><span data-line="703"><span class="sd">        attributes on an existing ORM object.</span>
</span><span data-line="704">
</span><span data-line="705"><span class="sd">        This occurs during operations such as :meth:`_orm.Session.refresh`,</span>
</span><span data-line="706"><span class="sd">        as well as when an attribute deferred by :func:`_orm.defer` is</span>
</span><span data-line="707"><span class="sd">        being loaded, or an attribute that was expired either directly</span>
</span><span data-line="708"><span class="sd">        by :meth:`_orm.Session.expire` or via a commit operation is being</span>
</span><span data-line="709"><span class="sd">        loaded.</span>
</span><span data-line="710">
</span><span data-line="711"><span class="sd">        Handlers will very likely not want to add any options to queries</span>
</span><span data-line="712"><span class="sd">        when such an operation is occurring as the query should be a straight</span>
</span><span data-line="713"><span class="sd">        primary key fetch which should not have any additional WHERE criteria,</span>
</span><span data-line="714"><span class="sd">        and loader options travelling with the instance</span>
</span><span data-line="715"><span class="sd">        will have already been added to the query.</span>
</span><span data-line="716">
</span><span data-line="717"><span class="sd">        .. versionadded:: 1.4.0b2</span>
</span><span data-line="718">
</span><span data-line="719"><span class="sd">        .. seealso::</span>
</span><span data-line="720">
</span><span data-line="721"><span class="sd">            :attr:`_orm.ORMExecuteState.is_relationship_load`</span>
</span><span data-line="722">
</span><span data-line="723"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="724">        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orm_compile_options</span><span class="p">()</span>
</span><span data-line="725">        <span class="k">return</span> <span class="n">opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">_for_refresh_state</span>
</span><span data-line="726">
</span><span data-line="727">    <span class="nd">@property</span>
</span><span data-line="728">    <span class="k">def</span> <span class="nf">is_relationship_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="729"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this load is loading objects on behalf of a</span>
</span><span data-line="730"><span class="sd">        relationship.</span>
</span><span data-line="731">
</span><span data-line="732"><span class="sd">        This means, the loader in effect is either a LazyLoader,</span>
</span><span data-line="733"><span class="sd">        SelectInLoader, SubqueryLoader, or similar, and the entire</span>
</span><span data-line="734"><span class="sd">        SELECT statement being emitted is on behalf of a relationship</span>
</span><span data-line="735"><span class="sd">        load.</span>
</span><span data-line="736">
</span><span data-line="737"><span class="sd">        Handlers will very likely not want to add any options to queries</span>
</span><span data-line="738"><span class="sd">        when such an operation is occurring, as loader options are already</span>
</span><span data-line="739"><span class="sd">        capable of being propagated to relationship loaders and should</span>
</span><span data-line="740"><span class="sd">        be already present.</span>
</span><span data-line="741">
</span><span data-line="742"><span class="sd">        .. seealso::</span>
</span><span data-line="743">
</span><span data-line="744"><span class="sd">            :attr:`_orm.ORMExecuteState.is_column_load`</span>
</span><span data-line="745">
</span><span data-line="746"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="747">        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orm_compile_options</span><span class="p">()</span>
</span><span data-line="748">        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="749">            <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="750">        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader_strategy_path</span>
</span><span data-line="751">        <span class="k">return</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_root</span>
</span><span data-line="752">
</span><span data-line="753">    <span class="nd">@property</span>
</span><span data-line="754">    <span class="k">def</span> <span class="nf">load_options</span><span class="p">(</span>
</span><span data-line="755">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="756">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="757">        <span class="n">context</span><span class="o">.</span><span class="n">QueryContext</span><span class="o">.</span><span class="n">default_load_options</span><span class="p">,</span>
</span><span data-line="758">        <span class="n">Type</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">QueryContext</span><span class="o">.</span><span class="n">default_load_options</span><span class="p">],</span>
</span><span data-line="759">    <span class="p">]:</span>
</span><span data-line="760"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the load_options that will be used for this execution.&quot;&quot;&quot;</span>
</span><span data-line="761">
</span><span data-line="762">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_select</span><span class="p">:</span>
</span><span data-line="763">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="764">                <span class="s2">&quot;This ORM execution is not against a SELECT statement &quot;</span>
</span><span data-line="765">                <span class="s2">&quot;so there are no load options.&quot;</span>
</span><span data-line="766">            <span class="p">)</span>
</span><span data-line="767">
</span><span data-line="768">        <span class="n">lo</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="769">            <span class="n">context</span><span class="o">.</span><span class="n">QueryContext</span><span class="o">.</span><span class="n">default_load_options</span><span class="p">,</span>
</span><span data-line="770">            <span class="n">Type</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">QueryContext</span><span class="o">.</span><span class="n">default_load_options</span><span class="p">],</span>
</span><span data-line="771">        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="772">            <span class="s2">&quot;_sa_orm_load_options&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">QueryContext</span><span class="o">.</span><span class="n">default_load_options</span>
</span><span data-line="773">        <span class="p">)</span>
</span><span data-line="774">        <span class="k">return</span> <span class="n">lo</span>
</span><span data-line="775">
</span><span data-line="776">    <span class="nd">@property</span>
</span><span data-line="777">    <span class="k">def</span> <span class="nf">update_delete_options</span><span class="p">(</span>
</span><span data-line="778">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="779">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="780">        <span class="n">bulk_persistence</span><span class="o">.</span><span class="n">BulkUDCompileState</span><span class="o">.</span><span class="n">default_update_options</span><span class="p">,</span>
</span><span data-line="781">        <span class="n">Type</span><span class="p">[</span><span class="n">bulk_persistence</span><span class="o">.</span><span class="n">BulkUDCompileState</span><span class="o">.</span><span class="n">default_update_options</span><span class="p">],</span>
</span><span data-line="782">    <span class="p">]:</span>
</span><span data-line="783"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the update_delete_options that will be used for this</span>
</span><span data-line="784"><span class="sd">        execution.&quot;&quot;&quot;</span>
</span><span data-line="785">
</span><span data-line="786">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_crud</span><span class="p">:</span>
</span><span data-line="787">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="788">                <span class="s2">&quot;This ORM execution is not against an UPDATE or DELETE &quot;</span>
</span><span data-line="789">                <span class="s2">&quot;statement so there are no update options.&quot;</span>
</span><span data-line="790">            <span class="p">)</span>
</span><span data-line="791">        <span class="n">uo</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="792">            <span class="n">bulk_persistence</span><span class="o">.</span><span class="n">BulkUDCompileState</span><span class="o">.</span><span class="n">default_update_options</span><span class="p">,</span>
</span><span data-line="793">            <span class="n">Type</span><span class="p">[</span><span class="n">bulk_persistence</span><span class="o">.</span><span class="n">BulkUDCompileState</span><span class="o">.</span><span class="n">default_update_options</span><span class="p">],</span>
</span><span data-line="794">        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="795">            <span class="s2">&quot;_sa_orm_update_options&quot;</span><span class="p">,</span>
</span><span data-line="796">            <span class="n">bulk_persistence</span><span class="o">.</span><span class="n">BulkUDCompileState</span><span class="o">.</span><span class="n">default_update_options</span><span class="p">,</span>
</span><span data-line="797">        <span class="p">)</span>
</span><span data-line="798">        <span class="k">return</span> <span class="n">uo</span>
</span><span data-line="799">
</span><span data-line="800">    <span class="nd">@property</span>
</span><span data-line="801">    <span class="k">def</span> <span class="nf">_non_compile_orm_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]:</span>
</span><span data-line="802">        <span class="k">return</span> <span class="p">[</span>
</span><span data-line="803">            <span class="n">opt</span>
</span><span data-line="804">            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">_with_options</span>
</span><span data-line="805">            <span class="k">if</span> <span class="n">is_orm_option</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">opt</span><span class="o">.</span><span class="n">_is_compile_state</span>
</span><span data-line="806">        <span class="p">]</span>
</span><span data-line="807">
</span><span data-line="808">    <span class="nd">@property</span>
</span><span data-line="809">    <span class="k">def</span> <span class="nf">user_defined_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">UserDefinedOption</span><span class="p">]:</span>
</span><span data-line="810"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The sequence of :class:`.UserDefinedOptions` that have been</span>
</span><span data-line="811"><span class="sd">        associated with the statement being invoked.</span>
</span><span data-line="812">
</span><span data-line="813"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="814">        <span class="k">return</span> <span class="p">[</span>
</span><span data-line="815">            <span class="n">opt</span>
</span><span data-line="816">            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">_with_options</span>
</span><span data-line="817">            <span class="k">if</span> <span class="n">is_user_defined_option</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
</span><span data-line="818">        <span class="p">]</span>
</span><span data-line="819">
</span><span data-line="820">
</span><span data-line="821"><span class="k">class</span> <span class="nc">SessionTransactionOrigin</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span data-line="822"><span class="w">    </span><span class="sd">&quot;&quot;&quot;indicates the origin of a :class:`.SessionTransaction`.</span>
</span><span data-line="823">
</span><span data-line="824"><span class="sd">    This enumeration is present on the</span>
</span><span data-line="825"><span class="sd">    :attr:`.SessionTransaction.origin` attribute of any</span>
</span><span data-line="826"><span class="sd">    :class:`.SessionTransaction` object.</span>
</span><span data-line="827">
</span><span data-line="828"><span class="sd">    .. versionadded:: 2.0</span>
</span><span data-line="829">
</span><span data-line="830"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="831">
</span><span data-line="832">    <span class="n">AUTOBEGIN</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="833"><span class="w">    </span><span class="sd">&quot;&quot;&quot;transaction were started by autobegin&quot;&quot;&quot;</span>
</span><span data-line="834">
</span><span data-line="835">    <span class="n">BEGIN</span> <span class="o">=</span> <span class="mi">1</span>
</span><span data-line="836"><span class="w">    </span><span class="sd">&quot;&quot;&quot;transaction were started by calling :meth:`_orm.Session.begin`&quot;&quot;&quot;</span>
</span><span data-line="837">
</span><span data-line="838">    <span class="n">BEGIN_NESTED</span> <span class="o">=</span> <span class="mi">2</span>
</span><span data-line="839"><span class="w">    </span><span class="sd">&quot;&quot;&quot;tranaction were started by :meth:`_orm.Session.begin_nested`&quot;&quot;&quot;</span>
</span><span data-line="840">
</span><span data-line="841">    <span class="n">SUBTRANSACTION</span> <span class="o">=</span> <span class="mi">3</span>
</span><span data-line="842"><span class="w">    </span><span class="sd">&quot;&quot;&quot;transaction is an internal &quot;subtransaction&quot; &quot;&quot;&quot;</span>
</span><span data-line="843">
</span><span data-line="844">
</span><span data-line="845"><span class="k">class</span> <span class="nc">SessionTransaction</span><span class="p">(</span><span class="n">_StateChange</span><span class="p">,</span> <span class="n">TransactionalContext</span><span class="p">):</span>
</span><span data-line="846"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A :class:`.Session`-level transaction.</span>
</span><span data-line="847">
</span><span data-line="848"><span class="sd">    :class:`.SessionTransaction` is produced from the</span>
</span><span data-line="849"><span class="sd">    :meth:`_orm.Session.begin`</span>
</span><span data-line="850"><span class="sd">    and :meth:`_orm.Session.begin_nested` methods.   It&#39;s largely an internal</span>
</span><span data-line="851"><span class="sd">    object that in modern use provides a context manager for session</span>
</span><span data-line="852"><span class="sd">    transactions.</span>
</span><span data-line="853">
</span><span data-line="854"><span class="sd">    Documentation on interacting with :class:`_orm.SessionTransaction` is</span>
</span><span data-line="855"><span class="sd">    at: :ref:`unitofwork_transaction`.</span>
</span><span data-line="856">
</span><span data-line="857">
</span><span data-line="858"><span class="sd">    .. versionchanged:: 1.4  The scoping and API methods to work with the</span>
</span><span data-line="859"><span class="sd">       :class:`_orm.SessionTransaction` object directly have been simplified.</span>
</span><span data-line="860">
</span><span data-line="861"><span class="sd">    .. seealso::</span>
</span><span data-line="862">
</span><span data-line="863"><span class="sd">        :ref:`unitofwork_transaction`</span>
</span><span data-line="864">
</span><span data-line="865"><span class="sd">        :meth:`.Session.begin`</span>
</span><span data-line="866">
</span><span data-line="867"><span class="sd">        :meth:`.Session.begin_nested`</span>
</span><span data-line="868">
</span><span data-line="869"><span class="sd">        :meth:`.Session.rollback`</span>
</span><span data-line="870">
</span><span data-line="871"><span class="sd">        :meth:`.Session.commit`</span>
</span><span data-line="872">
</span><span data-line="873"><span class="sd">        :meth:`.Session.in_transaction`</span>
</span><span data-line="874">
</span><span data-line="875"><span class="sd">        :meth:`.Session.in_nested_transaction`</span>
</span><span data-line="876">
</span><span data-line="877"><span class="sd">        :meth:`.Session.get_transaction`</span>
</span><span data-line="878">
</span><span data-line="879"><span class="sd">        :meth:`.Session.get_nested_transaction`</span>
</span><span data-line="880">
</span><span data-line="881">
</span><span data-line="882"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="883">
</span><span data-line="884">    <span class="n">_rollback_exception</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="885">
</span><span data-line="886">    <span class="n">_connections</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
</span><span data-line="887">        <span class="n">Union</span><span class="p">[</span><span class="n">Engine</span><span class="p">,</span> <span class="n">Connection</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Connection</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span data-line="888">    <span class="p">]</span>
</span><span data-line="889">    <span class="n">session</span><span class="p">:</span> <span class="n">Session</span>
</span><span data-line="890">    <span class="n">_parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]</span>
</span><span data-line="891">
</span><span data-line="892">    <span class="n">_state</span><span class="p">:</span> <span class="n">SessionTransactionState</span>
</span><span data-line="893">
</span><span data-line="894">    <span class="n">_new</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">]</span>
</span><span data-line="895">    <span class="n">_deleted</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">]</span>
</span><span data-line="896">    <span class="n">_dirty</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">]</span>
</span><span data-line="897">    <span class="n">_key_switches</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span>
</span><span data-line="898">        <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="899">    <span class="p">]</span>
</span><span data-line="900">
</span><span data-line="901">    <span class="n">origin</span><span class="p">:</span> <span class="n">SessionTransactionOrigin</span>
</span><span data-line="902"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Origin of this :class:`_orm.SessionTransaction`.</span>
</span><span data-line="903">
</span><span data-line="904"><span class="sd">    Refers to a :class:`.SessionTransactionOrigin` instance which is an</span>
</span><span data-line="905"><span class="sd">    enumeration indicating the source event that led to constructing</span>
</span><span data-line="906"><span class="sd">    this :class:`_orm.SessionTransaction`.</span>
</span><span data-line="907">
</span><span data-line="908"><span class="sd">    .. versionadded:: 2.0</span>
</span><span data-line="909">
</span><span data-line="910"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="911">
</span><span data-line="912">    <span class="n">nested</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="913"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Indicates if this is a nested, or SAVEPOINT, transaction.</span>
</span><span data-line="914">
</span><span data-line="915"><span class="sd">    When :attr:`.SessionTransaction.nested` is True, it is expected</span>
</span><span data-line="916"><span class="sd">    that :attr:`.SessionTransaction.parent` will be present as well,</span>
</span><span data-line="917"><span class="sd">    linking to the enclosing :class:`.SessionTransaction`.</span>
</span><span data-line="918">
</span><span data-line="919"><span class="sd">    .. seealso::</span>
</span><span data-line="920">
</span><span data-line="921"><span class="sd">        :attr:`.SessionTransaction.origin`</span>
</span><span data-line="922">
</span><span data-line="923"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="924">
</span><span data-line="925">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="926">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="927">        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span>
</span><span data-line="928">        <span class="n">origin</span><span class="p">:</span> <span class="n">SessionTransactionOrigin</span><span class="p">,</span>
</span><span data-line="929">        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="930">    <span class="p">):</span>
</span><span data-line="931">        <span class="n">TransactionalContext</span><span class="o">.</span><span class="n">_trans_ctx_check</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</span><span data-line="932">
</span><span data-line="933">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
</span><span data-line="934">        <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="935">        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span data-line="936">        <span class="bp">self</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="n">nested</span> <span class="o">=</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">BEGIN_NESTED</span>
</span><span data-line="937">        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
</span><span data-line="938">
</span><span data-line="939">        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">_close_state</span> <span class="ow">is</span> <span class="n">_SessionCloseState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">:</span>
</span><span data-line="940">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="941">                <span class="s2">&quot;This Session has been permanently closed and is unable &quot;</span>
</span><span data-line="942">                <span class="s2">&quot;to handle any more transaction requests.&quot;</span>
</span><span data-line="943">            <span class="p">)</span>
</span><span data-line="944">
</span><span data-line="945">        <span class="k">if</span> <span class="n">nested</span><span class="p">:</span>
</span><span data-line="946">            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span>
</span><span data-line="947">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="948">                    <span class="s2">&quot;Can&#39;t start a SAVEPOINT transaction when no existing &quot;</span>
</span><span data-line="949">                    <span class="s2">&quot;transaction is in progress&quot;</span>
</span><span data-line="950">                <span class="p">)</span>
</span><span data-line="951">
</span><span data-line="952">            <span class="bp">self</span><span class="o">.</span><span class="n">_previous_nested_transaction</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">_nested_transaction</span>
</span><span data-line="953">        <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">SUBTRANSACTION</span><span class="p">:</span>
</span><span data-line="954">            <span class="k">assert</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="955">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="956">            <span class="k">assert</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="957">
</span><span data-line="958">        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span>
</span><span data-line="959">
</span><span data-line="960">        <span class="bp">self</span><span class="o">.</span><span class="n">_take_snapshot</span><span class="p">()</span>
</span><span data-line="961">
</span><span data-line="962">        <span class="c1"># make sure transaction is assigned before we call the</span>
</span><span data-line="963">        <span class="c1"># dispatch</span>
</span><span data-line="964">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="bp">self</span>
</span><span data-line="965">
</span><span data-line="966">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_transaction_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span data-line="967">
</span><span data-line="968">    <span class="k">def</span> <span class="nf">_raise_for_prerequisite_state</span><span class="p">(</span>
</span><span data-line="969">        <span class="bp">self</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">_StateChangeState</span>
</span><span data-line="970">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="971">        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">DEACTIVE</span><span class="p">:</span>
</span><span data-line="972">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rollback_exception</span><span class="p">:</span>
</span><span data-line="973">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">PendingRollbackError</span><span class="p">(</span>
</span><span data-line="974">                    <span class="s2">&quot;This Session&#39;s transaction has been rolled back &quot;</span>
</span><span data-line="975">                    <span class="s2">&quot;due to a previous exception during flush.&quot;</span>
</span><span data-line="976">                    <span class="s2">&quot; To begin a new transaction with this Session, &quot;</span>
</span><span data-line="977">                    <span class="s2">&quot;first issue Session.rollback().&quot;</span>
</span><span data-line="978">                    <span class="sa">f</span><span class="s2">&quot; Original exception was: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_rollback_exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span data-line="979">                    <span class="n">code</span><span class="o">=</span><span class="s2">&quot;7s2a&quot;</span><span class="p">,</span>
</span><span data-line="980">                <span class="p">)</span>
</span><span data-line="981">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="982">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="983">                    <span class="s2">&quot;This session is in &#39;inactive&#39; state, due to the &quot;</span>
</span><span data-line="984">                    <span class="s2">&quot;SQL transaction being rolled back; no further SQL &quot;</span>
</span><span data-line="985">                    <span class="s2">&quot;can be emitted within this transaction.&quot;</span>
</span><span data-line="986">                <span class="p">)</span>
</span><span data-line="987">        <span class="k">elif</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">:</span>
</span><span data-line="988">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ResourceClosedError</span><span class="p">(</span><span class="s2">&quot;This transaction is closed&quot;</span><span class="p">)</span>
</span><span data-line="989">        <span class="k">elif</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PROVISIONING_CONNECTION</span><span class="p">:</span>
</span><span data-line="990">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="991">                <span class="s2">&quot;This session is provisioning a new connection; concurrent &quot;</span>
</span><span data-line="992">                <span class="s2">&quot;operations are not permitted&quot;</span><span class="p">,</span>
</span><span data-line="993">                <span class="n">code</span><span class="o">=</span><span class="s2">&quot;isce&quot;</span><span class="p">,</span>
</span><span data-line="994">            <span class="p">)</span>
</span><span data-line="995">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="996">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="997">                <span class="sa">f</span><span class="s2">&quot;This session is in &#39;</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; state; no &quot;</span>
</span><span data-line="998">                <span class="s2">&quot;further SQL can be emitted within this transaction.&quot;</span>
</span><span data-line="999">            <span class="p">)</span>
</span><span data-line="1000">
</span><span data-line="1001">    <span class="nd">@property</span>
</span><span data-line="1002">    <span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]:</span>
</span><span data-line="1003"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The parent :class:`.SessionTransaction` of this</span>
</span><span data-line="1004"><span class="sd">        :class:`.SessionTransaction`.</span>
</span><span data-line="1005">
</span><span data-line="1006"><span class="sd">        If this attribute is ``None``, indicates this</span>
</span><span data-line="1007"><span class="sd">        :class:`.SessionTransaction` is at the top of the stack, and</span>
</span><span data-line="1008"><span class="sd">        corresponds to a real &quot;COMMIT&quot;/&quot;ROLLBACK&quot;</span>
</span><span data-line="1009"><span class="sd">        block.  If non-``None``, then this is either a &quot;subtransaction&quot;</span>
</span><span data-line="1010"><span class="sd">        (an internal marker object used by the flush process) or a</span>
</span><span data-line="1011"><span class="sd">        &quot;nested&quot; / SAVEPOINT transaction.  If the</span>
</span><span data-line="1012"><span class="sd">        :attr:`.SessionTransaction.nested` attribute is ``True``, then</span>
</span><span data-line="1013"><span class="sd">        this is a SAVEPOINT, and if ``False``, indicates this a subtransaction.</span>
</span><span data-line="1014">
</span><span data-line="1015"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1016">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
</span><span data-line="1017">
</span><span data-line="1018">    <span class="nd">@property</span>
</span><span data-line="1019">    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1020">        <span class="k">return</span> <span class="p">(</span>
</span><span data-line="1021">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1022">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">is</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span>
</span><span data-line="1023">        <span class="p">)</span>
</span><span data-line="1024">
</span><span data-line="1025">    <span class="nd">@property</span>
</span><span data-line="1026">    <span class="k">def</span> <span class="nf">_is_transaction_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1027">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
</span><span data-line="1028">
</span><span data-line="1029">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span data-line="1030">        <span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,),</span> <span class="n">_StateChangeStates</span><span class="o">.</span><span class="n">NO_CHANGE</span>
</span><span data-line="1031">    <span class="p">)</span>
</span><span data-line="1032">    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span>
</span><span data-line="1033">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1034">        <span class="n">bindkey</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="1035">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ExecuteOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1036">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1037">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
</span><span data-line="1038">        <span class="n">bind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_bind</span><span class="p">(</span><span class="n">bindkey</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="1039">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_for_bind</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">execution_options</span><span class="p">)</span>
</span><span data-line="1040">
</span><span data-line="1041">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span data-line="1042">        <span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,),</span> <span class="n">_StateChangeStates</span><span class="o">.</span><span class="n">NO_CHANGE</span>
</span><span data-line="1043">    <span class="p">)</span>
</span><span data-line="1044">    <span class="k">def</span> <span class="nf">_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nested</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SessionTransaction</span><span class="p">:</span>
</span><span data-line="1045">        <span class="k">return</span> <span class="n">SessionTransaction</span><span class="p">(</span>
</span><span data-line="1046">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
</span><span data-line="1047">            <span class="p">(</span>
</span><span data-line="1048">                <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">BEGIN_NESTED</span>
</span><span data-line="1049">                <span class="k">if</span> <span class="n">nested</span>
</span><span data-line="1050">                <span class="k">else</span> <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">SUBTRANSACTION</span>
</span><span data-line="1051">            <span class="p">),</span>
</span><span data-line="1052">            <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1053">        <span class="p">)</span>
</span><span data-line="1054">
</span><span data-line="1055">    <span class="k">def</span> <span class="nf">_iterate_self_and_parents</span><span class="p">(</span>
</span><span data-line="1056">        <span class="bp">self</span><span class="p">,</span> <span class="n">upto</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1057">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]:</span>
</span><span data-line="1058">        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span>
</span><span data-line="1059">        <span class="n">result</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
</span><span data-line="1060">        <span class="k">while</span> <span class="n">current</span><span class="p">:</span>
</span><span data-line="1061">            <span class="n">result</span> <span class="o">+=</span> <span class="p">(</span><span class="n">current</span><span class="p">,)</span>
</span><span data-line="1062">            <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="n">upto</span><span class="p">:</span>
</span><span data-line="1063">                <span class="k">break</span>
</span><span data-line="1064">            <span class="k">elif</span> <span class="n">current</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1065">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1066">                    <span class="s2">&quot;Transaction </span><span class="si">%s</span><span class="s2"> is not on the active transaction list&quot;</span>
</span><span data-line="1067">                    <span class="o">%</span> <span class="p">(</span><span class="n">upto</span><span class="p">)</span>
</span><span data-line="1068">                <span class="p">)</span>
</span><span data-line="1069">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1070">                <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">_parent</span>
</span><span data-line="1071">
</span><span data-line="1072">        <span class="k">return</span> <span class="n">result</span>
</span><span data-line="1073">
</span><span data-line="1074">    <span class="k">def</span> <span class="nf">_take_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1075">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_transaction_boundary</span><span class="p">:</span>
</span><span data-line="1076">            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
</span><span data-line="1077">            <span class="k">assert</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1078">            <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_new</span>
</span><span data-line="1079">            <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_deleted</span>
</span><span data-line="1080">            <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_dirty</span>
</span><span data-line="1081">            <span class="bp">self</span><span class="o">.</span><span class="n">_key_switches</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_key_switches</span>
</span><span data-line="1082">            <span class="k">return</span>
</span><span data-line="1083">
</span><span data-line="1084">        <span class="n">is_begin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span>
</span><span data-line="1085">            <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">BEGIN</span><span class="p">,</span>
</span><span data-line="1086">            <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">AUTOBEGIN</span><span class="p">,</span>
</span><span data-line="1087">        <span class="p">)</span>
</span><span data-line="1088">        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_begin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_flushing</span><span class="p">:</span>
</span><span data-line="1089">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span data-line="1090">
</span><span data-line="1091">        <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span data-line="1092">        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span data-line="1093">        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span data-line="1094">        <span class="bp">self</span><span class="o">.</span><span class="n">_key_switches</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span data-line="1095">
</span><span data-line="1096">    <span class="k">def</span> <span class="nf">_restore_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirty_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1097"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore the restoration state taken before a transaction began.</span>
</span><span data-line="1098">
</span><span data-line="1099"><span class="sd">        Corresponds to a rollback.</span>
</span><span data-line="1100">
</span><span data-line="1101"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1102">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_transaction_boundary</span>
</span><span data-line="1103">
</span><span data-line="1104">        <span class="n">to_expunge</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_new</span><span class="p">)</span>
</span><span data-line="1105">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_expunge_states</span><span class="p">(</span><span class="n">to_expunge</span><span class="p">,</span> <span class="n">to_transient</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1106">
</span><span data-line="1107">        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">oldkey</span><span class="p">,</span> <span class="n">newkey</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_switches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="1108">            <span class="c1"># we probably can do this conditionally based on</span>
</span><span data-line="1109">            <span class="c1"># if we expunged or not, but safe_discard does that anyway</span>
</span><span data-line="1110">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">safe_discard</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span data-line="1111">
</span><span data-line="1112">            <span class="c1"># restore the old key</span>
</span><span data-line="1113">            <span class="n">s</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">oldkey</span>
</span><span data-line="1114">
</span><span data-line="1115">            <span class="c1"># now restore the object, but only if we didn&#39;t expunge</span>
</span><span data-line="1116">            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">to_expunge</span><span class="p">:</span>
</span><span data-line="1117">                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span data-line="1118">
</span><span data-line="1119">        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_deleted</span><span class="p">):</span>
</span><span data-line="1120">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_update_impl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">revert_deletion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1121">
</span><span data-line="1122">        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_deleted</span>
</span><span data-line="1123">
</span><span data-line="1124">        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">all_states</span><span class="p">():</span>
</span><span data-line="1125">            <span class="k">if</span> <span class="ow">not</span> <span class="n">dirty_only</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">modified</span> <span class="ow">or</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">:</span>
</span><span data-line="1126">                <span class="n">s</span><span class="o">.</span><span class="n">_expire</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="p">)</span>
</span><span data-line="1127">
</span><span data-line="1128">    <span class="k">def</span> <span class="nf">_remove_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1129"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the restoration state taken before a transaction began.</span>
</span><span data-line="1130">
</span><span data-line="1131"><span class="sd">        Corresponds to a commit.</span>
</span><span data-line="1132">
</span><span data-line="1133"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1134">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_transaction_boundary</span>
</span><span data-line="1135">
</span><span data-line="1136">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">expire_on_commit</span><span class="p">:</span>
</span><span data-line="1137">            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">all_states</span><span class="p">():</span>
</span><span data-line="1138">                <span class="n">s</span><span class="o">.</span><span class="n">_expire</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="p">)</span>
</span><span data-line="1139">
</span><span data-line="1140">            <span class="n">statelib</span><span class="o">.</span><span class="n">InstanceState</span><span class="o">.</span><span class="n">_detach_states</span><span class="p">(</span>
</span><span data-line="1141">                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span data-line="1142">            <span class="p">)</span>
</span><span data-line="1143">            <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span data-line="1144">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span data-line="1145">            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
</span><span data-line="1146">            <span class="k">assert</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1147">            <span class="n">parent</span><span class="o">.</span><span class="n">_new</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">)</span>
</span><span data-line="1148">            <span class="n">parent</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">)</span>
</span><span data-line="1149">            <span class="n">parent</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="p">)</span>
</span><span data-line="1150">            <span class="n">parent</span><span class="o">.</span><span class="n">_key_switches</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_switches</span><span class="p">)</span>
</span><span data-line="1151">
</span><span data-line="1152">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span data-line="1153">        <span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,),</span> <span class="n">_StateChangeStates</span><span class="o">.</span><span class="n">NO_CHANGE</span>
</span><span data-line="1154">    <span class="p">)</span>
</span><span data-line="1155">    <span class="k">def</span> <span class="nf">_connection_for_bind</span><span class="p">(</span>
</span><span data-line="1156">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1157">        <span class="n">bind</span><span class="p">:</span> <span class="n">_SessionBind</span><span class="p">,</span>
</span><span data-line="1158">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">],</span>
</span><span data-line="1159">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
</span><span data-line="1160">        <span class="k">if</span> <span class="n">bind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">:</span>
</span><span data-line="1161">            <span class="k">if</span> <span class="n">execution_options</span><span class="p">:</span>
</span><span data-line="1162">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="1163">                    <span class="s2">&quot;Connection is already established for the &quot;</span>
</span><span data-line="1164">                    <span class="s2">&quot;given bind; execution_options ignored&quot;</span>
</span><span data-line="1165">                <span class="p">)</span>
</span><span data-line="1166">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">[</span><span class="n">bind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="1167">
</span><span data-line="1168">        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PROVISIONING_CONNECTION</span>
</span><span data-line="1169">
</span><span data-line="1170">        <span class="n">local_connect</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1171">        <span class="n">should_commit</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1172">
</span><span data-line="1173">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1174">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">:</span>
</span><span data-line="1175">                <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_connection_for_bind</span><span class="p">(</span>
</span><span data-line="1176">                    <span class="n">bind</span><span class="p">,</span> <span class="n">execution_options</span>
</span><span data-line="1177">                <span class="p">)</span>
</span><span data-line="1178">                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span data-line="1179">                    <span class="k">return</span> <span class="n">conn</span>
</span><span data-line="1180">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1181">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
</span><span data-line="1182">                    <span class="n">conn</span> <span class="o">=</span> <span class="n">bind</span>
</span><span data-line="1183">                    <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">engine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">:</span>
</span><span data-line="1184">                        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1185">                            <span class="s2">&quot;Session already has a Connection associated &quot;</span>
</span><span data-line="1186">                            <span class="s2">&quot;for the given Connection&#39;s Engine&quot;</span>
</span><span data-line="1187">                        <span class="p">)</span>
</span><span data-line="1188">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1189">                    <span class="n">conn</span> <span class="o">=</span> <span class="n">bind</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span data-line="1190">                    <span class="n">local_connect</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1191">
</span><span data-line="1192">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="1193">                <span class="k">if</span> <span class="n">execution_options</span><span class="p">:</span>
</span><span data-line="1194">                    <span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="o">**</span><span class="n">execution_options</span><span class="p">)</span>
</span><span data-line="1195">
</span><span data-line="1196">                <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span>
</span><span data-line="1197">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">twophase</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1198">                    <span class="c1"># TODO: shouldn&#39;t we only be here if not</span>
</span><span data-line="1199">                    <span class="c1"># conn.in_transaction() ?</span>
</span><span data-line="1200">                    <span class="c1"># if twophase is set and conn.in_transaction(), validate</span>
</span><span data-line="1201">                    <span class="c1"># that it is in fact twophase.</span>
</span><span data-line="1202">                    <span class="n">transaction</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin_twophase</span><span class="p">()</span>
</span><span data-line="1203">                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span data-line="1204">                    <span class="n">transaction</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>
</span><span data-line="1205">                <span class="k">elif</span> <span class="n">conn</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">():</span>
</span><span data-line="1206">                    <span class="n">join_transaction_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">join_transaction_mode</span>
</span><span data-line="1207">
</span><span data-line="1208">                    <span class="k">if</span> <span class="n">join_transaction_mode</span> <span class="o">==</span> <span class="s2">&quot;conditional_savepoint&quot;</span><span class="p">:</span>
</span><span data-line="1209">                        <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">in_nested_transaction</span><span class="p">():</span>
</span><span data-line="1210">                            <span class="n">join_transaction_mode</span> <span class="o">=</span> <span class="s2">&quot;create_savepoint&quot;</span>
</span><span data-line="1211">                        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1212">                            <span class="n">join_transaction_mode</span> <span class="o">=</span> <span class="s2">&quot;rollback_only&quot;</span>
</span><span data-line="1213">
</span><span data-line="1214">                        <span class="k">if</span> <span class="n">local_connect</span><span class="p">:</span>
</span><span data-line="1215">                            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="1216">                                <span class="s2">&quot;The engine provided as bind produced a &quot;</span>
</span><span data-line="1217">                                <span class="s2">&quot;connection that is already in a transaction. &quot;</span>
</span><span data-line="1218">                                <span class="s2">&quot;This is usually caused by a core event, &quot;</span>
</span><span data-line="1219">                                <span class="s2">&quot;such as &#39;engine_connect&#39;, that has left a &quot;</span>
</span><span data-line="1220">                                <span class="s2">&quot;transaction open. The effective join &quot;</span>
</span><span data-line="1221">                                <span class="s2">&quot;transaction mode used by this session is &quot;</span>
</span><span data-line="1222">                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">join_transaction_mode</span><span class="si">!r}</span><span class="s2">. To silence this &quot;</span>
</span><span data-line="1223">                                <span class="s2">&quot;warning, do not leave transactions open&quot;</span>
</span><span data-line="1224">                            <span class="p">)</span>
</span><span data-line="1225">                    <span class="k">if</span> <span class="n">join_transaction_mode</span> <span class="ow">in</span> <span class="p">(</span>
</span><span data-line="1226">                        <span class="s2">&quot;control_fully&quot;</span><span class="p">,</span>
</span><span data-line="1227">                        <span class="s2">&quot;rollback_only&quot;</span><span class="p">,</span>
</span><span data-line="1228">                    <span class="p">):</span>
</span><span data-line="1229">                        <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">in_nested_transaction</span><span class="p">():</span>
</span><span data-line="1230">                            <span class="n">transaction</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1231">                                <span class="n">conn</span><span class="o">.</span><span class="n">_get_required_nested_transaction</span><span class="p">()</span>
</span><span data-line="1232">                            <span class="p">)</span>
</span><span data-line="1233">                        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1234">                            <span class="n">transaction</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">_get_required_transaction</span><span class="p">()</span>
</span><span data-line="1235">                        <span class="k">if</span> <span class="n">join_transaction_mode</span> <span class="o">==</span> <span class="s2">&quot;rollback_only&quot;</span><span class="p">:</span>
</span><span data-line="1236">                            <span class="n">should_commit</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1237">                    <span class="k">elif</span> <span class="n">join_transaction_mode</span> <span class="o">==</span> <span class="s2">&quot;create_savepoint&quot;</span><span class="p">:</span>
</span><span data-line="1238">                        <span class="n">transaction</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>
</span><span data-line="1239">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="1240">                        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="n">join_transaction_mode</span>
</span><span data-line="1241">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1242">                    <span class="n">transaction</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
</span><span data-line="1243">            <span class="k">except</span><span class="p">:</span>
</span><span data-line="1244">                <span class="c1"># connection will not not be associated with this Session;</span>
</span><span data-line="1245">                <span class="c1"># close it immediately so that it isn&#39;t closed under GC</span>
</span><span data-line="1246">                <span class="k">if</span> <span class="n">local_connect</span><span class="p">:</span>
</span><span data-line="1247">                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1248">                <span class="k">raise</span>
</span><span data-line="1249">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1250">                <span class="n">bind_is_connection</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">Connection</span><span class="p">)</span>
</span><span data-line="1251">
</span><span data-line="1252">                <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">[</span><span class="n">conn</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">[</span><span class="n">conn</span><span class="o">.</span><span class="n">engine</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1253">                    <span class="n">conn</span><span class="p">,</span>
</span><span data-line="1254">                    <span class="n">transaction</span><span class="p">,</span>
</span><span data-line="1255">                    <span class="n">should_commit</span><span class="p">,</span>
</span><span data-line="1256">                    <span class="ow">not</span> <span class="n">bind_is_connection</span><span class="p">,</span>
</span><span data-line="1257">                <span class="p">)</span>
</span><span data-line="1258">                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_begin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
</span><span data-line="1259">                <span class="k">return</span> <span class="n">conn</span>
</span><span data-line="1260">        <span class="k">finally</span><span class="p">:</span>
</span><span data-line="1261">            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span>
</span><span data-line="1262">
</span><span data-line="1263">    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1264">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">twophase</span><span class="p">:</span>
</span><span data-line="1265">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1266">                <span class="s2">&quot;&#39;twophase&#39; mode not enabled, or not root transaction; &quot;</span>
</span><span data-line="1267">                <span class="s2">&quot;can&#39;t prepare.&quot;</span>
</span><span data-line="1268">            <span class="p">)</span>
</span><span data-line="1269">        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_impl</span><span class="p">()</span>
</span><span data-line="1270">
</span><span data-line="1271">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span data-line="1272">        <span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,),</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span>
</span><span data-line="1273">    <span class="p">)</span>
</span><span data-line="1274">    <span class="k">def</span> <span class="nf">_prepare_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1275">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span data-line="1276">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_commit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
</span><span data-line="1277">
</span><span data-line="1278">        <span class="n">stx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_transaction</span>
</span><span data-line="1279">        <span class="k">assert</span> <span class="n">stx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1280">        <span class="k">if</span> <span class="n">stx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
</span><span data-line="1281">            <span class="k">for</span> <span class="n">subtransaction</span> <span class="ow">in</span> <span class="n">stx</span><span class="o">.</span><span class="n">_iterate_self_and_parents</span><span class="p">(</span><span class="n">upto</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1282">                <span class="n">subtransaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="1283">
</span><span data-line="1284">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_flushing</span><span class="p">:</span>
</span><span data-line="1285">            <span class="k">for</span> <span class="n">_flush_guard</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
</span><span data-line="1286">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_is_clean</span><span class="p">():</span>
</span><span data-line="1287">                    <span class="k">break</span>
</span><span data-line="1288">                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span data-line="1289">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1290">                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">FlushError</span><span class="p">(</span>
</span><span data-line="1291">                    <span class="s2">&quot;Over 100 subsequent flushes have occurred within &quot;</span>
</span><span data-line="1292">                    <span class="s2">&quot;session.commit() - is an after_flush() hook &quot;</span>
</span><span data-line="1293">                    <span class="s2">&quot;creating new objects?&quot;</span>
</span><span data-line="1294">                <span class="p">)</span>
</span><span data-line="1295">
</span><span data-line="1296">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">twophase</span><span class="p">:</span>
</span><span data-line="1297">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="1298">                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span data-line="1299">                    <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;TwoPhaseTransaction&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
</span><span data-line="1300">            <span class="k">except</span><span class="p">:</span>
</span><span data-line="1301">                <span class="k">with</span> <span class="n">util</span><span class="o">.</span><span class="n">safe_reraise</span><span class="p">():</span>
</span><span data-line="1302">                    <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span data-line="1303">
</span><span data-line="1304">        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span>
</span><span data-line="1305">
</span><span data-line="1306">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span data-line="1307">        <span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span><span class="p">),</span>
</span><span data-line="1308">        <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">,</span>
</span><span data-line="1309">    <span class="p">)</span>
</span><span data-line="1310">    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_to_root</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1311">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span><span class="p">:</span>
</span><span data-line="1312">            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect_state</span><span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span><span class="p">):</span>
</span><span data-line="1313">                <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_impl</span><span class="p">()</span>
</span><span data-line="1314">
</span><span data-line="1315">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span data-line="1316">            <span class="k">for</span> <span class="n">conn</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">should_commit</span><span class="p">,</span> <span class="n">autoclose</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span>
</span><span data-line="1317">                <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span data-line="1318">            <span class="p">):</span>
</span><span data-line="1319">                <span class="k">if</span> <span class="n">should_commit</span><span class="p">:</span>
</span><span data-line="1320">                    <span class="n">trans</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="1321">
</span><span data-line="1322">            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">COMMITTED</span>
</span><span data-line="1323">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_commit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
</span><span data-line="1324">
</span><span data-line="1325">            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_snapshot</span><span class="p">()</span>
</span><span data-line="1326">
</span><span data-line="1327">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect_state</span><span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">):</span>
</span><span data-line="1328">            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1329">
</span><span data-line="1330">        <span class="k">if</span> <span class="n">_to_root</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">:</span>
</span><span data-line="1331">            <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">_to_root</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1332">
</span><span data-line="1333">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span data-line="1334">        <span class="p">(</span>
</span><span data-line="1335">            <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
</span><span data-line="1336">            <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">DEACTIVE</span><span class="p">,</span>
</span><span data-line="1337">            <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span><span class="p">,</span>
</span><span data-line="1338">        <span class="p">),</span>
</span><span data-line="1339">        <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">,</span>
</span><span data-line="1340">    <span class="p">)</span>
</span><span data-line="1341">    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span>
</span><span data-line="1342">        <span class="bp">self</span><span class="p">,</span> <span class="n">_capture_exception</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">_to_root</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1343">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1344">        <span class="n">stx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_transaction</span>
</span><span data-line="1345">        <span class="k">assert</span> <span class="n">stx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1346">        <span class="k">if</span> <span class="n">stx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
</span><span data-line="1347">            <span class="k">for</span> <span class="n">subtransaction</span> <span class="ow">in</span> <span class="n">stx</span><span class="o">.</span><span class="n">_iterate_self_and_parents</span><span class="p">(</span><span class="n">upto</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1348">                <span class="n">subtransaction</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1349">
</span><span data-line="1350">        <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span>
</span><span data-line="1351">        <span class="n">rollback_err</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1352">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">in</span> <span class="p">(</span>
</span><span data-line="1353">            <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
</span><span data-line="1354">            <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span><span class="p">,</span>
</span><span data-line="1355">        <span class="p">):</span>
</span><span data-line="1356">            <span class="k">for</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterate_self_and_parents</span><span class="p">():</span>
</span><span data-line="1357">                <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">transaction</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span data-line="1358">                    <span class="k">try</span><span class="p">:</span>
</span><span data-line="1359">                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span data-line="1360">                            <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span data-line="1361">
</span><span data-line="1362">                        <span class="n">transaction</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">DEACTIVE</span>
</span><span data-line="1363">                        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_rollback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
</span><span data-line="1364">                    <span class="k">except</span><span class="p">:</span>
</span><span data-line="1365">                        <span class="n">rollback_err</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
</span><span data-line="1366">                    <span class="k">finally</span><span class="p">:</span>
</span><span data-line="1367">                        <span class="n">transaction</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">DEACTIVE</span>
</span><span data-line="1368">                        <span class="n">transaction</span><span class="o">.</span><span class="n">_restore_snapshot</span><span class="p">(</span>
</span><span data-line="1369">                            <span class="n">dirty_only</span><span class="o">=</span><span class="n">transaction</span><span class="o">.</span><span class="n">nested</span>
</span><span data-line="1370">                        <span class="p">)</span>
</span><span data-line="1371">                    <span class="n">boundary</span> <span class="o">=</span> <span class="n">transaction</span>
</span><span data-line="1372">                    <span class="k">break</span>
</span><span data-line="1373">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1374">                    <span class="n">transaction</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">DEACTIVE</span>
</span><span data-line="1375">
</span><span data-line="1376">        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span data-line="1377">
</span><span data-line="1378">        <span class="k">if</span> <span class="ow">not</span> <span class="n">rollback_err</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sess</span><span class="o">.</span><span class="n">_is_clean</span><span class="p">():</span>
</span><span data-line="1379">            <span class="c1"># if items were added, deleted, or mutated</span>
</span><span data-line="1380">            <span class="c1"># here, we need to re-restore the snapshot</span>
</span><span data-line="1381">            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="1382">                <span class="s2">&quot;Session&#39;s state has been changed on &quot;</span>
</span><span data-line="1383">                <span class="s2">&quot;a non-active transaction - this state &quot;</span>
</span><span data-line="1384">                <span class="s2">&quot;will be discarded.&quot;</span>
</span><span data-line="1385">            <span class="p">)</span>
</span><span data-line="1386">            <span class="n">boundary</span><span class="o">.</span><span class="n">_restore_snapshot</span><span class="p">(</span><span class="n">dirty_only</span><span class="o">=</span><span class="n">boundary</span><span class="o">.</span><span class="n">nested</span><span class="p">)</span>
</span><span data-line="1387">
</span><span data-line="1388">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect_state</span><span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">):</span>
</span><span data-line="1389">            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1390">
</span><span data-line="1391">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">and</span> <span class="n">_capture_exception</span><span class="p">:</span>
</span><span data-line="1392">            <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_rollback_exception</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="1393">
</span><span data-line="1394">        <span class="k">if</span> <span class="n">rollback_err</span> <span class="ow">and</span> <span class="n">rollback_err</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span data-line="1395">            <span class="k">raise</span> <span class="n">rollback_err</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">rollback_err</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span data-line="1396">
</span><span data-line="1397">        <span class="n">sess</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_soft_rollback</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span data-line="1398">
</span><span data-line="1399">        <span class="k">if</span> <span class="n">_to_root</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">:</span>
</span><span data-line="1400">            <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">_to_root</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1401">
</span><span data-line="1402">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span data-line="1403">        <span class="n">_StateChangeStates</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span>
</span><span data-line="1404">    <span class="p">)</span>
</span><span data-line="1405">    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invalidate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1406">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span data-line="1407">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1408">                <span class="bp">self</span><span class="o">.</span><span class="n">_previous_nested_transaction</span>
</span><span data-line="1409">            <span class="p">)</span>
</span><span data-line="1410">
</span><span data-line="1411">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
</span><span data-line="1412">
</span><span data-line="1413">        <span class="k">for</span> <span class="n">connection</span><span class="p">,</span> <span class="n">transaction</span><span class="p">,</span> <span class="n">should_commit</span><span class="p">,</span> <span class="n">autoclose</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span>
</span><span data-line="1414">            <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span data-line="1415">        <span class="p">):</span>
</span><span data-line="1416">            <span class="k">if</span> <span class="n">invalidate</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1417">                <span class="n">connection</span><span class="o">.</span><span class="n">invalidate</span><span class="p">()</span>
</span><span data-line="1418">            <span class="k">if</span> <span class="n">should_commit</span> <span class="ow">and</span> <span class="n">transaction</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
</span><span data-line="1419">                <span class="n">transaction</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1420">            <span class="k">if</span> <span class="n">autoclose</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1421">                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1422">
</span><span data-line="1423">        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span>
</span><span data-line="1424">        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span data-line="1425">
</span><span data-line="1426">        <span class="c1"># TODO: these two None sets were historically after the</span>
</span><span data-line="1427">        <span class="c1"># event hook below, and in 2.0 I changed it this way for some reason,</span>
</span><span data-line="1428">        <span class="c1"># and I remember there being a reason, but not what it was.</span>
</span><span data-line="1429">        <span class="c1"># Why do we need to get rid of them at all?  test_memusage::CycleTest</span>
</span><span data-line="1430">        <span class="c1"># passes with these commented out.</span>
</span><span data-line="1431">        <span class="c1"># self.session = None  # type: ignore</span>
</span><span data-line="1432">        <span class="c1"># self._connections = None  # type: ignore</span>
</span><span data-line="1433">
</span><span data-line="1434">        <span class="n">sess</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_transaction_end</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span data-line="1435">
</span><span data-line="1436">    <span class="k">def</span> <span class="nf">_get_subject</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Session</span><span class="p">:</span>
</span><span data-line="1437">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span data-line="1438">
</span><span data-line="1439">    <span class="k">def</span> <span class="nf">_transaction_is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1440">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">is</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span>
</span><span data-line="1441">
</span><span data-line="1442">    <span class="k">def</span> <span class="nf">_transaction_is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1443">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">is</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span>
</span><span data-line="1444">
</span><span data-line="1445">    <span class="k">def</span> <span class="nf">_rollback_can_be_called</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1446">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">COMMITTED</span><span class="p">,</span> <span class="n">CLOSED</span><span class="p">)</span>
</span><span data-line="1447">
</span><span data-line="1448">
</span><span data-line="1449"><span class="k">class</span> <span class="nc">_SessionCloseState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span data-line="1450">    <span class="n">ACTIVE</span> <span class="o">=</span> <span class="mi">1</span>
</span><span data-line="1451">    <span class="n">CLOSED</span> <span class="o">=</span> <span class="mi">2</span>
</span><span data-line="1452">    <span class="n">CLOSE_IS_RESET</span> <span class="o">=</span> <span class="mi">3</span>
</span><span data-line="1453">
</span><span data-line="1454">
</span><span data-line="1455"><span class="k">class</span> <span class="nc">Session</span><span class="p">(</span><span class="n">_SessionClassMethods</span><span class="p">,</span> <span class="n">EventTarget</span><span class="p">):</span>
</span><span data-line="1456"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages persistence operations for ORM-mapped objects.</span>
</span><span data-line="1457">
</span><span data-line="1458"><span class="sd">    The :class:`_orm.Session` is **not safe for use in concurrent threads.**.</span>
</span><span data-line="1459"><span class="sd">    See :ref:`session_faq_threadsafe` for background.</span>
</span><span data-line="1460">
</span><span data-line="1461"><span class="sd">    The Session&#39;s usage paradigm is described at :doc:`/orm/session`.</span>
</span><span data-line="1462">
</span><span data-line="1463">
</span><span data-line="1464"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1465">
</span><span data-line="1466">    <span class="n">_is_asyncio</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1467">
</span><span data-line="1468">    <span class="n">dispatch</span><span class="p">:</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span>
</span><span data-line="1469">
</span><span data-line="1470">    <span class="n">identity_map</span><span class="p">:</span> <span class="n">IdentityMap</span>
</span><span data-line="1471"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A mapping of object identities to objects themselves.</span>
</span><span data-line="1472">
</span><span data-line="1473"><span class="sd">    Iterating through ``Session.identity_map.values()`` provides</span>
</span><span data-line="1474"><span class="sd">    access to the full set of persistent objects (i.e., those</span>
</span><span data-line="1475"><span class="sd">    that have row identity) currently in the session.</span>
</span><span data-line="1476">
</span><span data-line="1477"><span class="sd">    .. seealso::</span>
</span><span data-line="1478">
</span><span data-line="1479"><span class="sd">        :func:`.identity_key` - helper function to produce the keys used</span>
</span><span data-line="1480"><span class="sd">        in this dictionary.</span>
</span><span data-line="1481">
</span><span data-line="1482"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1483">
</span><span data-line="1484">    <span class="n">_new</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="1485">    <span class="n">_deleted</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="1486">    <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Engine</span><span class="p">,</span> <span class="n">Connection</span><span class="p">]]</span>
</span><span data-line="1487">    <span class="n">__binds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">_SessionBindKey</span><span class="p">,</span> <span class="n">_SessionBind</span><span class="p">]</span>
</span><span data-line="1488">    <span class="n">_flushing</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="1489">    <span class="n">_warn_on_events</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="1490">    <span class="n">_transaction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]</span>
</span><span data-line="1491">    <span class="n">_nested_transaction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]</span>
</span><span data-line="1492">    <span class="n">hash_key</span><span class="p">:</span> <span class="nb">int</span>
</span><span data-line="1493">    <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="1494">    <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="1495">    <span class="n">enable_baked_queries</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="1496">    <span class="n">twophase</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="1497">    <span class="n">join_transaction_mode</span><span class="p">:</span> <span class="n">JoinTransactionMode</span>
</span><span data-line="1498">    <span class="n">_query_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Query</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="1499">    <span class="n">_close_state</span><span class="p">:</span> <span class="n">_SessionCloseState</span>
</span><span data-line="1500">
</span><span data-line="1501">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="1502">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1503">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_SessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1504">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="1505">        <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1506">        <span class="n">future</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1507">        <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1508">        <span class="n">autobegin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1509">        <span class="n">twophase</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1510">        <span class="n">binds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">_SessionBindKey</span><span class="p">,</span> <span class="n">_SessionBind</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1511">        <span class="n">enable_baked_queries</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="1512">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1513">        <span class="n">query_cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Query</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1514">        <span class="n">autocommit</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="1515">        <span class="n">join_transaction_mode</span><span class="p">:</span> <span class="n">JoinTransactionMode</span> <span class="o">=</span> <span class="s2">&quot;conditional_savepoint&quot;</span><span class="p">,</span>
</span><span data-line="1516">        <span class="n">close_resets_only</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">_NoArg</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="1517">    <span class="p">):</span>
</span><span data-line="1518"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct a new :class:`_orm.Session`.</span>
</span><span data-line="1519">
</span><span data-line="1520"><span class="sd">        See also the :class:`.sessionmaker` function which is used to</span>
</span><span data-line="1521"><span class="sd">        generate a :class:`.Session`-producing callable with a given</span>
</span><span data-line="1522"><span class="sd">        set of arguments.</span>
</span><span data-line="1523">
</span><span data-line="1524"><span class="sd">        :param autoflush: When ``True``, all query operations will issue a</span>
</span><span data-line="1525"><span class="sd">           :meth:`~.Session.flush` call to this ``Session`` before proceeding.</span>
</span><span data-line="1526"><span class="sd">           This is a convenience feature so that :meth:`~.Session.flush` need</span>
</span><span data-line="1527"><span class="sd">           not be called repeatedly in order for database queries to retrieve</span>
</span><span data-line="1528"><span class="sd">           results.</span>
</span><span data-line="1529">
</span><span data-line="1530"><span class="sd">           .. seealso::</span>
</span><span data-line="1531">
</span><span data-line="1532"><span class="sd">               :ref:`session_flushing` - additional background on autoflush</span>
</span><span data-line="1533">
</span><span data-line="1534"><span class="sd">        :param autobegin: Automatically start transactions (i.e. equivalent to</span>
</span><span data-line="1535"><span class="sd">           invoking :meth:`_orm.Session.begin`) when database access is</span>
</span><span data-line="1536"><span class="sd">           requested by an operation.   Defaults to ``True``.    Set to</span>
</span><span data-line="1537"><span class="sd">           ``False`` to prevent a :class:`_orm.Session` from implicitly</span>
</span><span data-line="1538"><span class="sd">           beginning transactions after construction, as well as after any of</span>
</span><span data-line="1539"><span class="sd">           the :meth:`_orm.Session.rollback`, :meth:`_orm.Session.commit`,</span>
</span><span data-line="1540"><span class="sd">           or :meth:`_orm.Session.close` methods are called.</span>
</span><span data-line="1541">
</span><span data-line="1542"><span class="sd">           .. versionadded:: 2.0</span>
</span><span data-line="1543">
</span><span data-line="1544"><span class="sd">           .. seealso::</span>
</span><span data-line="1545">
</span><span data-line="1546"><span class="sd">                :ref:`session_autobegin_disable`</span>
</span><span data-line="1547">
</span><span data-line="1548"><span class="sd">        :param bind: An optional :class:`_engine.Engine` or</span>
</span><span data-line="1549"><span class="sd">           :class:`_engine.Connection` to</span>
</span><span data-line="1550"><span class="sd">           which this ``Session`` should be bound. When specified, all SQL</span>
</span><span data-line="1551"><span class="sd">           operations performed by this session will execute via this</span>
</span><span data-line="1552"><span class="sd">           connectable.</span>
</span><span data-line="1553">
</span><span data-line="1554"><span class="sd">        :param binds: A dictionary which may specify any number of</span>
</span><span data-line="1555"><span class="sd">           :class:`_engine.Engine` or :class:`_engine.Connection`</span>
</span><span data-line="1556"><span class="sd">           objects as the source of</span>
</span><span data-line="1557"><span class="sd">           connectivity for SQL operations on a per-entity basis.   The keys</span>
</span><span data-line="1558"><span class="sd">           of the dictionary consist of any series of mapped classes,</span>
</span><span data-line="1559"><span class="sd">           arbitrary Python classes that are bases for mapped classes,</span>
</span><span data-line="1560"><span class="sd">           :class:`_schema.Table` objects and :class:`_orm.Mapper` objects.</span>
</span><span data-line="1561"><span class="sd">           The</span>
</span><span data-line="1562"><span class="sd">           values of the dictionary are then instances of</span>
</span><span data-line="1563"><span class="sd">           :class:`_engine.Engine`</span>
</span><span data-line="1564"><span class="sd">           or less commonly :class:`_engine.Connection` objects.</span>
</span><span data-line="1565"><span class="sd">           Operations which</span>
</span><span data-line="1566"><span class="sd">           proceed relative to a particular mapped class will consult this</span>
</span><span data-line="1567"><span class="sd">           dictionary for the closest matching entity in order to determine</span>
</span><span data-line="1568"><span class="sd">           which :class:`_engine.Engine` should be used for a particular SQL</span>
</span><span data-line="1569"><span class="sd">           operation.    The complete heuristics for resolution are</span>
</span><span data-line="1570"><span class="sd">           described at :meth:`.Session.get_bind`.  Usage looks like::</span>
</span><span data-line="1571">
</span><span data-line="1572"><span class="sd">            Session = sessionmaker(binds={</span>
</span><span data-line="1573"><span class="sd">                SomeMappedClass: create_engine(&#39;postgresql+psycopg2://engine1&#39;),</span>
</span><span data-line="1574"><span class="sd">                SomeDeclarativeBase: create_engine(&#39;postgresql+psycopg2://engine2&#39;),</span>
</span><span data-line="1575"><span class="sd">                some_mapper: create_engine(&#39;postgresql+psycopg2://engine3&#39;),</span>
</span><span data-line="1576"><span class="sd">                some_table: create_engine(&#39;postgresql+psycopg2://engine4&#39;),</span>
</span><span data-line="1577"><span class="sd">                })</span>
</span><span data-line="1578">
</span><span data-line="1579"><span class="sd">           .. seealso::</span>
</span><span data-line="1580">
</span><span data-line="1581"><span class="sd">                :ref:`session_partitioning`</span>
</span><span data-line="1582">
</span><span data-line="1583"><span class="sd">                :meth:`.Session.bind_mapper`</span>
</span><span data-line="1584">
</span><span data-line="1585"><span class="sd">                :meth:`.Session.bind_table`</span>
</span><span data-line="1586">
</span><span data-line="1587"><span class="sd">                :meth:`.Session.get_bind`</span>
</span><span data-line="1588">
</span><span data-line="1589">
</span><span data-line="1590"><span class="sd">        :param \class_: Specify an alternate class other than</span>
</span><span data-line="1591"><span class="sd">           ``sqlalchemy.orm.session.Session`` which should be used by the</span>
</span><span data-line="1592"><span class="sd">           returned class. This is the only argument that is local to the</span>
</span><span data-line="1593"><span class="sd">           :class:`.sessionmaker` function, and is not sent directly to the</span>
</span><span data-line="1594"><span class="sd">           constructor for ``Session``.</span>
</span><span data-line="1595">
</span><span data-line="1596"><span class="sd">        :param enable_baked_queries: legacy; defaults to ``True``.</span>
</span><span data-line="1597"><span class="sd">           A parameter consumed</span>
</span><span data-line="1598"><span class="sd">           by the :mod:`sqlalchemy.ext.baked` extension to determine if</span>
</span><span data-line="1599"><span class="sd">           &quot;baked queries&quot; should be cached, as is the normal operation</span>
</span><span data-line="1600"><span class="sd">           of this extension.  When set to ``False``, caching as used by</span>
</span><span data-line="1601"><span class="sd">           this particular extension is disabled.</span>
</span><span data-line="1602">
</span><span data-line="1603"><span class="sd">           .. versionchanged:: 1.4 The ``sqlalchemy.ext.baked`` extension is</span>
</span><span data-line="1604"><span class="sd">              legacy and is not used by any of SQLAlchemy&#39;s internals. This</span>
</span><span data-line="1605"><span class="sd">              flag therefore only affects applications that are making explicit</span>
</span><span data-line="1606"><span class="sd">              use of this extension within their own code.</span>
</span><span data-line="1607">
</span><span data-line="1608"><span class="sd">        :param expire_on_commit:  Defaults to ``True``. When ``True``, all</span>
</span><span data-line="1609"><span class="sd">           instances will be fully expired after each :meth:`~.commit`,</span>
</span><span data-line="1610"><span class="sd">           so that all attribute/object access subsequent to a completed</span>
</span><span data-line="1611"><span class="sd">           transaction will load from the most recent database state.</span>
</span><span data-line="1612">
</span><span data-line="1613"><span class="sd">            .. seealso::</span>
</span><span data-line="1614">
</span><span data-line="1615"><span class="sd">                :ref:`session_committing`</span>
</span><span data-line="1616">
</span><span data-line="1617"><span class="sd">        :param future: Deprecated; this flag is always True.</span>
</span><span data-line="1618">
</span><span data-line="1619"><span class="sd">          .. seealso::</span>
</span><span data-line="1620">
</span><span data-line="1621"><span class="sd">            :ref:`migration_20_toplevel`</span>
</span><span data-line="1622">
</span><span data-line="1623"><span class="sd">        :param info: optional dictionary of arbitrary data to be associated</span>
</span><span data-line="1624"><span class="sd">           with this :class:`.Session`.  Is available via the</span>
</span><span data-line="1625"><span class="sd">           :attr:`.Session.info` attribute.  Note the dictionary is copied at</span>
</span><span data-line="1626"><span class="sd">           construction time so that modifications to the per-</span>
</span><span data-line="1627"><span class="sd">           :class:`.Session` dictionary will be local to that</span>
</span><span data-line="1628"><span class="sd">           :class:`.Session`.</span>
</span><span data-line="1629">
</span><span data-line="1630"><span class="sd">        :param query_cls:  Class which should be used to create new Query</span>
</span><span data-line="1631"><span class="sd">          objects, as returned by the :meth:`~.Session.query` method.</span>
</span><span data-line="1632"><span class="sd">          Defaults to :class:`_query.Query`.</span>
</span><span data-line="1633">
</span><span data-line="1634"><span class="sd">        :param twophase:  When ``True``, all transactions will be started as</span>
</span><span data-line="1635"><span class="sd">            a &quot;two phase&quot; transaction, i.e. using the &quot;two phase&quot; semantics</span>
</span><span data-line="1636"><span class="sd">            of the database in use along with an XID.  During a</span>
</span><span data-line="1637"><span class="sd">            :meth:`~.commit`, after :meth:`~.flush` has been issued for all</span>
</span><span data-line="1638"><span class="sd">            attached databases, the :meth:`~.TwoPhaseTransaction.prepare`</span>
</span><span data-line="1639"><span class="sd">            method on each database&#39;s :class:`.TwoPhaseTransaction` will be</span>
</span><span data-line="1640"><span class="sd">            called. This allows each database to roll back the entire</span>
</span><span data-line="1641"><span class="sd">            transaction, before each transaction is committed.</span>
</span><span data-line="1642">
</span><span data-line="1643"><span class="sd">        :param autocommit: the &quot;autocommit&quot; keyword is present for backwards</span>
</span><span data-line="1644"><span class="sd">            compatibility but must remain at its default value of ``False``.</span>
</span><span data-line="1645">
</span><span data-line="1646"><span class="sd">        :param join_transaction_mode: Describes the transactional behavior to</span>
</span><span data-line="1647"><span class="sd">          take when a given bind is a :class:`_engine.Connection` that</span>
</span><span data-line="1648"><span class="sd">          has already begun a transaction outside the scope of this</span>
</span><span data-line="1649"><span class="sd">          :class:`_orm.Session`; in other words the</span>
</span><span data-line="1650"><span class="sd">          :meth:`_engine.Connection.in_transaction()` method returns True.</span>
</span><span data-line="1651">
</span><span data-line="1652"><span class="sd">          The following behaviors only take effect when the :class:`_orm.Session`</span>
</span><span data-line="1653"><span class="sd">          **actually makes use of the connection given**; that is, a method</span>
</span><span data-line="1654"><span class="sd">          such as :meth:`_orm.Session.execute`, :meth:`_orm.Session.connection`,</span>
</span><span data-line="1655"><span class="sd">          etc. are actually invoked:</span>
</span><span data-line="1656">
</span><span data-line="1657"><span class="sd">          * ``&quot;conditional_savepoint&quot;`` - this is the default.  if the given</span>
</span><span data-line="1658"><span class="sd">            :class:`_engine.Connection` is begun within a transaction but</span>
</span><span data-line="1659"><span class="sd">            does not have a SAVEPOINT, then ``&quot;rollback_only&quot;`` is used.</span>
</span><span data-line="1660"><span class="sd">            If the :class:`_engine.Connection` is additionally within</span>
</span><span data-line="1661"><span class="sd">            a SAVEPOINT, in other words</span>
</span><span data-line="1662"><span class="sd">            :meth:`_engine.Connection.in_nested_transaction()` method returns</span>
</span><span data-line="1663"><span class="sd">            True, then ``&quot;create_savepoint&quot;`` is used.</span>
</span><span data-line="1664">
</span><span data-line="1665"><span class="sd">            ``&quot;conditional_savepoint&quot;`` behavior attempts to make use of</span>
</span><span data-line="1666"><span class="sd">            savepoints in order to keep the state of the existing transaction</span>
</span><span data-line="1667"><span class="sd">            unchanged, but only if there is already a savepoint in progress;</span>
</span><span data-line="1668"><span class="sd">            otherwise, it is not assumed that the backend in use has adequate</span>
</span><span data-line="1669"><span class="sd">            support for SAVEPOINT, as availability of this feature varies.</span>
</span><span data-line="1670"><span class="sd">            ``&quot;conditional_savepoint&quot;`` also seeks to establish approximate</span>
</span><span data-line="1671"><span class="sd">            backwards compatibility with previous :class:`_orm.Session`</span>
</span><span data-line="1672"><span class="sd">            behavior, for applications that are not setting a specific mode. It</span>
</span><span data-line="1673"><span class="sd">            is recommended that one of the explicit settings be used.</span>
</span><span data-line="1674">
</span><span data-line="1675"><span class="sd">          * ``&quot;create_savepoint&quot;`` - the :class:`_orm.Session` will use</span>
</span><span data-line="1676"><span class="sd">            :meth:`_engine.Connection.begin_nested()` in all cases to create</span>
</span><span data-line="1677"><span class="sd">            its own transaction.  This transaction by its nature rides</span>
</span><span data-line="1678"><span class="sd">            &quot;on top&quot; of any existing transaction that&#39;s opened on the given</span>
</span><span data-line="1679"><span class="sd">            :class:`_engine.Connection`; if the underlying database and</span>
</span><span data-line="1680"><span class="sd">            the driver in use has full, non-broken support for SAVEPOINT, the</span>
</span><span data-line="1681"><span class="sd">            external transaction will remain unaffected throughout the</span>
</span><span data-line="1682"><span class="sd">            lifespan of the :class:`_orm.Session`.</span>
</span><span data-line="1683">
</span><span data-line="1684"><span class="sd">            The ``&quot;create_savepoint&quot;`` mode is the most useful for integrating</span>
</span><span data-line="1685"><span class="sd">            a :class:`_orm.Session` into a test suite where an externally</span>
</span><span data-line="1686"><span class="sd">            initiated transaction should remain unaffected; however, it relies</span>
</span><span data-line="1687"><span class="sd">            on proper SAVEPOINT support from the underlying driver and</span>
</span><span data-line="1688"><span class="sd">            database.</span>
</span><span data-line="1689">
</span><span data-line="1690"><span class="sd">            .. tip:: When using SQLite, the SQLite driver included through</span>
</span><span data-line="1691"><span class="sd">               Python 3.11 does not handle SAVEPOINTs correctly in all cases</span>
</span><span data-line="1692"><span class="sd">               without workarounds. See the sections</span>
</span><span data-line="1693"><span class="sd">               :ref:`pysqlite_serializable` and :ref:`aiosqlite_serializable`</span>
</span><span data-line="1694"><span class="sd">               for details on current workarounds.</span>
</span><span data-line="1695">
</span><span data-line="1696"><span class="sd">          * ``&quot;control_fully&quot;`` - the :class:`_orm.Session` will take</span>
</span><span data-line="1697"><span class="sd">            control of the given transaction as its own;</span>
</span><span data-line="1698"><span class="sd">            :meth:`_orm.Session.commit` will call ``.commit()`` on the</span>
</span><span data-line="1699"><span class="sd">            transaction, :meth:`_orm.Session.rollback` will call</span>
</span><span data-line="1700"><span class="sd">            ``.rollback()`` on the transaction, :meth:`_orm.Session.close` will</span>
</span><span data-line="1701"><span class="sd">            call ``.rollback`` on the transaction.</span>
</span><span data-line="1702">
</span><span data-line="1703"><span class="sd">            .. tip:: This mode of use is equivalent to how SQLAlchemy 1.4 would</span>
</span><span data-line="1704"><span class="sd">               handle a :class:`_engine.Connection` given with an existing</span>
</span><span data-line="1705"><span class="sd">               SAVEPOINT (i.e. :meth:`_engine.Connection.begin_nested`); the</span>
</span><span data-line="1706"><span class="sd">               :class:`_orm.Session` would take full control of the existing</span>
</span><span data-line="1707"><span class="sd">               SAVEPOINT.</span>
</span><span data-line="1708">
</span><span data-line="1709"><span class="sd">          * ``&quot;rollback_only&quot;`` - the :class:`_orm.Session` will take control</span>
</span><span data-line="1710"><span class="sd">            of the given transaction for ``.rollback()`` calls only;</span>
</span><span data-line="1711"><span class="sd">            ``.commit()`` calls will not be propagated to the given</span>
</span><span data-line="1712"><span class="sd">            transaction.  ``.close()`` calls will have no effect on the</span>
</span><span data-line="1713"><span class="sd">            given transaction.</span>
</span><span data-line="1714">
</span><span data-line="1715"><span class="sd">            .. tip:: This mode of use is equivalent to how SQLAlchemy 1.4 would</span>
</span><span data-line="1716"><span class="sd">               handle a :class:`_engine.Connection` given with an existing</span>
</span><span data-line="1717"><span class="sd">               regular database transaction (i.e.</span>
</span><span data-line="1718"><span class="sd">               :meth:`_engine.Connection.begin`); the :class:`_orm.Session`</span>
</span><span data-line="1719"><span class="sd">               would propagate :meth:`_orm.Session.rollback` calls to the</span>
</span><span data-line="1720"><span class="sd">               underlying transaction, but not :meth:`_orm.Session.commit` or</span>
</span><span data-line="1721"><span class="sd">               :meth:`_orm.Session.close` calls.</span>
</span><span data-line="1722">
</span><span data-line="1723"><span class="sd">          .. versionadded:: 2.0.0rc1</span>
</span><span data-line="1724">
</span><span data-line="1725"><span class="sd">        :param close_resets_only: Defaults to ``True``. Determines if</span>
</span><span data-line="1726"><span class="sd">          the session should reset itself after calling ``.close()``</span>
</span><span data-line="1727"><span class="sd">          or should pass in a no longer usable state, disabling re-use.</span>
</span><span data-line="1728">
</span><span data-line="1729"><span class="sd">          .. versionadded:: 2.0.22 added flag ``close_resets_only``.</span>
</span><span data-line="1730"><span class="sd">            A future SQLAlchemy version may change the default value of</span>
</span><span data-line="1731"><span class="sd">            this flag to ``False``.</span>
</span><span data-line="1732">
</span><span data-line="1733"><span class="sd">          .. seealso::</span>
</span><span data-line="1734">
</span><span data-line="1735"><span class="sd">            :ref:`session_closing` - Detail on the semantics of</span>
</span><span data-line="1736"><span class="sd">            :meth:`_orm.Session.close` and :meth:`_orm.Session.reset`.</span>
</span><span data-line="1737">
</span><span data-line="1738"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
</span><span data-line="1739">
</span><span data-line="1740">        <span class="c1"># considering allowing the &quot;autocommit&quot; keyword to still be accepted</span>
</span><span data-line="1741">        <span class="c1"># as long as it&#39;s False, so that external test suites, oslo.db etc</span>
</span><span data-line="1742">        <span class="c1"># continue to function as the argument appears to be passed in lots</span>
</span><span data-line="1743">        <span class="c1"># of cases including in our own test suite</span>
</span><span data-line="1744">        <span class="k">if</span> <span class="n">autocommit</span><span class="p">:</span>
</span><span data-line="1745">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1746">                <span class="s2">&quot;autocommit=True is no longer supported&quot;</span>
</span><span data-line="1747">            <span class="p">)</span>
</span><span data-line="1748">        <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">WeakInstanceDict</span><span class="p">()</span>
</span><span data-line="1749">
</span><span data-line="1750">        <span class="k">if</span> <span class="ow">not</span> <span class="n">future</span><span class="p">:</span>
</span><span data-line="1751">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1752">                <span class="s2">&quot;The &#39;future&#39; parameter passed to &quot;</span>
</span><span data-line="1753">                <span class="s2">&quot;Session() may only be set to True.&quot;</span>
</span><span data-line="1754">            <span class="p">)</span>
</span><span data-line="1755">
</span><span data-line="1756">        <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># InstanceState-&gt;object, strong refs object</span>
</span><span data-line="1757">        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># same</span>
</span><span data-line="1758">        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">bind</span>
</span><span data-line="1759">        <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1760">        <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1761">        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1762">        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1763">        <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1764">        <span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span> <span class="o">=</span> <span class="n">_new_sessionid</span><span class="p">()</span>
</span><span data-line="1765">        <span class="bp">self</span><span class="o">.</span><span class="n">autobegin</span> <span class="o">=</span> <span class="n">autobegin</span>
</span><span data-line="1766">        <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span> <span class="o">=</span> <span class="n">autoflush</span>
</span><span data-line="1767">        <span class="bp">self</span><span class="o">.</span><span class="n">expire_on_commit</span> <span class="o">=</span> <span class="n">expire_on_commit</span>
</span><span data-line="1768">        <span class="bp">self</span><span class="o">.</span><span class="n">enable_baked_queries</span> <span class="o">=</span> <span class="n">enable_baked_queries</span>
</span><span data-line="1769">
</span><span data-line="1770">        <span class="c1"># the idea is that at some point NO_ARG will warn that in the future</span>
</span><span data-line="1771">        <span class="c1"># the default will switch to close_resets_only=False.</span>
</span><span data-line="1772">        <span class="k">if</span> <span class="n">close_resets_only</span> <span class="ow">or</span> <span class="n">close_resets_only</span> <span class="ow">is</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">:</span>
</span><span data-line="1773">            <span class="bp">self</span><span class="o">.</span><span class="n">_close_state</span> <span class="o">=</span> <span class="n">_SessionCloseState</span><span class="o">.</span><span class="n">CLOSE_IS_RESET</span>
</span><span data-line="1774">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1775">            <span class="bp">self</span><span class="o">.</span><span class="n">_close_state</span> <span class="o">=</span> <span class="n">_SessionCloseState</span><span class="o">.</span><span class="n">ACTIVE</span>
</span><span data-line="1776">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1777">            <span class="n">join_transaction_mode</span>
</span><span data-line="1778">            <span class="ow">and</span> <span class="n">join_transaction_mode</span>
</span><span data-line="1779">            <span class="ow">not</span> <span class="ow">in</span> <span class="n">JoinTransactionMode</span><span class="o">.</span><span class="n">__args__</span>  <span class="c1"># type: ignore</span>
</span><span data-line="1780">        <span class="p">):</span>
</span><span data-line="1781">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1782">                <span class="sa">f</span><span class="s2">&quot;invalid selection for join_transaction_mode: &quot;</span>
</span><span data-line="1783">                <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">join_transaction_mode</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span data-line="1784">            <span class="p">)</span>
</span><span data-line="1785">        <span class="bp">self</span><span class="o">.</span><span class="n">join_transaction_mode</span> <span class="o">=</span> <span class="n">join_transaction_mode</span>
</span><span data-line="1786">
</span><span data-line="1787">        <span class="bp">self</span><span class="o">.</span><span class="n">twophase</span> <span class="o">=</span> <span class="n">twophase</span>
</span><span data-line="1788">        <span class="bp">self</span><span class="o">.</span><span class="n">_query_cls</span> <span class="o">=</span> <span class="n">query_cls</span> <span class="k">if</span> <span class="n">query_cls</span> <span class="k">else</span> <span class="n">query</span><span class="o">.</span><span class="n">Query</span>
</span><span data-line="1789">        <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
</span><span data-line="1790">            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span data-line="1791">
</span><span data-line="1792">        <span class="k">if</span> <span class="n">binds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1793">            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">bind</span> <span class="ow">in</span> <span class="n">binds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="1794">                <span class="bp">self</span><span class="o">.</span><span class="n">_add_bind</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">bind</span><span class="p">)</span>
</span><span data-line="1795">
</span><span data-line="1796">        <span class="n">_sessions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
</span><span data-line="1797">
</span><span data-line="1798">    <span class="c1"># used by sqlalchemy.engine.util.TransactionalContext</span>
</span><span data-line="1799">    <span class="n">_trans_context_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransactionalContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1800">
</span><span data-line="1801">    <span class="n">connection_callable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ConnectionCallableProto</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1802">
</span><span data-line="1803">    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">_S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_S</span><span class="p">:</span>
</span><span data-line="1804">        <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="1805">
</span><span data-line="1806">    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">traceback</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1807">        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1808">
</span><span data-line="1809">    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span data-line="1810">    <span class="k">def</span> <span class="nf">_maker_context_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">_S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_S</span><span class="p">]:</span>
</span><span data-line="1811">        <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
</span><span data-line="1812">            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
</span><span data-line="1813">                <span class="k">yield</span> <span class="bp">self</span>
</span><span data-line="1814">
</span><span data-line="1815">    <span class="k">def</span> <span class="nf">in_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1816"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this :class:`_orm.Session` has begun a transaction.</span>
</span><span data-line="1817">
</span><span data-line="1818"><span class="sd">        .. versionadded:: 1.4</span>
</span><span data-line="1819">
</span><span data-line="1820"><span class="sd">        .. seealso::</span>
</span><span data-line="1821">
</span><span data-line="1822"><span class="sd">            :attr:`_orm.Session.is_active`</span>
</span><span data-line="1823">
</span><span data-line="1824">
</span><span data-line="1825"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1826">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1827">
</span><span data-line="1828">    <span class="k">def</span> <span class="nf">in_nested_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1829"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this :class:`_orm.Session` has begun a nested</span>
</span><span data-line="1830"><span class="sd">        transaction, e.g. SAVEPOINT.</span>
</span><span data-line="1831">
</span><span data-line="1832"><span class="sd">        .. versionadded:: 1.4</span>
</span><span data-line="1833">
</span><span data-line="1834"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1835">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1836">
</span><span data-line="1837">    <span class="k">def</span> <span class="nf">get_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]:</span>
</span><span data-line="1838"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current root transaction in progress, if any.</span>
</span><span data-line="1839">
</span><span data-line="1840"><span class="sd">        .. versionadded:: 1.4</span>
</span><span data-line="1841">
</span><span data-line="1842"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1843">        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span data-line="1844">        <span class="k">while</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">trans</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1845">            <span class="n">trans</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">_parent</span>
</span><span data-line="1846">        <span class="k">return</span> <span class="n">trans</span>
</span><span data-line="1847">
</span><span data-line="1848">    <span class="k">def</span> <span class="nf">get_nested_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]:</span>
</span><span data-line="1849"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current nested transaction in progress, if any.</span>
</span><span data-line="1850">
</span><span data-line="1851"><span class="sd">        .. versionadded:: 1.4</span>
</span><span data-line="1852">
</span><span data-line="1853"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1854">
</span><span data-line="1855">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span>
</span><span data-line="1856">
</span><span data-line="1857">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span data-line="1858">    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_InfoType</span><span class="p">:</span>
</span><span data-line="1859"><span class="w">        </span><span class="sd">&quot;&quot;&quot;A user-modifiable dictionary.</span>
</span><span data-line="1860">
</span><span data-line="1861"><span class="sd">        The initial value of this dictionary can be populated using the</span>
</span><span data-line="1862"><span class="sd">        ``info`` argument to the :class:`.Session` constructor or</span>
</span><span data-line="1863"><span class="sd">        :class:`.sessionmaker` constructor or factory methods.  The dictionary</span>
</span><span data-line="1864"><span class="sd">        here is always local to this :class:`.Session` and can be modified</span>
</span><span data-line="1865"><span class="sd">        independently of all other :class:`.Session` objects.</span>
</span><span data-line="1866">
</span><span data-line="1867"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1868">        <span class="k">return</span> <span class="p">{}</span>
</span><span data-line="1869">
</span><span data-line="1870">    <span class="k">def</span> <span class="nf">_autobegin_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SessionTransaction</span><span class="p">:</span>
</span><span data-line="1871">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1872">            <span class="k">if</span> <span class="ow">not</span> <span class="n">begin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">autobegin</span><span class="p">:</span>
</span><span data-line="1873">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1874">                    <span class="s2">&quot;Autobegin is disabled on this Session; please call &quot;</span>
</span><span data-line="1875">                    <span class="s2">&quot;session.begin() to start a new transaction&quot;</span>
</span><span data-line="1876">                <span class="p">)</span>
</span><span data-line="1877">            <span class="n">trans</span> <span class="o">=</span> <span class="n">SessionTransaction</span><span class="p">(</span>
</span><span data-line="1878">                <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1879">                <span class="p">(</span>
</span><span data-line="1880">                    <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">BEGIN</span>
</span><span data-line="1881">                    <span class="k">if</span> <span class="n">begin</span>
</span><span data-line="1882">                    <span class="k">else</span> <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">AUTOBEGIN</span>
</span><span data-line="1883">                <span class="p">),</span>
</span><span data-line="1884">            <span class="p">)</span>
</span><span data-line="1885">            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="n">trans</span>
</span><span data-line="1886">            <span class="k">return</span> <span class="n">trans</span>
</span><span data-line="1887">
</span><span data-line="1888">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span data-line="1889">
</span><span data-line="1890">    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nested</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SessionTransaction</span><span class="p">:</span>
</span><span data-line="1891"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Begin a transaction, or nested transaction,</span>
</span><span data-line="1892"><span class="sd">        on this :class:`.Session`, if one is not already begun.</span>
</span><span data-line="1893">
</span><span data-line="1894"><span class="sd">        The :class:`_orm.Session` object features **autobegin** behavior,</span>
</span><span data-line="1895"><span class="sd">        so that normally it is not necessary to call the</span>
</span><span data-line="1896"><span class="sd">        :meth:`_orm.Session.begin`</span>
</span><span data-line="1897"><span class="sd">        method explicitly. However, it may be used in order to control</span>
</span><span data-line="1898"><span class="sd">        the scope of when the transactional state is begun.</span>
</span><span data-line="1899">
</span><span data-line="1900"><span class="sd">        When used to begin the outermost transaction, an error is raised</span>
</span><span data-line="1901"><span class="sd">        if this :class:`.Session` is already inside of a transaction.</span>
</span><span data-line="1902">
</span><span data-line="1903"><span class="sd">        :param nested: if True, begins a SAVEPOINT transaction and is</span>
</span><span data-line="1904"><span class="sd">         equivalent to calling :meth:`~.Session.begin_nested`. For</span>
</span><span data-line="1905"><span class="sd">         documentation on SAVEPOINT transactions, please see</span>
</span><span data-line="1906"><span class="sd">         :ref:`session_begin_nested`.</span>
</span><span data-line="1907">
</span><span data-line="1908"><span class="sd">        :return: the :class:`.SessionTransaction` object.  Note that</span>
</span><span data-line="1909"><span class="sd">         :class:`.SessionTransaction`</span>
</span><span data-line="1910"><span class="sd">         acts as a Python context manager, allowing :meth:`.Session.begin`</span>
</span><span data-line="1911"><span class="sd">         to be used in a &quot;with&quot; block.  See :ref:`session_explicit_begin` for</span>
</span><span data-line="1912"><span class="sd">         an example.</span>
</span><span data-line="1913">
</span><span data-line="1914"><span class="sd">        .. seealso::</span>
</span><span data-line="1915">
</span><span data-line="1916"><span class="sd">            :ref:`session_autobegin`</span>
</span><span data-line="1917">
</span><span data-line="1918"><span class="sd">            :ref:`unitofwork_transaction`</span>
</span><span data-line="1919">
</span><span data-line="1920"><span class="sd">            :meth:`.Session.begin_nested`</span>
</span><span data-line="1921">
</span><span data-line="1922">
</span><span data-line="1923"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1924">
</span><span data-line="1925">        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span data-line="1926">        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1927">            <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1928">
</span><span data-line="1929">            <span class="k">if</span> <span class="ow">not</span> <span class="n">nested</span><span class="p">:</span>
</span><span data-line="1930">                <span class="k">return</span> <span class="n">trans</span>
</span><span data-line="1931">
</span><span data-line="1932">        <span class="k">assert</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1933">
</span><span data-line="1934">        <span class="k">if</span> <span class="n">nested</span><span class="p">:</span>
</span><span data-line="1935">            <span class="n">trans</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">_begin</span><span class="p">(</span><span class="n">nested</span><span class="o">=</span><span class="n">nested</span><span class="p">)</span>
</span><span data-line="1936">            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="n">trans</span>
</span><span data-line="1937">            <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="o">=</span> <span class="n">trans</span>
</span><span data-line="1938">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1939">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1940">                <span class="s2">&quot;A transaction is already begun on this Session.&quot;</span>
</span><span data-line="1941">            <span class="p">)</span>
</span><span data-line="1942">
</span><span data-line="1943">        <span class="k">return</span> <span class="n">trans</span>  <span class="c1"># needed for __enter__/__exit__ hook</span>
</span><span data-line="1944">
</span><span data-line="1945">    <span class="k">def</span> <span class="nf">begin_nested</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SessionTransaction</span><span class="p">:</span>
</span><span data-line="1946"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Begin a &quot;nested&quot; transaction on this Session, e.g. SAVEPOINT.</span>
</span><span data-line="1947">
</span><span data-line="1948"><span class="sd">        The target database(s) and associated drivers must support SQL</span>
</span><span data-line="1949"><span class="sd">        SAVEPOINT for this method to function correctly.</span>
</span><span data-line="1950">
</span><span data-line="1951"><span class="sd">        For documentation on SAVEPOINT</span>
</span><span data-line="1952"><span class="sd">        transactions, please see :ref:`session_begin_nested`.</span>
</span><span data-line="1953">
</span><span data-line="1954"><span class="sd">        :return: the :class:`.SessionTransaction` object.  Note that</span>
</span><span data-line="1955"><span class="sd">         :class:`.SessionTransaction` acts as a context manager, allowing</span>
</span><span data-line="1956"><span class="sd">         :meth:`.Session.begin_nested` to be used in a &quot;with&quot; block.</span>
</span><span data-line="1957"><span class="sd">         See :ref:`session_begin_nested` for a usage example.</span>
</span><span data-line="1958">
</span><span data-line="1959"><span class="sd">        .. seealso::</span>
</span><span data-line="1960">
</span><span data-line="1961"><span class="sd">            :ref:`session_begin_nested`</span>
</span><span data-line="1962">
</span><span data-line="1963"><span class="sd">            :ref:`pysqlite_serializable` - special workarounds required</span>
</span><span data-line="1964"><span class="sd">            with the SQLite driver in order for SAVEPOINT to work</span>
</span><span data-line="1965"><span class="sd">            correctly. For asyncio use cases, see the section</span>
</span><span data-line="1966"><span class="sd">            :ref:`aiosqlite_serializable`.</span>
</span><span data-line="1967">
</span><span data-line="1968"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1969">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">nested</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1970">
</span><span data-line="1971">    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1972"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Rollback the current transaction in progress.</span>
</span><span data-line="1973">
</span><span data-line="1974"><span class="sd">        If no transaction is in progress, this method is a pass-through.</span>
</span><span data-line="1975">
</span><span data-line="1976"><span class="sd">        The method always rolls back</span>
</span><span data-line="1977"><span class="sd">        the topmost database transaction, discarding any nested</span>
</span><span data-line="1978"><span class="sd">        transactions that may be in progress.</span>
</span><span data-line="1979">
</span><span data-line="1980"><span class="sd">        .. seealso::</span>
</span><span data-line="1981">
</span><span data-line="1982"><span class="sd">            :ref:`session_rollback`</span>
</span><span data-line="1983">
</span><span data-line="1984"><span class="sd">            :ref:`unitofwork_transaction`</span>
</span><span data-line="1985">
</span><span data-line="1986"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1987">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1988">            <span class="k">pass</span>
</span><span data-line="1989">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1990">            <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">_to_root</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1991">
</span><span data-line="1992">    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1993"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Flush pending changes and commit the current transaction.</span>
</span><span data-line="1994">
</span><span data-line="1995"><span class="sd">        When the COMMIT operation is complete, all objects are fully</span>
</span><span data-line="1996"><span class="sd">        :term:`expired`, erasing their internal contents, which will be</span>
</span><span data-line="1997"><span class="sd">        automatically re-loaded when the objects are next accessed. In the</span>
</span><span data-line="1998"><span class="sd">        interim, these objects are in an expired state and will not function if</span>
</span><span data-line="1999"><span class="sd">        they are :term:`detached` from the :class:`.Session`. Additionally,</span>
</span><span data-line="2000"><span class="sd">        this re-load operation is not supported when using asyncio-oriented</span>
</span><span data-line="2001"><span class="sd">        APIs. The :paramref:`.Session.expire_on_commit` parameter may be used</span>
</span><span data-line="2002"><span class="sd">        to disable this behavior.</span>
</span><span data-line="2003">
</span><span data-line="2004"><span class="sd">        When there is no transaction in place for the :class:`.Session`,</span>
</span><span data-line="2005"><span class="sd">        indicating that no operations were invoked on this :class:`.Session`</span>
</span><span data-line="2006"><span class="sd">        since the previous call to :meth:`.Session.commit`, the method will</span>
</span><span data-line="2007"><span class="sd">        begin and commit an internal-only &quot;logical&quot; transaction, that does not</span>
</span><span data-line="2008"><span class="sd">        normally affect the database unless pending flush changes were</span>
</span><span data-line="2009"><span class="sd">        detected, but will still invoke event handlers and object expiration</span>
</span><span data-line="2010"><span class="sd">        rules.</span>
</span><span data-line="2011">
</span><span data-line="2012"><span class="sd">        The outermost database transaction is committed unconditionally,</span>
</span><span data-line="2013"><span class="sd">        automatically releasing any SAVEPOINTs in effect.</span>
</span><span data-line="2014">
</span><span data-line="2015"><span class="sd">        .. seealso::</span>
</span><span data-line="2016">
</span><span data-line="2017"><span class="sd">            :ref:`session_committing`</span>
</span><span data-line="2018">
</span><span data-line="2019"><span class="sd">            :ref:`unitofwork_transaction`</span>
</span><span data-line="2020">
</span><span data-line="2021"><span class="sd">            :ref:`asyncio_orm_avoid_lazyloads`</span>
</span><span data-line="2022">
</span><span data-line="2023"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2024">        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span data-line="2025">        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2026">            <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">()</span>
</span><span data-line="2027">
</span><span data-line="2028">        <span class="n">trans</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">_to_root</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="2029">
</span><span data-line="2030">    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2031"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the current transaction in progress for two phase commit.</span>
</span><span data-line="2032">
</span><span data-line="2033"><span class="sd">        If no transaction is in progress, this method raises an</span>
</span><span data-line="2034"><span class="sd">        :exc:`~sqlalchemy.exc.InvalidRequestError`.</span>
</span><span data-line="2035">
</span><span data-line="2036"><span class="sd">        Only root transactions of two phase sessions can be prepared. If the</span>
</span><span data-line="2037"><span class="sd">        current transaction is not such, an</span>
</span><span data-line="2038"><span class="sd">        :exc:`~sqlalchemy.exc.InvalidRequestError` is raised.</span>
</span><span data-line="2039">
</span><span data-line="2040"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2041">        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span data-line="2042">        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2043">            <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">()</span>
</span><span data-line="2044">
</span><span data-line="2045">        <span class="n">trans</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
</span><span data-line="2046">
</span><span data-line="2047">    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span>
</span><span data-line="2048">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2049">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2050">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2051">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
</span><span data-line="2052"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return a :class:`_engine.Connection` object corresponding to this</span>
</span><span data-line="2053"><span class="sd">        :class:`.Session` object&#39;s transactional state.</span>
</span><span data-line="2054">
</span><span data-line="2055"><span class="sd">        Either the :class:`_engine.Connection` corresponding to the current</span>
</span><span data-line="2056"><span class="sd">        transaction is returned, or if no transaction is in progress, a new</span>
</span><span data-line="2057"><span class="sd">        one is begun and the :class:`_engine.Connection`</span>
</span><span data-line="2058"><span class="sd">        returned (note that no</span>
</span><span data-line="2059"><span class="sd">        transactional state is established with the DBAPI until the first</span>
</span><span data-line="2060"><span class="sd">        SQL statement is emitted).</span>
</span><span data-line="2061">
</span><span data-line="2062"><span class="sd">        Ambiguity in multi-bind or unbound :class:`.Session` objects can be</span>
</span><span data-line="2063"><span class="sd">        resolved through any of the optional keyword arguments.   This</span>
</span><span data-line="2064"><span class="sd">        ultimately makes usage of the :meth:`.get_bind` method for resolution.</span>
</span><span data-line="2065">
</span><span data-line="2066"><span class="sd">        :param bind_arguments: dictionary of bind arguments.  May include</span>
</span><span data-line="2067"><span class="sd">         &quot;mapper&quot;, &quot;bind&quot;, &quot;clause&quot;, other custom arguments that are passed</span>
</span><span data-line="2068"><span class="sd">         to :meth:`.Session.get_bind`.</span>
</span><span data-line="2069">
</span><span data-line="2070"><span class="sd">        :param execution_options: a dictionary of execution options that will</span>
</span><span data-line="2071"><span class="sd">         be passed to :meth:`_engine.Connection.execution_options`, **when the</span>
</span><span data-line="2072"><span class="sd">         connection is first procured only**.   If the connection is already</span>
</span><span data-line="2073"><span class="sd">         present within the :class:`.Session`, a warning is emitted and</span>
</span><span data-line="2074"><span class="sd">         the arguments are ignored.</span>
</span><span data-line="2075">
</span><span data-line="2076"><span class="sd">         .. seealso::</span>
</span><span data-line="2077">
</span><span data-line="2078"><span class="sd">            :ref:`session_transaction_isolation`</span>
</span><span data-line="2079">
</span><span data-line="2080"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2081">
</span><span data-line="2082">        <span class="k">if</span> <span class="n">bind_arguments</span><span class="p">:</span>
</span><span data-line="2083">            <span class="n">bind</span> <span class="o">=</span> <span class="n">bind_arguments</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;bind&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="2084">
</span><span data-line="2085">            <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2086">                <span class="n">bind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bind</span><span class="p">(</span><span class="o">**</span><span class="n">bind_arguments</span><span class="p">)</span>
</span><span data-line="2087">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2088">            <span class="n">bind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bind</span><span class="p">()</span>
</span><span data-line="2089">
</span><span data-line="2090">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_for_bind</span><span class="p">(</span>
</span><span data-line="2091">            <span class="n">bind</span><span class="p">,</span>
</span><span data-line="2092">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="2093">        <span class="p">)</span>
</span><span data-line="2094">
</span><span data-line="2095">    <span class="k">def</span> <span class="nf">_connection_for_bind</span><span class="p">(</span>
</span><span data-line="2096">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2097">        <span class="n">engine</span><span class="p">:</span> <span class="n">_SessionBind</span><span class="p">,</span>
</span><span data-line="2098">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2099">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2100">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
</span><span data-line="2101">        <span class="n">TransactionalContext</span><span class="o">.</span><span class="n">_trans_ctx_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="2102">
</span><span data-line="2103">        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span data-line="2104">        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2105">            <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">()</span>
</span><span data-line="2106">        <span class="k">return</span> <span class="n">trans</span><span class="o">.</span><span class="n">_connection_for_bind</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">execution_options</span><span class="p">)</span>
</span><span data-line="2107">
</span><span data-line="2108">    <span class="nd">@overload</span>
</span><span data-line="2109">    <span class="k">def</span> <span class="nf">_execute_internal</span><span class="p">(</span>
</span><span data-line="2110">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2111">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span data-line="2112">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreSingleExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2113">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2114">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2115">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2116">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2117">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2118">        <span class="n">_scalar_result</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="2119">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="2120">
</span><span data-line="2121">    <span class="nd">@overload</span>
</span><span data-line="2122">    <span class="k">def</span> <span class="nf">_execute_internal</span><span class="p">(</span>
</span><span data-line="2123">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2124">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span data-line="2125">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2126">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2127">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2128">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2129">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2130">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2131">        <span class="n">_scalar_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="2132">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="2133">
</span><span data-line="2134">    <span class="k">def</span> <span class="nf">_execute_internal</span><span class="p">(</span>
</span><span data-line="2135">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2136">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span data-line="2137">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2138">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2139">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2140">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2141">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2142">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2143">        <span class="n">_scalar_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2144">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="2145">        <span class="n">statement</span> <span class="o">=</span> <span class="n">coercions</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">roles</span><span class="o">.</span><span class="n">StatementRole</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>
</span><span data-line="2146">
</span><span data-line="2147">        <span class="k">if</span> <span class="ow">not</span> <span class="n">bind_arguments</span><span class="p">:</span>
</span><span data-line="2148">            <span class="n">bind_arguments</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="2149">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2150">            <span class="n">bind_arguments</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bind_arguments</span><span class="p">)</span>
</span><span data-line="2151">
</span><span data-line="2152">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2153">            <span class="n">statement</span><span class="o">.</span><span class="n">_propagate_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compile_state_plugin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="2154">            <span class="o">==</span> <span class="s2">&quot;orm&quot;</span>
</span><span data-line="2155">        <span class="p">):</span>
</span><span data-line="2156">            <span class="n">compile_state_cls</span> <span class="o">=</span> <span class="n">CompileState</span><span class="o">.</span><span class="n">_get_plugin_class_for_plugin</span><span class="p">(</span>
</span><span data-line="2157">                <span class="n">statement</span><span class="p">,</span> <span class="s2">&quot;orm&quot;</span>
</span><span data-line="2158">            <span class="p">)</span>
</span><span data-line="2159">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="2160">                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span data-line="2161">                    <span class="n">compile_state_cls</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">AbstractORMCompileState</span>
</span><span data-line="2162">                <span class="p">)</span>
</span><span data-line="2163">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2164">            <span class="n">compile_state_cls</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="2165">            <span class="n">bind_arguments</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;clause&quot;</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>
</span><span data-line="2166">
</span><span data-line="2167">        <span class="n">execution_options</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">coerce_to_immutabledict</span><span class="p">(</span><span class="n">execution_options</span><span class="p">)</span>
</span><span data-line="2168">
</span><span data-line="2169">        <span class="k">if</span> <span class="n">_parent_execute_state</span><span class="p">:</span>
</span><span data-line="2170">            <span class="n">events_todo</span> <span class="o">=</span> <span class="n">_parent_execute_state</span><span class="o">.</span><span class="n">_remaining_events</span><span class="p">()</span>
</span><span data-line="2171">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2172">            <span class="n">events_todo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">do_orm_execute</span>
</span><span data-line="2173">            <span class="k">if</span> <span class="n">_add_event</span><span class="p">:</span>
</span><span data-line="2174">                <span class="n">events_todo</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">events_todo</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">_add_event</span><span class="p">]</span>
</span><span data-line="2175">
</span><span data-line="2176">        <span class="k">if</span> <span class="n">events_todo</span><span class="p">:</span>
</span><span data-line="2177">            <span class="k">if</span> <span class="n">compile_state_cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2178">                <span class="c1"># for event handlers, do the orm_pre_session_exec</span>
</span><span data-line="2179">                <span class="c1"># pass ahead of the event handlers, so that things like</span>
</span><span data-line="2180">                <span class="c1"># .load_options, .update_delete_options etc. are populated.</span>
</span><span data-line="2181">                <span class="c1"># is_pre_event=True allows the hook to hold off on things</span>
</span><span data-line="2182">                <span class="c1"># it doesn&#39;t want to do twice, including autoflush as well</span>
</span><span data-line="2183">                <span class="c1"># as &quot;pre fetch&quot; for DML, etc.</span>
</span><span data-line="2184">                <span class="p">(</span>
</span><span data-line="2185">                    <span class="n">statement</span><span class="p">,</span>
</span><span data-line="2186">                    <span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="2187">                <span class="p">)</span> <span class="o">=</span> <span class="n">compile_state_cls</span><span class="o">.</span><span class="n">orm_pre_session_exec</span><span class="p">(</span>
</span><span data-line="2188">                    <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2189">                    <span class="n">statement</span><span class="p">,</span>
</span><span data-line="2190">                    <span class="n">params</span><span class="p">,</span>
</span><span data-line="2191">                    <span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="2192">                    <span class="n">bind_arguments</span><span class="p">,</span>
</span><span data-line="2193">                    <span class="kc">True</span><span class="p">,</span>
</span><span data-line="2194">                <span class="p">)</span>
</span><span data-line="2195">
</span><span data-line="2196">            <span class="n">orm_exec_state</span> <span class="o">=</span> <span class="n">ORMExecuteState</span><span class="p">(</span>
</span><span data-line="2197">                <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2198">                <span class="n">statement</span><span class="p">,</span>
</span><span data-line="2199">                <span class="n">params</span><span class="p">,</span>
</span><span data-line="2200">                <span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="2201">                <span class="n">bind_arguments</span><span class="p">,</span>
</span><span data-line="2202">                <span class="n">compile_state_cls</span><span class="p">,</span>
</span><span data-line="2203">                <span class="n">events_todo</span><span class="p">,</span>
</span><span data-line="2204">            <span class="p">)</span>
</span><span data-line="2205">            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events_todo</span><span class="p">):</span>
</span><span data-line="2206">                <span class="n">orm_exec_state</span><span class="o">.</span><span class="n">_starting_event_idx</span> <span class="o">=</span> <span class="n">idx</span>
</span><span data-line="2207">                <span class="n">fn_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">orm_exec_state</span><span class="p">)</span>
</span><span data-line="2208">                <span class="k">if</span> <span class="n">fn_result</span><span class="p">:</span>
</span><span data-line="2209">                    <span class="k">if</span> <span class="n">_scalar_result</span><span class="p">:</span>
</span><span data-line="2210">                        <span class="k">return</span> <span class="n">fn_result</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
</span><span data-line="2211">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="2212">                        <span class="k">return</span> <span class="n">fn_result</span>
</span><span data-line="2213">
</span><span data-line="2214">            <span class="n">statement</span> <span class="o">=</span> <span class="n">orm_exec_state</span><span class="o">.</span><span class="n">statement</span>
</span><span data-line="2215">            <span class="n">execution_options</span> <span class="o">=</span> <span class="n">orm_exec_state</span><span class="o">.</span><span class="n">local_execution_options</span>
</span><span data-line="2216">
</span><span data-line="2217">        <span class="k">if</span> <span class="n">compile_state_cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2218">            <span class="c1"># now run orm_pre_session_exec() &quot;for real&quot;.   if there were</span>
</span><span data-line="2219">            <span class="c1"># event hooks, this will re-run the steps that interpret</span>
</span><span data-line="2220">            <span class="c1"># new execution_options into load_options / update_delete_options,</span>
</span><span data-line="2221">            <span class="c1"># which we assume the event hook might have updated.</span>
</span><span data-line="2222">            <span class="c1"># autoflush will also be invoked in this step if enabled.</span>
</span><span data-line="2223">            <span class="p">(</span>
</span><span data-line="2224">                <span class="n">statement</span><span class="p">,</span>
</span><span data-line="2225">                <span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="2226">            <span class="p">)</span> <span class="o">=</span> <span class="n">compile_state_cls</span><span class="o">.</span><span class="n">orm_pre_session_exec</span><span class="p">(</span>
</span><span data-line="2227">                <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2228">                <span class="n">statement</span><span class="p">,</span>
</span><span data-line="2229">                <span class="n">params</span><span class="p">,</span>
</span><span data-line="2230">                <span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="2231">                <span class="n">bind_arguments</span><span class="p">,</span>
</span><span data-line="2232">                <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2233">            <span class="p">)</span>
</span><span data-line="2234">
</span><span data-line="2235">        <span class="n">bind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bind</span><span class="p">(</span><span class="o">**</span><span class="n">bind_arguments</span><span class="p">)</span>
</span><span data-line="2236">
</span><span data-line="2237">        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_for_bind</span><span class="p">(</span><span class="n">bind</span><span class="p">)</span>
</span><span data-line="2238">
</span><span data-line="2239">        <span class="k">if</span> <span class="n">_scalar_result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">compile_state_cls</span><span class="p">:</span>
</span><span data-line="2240">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="2241">                <span class="n">params</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">_CoreSingleExecuteParams</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span data-line="2242">            <span class="k">return</span> <span class="n">conn</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
</span><span data-line="2243">                <span class="n">statement</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span>
</span><span data-line="2244">            <span class="p">)</span>
</span><span data-line="2245">
</span><span data-line="2246">        <span class="k">if</span> <span class="n">compile_state_cls</span><span class="p">:</span>
</span><span data-line="2247">            <span class="n">result</span><span class="p">:</span> <span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">compile_state_cls</span><span class="o">.</span><span class="n">orm_execute_statement</span><span class="p">(</span>
</span><span data-line="2248">                <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2249">                <span class="n">statement</span><span class="p">,</span>
</span><span data-line="2250">                <span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span data-line="2251">                <span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="2252">                <span class="n">bind_arguments</span><span class="p">,</span>
</span><span data-line="2253">                <span class="n">conn</span><span class="p">,</span>
</span><span data-line="2254">            <span class="p">)</span>
</span><span data-line="2255">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2256">            <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span data-line="2257">                <span class="n">statement</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span>
</span><span data-line="2258">            <span class="p">)</span>
</span><span data-line="2259">
</span><span data-line="2260">        <span class="k">if</span> <span class="n">_scalar_result</span><span class="p">:</span>
</span><span data-line="2261">            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
</span><span data-line="2262">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2263">            <span class="k">return</span> <span class="n">result</span>
</span><span data-line="2264">
</span><span data-line="2265">    <span class="nd">@overload</span>
</span><span data-line="2266">    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
</span><span data-line="2267">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2268">        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="2269">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2270">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2271">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2272">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2273">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2274">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2275">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="2276">
</span><span data-line="2277">    <span class="nd">@overload</span>
</span><span data-line="2278">    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
</span><span data-line="2279">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2280">        <span class="n">statement</span><span class="p">:</span> <span class="n">UpdateBase</span><span class="p">,</span>
</span><span data-line="2281">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2282">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2283">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2284">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2285">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2286">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2287">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="2288">
</span><span data-line="2289">    <span class="nd">@overload</span>
</span><span data-line="2290">    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
</span><span data-line="2291">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2292">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span data-line="2293">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2294">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2295">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2296">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2297">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2298">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2299">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="2300">
</span><span data-line="2301">    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
</span><span data-line="2302">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2303">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span data-line="2304">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2305">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2306">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2307">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2308">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2309">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2310">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="2311"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Execute a SQL expression construct.</span>
</span><span data-line="2312">
</span><span data-line="2313"><span class="sd">        Returns a :class:`_engine.Result` object representing</span>
</span><span data-line="2314"><span class="sd">        results of the statement execution.</span>
</span><span data-line="2315">
</span><span data-line="2316"><span class="sd">        E.g.::</span>
</span><span data-line="2317">
</span><span data-line="2318"><span class="sd">            from sqlalchemy import select</span>
</span><span data-line="2319"><span class="sd">            result = session.execute(</span>
</span><span data-line="2320"><span class="sd">                select(User).where(User.id == 5)</span>
</span><span data-line="2321"><span class="sd">            )</span>
</span><span data-line="2322">
</span><span data-line="2323"><span class="sd">        The API contract of :meth:`_orm.Session.execute` is similar to that</span>
</span><span data-line="2324"><span class="sd">        of :meth:`_engine.Connection.execute`, the :term:`2.0 style` version</span>
</span><span data-line="2325"><span class="sd">        of :class:`_engine.Connection`.</span>
</span><span data-line="2326">
</span><span data-line="2327"><span class="sd">        .. versionchanged:: 1.4 the :meth:`_orm.Session.execute` method is</span>
</span><span data-line="2328"><span class="sd">           now the primary point of ORM statement execution when using</span>
</span><span data-line="2329"><span class="sd">           :term:`2.0 style` ORM usage.</span>
</span><span data-line="2330">
</span><span data-line="2331"><span class="sd">        :param statement:</span>
</span><span data-line="2332"><span class="sd">            An executable statement (i.e. an :class:`.Executable` expression</span>
</span><span data-line="2333"><span class="sd">            such as :func:`_expression.select`).</span>
</span><span data-line="2334">
</span><span data-line="2335"><span class="sd">        :param params:</span>
</span><span data-line="2336"><span class="sd">            Optional dictionary, or list of dictionaries, containing</span>
</span><span data-line="2337"><span class="sd">            bound parameter values.   If a single dictionary, single-row</span>
</span><span data-line="2338"><span class="sd">            execution occurs; if a list of dictionaries, an</span>
</span><span data-line="2339"><span class="sd">            &quot;executemany&quot; will be invoked.  The keys in each dictionary</span>
</span><span data-line="2340"><span class="sd">            must correspond to parameter names present in the statement.</span>
</span><span data-line="2341">
</span><span data-line="2342"><span class="sd">        :param execution_options: optional dictionary of execution options,</span>
</span><span data-line="2343"><span class="sd">         which will be associated with the statement execution.  This</span>
</span><span data-line="2344"><span class="sd">         dictionary can provide a subset of the options that are accepted</span>
</span><span data-line="2345"><span class="sd">         by :meth:`_engine.Connection.execution_options`, and may also</span>
</span><span data-line="2346"><span class="sd">         provide additional options understood only in an ORM context.</span>
</span><span data-line="2347">
</span><span data-line="2348"><span class="sd">         .. seealso::</span>
</span><span data-line="2349">
</span><span data-line="2350"><span class="sd">            :ref:`orm_queryguide_execution_options` - ORM-specific execution</span>
</span><span data-line="2351"><span class="sd">            options</span>
</span><span data-line="2352">
</span><span data-line="2353"><span class="sd">        :param bind_arguments: dictionary of additional arguments to determine</span>
</span><span data-line="2354"><span class="sd">         the bind.  May include &quot;mapper&quot;, &quot;bind&quot;, or other custom arguments.</span>
</span><span data-line="2355"><span class="sd">         Contents of this dictionary are passed to the</span>
</span><span data-line="2356"><span class="sd">         :meth:`.Session.get_bind` method.</span>
</span><span data-line="2357">
</span><span data-line="2358"><span class="sd">        :return: a :class:`_engine.Result` object.</span>
</span><span data-line="2359">
</span><span data-line="2360">
</span><span data-line="2361"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2362">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_internal</span><span class="p">(</span>
</span><span data-line="2363">            <span class="n">statement</span><span class="p">,</span>
</span><span data-line="2364">            <span class="n">params</span><span class="p">,</span>
</span><span data-line="2365">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="2366">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span data-line="2367">            <span class="n">_parent_execute_state</span><span class="o">=</span><span class="n">_parent_execute_state</span><span class="p">,</span>
</span><span data-line="2368">            <span class="n">_add_event</span><span class="o">=</span><span class="n">_add_event</span><span class="p">,</span>
</span><span data-line="2369">        <span class="p">)</span>
</span><span data-line="2370">
</span><span data-line="2371">    <span class="nd">@overload</span>
</span><span data-line="2372">    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span>
</span><span data-line="2373">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2374">        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span>
</span><span data-line="2375">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreSingleExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2376">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2377">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2378">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2379">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2380">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="2381">
</span><span data-line="2382">    <span class="nd">@overload</span>
</span><span data-line="2383">    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span>
</span><span data-line="2384">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2385">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span data-line="2386">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreSingleExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2387">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2388">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2389">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2390">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2391">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="2392">
</span><span data-line="2393">    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span>
</span><span data-line="2394">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2395">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span data-line="2396">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreSingleExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2397">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2398">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2399">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2400">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2401">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="2402"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a statement and return a scalar result.</span>
</span><span data-line="2403">
</span><span data-line="2404"><span class="sd">        Usage and parameters are the same as that of</span>
</span><span data-line="2405"><span class="sd">        :meth:`_orm.Session.execute`; the return result is a scalar Python</span>
</span><span data-line="2406"><span class="sd">        value.</span>
</span><span data-line="2407">
</span><span data-line="2408"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2409">
</span><span data-line="2410">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_internal</span><span class="p">(</span>
</span><span data-line="2411">            <span class="n">statement</span><span class="p">,</span>
</span><span data-line="2412">            <span class="n">params</span><span class="p">,</span>
</span><span data-line="2413">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="2414">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span data-line="2415">            <span class="n">_scalar_result</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="2416">            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span data-line="2417">        <span class="p">)</span>
</span><span data-line="2418">
</span><span data-line="2419">    <span class="nd">@overload</span>
</span><span data-line="2420">    <span class="k">def</span> <span class="nf">scalars</span><span class="p">(</span>
</span><span data-line="2421">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2422">        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span>
</span><span data-line="2423">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2424">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2425">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2426">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2427">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2428">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarResult</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="2429">
</span><span data-line="2430">    <span class="nd">@overload</span>
</span><span data-line="2431">    <span class="k">def</span> <span class="nf">scalars</span><span class="p">(</span>
</span><span data-line="2432">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2433">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span data-line="2434">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2435">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2436">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2437">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2438">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2439">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="2440">
</span><span data-line="2441">    <span class="k">def</span> <span class="nf">scalars</span><span class="p">(</span>
</span><span data-line="2442">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2443">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span data-line="2444">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2445">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2446">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2447">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2448">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2449">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="2450"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a statement and return the results as scalars.</span>
</span><span data-line="2451">
</span><span data-line="2452"><span class="sd">        Usage and parameters are the same as that of</span>
</span><span data-line="2453"><span class="sd">        :meth:`_orm.Session.execute`; the return result is a</span>
</span><span data-line="2454"><span class="sd">        :class:`_result.ScalarResult` filtering object which</span>
</span><span data-line="2455"><span class="sd">        will return single elements rather than :class:`_row.Row` objects.</span>
</span><span data-line="2456">
</span><span data-line="2457"><span class="sd">        :return:  a :class:`_result.ScalarResult` object</span>
</span><span data-line="2458">
</span><span data-line="2459"><span class="sd">        .. versionadded:: 1.4.24 Added :meth:`_orm.Session.scalars`</span>
</span><span data-line="2460">
</span><span data-line="2461"><span class="sd">        .. versionadded:: 1.4.26 Added :meth:`_orm.scoped_session.scalars`</span>
</span><span data-line="2462">
</span><span data-line="2463"><span class="sd">        .. seealso::</span>
</span><span data-line="2464">
</span><span data-line="2465"><span class="sd">            :ref:`orm_queryguide_select_orm_entities` - contrasts the behavior</span>
</span><span data-line="2466"><span class="sd">            of :meth:`_orm.Session.execute` to :meth:`_orm.Session.scalars`</span>
</span><span data-line="2467">
</span><span data-line="2468"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2469">
</span><span data-line="2470">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_internal</span><span class="p">(</span>
</span><span data-line="2471">            <span class="n">statement</span><span class="p">,</span>
</span><span data-line="2472">            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span data-line="2473">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="2474">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span data-line="2475">            <span class="n">_scalar_result</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># mypy appreciates this</span>
</span><span data-line="2476">            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span data-line="2477">        <span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span>
</span><span data-line="2478">
</span><span data-line="2479">    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2480"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close out the transactional resources and ORM objects used by this</span>
</span><span data-line="2481"><span class="sd">        :class:`_orm.Session`.</span>
</span><span data-line="2482">
</span><span data-line="2483"><span class="sd">        This expunges all ORM objects associated with this</span>
</span><span data-line="2484"><span class="sd">        :class:`_orm.Session`, ends any transaction in progress and</span>
</span><span data-line="2485"><span class="sd">        :term:`releases` any :class:`_engine.Connection` objects which this</span>
</span><span data-line="2486"><span class="sd">        :class:`_orm.Session` itself has checked out from associated</span>
</span><span data-line="2487"><span class="sd">        :class:`_engine.Engine` objects. The operation then leaves the</span>
</span><span data-line="2488"><span class="sd">        :class:`_orm.Session` in a state which it may be used again.</span>
</span><span data-line="2489">
</span><span data-line="2490"><span class="sd">        .. tip::</span>
</span><span data-line="2491">
</span><span data-line="2492"><span class="sd">            In the default running mode the :meth:`_orm.Session.close`</span>
</span><span data-line="2493"><span class="sd">            method **does not prevent the Session from being used again**.</span>
</span><span data-line="2494"><span class="sd">            The :class:`_orm.Session` itself does not actually have a</span>
</span><span data-line="2495"><span class="sd">            distinct &quot;closed&quot; state; it merely means</span>
</span><span data-line="2496"><span class="sd">            the :class:`_orm.Session` will release all database connections</span>
</span><span data-line="2497"><span class="sd">            and ORM objects.</span>
</span><span data-line="2498">
</span><span data-line="2499"><span class="sd">            Setting the parameter :paramref:`_orm.Session.close_resets_only`</span>
</span><span data-line="2500"><span class="sd">            to ``False`` will instead make the ``close`` final, meaning that</span>
</span><span data-line="2501"><span class="sd">            any further action on the session will be forbidden.</span>
</span><span data-line="2502">
</span><span data-line="2503"><span class="sd">        .. versionchanged:: 1.4  The :meth:`.Session.close` method does not</span>
</span><span data-line="2504"><span class="sd">           immediately create a new :class:`.SessionTransaction` object;</span>
</span><span data-line="2505"><span class="sd">           instead, the new :class:`.SessionTransaction` is created only if</span>
</span><span data-line="2506"><span class="sd">           the :class:`.Session` is used again for a database operation.</span>
</span><span data-line="2507">
</span><span data-line="2508"><span class="sd">        .. seealso::</span>
</span><span data-line="2509">
</span><span data-line="2510"><span class="sd">            :ref:`session_closing` - detail on the semantics of</span>
</span><span data-line="2511"><span class="sd">            :meth:`_orm.Session.close` and :meth:`_orm.Session.reset`.</span>
</span><span data-line="2512">
</span><span data-line="2513"><span class="sd">            :meth:`_orm.Session.reset` - a similar method that behaves like</span>
</span><span data-line="2514"><span class="sd">            ``close()`` with  the parameter</span>
</span><span data-line="2515"><span class="sd">            :paramref:`_orm.Session.close_resets_only` set to ``True``.</span>
</span><span data-line="2516">
</span><span data-line="2517"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2518">        <span class="bp">self</span><span class="o">.</span><span class="n">_close_impl</span><span class="p">(</span><span class="n">invalidate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="2519">
</span><span data-line="2520">    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2521"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close out the transactional resources and ORM objects used by this</span>
</span><span data-line="2522"><span class="sd">        :class:`_orm.Session`, resetting the session to its initial state.</span>
</span><span data-line="2523">
</span><span data-line="2524"><span class="sd">        This method provides for same &quot;reset-only&quot; behavior that the</span>
</span><span data-line="2525"><span class="sd">        :meth:`_orm.Session.close` method has provided historically, where the</span>
</span><span data-line="2526"><span class="sd">        state of the :class:`_orm.Session` is reset as though the object were</span>
</span><span data-line="2527"><span class="sd">        brand new, and ready to be used again.</span>
</span><span data-line="2528"><span class="sd">        This method may then be useful for :class:`_orm.Session` objects</span>
</span><span data-line="2529"><span class="sd">        which set :paramref:`_orm.Session.close_resets_only` to ``False``,</span>
</span><span data-line="2530"><span class="sd">        so that &quot;reset only&quot; behavior is still available.</span>
</span><span data-line="2531">
</span><span data-line="2532"><span class="sd">        .. versionadded:: 2.0.22</span>
</span><span data-line="2533">
</span><span data-line="2534"><span class="sd">        .. seealso::</span>
</span><span data-line="2535">
</span><span data-line="2536"><span class="sd">            :ref:`session_closing` - detail on the semantics of</span>
</span><span data-line="2537"><span class="sd">            :meth:`_orm.Session.close` and :meth:`_orm.Session.reset`.</span>
</span><span data-line="2538">
</span><span data-line="2539"><span class="sd">            :meth:`_orm.Session.close` - a similar method will additionally</span>
</span><span data-line="2540"><span class="sd">            prevent re-use of the Session when the parameter</span>
</span><span data-line="2541"><span class="sd">            :paramref:`_orm.Session.close_resets_only` is set to ``False``.</span>
</span><span data-line="2542"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2543">        <span class="bp">self</span><span class="o">.</span><span class="n">_close_impl</span><span class="p">(</span><span class="n">invalidate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="2544">
</span><span data-line="2545">    <span class="k">def</span> <span class="nf">invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2546"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close this Session, using connection invalidation.</span>
</span><span data-line="2547">
</span><span data-line="2548"><span class="sd">        This is a variant of :meth:`.Session.close` that will additionally</span>
</span><span data-line="2549"><span class="sd">        ensure that the :meth:`_engine.Connection.invalidate`</span>
</span><span data-line="2550"><span class="sd">        method will be called on each :class:`_engine.Connection` object</span>
</span><span data-line="2551"><span class="sd">        that is currently in use for a transaction (typically there is only</span>
</span><span data-line="2552"><span class="sd">        one connection unless the :class:`_orm.Session` is used with</span>
</span><span data-line="2553"><span class="sd">        multiple engines).</span>
</span><span data-line="2554">
</span><span data-line="2555"><span class="sd">        This can be called when the database is known to be in a state where</span>
</span><span data-line="2556"><span class="sd">        the connections are no longer safe to be used.</span>
</span><span data-line="2557">
</span><span data-line="2558"><span class="sd">        Below illustrates a scenario when using `gevent</span>
</span><span data-line="2559"><span class="sd">        &lt;https://www.gevent.org/&gt;`_, which can produce ``Timeout`` exceptions</span>
</span><span data-line="2560"><span class="sd">        that may mean the underlying connection should be discarded::</span>
</span><span data-line="2561">
</span><span data-line="2562"><span class="sd">            import gevent</span>
</span><span data-line="2563">
</span><span data-line="2564"><span class="sd">            try:</span>
</span><span data-line="2565"><span class="sd">                sess = Session()</span>
</span><span data-line="2566"><span class="sd">                sess.add(User())</span>
</span><span data-line="2567"><span class="sd">                sess.commit()</span>
</span><span data-line="2568"><span class="sd">            except gevent.Timeout:</span>
</span><span data-line="2569"><span class="sd">                sess.invalidate()</span>
</span><span data-line="2570"><span class="sd">                raise</span>
</span><span data-line="2571"><span class="sd">            except:</span>
</span><span data-line="2572"><span class="sd">                sess.rollback()</span>
</span><span data-line="2573"><span class="sd">                raise</span>
</span><span data-line="2574">
</span><span data-line="2575"><span class="sd">        The method additionally does everything that :meth:`_orm.Session.close`</span>
</span><span data-line="2576"><span class="sd">        does, including that all ORM objects are expunged.</span>
</span><span data-line="2577">
</span><span data-line="2578"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2579">        <span class="bp">self</span><span class="o">.</span><span class="n">_close_impl</span><span class="p">(</span><span class="n">invalidate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="2580">
</span><span data-line="2581">    <span class="k">def</span> <span class="nf">_close_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invalidate</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">is_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2582">        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reset</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close_state</span> <span class="ow">is</span> <span class="n">_SessionCloseState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">:</span>
</span><span data-line="2583">            <span class="bp">self</span><span class="o">.</span><span class="n">_close_state</span> <span class="o">=</span> <span class="n">_SessionCloseState</span><span class="o">.</span><span class="n">CLOSED</span>
</span><span data-line="2584">        <span class="bp">self</span><span class="o">.</span><span class="n">expunge_all</span><span class="p">()</span>
</span><span data-line="2585">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2586">            <span class="k">for</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_iterate_self_and_parents</span><span class="p">():</span>
</span><span data-line="2587">                <span class="n">transaction</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">invalidate</span><span class="p">)</span>
</span><span data-line="2588">
</span><span data-line="2589">    <span class="k">def</span> <span class="nf">expunge_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2590"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all object instances from this ``Session``.</span>
</span><span data-line="2591">
</span><span data-line="2592"><span class="sd">        This is equivalent to calling ``expunge(obj)`` on all objects in this</span>
</span><span data-line="2593"><span class="sd">        ``Session``.</span>
</span><span data-line="2594">
</span><span data-line="2595"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2596">
</span><span data-line="2597">        <span class="n">all_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">all_states</span><span class="p">()</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">)</span>
</span><span data-line="2598">        <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_kill</span><span class="p">()</span>
</span><span data-line="2599">        <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">WeakInstanceDict</span><span class="p">()</span>
</span><span data-line="2600">        <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="2601">        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="2602">
</span><span data-line="2603">        <span class="n">statelib</span><span class="o">.</span><span class="n">InstanceState</span><span class="o">.</span><span class="n">_detach_states</span><span class="p">(</span><span class="n">all_states</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span data-line="2604">
</span><span data-line="2605">    <span class="k">def</span> <span class="nf">_add_bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_SessionBindKey</span><span class="p">,</span> <span class="n">bind</span><span class="p">:</span> <span class="n">_SessionBind</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2606">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="2607">            <span class="n">insp</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="2608">        <span class="k">except</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">NoInspectionAvailable</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="2609">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
</span><span data-line="2610">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="2611">                    <span class="s2">&quot;Not an acceptable bind target: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span>
</span><span data-line="2612">                <span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span data-line="2613">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2614">                <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
</span><span data-line="2615">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2616">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="2617">                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">insp</span><span class="p">,</span> <span class="n">Inspectable</span><span class="p">)</span>
</span><span data-line="2618">
</span><span data-line="2619">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">insp</span><span class="p">,</span> <span class="n">TableClause</span><span class="p">):</span>
</span><span data-line="2620">                <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="n">insp</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
</span><span data-line="2621">            <span class="k">elif</span> <span class="n">insp_is_mapper</span><span class="p">(</span><span class="n">insp</span><span class="p">):</span>
</span><span data-line="2622">                <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="n">insp</span><span class="o">.</span><span class="n">class_</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
</span><span data-line="2623">                <span class="k">for</span> <span class="n">_selectable</span> <span class="ow">in</span> <span class="n">insp</span><span class="o">.</span><span class="n">_all_tables</span><span class="p">:</span>
</span><span data-line="2624">                    <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="n">_selectable</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
</span><span data-line="2625">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2626">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="2627">                    <span class="s2">&quot;Not an acceptable bind target: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span>
</span><span data-line="2628">                <span class="p">)</span>
</span><span data-line="2629">
</span><span data-line="2630">    <span class="k">def</span> <span class="nf">bind_mapper</span><span class="p">(</span>
</span><span data-line="2631">        <span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">:</span> <span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">bind</span><span class="p">:</span> <span class="n">_SessionBind</span>
</span><span data-line="2632">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2633"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Associate a :class:`_orm.Mapper` or arbitrary Python class with a</span>
</span><span data-line="2634"><span class="sd">        &quot;bind&quot;, e.g. an :class:`_engine.Engine` or</span>
</span><span data-line="2635"><span class="sd">        :class:`_engine.Connection`.</span>
</span><span data-line="2636">
</span><span data-line="2637"><span class="sd">        The given entity is added to a lookup used by the</span>
</span><span data-line="2638"><span class="sd">        :meth:`.Session.get_bind` method.</span>
</span><span data-line="2639">
</span><span data-line="2640"><span class="sd">        :param mapper: a :class:`_orm.Mapper` object,</span>
</span><span data-line="2641"><span class="sd">         or an instance of a mapped</span>
</span><span data-line="2642"><span class="sd">         class, or any Python class that is the base of a set of mapped</span>
</span><span data-line="2643"><span class="sd">         classes.</span>
</span><span data-line="2644">
</span><span data-line="2645"><span class="sd">        :param bind: an :class:`_engine.Engine` or :class:`_engine.Connection`</span>
</span><span data-line="2646"><span class="sd">                    object.</span>
</span><span data-line="2647">
</span><span data-line="2648"><span class="sd">        .. seealso::</span>
</span><span data-line="2649">
</span><span data-line="2650"><span class="sd">            :ref:`session_partitioning`</span>
</span><span data-line="2651">
</span><span data-line="2652"><span class="sd">            :paramref:`.Session.binds`</span>
</span><span data-line="2653">
</span><span data-line="2654"><span class="sd">            :meth:`.Session.bind_table`</span>
</span><span data-line="2655">
</span><span data-line="2656">
</span><span data-line="2657"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2658">        <span class="bp">self</span><span class="o">.</span><span class="n">_add_bind</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">bind</span><span class="p">)</span>
</span><span data-line="2659">
</span><span data-line="2660">    <span class="k">def</span> <span class="nf">bind_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">TableClause</span><span class="p">,</span> <span class="n">bind</span><span class="p">:</span> <span class="n">_SessionBind</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2661"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Associate a :class:`_schema.Table` with a &quot;bind&quot;, e.g. an</span>
</span><span data-line="2662"><span class="sd">        :class:`_engine.Engine`</span>
</span><span data-line="2663"><span class="sd">        or :class:`_engine.Connection`.</span>
</span><span data-line="2664">
</span><span data-line="2665"><span class="sd">        The given :class:`_schema.Table` is added to a lookup used by the</span>
</span><span data-line="2666"><span class="sd">        :meth:`.Session.get_bind` method.</span>
</span><span data-line="2667">
</span><span data-line="2668"><span class="sd">        :param table: a :class:`_schema.Table` object,</span>
</span><span data-line="2669"><span class="sd">         which is typically the target</span>
</span><span data-line="2670"><span class="sd">         of an ORM mapping, or is present within a selectable that is</span>
</span><span data-line="2671"><span class="sd">         mapped.</span>
</span><span data-line="2672">
</span><span data-line="2673"><span class="sd">        :param bind: an :class:`_engine.Engine` or :class:`_engine.Connection`</span>
</span><span data-line="2674"><span class="sd">         object.</span>
</span><span data-line="2675">
</span><span data-line="2676"><span class="sd">        .. seealso::</span>
</span><span data-line="2677">
</span><span data-line="2678"><span class="sd">            :ref:`session_partitioning`</span>
</span><span data-line="2679">
</span><span data-line="2680"><span class="sd">            :paramref:`.Session.binds`</span>
</span><span data-line="2681">
</span><span data-line="2682"><span class="sd">            :meth:`.Session.bind_mapper`</span>
</span><span data-line="2683">
</span><span data-line="2684">
</span><span data-line="2685"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2686">        <span class="bp">self</span><span class="o">.</span><span class="n">_add_bind</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">bind</span><span class="p">)</span>
</span><span data-line="2687">
</span><span data-line="2688">    <span class="k">def</span> <span class="nf">get_bind</span><span class="p">(</span>
</span><span data-line="2689">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2690">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2691">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="2692">        <span class="n">clause</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ClauseElement</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2693">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_SessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2694">        <span class="n">_sa_skip_events</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2695">        <span class="n">_sa_skip_for_implicit_returning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="2696">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="2697">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Engine</span><span class="p">,</span> <span class="n">Connection</span><span class="p">]:</span>
</span><span data-line="2698"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a &quot;bind&quot; to which this :class:`.Session` is bound.</span>
</span><span data-line="2699">
</span><span data-line="2700"><span class="sd">        The &quot;bind&quot; is usually an instance of :class:`_engine.Engine`,</span>
</span><span data-line="2701"><span class="sd">        except in the case where the :class:`.Session` has been</span>
</span><span data-line="2702"><span class="sd">        explicitly bound directly to a :class:`_engine.Connection`.</span>
</span><span data-line="2703">
</span><span data-line="2704"><span class="sd">        For a multiply-bound or unbound :class:`.Session`, the</span>
</span><span data-line="2705"><span class="sd">        ``mapper`` or ``clause`` arguments are used to determine the</span>
</span><span data-line="2706"><span class="sd">        appropriate bind to return.</span>
</span><span data-line="2707">
</span><span data-line="2708"><span class="sd">        Note that the &quot;mapper&quot; argument is usually present</span>
</span><span data-line="2709"><span class="sd">        when :meth:`.Session.get_bind` is called via an ORM</span>
</span><span data-line="2710"><span class="sd">        operation such as a :meth:`.Session.query`, each</span>
</span><span data-line="2711"><span class="sd">        individual INSERT/UPDATE/DELETE operation within a</span>
</span><span data-line="2712"><span class="sd">        :meth:`.Session.flush`, call, etc.</span>
</span><span data-line="2713">
</span><span data-line="2714"><span class="sd">        The order of resolution is:</span>
</span><span data-line="2715">
</span><span data-line="2716"><span class="sd">        1. if mapper given and :paramref:`.Session.binds` is present,</span>
</span><span data-line="2717"><span class="sd">           locate a bind based first on the mapper in use, then</span>
</span><span data-line="2718"><span class="sd">           on the mapped class in use, then on any base classes that are</span>
</span><span data-line="2719"><span class="sd">           present in the ``__mro__`` of the mapped class, from more specific</span>
</span><span data-line="2720"><span class="sd">           superclasses to more general.</span>
</span><span data-line="2721"><span class="sd">        2. if clause given and ``Session.binds`` is present,</span>
</span><span data-line="2722"><span class="sd">           locate a bind based on :class:`_schema.Table` objects</span>
</span><span data-line="2723"><span class="sd">           found in the given clause present in ``Session.binds``.</span>
</span><span data-line="2724"><span class="sd">        3. if ``Session.binds`` is present, return that.</span>
</span><span data-line="2725"><span class="sd">        4. if clause given, attempt to return a bind</span>
</span><span data-line="2726"><span class="sd">           linked to the :class:`_schema.MetaData` ultimately</span>
</span><span data-line="2727"><span class="sd">           associated with the clause.</span>
</span><span data-line="2728"><span class="sd">        5. if mapper given, attempt to return a bind</span>
</span><span data-line="2729"><span class="sd">           linked to the :class:`_schema.MetaData` ultimately</span>
</span><span data-line="2730"><span class="sd">           associated with the :class:`_schema.Table` or other</span>
</span><span data-line="2731"><span class="sd">           selectable to which the mapper is mapped.</span>
</span><span data-line="2732"><span class="sd">        6. No bind can be found, :exc:`~sqlalchemy.exc.UnboundExecutionError`</span>
</span><span data-line="2733"><span class="sd">           is raised.</span>
</span><span data-line="2734">
</span><span data-line="2735"><span class="sd">        Note that the :meth:`.Session.get_bind` method can be overridden on</span>
</span><span data-line="2736"><span class="sd">        a user-defined subclass of :class:`.Session` to provide any kind</span>
</span><span data-line="2737"><span class="sd">        of bind resolution scheme.  See the example at</span>
</span><span data-line="2738"><span class="sd">        :ref:`session_custom_partitioning`.</span>
</span><span data-line="2739">
</span><span data-line="2740"><span class="sd">        :param mapper:</span>
</span><span data-line="2741"><span class="sd">          Optional mapped class or corresponding :class:`_orm.Mapper` instance.</span>
</span><span data-line="2742"><span class="sd">          The bind can be derived from a :class:`_orm.Mapper` first by</span>
</span><span data-line="2743"><span class="sd">          consulting the &quot;binds&quot; map associated with this :class:`.Session`,</span>
</span><span data-line="2744"><span class="sd">          and secondly by consulting the :class:`_schema.MetaData` associated</span>
</span><span data-line="2745"><span class="sd">          with the :class:`_schema.Table` to which the :class:`_orm.Mapper` is</span>
</span><span data-line="2746"><span class="sd">          mapped for a bind.</span>
</span><span data-line="2747">
</span><span data-line="2748"><span class="sd">        :param clause:</span>
</span><span data-line="2749"><span class="sd">            A :class:`_expression.ClauseElement` (i.e.</span>
</span><span data-line="2750"><span class="sd">            :func:`_expression.select`,</span>
</span><span data-line="2751"><span class="sd">            :func:`_expression.text`,</span>
</span><span data-line="2752"><span class="sd">            etc.).  If the ``mapper`` argument is not present or could not</span>
</span><span data-line="2753"><span class="sd">            produce a bind, the given expression construct will be searched</span>
</span><span data-line="2754"><span class="sd">            for a bound element, typically a :class:`_schema.Table`</span>
</span><span data-line="2755"><span class="sd">            associated with</span>
</span><span data-line="2756"><span class="sd">            bound :class:`_schema.MetaData`.</span>
</span><span data-line="2757">
</span><span data-line="2758"><span class="sd">        .. seealso::</span>
</span><span data-line="2759">
</span><span data-line="2760"><span class="sd">             :ref:`session_partitioning`</span>
</span><span data-line="2761">
</span><span data-line="2762"><span class="sd">             :paramref:`.Session.binds`</span>
</span><span data-line="2763">
</span><span data-line="2764"><span class="sd">             :meth:`.Session.bind_mapper`</span>
</span><span data-line="2765">
</span><span data-line="2766"><span class="sd">             :meth:`.Session.bind_table`</span>
</span><span data-line="2767">
</span><span data-line="2768"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2769">
</span><span data-line="2770">        <span class="c1"># this function is documented as a subclassing hook, so we have</span>
</span><span data-line="2771">        <span class="c1"># to call this method even if the return is simple</span>
</span><span data-line="2772">        <span class="k">if</span> <span class="n">bind</span><span class="p">:</span>
</span><span data-line="2773">            <span class="k">return</span> <span class="n">bind</span>
</span><span data-line="2774">        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">:</span>
</span><span data-line="2775">            <span class="c1"># simplest and most common case, we have a bind and no</span>
</span><span data-line="2776">            <span class="c1"># per-mapper/table binds, we&#39;re done</span>
</span><span data-line="2777">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span>
</span><span data-line="2778">
</span><span data-line="2779">        <span class="c1"># we don&#39;t have self.bind and either have self.__binds</span>
</span><span data-line="2780">        <span class="c1"># or we don&#39;t have self.__binds (which is legacy).  Look at the</span>
</span><span data-line="2781">        <span class="c1"># mapper and the clause</span>
</span><span data-line="2782">        <span class="k">if</span> <span class="n">mapper</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">clause</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2783">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">:</span>
</span><span data-line="2784">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span>
</span><span data-line="2785">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="2786">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">UnboundExecutionError</span><span class="p">(</span>
</span><span data-line="2787">                    <span class="s2">&quot;This session is not bound to a single Engine or &quot;</span>
</span><span data-line="2788">                    <span class="s2">&quot;Connection, and no context was provided to locate &quot;</span>
</span><span data-line="2789">                    <span class="s2">&quot;a binding.&quot;</span>
</span><span data-line="2790">                <span class="p">)</span>
</span><span data-line="2791">
</span><span data-line="2792">        <span class="c1"># look more closely at the mapper.</span>
</span><span data-line="2793">        <span class="k">if</span> <span class="n">mapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2794">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="2795">                <span class="n">inspected_mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
</span><span data-line="2796">            <span class="k">except</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">NoInspectionAvailable</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="2797">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
</span><span data-line="2798">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedClassError</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span data-line="2799">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="2800">                    <span class="k">raise</span>
</span><span data-line="2801">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2802">            <span class="n">inspected_mapper</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="2803">
</span><span data-line="2804">        <span class="c1"># match up the mapper or clause in the __binds</span>
</span><span data-line="2805">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">:</span>
</span><span data-line="2806">            <span class="c1"># matching mappers and selectables to entries in the</span>
</span><span data-line="2807">            <span class="c1"># binds dictionary; supported use case.</span>
</span><span data-line="2808">            <span class="k">if</span> <span class="n">inspected_mapper</span><span class="p">:</span>
</span><span data-line="2809">                <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">inspected_mapper</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
</span><span data-line="2810">                    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">:</span>
</span><span data-line="2811">                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
</span><span data-line="2812">                <span class="k">if</span> <span class="n">clause</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2813">                    <span class="n">clause</span> <span class="o">=</span> <span class="n">inspected_mapper</span><span class="o">.</span><span class="n">persist_selectable</span>
</span><span data-line="2814">
</span><span data-line="2815">            <span class="k">if</span> <span class="n">clause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2816">                <span class="n">plugin_subject</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">_propagate_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="2817">                    <span class="s2">&quot;plugin_subject&quot;</span><span class="p">,</span> <span class="kc">None</span>
</span><span data-line="2818">                <span class="p">)</span>
</span><span data-line="2819">
</span><span data-line="2820">                <span class="k">if</span> <span class="n">plugin_subject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2821">                    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">plugin_subject</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
</span><span data-line="2822">                        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">:</span>
</span><span data-line="2823">                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
</span><span data-line="2824">
</span><span data-line="2825">                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">visitors</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">clause</span><span class="p">):</span>
</span><span data-line="2826">                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">:</span>
</span><span data-line="2827">                        <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="2828">                            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Table</span><span class="p">)</span>
</span><span data-line="2829">                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
</span><span data-line="2830">
</span><span data-line="2831">        <span class="c1"># none of the __binds matched, but we have a fallback bind.</span>
</span><span data-line="2832">        <span class="c1"># return that</span>
</span><span data-line="2833">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">:</span>
</span><span data-line="2834">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span>
</span><span data-line="2835">
</span><span data-line="2836">        <span class="n">context</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2837">        <span class="k">if</span> <span class="n">inspected_mapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2838">            <span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mapper </span><span class="si">{</span><span class="n">inspected_mapper</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="2839">        <span class="k">if</span> <span class="n">clause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2840">            <span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;SQL expression&quot;</span><span class="p">)</span>
</span><span data-line="2841">
</span><span data-line="2842">        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">UnboundExecutionError</span><span class="p">(</span>
</span><span data-line="2843">            <span class="sa">f</span><span class="s2">&quot;Could not locate a bind configured on &quot;</span>
</span><span data-line="2844">            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="si">}</span><span class="s1"> or this Session.&#39;</span>
</span><span data-line="2845">        <span class="p">)</span>
</span><span data-line="2846">
</span><span data-line="2847">    <span class="nd">@overload</span>
</span><span data-line="2848">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_entity</span><span class="p">:</span> <span class="n">_EntityType</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Query</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="2849">
</span><span data-line="2850">    <span class="nd">@overload</span>
</span><span data-line="2851">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span data-line="2852">        <span class="bp">self</span><span class="p">,</span> <span class="n">_colexpr</span><span class="p">:</span> <span class="n">TypedColumnsClauseRole</span><span class="p">[</span><span class="n">_T</span><span class="p">]</span>
</span><span data-line="2853">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span> <span class="o">...</span>
</span><span data-line="2854">
</span><span data-line="2855">    <span class="c1"># START OVERLOADED FUNCTIONS self.query RowReturningQuery 2-8</span>
</span><span data-line="2856">
</span><span data-line="2857">    <span class="c1"># code within this block is **programmatically,</span>
</span><span data-line="2858">    <span class="c1"># statically generated** by tools/generate_tuple_map_overloads.py</span>
</span><span data-line="2859">
</span><span data-line="2860">    <span class="nd">@overload</span>
</span><span data-line="2861">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span data-line="2862">        <span class="bp">self</span><span class="p">,</span> <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span> <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">]</span>
</span><span data-line="2863">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">]]:</span> <span class="o">...</span>
</span><span data-line="2864">
</span><span data-line="2865">    <span class="nd">@overload</span>
</span><span data-line="2866">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span data-line="2867">        <span class="bp">self</span><span class="p">,</span> <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span> <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">],</span> <span class="n">__ent2</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T2</span><span class="p">]</span>
</span><span data-line="2868">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">]]:</span> <span class="o">...</span>
</span><span data-line="2869">
</span><span data-line="2870">    <span class="nd">@overload</span>
</span><span data-line="2871">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span data-line="2872">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2873">        <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span>
</span><span data-line="2874">        <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">],</span>
</span><span data-line="2875">        <span class="n">__ent2</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T2</span><span class="p">],</span>
</span><span data-line="2876">        <span class="n">__ent3</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T3</span><span class="p">],</span>
</span><span data-line="2877">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">,</span> <span class="n">_T3</span><span class="p">]]:</span> <span class="o">...</span>
</span><span data-line="2878">
</span><span data-line="2879">    <span class="nd">@overload</span>
</span><span data-line="2880">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span data-line="2881">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2882">        <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span>
</span><span data-line="2883">        <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">],</span>
</span><span data-line="2884">        <span class="n">__ent2</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T2</span><span class="p">],</span>
</span><span data-line="2885">        <span class="n">__ent3</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T3</span><span class="p">],</span>
</span><span data-line="2886">        <span class="n">__ent4</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T4</span><span class="p">],</span>
</span><span data-line="2887">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">,</span> <span class="n">_T3</span><span class="p">,</span> <span class="n">_T4</span><span class="p">]]:</span> <span class="o">...</span>
</span><span data-line="2888">
</span><span data-line="2889">    <span class="nd">@overload</span>
</span><span data-line="2890">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span data-line="2891">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2892">        <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span>
</span><span data-line="2893">        <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">],</span>
</span><span data-line="2894">        <span class="n">__ent2</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T2</span><span class="p">],</span>
</span><span data-line="2895">        <span class="n">__ent3</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T3</span><span class="p">],</span>
</span><span data-line="2896">        <span class="n">__ent4</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T4</span><span class="p">],</span>
</span><span data-line="2897">        <span class="n">__ent5</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T5</span><span class="p">],</span>
</span><span data-line="2898">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">,</span> <span class="n">_T3</span><span class="p">,</span> <span class="n">_T4</span><span class="p">,</span> <span class="n">_T5</span><span class="p">]]:</span> <span class="o">...</span>
</span><span data-line="2899">
</span><span data-line="2900">    <span class="nd">@overload</span>
</span><span data-line="2901">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span data-line="2902">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2903">        <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span>
</span><span data-line="2904">        <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">],</span>
</span><span data-line="2905">        <span class="n">__ent2</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T2</span><span class="p">],</span>
</span><span data-line="2906">        <span class="n">__ent3</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T3</span><span class="p">],</span>
</span><span data-line="2907">        <span class="n">__ent4</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T4</span><span class="p">],</span>
</span><span data-line="2908">        <span class="n">__ent5</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T5</span><span class="p">],</span>
</span><span data-line="2909">        <span class="n">__ent6</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T6</span><span class="p">],</span>
</span><span data-line="2910">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">,</span> <span class="n">_T3</span><span class="p">,</span> <span class="n">_T4</span><span class="p">,</span> <span class="n">_T5</span><span class="p">,</span> <span class="n">_T6</span><span class="p">]]:</span> <span class="o">...</span>
</span><span data-line="2911">
</span><span data-line="2912">    <span class="nd">@overload</span>
</span><span data-line="2913">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span data-line="2914">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2915">        <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span>
</span><span data-line="2916">        <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">],</span>
</span><span data-line="2917">        <span class="n">__ent2</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T2</span><span class="p">],</span>
</span><span data-line="2918">        <span class="n">__ent3</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T3</span><span class="p">],</span>
</span><span data-line="2919">        <span class="n">__ent4</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T4</span><span class="p">],</span>
</span><span data-line="2920">        <span class="n">__ent5</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T5</span><span class="p">],</span>
</span><span data-line="2921">        <span class="n">__ent6</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T6</span><span class="p">],</span>
</span><span data-line="2922">        <span class="n">__ent7</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T7</span><span class="p">],</span>
</span><span data-line="2923">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">,</span> <span class="n">_T3</span><span class="p">,</span> <span class="n">_T4</span><span class="p">,</span> <span class="n">_T5</span><span class="p">,</span> <span class="n">_T6</span><span class="p">,</span> <span class="n">_T7</span><span class="p">]]:</span> <span class="o">...</span>
</span><span data-line="2924">
</span><span data-line="2925">    <span class="c1"># END OVERLOADED FUNCTIONS self.query</span>
</span><span data-line="2926">
</span><span data-line="2927">    <span class="nd">@overload</span>
</span><span data-line="2928">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span data-line="2929">        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">entities</span><span class="p">:</span> <span class="n">_ColumnsClauseArgument</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="2930">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Query</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="2931">
</span><span data-line="2932">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span data-line="2933">        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">entities</span><span class="p">:</span> <span class="n">_ColumnsClauseArgument</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="2934">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Query</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="2935"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a new :class:`_query.Query` object corresponding to this</span>
</span><span data-line="2936"><span class="sd">        :class:`_orm.Session`.</span>
</span><span data-line="2937">
</span><span data-line="2938"><span class="sd">        Note that the :class:`_query.Query` object is legacy as of</span>
</span><span data-line="2939"><span class="sd">        SQLAlchemy 2.0; the :func:`_sql.select` construct is now used</span>
</span><span data-line="2940"><span class="sd">        to construct ORM queries.</span>
</span><span data-line="2941">
</span><span data-line="2942"><span class="sd">        .. seealso::</span>
</span><span data-line="2943">
</span><span data-line="2944"><span class="sd">            :ref:`unified_tutorial`</span>
</span><span data-line="2945">
</span><span data-line="2946"><span class="sd">            :ref:`queryguide_toplevel`</span>
</span><span data-line="2947">
</span><span data-line="2948"><span class="sd">            :ref:`query_api_toplevel` - legacy API doc</span>
</span><span data-line="2949">
</span><span data-line="2950"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="2951">
</span><span data-line="2952">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_cls</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span data-line="2953">
</span><span data-line="2954">    <span class="k">def</span> <span class="nf">_identity_lookup</span><span class="p">(</span>
</span><span data-line="2955">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="2956">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="2957">        <span class="n">primary_key_identity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span>
</span><span data-line="2958">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2959">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span data-line="2960">        <span class="n">lazy_loaded_from</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2961">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="2962">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="2963">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">LoaderCallableStatus</span><span class="p">]:</span>
</span><span data-line="2964"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Locate an object in the identity map.</span>
</span><span data-line="2965">
</span><span data-line="2966"><span class="sd">        Given a primary key identity, constructs an identity key and then</span>
</span><span data-line="2967"><span class="sd">        looks in the session&#39;s identity map.  If present, the object may</span>
</span><span data-line="2968"><span class="sd">        be run through unexpiration rules (e.g. load unloaded attributes,</span>
</span><span data-line="2969"><span class="sd">        check if was deleted).</span>
</span><span data-line="2970">
</span><span data-line="2971"><span class="sd">        e.g.::</span>
</span><span data-line="2972">
</span><span data-line="2973"><span class="sd">            obj = session._identity_lookup(inspect(SomeClass), (1, ))</span>
</span><span data-line="2974">
</span><span data-line="2975"><span class="sd">        :param mapper: mapper in use</span>
</span><span data-line="2976"><span class="sd">        :param primary_key_identity: the primary key we are searching for, as</span>
</span><span data-line="2977"><span class="sd">         a tuple.</span>
</span><span data-line="2978"><span class="sd">        :param identity_token: identity token that should be used to create</span>
</span><span data-line="2979"><span class="sd">         the identity key.  Used as is, however overriding subclasses can</span>
</span><span data-line="2980"><span class="sd">         repurpose this in order to interpret the value in a special way,</span>
</span><span data-line="2981"><span class="sd">         such as if None then look among multiple target tokens.</span>
</span><span data-line="2982"><span class="sd">        :param passive: passive load flag passed to</span>
</span><span data-line="2983"><span class="sd">         :func:`.loading.get_from_identity`, which impacts the behavior if</span>
</span><span data-line="2984"><span class="sd">         the object is found; the object may be validated and/or unexpired</span>
</span><span data-line="2985"><span class="sd">         if the flag allows for SQL to be emitted.</span>
</span><span data-line="2986"><span class="sd">        :param lazy_loaded_from: an :class:`.InstanceState` that is</span>
</span><span data-line="2987"><span class="sd">         specifically asking for this identity as a related identity.  Used</span>
</span><span data-line="2988"><span class="sd">         for sharding schemes where there is a correspondence between an object</span>
</span><span data-line="2989"><span class="sd">         and a related object being lazy-loaded (or otherwise</span>
</span><span data-line="2990"><span class="sd">         relationship-loaded).</span>
</span><span data-line="2991">
</span><span data-line="2992"><span class="sd">        :return: None if the object is not found in the identity map, *or*</span>
</span><span data-line="2993"><span class="sd">         if the object was unexpired and found to have been deleted.</span>
</span><span data-line="2994"><span class="sd">         if passive flags disallow SQL and the object is expired, returns</span>
</span><span data-line="2995"><span class="sd">         PASSIVE_NO_RESULT.   In all other cases the instance is returned.</span>
</span><span data-line="2996">
</span><span data-line="2997"><span class="sd">        .. versionchanged:: 1.4.0 - the :meth:`.Session._identity_lookup`</span>
</span><span data-line="2998"><span class="sd">           method was moved from :class:`_query.Query` to</span>
</span><span data-line="2999"><span class="sd">           :class:`.Session`, to avoid having to instantiate the</span>
</span><span data-line="3000"><span class="sd">           :class:`_query.Query` object.</span>
</span><span data-line="3001">
</span><span data-line="3002">
</span><span data-line="3003"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3004">
</span><span data-line="3005">        <span class="n">key</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">identity_key_from_primary_key</span><span class="p">(</span>
</span><span data-line="3006">            <span class="n">primary_key_identity</span><span class="p">,</span> <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span>
</span><span data-line="3007">        <span class="p">)</span>
</span><span data-line="3008">
</span><span data-line="3009">        <span class="c1"># work around: https://github.com/python/typing/discussions/1143</span>
</span><span data-line="3010">        <span class="n">return_value</span> <span class="o">=</span> <span class="n">loading</span><span class="o">.</span><span class="n">get_from_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span data-line="3011">        <span class="k">return</span> <span class="n">return_value</span>
</span><span data-line="3012">
</span><span data-line="3013">    <span class="nd">@util</span><span class="o">.</span><span class="n">non_memoized_property</span>
</span><span data-line="3014">    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span data-line="3015">    <span class="k">def</span> <span class="nf">no_autoflush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Session</span><span class="p">]:</span>
</span><span data-line="3016"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a context manager that disables autoflush.</span>
</span><span data-line="3017">
</span><span data-line="3018"><span class="sd">        e.g.::</span>
</span><span data-line="3019">
</span><span data-line="3020"><span class="sd">            with session.no_autoflush:</span>
</span><span data-line="3021">
</span><span data-line="3022"><span class="sd">                some_object = SomeClass()</span>
</span><span data-line="3023"><span class="sd">                session.add(some_object)</span>
</span><span data-line="3024"><span class="sd">                # won&#39;t autoflush</span>
</span><span data-line="3025"><span class="sd">                some_object.related_thing = session.query(SomeRelated).first()</span>
</span><span data-line="3026">
</span><span data-line="3027"><span class="sd">        Operations that proceed within the ``with:`` block</span>
</span><span data-line="3028"><span class="sd">        will not be subject to flushes occurring upon query</span>
</span><span data-line="3029"><span class="sd">        access.  This is useful when initializing a series</span>
</span><span data-line="3030"><span class="sd">        of objects which involve existing database queries,</span>
</span><span data-line="3031"><span class="sd">        where the uncompleted object should not yet be flushed.</span>
</span><span data-line="3032">
</span><span data-line="3033"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3034">        <span class="n">autoflush</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span>
</span><span data-line="3035">        <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="3036">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="3037">            <span class="k">yield</span> <span class="bp">self</span>
</span><span data-line="3038">        <span class="k">finally</span><span class="p">:</span>
</span><span data-line="3039">            <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span> <span class="o">=</span> <span class="n">autoflush</span>
</span><span data-line="3040">
</span><span data-line="3041">    <span class="nd">@util</span><span class="o">.</span><span class="n">langhelpers</span><span class="o">.</span><span class="n">tag_method_for_warnings</span><span class="p">(</span>
</span><span data-line="3042">        <span class="s2">&quot;This warning originated from the Session &#39;autoflush&#39; process, &quot;</span>
</span><span data-line="3043">        <span class="s2">&quot;which was invoked automatically in response to a user-initiated &quot;</span>
</span><span data-line="3044">        <span class="s2">&quot;operation.&quot;</span><span class="p">,</span>
</span><span data-line="3045">        <span class="n">sa_exc</span><span class="o">.</span><span class="n">SAWarning</span><span class="p">,</span>
</span><span data-line="3046">    <span class="p">)</span>
</span><span data-line="3047">    <span class="k">def</span> <span class="nf">_autoflush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3048">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span><span class="p">:</span>
</span><span data-line="3049">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="3050">                <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span data-line="3051">            <span class="k">except</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">StatementError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="3052">                <span class="c1"># note we are reraising StatementError as opposed to</span>
</span><span data-line="3053">                <span class="c1"># raising FlushError with &quot;chaining&quot; to remain compatible</span>
</span><span data-line="3054">                <span class="c1"># with code that catches StatementError, IntegrityError,</span>
</span><span data-line="3055">                <span class="c1"># etc.</span>
</span><span data-line="3056">                <span class="n">e</span><span class="o">.</span><span class="n">add_detail</span><span class="p">(</span>
</span><span data-line="3057">                    <span class="s2">&quot;raised as a result of Query-invoked autoflush; &quot;</span>
</span><span data-line="3058">                    <span class="s2">&quot;consider using a session.no_autoflush block if this &quot;</span>
</span><span data-line="3059">                    <span class="s2">&quot;flush is occurring prematurely&quot;</span>
</span><span data-line="3060">                <span class="p">)</span>
</span><span data-line="3061">                <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
</span><span data-line="3062">
</span><span data-line="3063">    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span>
</span><span data-line="3064">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="3065">        <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
</span><span data-line="3066">        <span class="n">attribute_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3067">        <span class="n">with_for_update</span><span class="p">:</span> <span class="n">ForUpdateParameter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3068">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3069"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Expire and refresh attributes on the given instance.</span>
</span><span data-line="3070">
</span><span data-line="3071"><span class="sd">        The selected attributes will first be expired as they would when using</span>
</span><span data-line="3072"><span class="sd">        :meth:`_orm.Session.expire`; then a SELECT statement will be issued to</span>
</span><span data-line="3073"><span class="sd">        the database to refresh column-oriented attributes with the current</span>
</span><span data-line="3074"><span class="sd">        value available in the current transaction.</span>
</span><span data-line="3075">
</span><span data-line="3076"><span class="sd">        :func:`_orm.relationship` oriented attributes will also be immediately</span>
</span><span data-line="3077"><span class="sd">        loaded if they were already eagerly loaded on the object, using the</span>
</span><span data-line="3078"><span class="sd">        same eager loading strategy that they were loaded with originally.</span>
</span><span data-line="3079">
</span><span data-line="3080"><span class="sd">        .. versionadded:: 1.4 - the :meth:`_orm.Session.refresh` method</span>
</span><span data-line="3081"><span class="sd">           can also refresh eagerly loaded attributes.</span>
</span><span data-line="3082">
</span><span data-line="3083"><span class="sd">        :func:`_orm.relationship` oriented attributes that would normally</span>
</span><span data-line="3084"><span class="sd">        load using the ``select`` (or &quot;lazy&quot;) loader strategy will also</span>
</span><span data-line="3085"><span class="sd">        load **if they are named explicitly in the attribute_names</span>
</span><span data-line="3086"><span class="sd">        collection**, emitting a SELECT statement for the attribute using the</span>
</span><span data-line="3087"><span class="sd">        ``immediate`` loader strategy.  If lazy-loaded relationships are not</span>
</span><span data-line="3088"><span class="sd">        named in :paramref:`_orm.Session.refresh.attribute_names`, then</span>
</span><span data-line="3089"><span class="sd">        they remain as &quot;lazy loaded&quot; attributes and are not implicitly</span>
</span><span data-line="3090"><span class="sd">        refreshed.</span>
</span><span data-line="3091">
</span><span data-line="3092"><span class="sd">        .. versionchanged:: 2.0.4  The :meth:`_orm.Session.refresh` method</span>
</span><span data-line="3093"><span class="sd">           will now refresh lazy-loaded :func:`_orm.relationship` oriented</span>
</span><span data-line="3094"><span class="sd">           attributes for those which are named explicitly in the</span>
</span><span data-line="3095"><span class="sd">           :paramref:`_orm.Session.refresh.attribute_names` collection.</span>
</span><span data-line="3096">
</span><span data-line="3097"><span class="sd">        .. tip::</span>
</span><span data-line="3098">
</span><span data-line="3099"><span class="sd">            While the :meth:`_orm.Session.refresh` method is capable of</span>
</span><span data-line="3100"><span class="sd">            refreshing both column and relationship oriented attributes, its</span>
</span><span data-line="3101"><span class="sd">            primary focus is on refreshing of local column-oriented attributes</span>
</span><span data-line="3102"><span class="sd">            on a single instance. For more open ended &quot;refresh&quot; functionality,</span>
</span><span data-line="3103"><span class="sd">            including the ability to refresh the attributes on many objects at</span>
</span><span data-line="3104"><span class="sd">            once while having explicit control over relationship loader</span>
</span><span data-line="3105"><span class="sd">            strategies, use the</span>
</span><span data-line="3106"><span class="sd">            :ref:`populate existing &lt;orm_queryguide_populate_existing&gt;` feature</span>
</span><span data-line="3107"><span class="sd">            instead.</span>
</span><span data-line="3108">
</span><span data-line="3109"><span class="sd">        Note that a highly isolated transaction will return the same values as</span>
</span><span data-line="3110"><span class="sd">        were previously read in that same transaction, regardless of changes</span>
</span><span data-line="3111"><span class="sd">        in database state outside of that transaction.   Refreshing</span>
</span><span data-line="3112"><span class="sd">        attributes usually only makes sense at the start of a transaction</span>
</span><span data-line="3113"><span class="sd">        where database rows have not yet been accessed.</span>
</span><span data-line="3114">
</span><span data-line="3115"><span class="sd">        :param attribute_names: optional.  An iterable collection of</span>
</span><span data-line="3116"><span class="sd">          string attribute names indicating a subset of attributes to</span>
</span><span data-line="3117"><span class="sd">          be refreshed.</span>
</span><span data-line="3118">
</span><span data-line="3119"><span class="sd">        :param with_for_update: optional boolean ``True`` indicating FOR UPDATE</span>
</span><span data-line="3120"><span class="sd">          should be used, or may be a dictionary containing flags to</span>
</span><span data-line="3121"><span class="sd">          indicate a more specific set of FOR UPDATE flags for the SELECT;</span>
</span><span data-line="3122"><span class="sd">          flags should match the parameters of</span>
</span><span data-line="3123"><span class="sd">          :meth:`_query.Query.with_for_update`.</span>
</span><span data-line="3124"><span class="sd">          Supersedes the :paramref:`.Session.refresh.lockmode` parameter.</span>
</span><span data-line="3125">
</span><span data-line="3126"><span class="sd">        .. seealso::</span>
</span><span data-line="3127">
</span><span data-line="3128"><span class="sd">            :ref:`session_expire` - introductory material</span>
</span><span data-line="3129">
</span><span data-line="3130"><span class="sd">            :meth:`.Session.expire`</span>
</span><span data-line="3131">
</span><span data-line="3132"><span class="sd">            :meth:`.Session.expire_all`</span>
</span><span data-line="3133">
</span><span data-line="3134"><span class="sd">            :ref:`orm_queryguide_populate_existing` - allows any ORM query</span>
</span><span data-line="3135"><span class="sd">            to refresh objects as they would be loaded normally.</span>
</span><span data-line="3136">
</span><span data-line="3137"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3138">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="3139">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="3140">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="3141">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span data-line="3142">
</span><span data-line="3143">        <span class="bp">self</span><span class="o">.</span><span class="n">_expire_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">)</span>
</span><span data-line="3144">
</span><span data-line="3145">        <span class="c1"># this autoflush previously used to occur as a secondary effect</span>
</span><span data-line="3146">        <span class="c1"># of the load_on_ident below.   Meaning we&#39;d organize the SELECT</span>
</span><span data-line="3147">        <span class="c1"># based on current DB pks, then flush, then if pks changed in that</span>
</span><span data-line="3148">        <span class="c1"># flush, crash.  this was unticketed but discovered as part of</span>
</span><span data-line="3149">        <span class="c1"># #8703.  So here, autoflush up front, dont autoflush inside</span>
</span><span data-line="3150">        <span class="c1"># load_on_ident.</span>
</span><span data-line="3151">        <span class="bp">self</span><span class="o">.</span><span class="n">_autoflush</span><span class="p">()</span>
</span><span data-line="3152">
</span><span data-line="3153">        <span class="k">if</span> <span class="n">with_for_update</span> <span class="o">==</span> <span class="p">{}:</span>
</span><span data-line="3154">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="3155">                <span class="s2">&quot;with_for_update should be the boolean value &quot;</span>
</span><span data-line="3156">                <span class="s2">&quot;True, or a dictionary with options.  &quot;</span>
</span><span data-line="3157">                <span class="s2">&quot;A blank dictionary is ambiguous.&quot;</span>
</span><span data-line="3158">            <span class="p">)</span>
</span><span data-line="3159">
</span><span data-line="3160">        <span class="n">with_for_update</span> <span class="o">=</span> <span class="n">ForUpdateArg</span><span class="o">.</span><span class="n">_from_argument</span><span class="p">(</span><span class="n">with_for_update</span><span class="p">)</span>
</span><span data-line="3161">
</span><span data-line="3162">        <span class="n">stmt</span><span class="p">:</span> <span class="n">Select</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">object_mapper</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
</span><span data-line="3163">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="3164">            <span class="n">loading</span><span class="o">.</span><span class="n">load_on_ident</span><span class="p">(</span>
</span><span data-line="3165">                <span class="bp">self</span><span class="p">,</span>
</span><span data-line="3166">                <span class="n">stmt</span><span class="p">,</span>
</span><span data-line="3167">                <span class="n">state</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span data-line="3168">                <span class="n">refresh_state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
</span><span data-line="3169">                <span class="n">with_for_update</span><span class="o">=</span><span class="n">with_for_update</span><span class="p">,</span>
</span><span data-line="3170">                <span class="n">only_load_props</span><span class="o">=</span><span class="n">attribute_names</span><span class="p">,</span>
</span><span data-line="3171">                <span class="n">require_pk_cols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="3172">                <span class="c1"># technically unnecessary as we just did autoflush</span>
</span><span data-line="3173">                <span class="c1"># above, however removes the additional unnecessary</span>
</span><span data-line="3174">                <span class="c1"># call to _autoflush()</span>
</span><span data-line="3175">                <span class="n">no_autoflush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="3176">                <span class="n">is_user_refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="3177">            <span class="p">)</span>
</span><span data-line="3178">            <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="3179">        <span class="p">):</span>
</span><span data-line="3180">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="3181">                <span class="s2">&quot;Could not refresh instance &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">instance_str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="3182">            <span class="p">)</span>
</span><span data-line="3183">
</span><span data-line="3184">    <span class="k">def</span> <span class="nf">expire_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3185"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Expires all persistent instances within this Session.</span>
</span><span data-line="3186">
</span><span data-line="3187"><span class="sd">        When any attributes on a persistent instance is next accessed,</span>
</span><span data-line="3188"><span class="sd">        a query will be issued using the</span>
</span><span data-line="3189"><span class="sd">        :class:`.Session` object&#39;s current transactional context in order to</span>
</span><span data-line="3190"><span class="sd">        load all expired attributes for the given instance.   Note that</span>
</span><span data-line="3191"><span class="sd">        a highly isolated transaction will return the same values as were</span>
</span><span data-line="3192"><span class="sd">        previously read in that same transaction, regardless of changes</span>
</span><span data-line="3193"><span class="sd">        in database state outside of that transaction.</span>
</span><span data-line="3194">
</span><span data-line="3195"><span class="sd">        To expire individual objects and individual attributes</span>
</span><span data-line="3196"><span class="sd">        on those objects, use :meth:`Session.expire`.</span>
</span><span data-line="3197">
</span><span data-line="3198"><span class="sd">        The :class:`.Session` object&#39;s default behavior is to</span>
</span><span data-line="3199"><span class="sd">        expire all state whenever the :meth:`Session.rollback`</span>
</span><span data-line="3200"><span class="sd">        or :meth:`Session.commit` methods are called, so that new</span>
</span><span data-line="3201"><span class="sd">        state can be loaded for the new transaction.   For this reason,</span>
</span><span data-line="3202"><span class="sd">        calling :meth:`Session.expire_all` is not usually needed,</span>
</span><span data-line="3203"><span class="sd">        assuming the transaction is isolated.</span>
</span><span data-line="3204">
</span><span data-line="3205"><span class="sd">        .. seealso::</span>
</span><span data-line="3206">
</span><span data-line="3207"><span class="sd">            :ref:`session_expire` - introductory material</span>
</span><span data-line="3208">
</span><span data-line="3209"><span class="sd">            :meth:`.Session.expire`</span>
</span><span data-line="3210">
</span><span data-line="3211"><span class="sd">            :meth:`.Session.refresh`</span>
</span><span data-line="3212">
</span><span data-line="3213"><span class="sd">            :meth:`_orm.Query.populate_existing`</span>
</span><span data-line="3214">
</span><span data-line="3215"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3216">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">all_states</span><span class="p">():</span>
</span><span data-line="3217">            <span class="n">state</span><span class="o">.</span><span class="n">_expire</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="p">)</span>
</span><span data-line="3218">
</span><span data-line="3219">    <span class="k">def</span> <span class="nf">expire</span><span class="p">(</span>
</span><span data-line="3220">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="3221">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3222"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Expire the attributes on an instance.</span>
</span><span data-line="3223">
</span><span data-line="3224"><span class="sd">        Marks the attributes of an instance as out of date. When an expired</span>
</span><span data-line="3225"><span class="sd">        attribute is next accessed, a query will be issued to the</span>
</span><span data-line="3226"><span class="sd">        :class:`.Session` object&#39;s current transactional context in order to</span>
</span><span data-line="3227"><span class="sd">        load all expired attributes for the given instance.   Note that</span>
</span><span data-line="3228"><span class="sd">        a highly isolated transaction will return the same values as were</span>
</span><span data-line="3229"><span class="sd">        previously read in that same transaction, regardless of changes</span>
</span><span data-line="3230"><span class="sd">        in database state outside of that transaction.</span>
</span><span data-line="3231">
</span><span data-line="3232"><span class="sd">        To expire all objects in the :class:`.Session` simultaneously,</span>
</span><span data-line="3233"><span class="sd">        use :meth:`Session.expire_all`.</span>
</span><span data-line="3234">
</span><span data-line="3235"><span class="sd">        The :class:`.Session` object&#39;s default behavior is to</span>
</span><span data-line="3236"><span class="sd">        expire all state whenever the :meth:`Session.rollback`</span>
</span><span data-line="3237"><span class="sd">        or :meth:`Session.commit` methods are called, so that new</span>
</span><span data-line="3238"><span class="sd">        state can be loaded for the new transaction.   For this reason,</span>
</span><span data-line="3239"><span class="sd">        calling :meth:`Session.expire` only makes sense for the specific</span>
</span><span data-line="3240"><span class="sd">        case that a non-ORM SQL statement was emitted in the current</span>
</span><span data-line="3241"><span class="sd">        transaction.</span>
</span><span data-line="3242">
</span><span data-line="3243"><span class="sd">        :param instance: The instance to be refreshed.</span>
</span><span data-line="3244"><span class="sd">        :param attribute_names: optional list of string attribute names</span>
</span><span data-line="3245"><span class="sd">          indicating a subset of attributes to be expired.</span>
</span><span data-line="3246">
</span><span data-line="3247"><span class="sd">        .. seealso::</span>
</span><span data-line="3248">
</span><span data-line="3249"><span class="sd">            :ref:`session_expire` - introductory material</span>
</span><span data-line="3250">
</span><span data-line="3251"><span class="sd">            :meth:`.Session.expire`</span>
</span><span data-line="3252">
</span><span data-line="3253"><span class="sd">            :meth:`.Session.refresh`</span>
</span><span data-line="3254">
</span><span data-line="3255"><span class="sd">            :meth:`_orm.Query.populate_existing`</span>
</span><span data-line="3256">
</span><span data-line="3257"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3258">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="3259">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="3260">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="3261">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span data-line="3262">        <span class="bp">self</span><span class="o">.</span><span class="n">_expire_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">)</span>
</span><span data-line="3263">
</span><span data-line="3264">    <span class="k">def</span> <span class="nf">_expire_state</span><span class="p">(</span>
</span><span data-line="3265">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="3266">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="3267">        <span class="n">attribute_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
</span><span data-line="3268">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3269">        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_persistent</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3270">        <span class="k">if</span> <span class="n">attribute_names</span><span class="p">:</span>
</span><span data-line="3271">            <span class="n">state</span><span class="o">.</span><span class="n">_expire_attributes</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">)</span>
</span><span data-line="3272">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="3273">            <span class="c1"># pre-fetch the full cascade since the expire is going to</span>
</span><span data-line="3274">            <span class="c1"># remove associations</span>
</span><span data-line="3275">            <span class="n">cascaded</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span data-line="3276">                <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">cascade_iterator</span><span class="p">(</span><span class="s2">&quot;refresh-expire&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span data-line="3277">            <span class="p">)</span>
</span><span data-line="3278">            <span class="bp">self</span><span class="o">.</span><span class="n">_conditional_expire</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3279">            <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">st_</span><span class="p">,</span> <span class="n">dct_</span> <span class="ow">in</span> <span class="n">cascaded</span><span class="p">:</span>
</span><span data-line="3280">                <span class="bp">self</span><span class="o">.</span><span class="n">_conditional_expire</span><span class="p">(</span><span class="n">st_</span><span class="p">)</span>
</span><span data-line="3281">
</span><span data-line="3282">    <span class="k">def</span> <span class="nf">_conditional_expire</span><span class="p">(</span>
</span><span data-line="3283">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">autoflush</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="3284">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3285"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Expire a state if persistent, else expunge if pending&quot;&quot;&quot;</span>
</span><span data-line="3286">
</span><span data-line="3287">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span data-line="3288">            <span class="n">state</span><span class="o">.</span><span class="n">_expire</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="p">)</span>
</span><span data-line="3289">        <span class="k">elif</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
</span><span data-line="3290">            <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3291">            <span class="n">state</span><span class="o">.</span><span class="n">_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="3292">
</span><span data-line="3293">    <span class="k">def</span> <span class="nf">expunge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3294"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the `instance` from this ``Session``.</span>
</span><span data-line="3295">
</span><span data-line="3296"><span class="sd">        This will free all internal references to the instance.  Cascading</span>
</span><span data-line="3297"><span class="sd">        will be applied according to the *expunge* cascade rule.</span>
</span><span data-line="3298">
</span><span data-line="3299"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3300">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="3301">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="3302">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="3303">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span data-line="3304">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span><span class="p">:</span>
</span><span data-line="3305">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="3306">                <span class="s2">&quot;Instance </span><span class="si">%s</span><span class="s2"> is not present in this Session&quot;</span> <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3307">            <span class="p">)</span>
</span><span data-line="3308">
</span><span data-line="3309">        <span class="n">cascaded</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span data-line="3310">            <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">cascade_iterator</span><span class="p">(</span><span class="s2">&quot;expunge&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span data-line="3311">        <span class="p">)</span>
</span><span data-line="3312">        <span class="bp">self</span><span class="o">.</span><span class="n">_expunge_states</span><span class="p">([</span><span class="n">state</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">st_</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">st_</span><span class="p">,</span> <span class="n">dct_</span> <span class="ow">in</span> <span class="n">cascaded</span><span class="p">])</span>
</span><span data-line="3313">
</span><span data-line="3314">    <span class="k">def</span> <span class="nf">_expunge_states</span><span class="p">(</span>
</span><span data-line="3315">        <span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">to_transient</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="3316">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3317">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span data-line="3318">            <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
</span><span data-line="3319">                <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3320">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">contains_state</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
</span><span data-line="3321">                <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">safe_discard</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3322">                <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="3323">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">:</span>
</span><span data-line="3324">                <span class="c1"># state is &quot;detached&quot; from being deleted, but still present</span>
</span><span data-line="3325">                <span class="c1"># in the transaction snapshot</span>
</span><span data-line="3326">                <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="3327">        <span class="n">statelib</span><span class="o">.</span><span class="n">InstanceState</span><span class="o">.</span><span class="n">_detach_states</span><span class="p">(</span>
</span><span data-line="3328">            <span class="n">states</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">to_transient</span><span class="o">=</span><span class="n">to_transient</span>
</span><span data-line="3329">        <span class="p">)</span>
</span><span data-line="3330">
</span><span data-line="3331">    <span class="k">def</span> <span class="nf">_register_persistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3332"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Register all persistent objects from a flush.</span>
</span><span data-line="3333">
</span><span data-line="3334"><span class="sd">        This is used both for pending objects moving to the persistent</span>
</span><span data-line="3335"><span class="sd">        state as well as already persistent objects.</span>
</span><span data-line="3336">
</span><span data-line="3337"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3338">
</span><span data-line="3339">        <span class="n">pending_to_persistent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">pending_to_persistent</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span data-line="3340">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span data-line="3341">            <span class="n">mapper</span> <span class="o">=</span> <span class="n">_state_mapper</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3342">
</span><span data-line="3343">            <span class="c1"># prevent against last minute dereferences of the object</span>
</span><span data-line="3344">            <span class="n">obj</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span>
</span><span data-line="3345">            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3346">                <span class="n">instance_key</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_identity_key_from_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3347">
</span><span data-line="3348">                <span class="k">if</span> <span class="p">(</span>
</span><span data-line="3349">                    <span class="n">_none_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">instance_key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span data-line="3350">                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">mapper</span><span class="o">.</span><span class="n">allow_partial_pks</span>
</span><span data-line="3351">                    <span class="ow">or</span> <span class="n">_none_set</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">instance_key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span data-line="3352">                <span class="p">):</span>
</span><span data-line="3353">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">FlushError</span><span class="p">(</span>
</span><span data-line="3354">                        <span class="s2">&quot;Instance </span><span class="si">%s</span><span class="s2"> has a NULL identity key.  If this is an &quot;</span>
</span><span data-line="3355">                        <span class="s2">&quot;auto-generated value, check that the database table &quot;</span>
</span><span data-line="3356">                        <span class="s2">&quot;allows generation of new primary key values, and &quot;</span>
</span><span data-line="3357">                        <span class="s2">&quot;that the mapped Column object is configured to &quot;</span>
</span><span data-line="3358">                        <span class="s2">&quot;expect these generated values.  Ensure also that &quot;</span>
</span><span data-line="3359">                        <span class="s2">&quot;this flush() is not occurring at an inappropriate &quot;</span>
</span><span data-line="3360">                        <span class="s2">&quot;time, such as within a load() event.&quot;</span>
</span><span data-line="3361">                        <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3362">                    <span class="p">)</span>
</span><span data-line="3363">
</span><span data-line="3364">                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3365">                    <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">instance_key</span>
</span><span data-line="3366">                <span class="k">elif</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">instance_key</span><span class="p">:</span>
</span><span data-line="3367">                    <span class="c1"># primary key switch. use safe_discard() in case another</span>
</span><span data-line="3368">                    <span class="c1"># state has already replaced this one in the identity</span>
</span><span data-line="3369">                    <span class="c1"># map (see test/orm/test_naturalpks.py ReversePKsTest)</span>
</span><span data-line="3370">                    <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">safe_discard</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3371">                    <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span data-line="3372">                    <span class="k">assert</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="3373">                    <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">trans</span><span class="o">.</span><span class="n">_key_switches</span><span class="p">:</span>
</span><span data-line="3374">                        <span class="n">orig_key</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">_key_switches</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="3375">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="3376">                        <span class="n">orig_key</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="3377">                    <span class="n">trans</span><span class="o">.</span><span class="n">_key_switches</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="3378">                        <span class="n">orig_key</span><span class="p">,</span>
</span><span data-line="3379">                        <span class="n">instance_key</span><span class="p">,</span>
</span><span data-line="3380">                    <span class="p">)</span>
</span><span data-line="3381">                    <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">instance_key</span>
</span><span data-line="3382">
</span><span data-line="3383">                <span class="c1"># there can be an existing state in the identity map</span>
</span><span data-line="3384">                <span class="c1"># that is replaced when the primary keys of two instances</span>
</span><span data-line="3385">                <span class="c1"># are swapped; see test/orm/test_naturalpks.py -&gt; test_reverse</span>
</span><span data-line="3386">                <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3387">                <span class="k">if</span> <span class="p">(</span>
</span><span data-line="3388">                    <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="3389">                    <span class="ow">and</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_identity_key_from_state</span><span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="o">==</span> <span class="n">instance_key</span>
</span><span data-line="3390">                    <span class="ow">and</span> <span class="n">old</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="3391">                <span class="p">):</span>
</span><span data-line="3392">                    <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="3393">                        <span class="s2">&quot;Identity map already had an identity for </span><span class="si">%s</span><span class="s2">, &quot;</span>
</span><span data-line="3394">                        <span class="s2">&quot;replacing it with newly flushed object.   Are there &quot;</span>
</span><span data-line="3395">                        <span class="s2">&quot;load operations occurring inside of an event handler &quot;</span>
</span><span data-line="3396">                        <span class="s2">&quot;within the flush?&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">instance_key</span><span class="p">,)</span>
</span><span data-line="3397">                    <span class="p">)</span>
</span><span data-line="3398">                <span class="n">state</span><span class="o">.</span><span class="n">_orphaned_outside_of_session</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="3399">
</span><span data-line="3400">        <span class="n">statelib</span><span class="o">.</span><span class="n">InstanceState</span><span class="o">.</span><span class="n">_commit_all_states</span><span class="p">(</span>
</span><span data-line="3401">            <span class="p">((</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span>
</span><span data-line="3402">        <span class="p">)</span>
</span><span data-line="3403">
</span><span data-line="3404">        <span class="bp">self</span><span class="o">.</span><span class="n">_register_altered</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
</span><span data-line="3405">
</span><span data-line="3406">        <span class="k">if</span> <span class="n">pending_to_persistent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3407">            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">):</span>
</span><span data-line="3408">                <span class="n">pending_to_persistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span data-line="3409">
</span><span data-line="3410">        <span class="c1"># remove from new last, might be the last strong ref</span>
</span><span data-line="3411">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">):</span>
</span><span data-line="3412">            <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3413">
</span><span data-line="3414">    <span class="k">def</span> <span class="nf">_register_altered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3415">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">:</span>
</span><span data-line="3416">            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span data-line="3417">                <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
</span><span data-line="3418">                    <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_new</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="3419">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="3420">                    <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_dirty</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="3421">
</span><span data-line="3422">    <span class="k">def</span> <span class="nf">_remove_newly_deleted</span><span class="p">(</span>
</span><span data-line="3423">        <span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="3424">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3425">        <span class="n">persistent_to_deleted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">persistent_to_deleted</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span data-line="3426">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span data-line="3427">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">:</span>
</span><span data-line="3428">                <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_deleted</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="3429">
</span><span data-line="3430">            <span class="k">if</span> <span class="n">persistent_to_deleted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3431">                <span class="c1"># get a strong reference before we pop out of</span>
</span><span data-line="3432">                <span class="c1"># self._deleted</span>
</span><span data-line="3433">                <span class="n">obj</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span>  <span class="c1"># noqa</span>
</span><span data-line="3434">
</span><span data-line="3435">            <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">safe_discard</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3436">            <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="3437">            <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="3438">            <span class="c1"># can&#39;t call state._detach() here, because this state</span>
</span><span data-line="3439">            <span class="c1"># is still in the transaction snapshot and needs to be</span>
</span><span data-line="3440">            <span class="c1"># tracked as part of that</span>
</span><span data-line="3441">            <span class="k">if</span> <span class="n">persistent_to_deleted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3442">                <span class="n">persistent_to_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span data-line="3443">
</span><span data-line="3444">    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">_warn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3445"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Place an object into this :class:`_orm.Session`.</span>
</span><span data-line="3446">
</span><span data-line="3447"><span class="sd">        Objects that are in the :term:`transient` state when passed to the</span>
</span><span data-line="3448"><span class="sd">        :meth:`_orm.Session.add` method will move to the</span>
</span><span data-line="3449"><span class="sd">        :term:`pending` state, until the next flush, at which point they</span>
</span><span data-line="3450"><span class="sd">        will move to the :term:`persistent` state.</span>
</span><span data-line="3451">
</span><span data-line="3452"><span class="sd">        Objects that are in the :term:`detached` state when passed to the</span>
</span><span data-line="3453"><span class="sd">        :meth:`_orm.Session.add` method will move to the :term:`persistent`</span>
</span><span data-line="3454"><span class="sd">        state directly.</span>
</span><span data-line="3455">
</span><span data-line="3456"><span class="sd">        If the transaction used by the :class:`_orm.Session` is rolled back,</span>
</span><span data-line="3457"><span class="sd">        objects which were transient when they were passed to</span>
</span><span data-line="3458"><span class="sd">        :meth:`_orm.Session.add` will be moved back to the</span>
</span><span data-line="3459"><span class="sd">        :term:`transient` state, and will no longer be present within this</span>
</span><span data-line="3460"><span class="sd">        :class:`_orm.Session`.</span>
</span><span data-line="3461">
</span><span data-line="3462"><span class="sd">        .. seealso::</span>
</span><span data-line="3463">
</span><span data-line="3464"><span class="sd">            :meth:`_orm.Session.add_all`</span>
</span><span data-line="3465">
</span><span data-line="3466"><span class="sd">            :ref:`session_adding` - at :ref:`session_basics`</span>
</span><span data-line="3467">
</span><span data-line="3468"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3469">        <span class="k">if</span> <span class="n">_warn</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span><span class="p">:</span>
</span><span data-line="3470">            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_warning</span><span class="p">(</span><span class="s2">&quot;Session.add()&quot;</span><span class="p">)</span>
</span><span data-line="3471">
</span><span data-line="3472">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="3473">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="3474">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="3475">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span data-line="3476">
</span><span data-line="3477">        <span class="bp">self</span><span class="o">.</span><span class="n">_save_or_update_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3478">
</span><span data-line="3479">    <span class="k">def</span> <span class="nf">add_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3480"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the given collection of instances to this :class:`_orm.Session`.</span>
</span><span data-line="3481">
</span><span data-line="3482"><span class="sd">        See the documentation for :meth:`_orm.Session.add` for a general</span>
</span><span data-line="3483"><span class="sd">        behavioral description.</span>
</span><span data-line="3484">
</span><span data-line="3485"><span class="sd">        .. seealso::</span>
</span><span data-line="3486">
</span><span data-line="3487"><span class="sd">            :meth:`_orm.Session.add`</span>
</span><span data-line="3488">
</span><span data-line="3489"><span class="sd">            :ref:`session_adding` - at :ref:`session_basics`</span>
</span><span data-line="3490">
</span><span data-line="3491"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3492">
</span><span data-line="3493">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span><span class="p">:</span>
</span><span data-line="3494">            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_warning</span><span class="p">(</span><span class="s2">&quot;Session.add_all()&quot;</span><span class="p">)</span>
</span><span data-line="3495">
</span><span data-line="3496">        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span data-line="3497">            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">_warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="3498">
</span><span data-line="3499">    <span class="k">def</span> <span class="nf">_save_or_update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3500">        <span class="n">state</span><span class="o">.</span><span class="n">_orphaned_outside_of_session</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="3501">        <span class="bp">self</span><span class="o">.</span><span class="n">_save_or_update_impl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3502">
</span><span data-line="3503">        <span class="n">mapper</span> <span class="o">=</span> <span class="n">_state_mapper</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3504">        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">st_</span><span class="p">,</span> <span class="n">dct_</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">cascade_iterator</span><span class="p">(</span>
</span><span data-line="3505">            <span class="s2">&quot;save-update&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">halt_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_contains_state</span>
</span><span data-line="3506">        <span class="p">):</span>
</span><span data-line="3507">            <span class="bp">self</span><span class="o">.</span><span class="n">_save_or_update_impl</span><span class="p">(</span><span class="n">st_</span><span class="p">)</span>
</span><span data-line="3508">
</span><span data-line="3509">    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3510"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark an instance as deleted.</span>
</span><span data-line="3511">
</span><span data-line="3512"><span class="sd">        The object is assumed to be either :term:`persistent` or</span>
</span><span data-line="3513"><span class="sd">        :term:`detached` when passed; after the method is called, the</span>
</span><span data-line="3514"><span class="sd">        object will remain in the :term:`persistent` state until the next</span>
</span><span data-line="3515"><span class="sd">        flush proceeds.  During this time, the object will also be a member</span>
</span><span data-line="3516"><span class="sd">        of the :attr:`_orm.Session.deleted` collection.</span>
</span><span data-line="3517">
</span><span data-line="3518"><span class="sd">        When the next flush proceeds, the object will move to the</span>
</span><span data-line="3519"><span class="sd">        :term:`deleted` state, indicating a ``DELETE`` statement was emitted</span>
</span><span data-line="3520"><span class="sd">        for its row within the current transaction.   When the transaction</span>
</span><span data-line="3521"><span class="sd">        is successfully committed,</span>
</span><span data-line="3522"><span class="sd">        the deleted object is moved to the :term:`detached` state and is</span>
</span><span data-line="3523"><span class="sd">        no longer present within this :class:`_orm.Session`.</span>
</span><span data-line="3524">
</span><span data-line="3525"><span class="sd">        .. seealso::</span>
</span><span data-line="3526">
</span><span data-line="3527"><span class="sd">            :ref:`session_deleting` - at :ref:`session_basics`</span>
</span><span data-line="3528">
</span><span data-line="3529"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3530">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span><span class="p">:</span>
</span><span data-line="3531">            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_warning</span><span class="p">(</span><span class="s2">&quot;Session.delete()&quot;</span><span class="p">)</span>
</span><span data-line="3532">
</span><span data-line="3533">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="3534">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="3535">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="3536">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span data-line="3537">
</span><span data-line="3538">        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_impl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="3539">
</span><span data-line="3540">    <span class="k">def</span> <span class="nf">_delete_impl</span><span class="p">(</span>
</span><span data-line="3541">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">head</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="3542">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3543">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3544">            <span class="k">if</span> <span class="n">head</span><span class="p">:</span>
</span><span data-line="3545">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="3546">                    <span class="s2">&quot;Instance &#39;</span><span class="si">%s</span><span class="s2">&#39; is not persisted&quot;</span> <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3547">                <span class="p">)</span>
</span><span data-line="3548">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="3549">                <span class="k">return</span>
</span><span data-line="3550">
</span><span data-line="3551">        <span class="n">to_attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="3552">
</span><span data-line="3553">        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="p">:</span>
</span><span data-line="3554">            <span class="k">return</span>
</span><span data-line="3555">
</span><span data-line="3556">        <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3557">
</span><span data-line="3558">        <span class="k">if</span> <span class="n">to_attach</span><span class="p">:</span>
</span><span data-line="3559">            <span class="bp">self</span><span class="o">.</span><span class="n">_after_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="3560">
</span><span data-line="3561">        <span class="k">if</span> <span class="n">head</span><span class="p">:</span>
</span><span data-line="3562">            <span class="c1"># grab the cascades before adding the item to the deleted list</span>
</span><span data-line="3563">            <span class="c1"># so that autoflush does not delete the item</span>
</span><span data-line="3564">            <span class="c1"># the strong reference to the instance itself is significant here</span>
</span><span data-line="3565">            <span class="n">cascade_states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span data-line="3566">                <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">cascade_iterator</span><span class="p">(</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span data-line="3567">            <span class="p">)</span>
</span><span data-line="3568">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="3569">            <span class="n">cascade_states</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="3570">
</span><span data-line="3571">        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span><span data-line="3572">
</span><span data-line="3573">        <span class="k">if</span> <span class="n">head</span><span class="p">:</span>
</span><span data-line="3574">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="3575">                <span class="k">assert</span> <span class="n">cascade_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="3576">            <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">st_</span><span class="p">,</span> <span class="n">dct_</span> <span class="ow">in</span> <span class="n">cascade_states</span><span class="p">:</span>
</span><span data-line="3577">                <span class="bp">self</span><span class="o">.</span><span class="n">_delete_impl</span><span class="p">(</span><span class="n">st_</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span data-line="3578">
</span><span data-line="3579">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
</span><span data-line="3580">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="3581">        <span class="n">entity</span><span class="p">:</span> <span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="3582">        <span class="n">ident</span><span class="p">:</span> <span class="n">_PKIdentityArgument</span><span class="p">,</span>
</span><span data-line="3583">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="3584">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3585">        <span class="n">populate_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="3586">        <span class="n">with_for_update</span><span class="p">:</span> <span class="n">ForUpdateParameter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3587">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3588">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="3589">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3590">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span data-line="3591"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an instance based on the given primary key identifier,</span>
</span><span data-line="3592"><span class="sd">        or ``None`` if not found.</span>
</span><span data-line="3593">
</span><span data-line="3594"><span class="sd">        E.g.::</span>
</span><span data-line="3595">
</span><span data-line="3596"><span class="sd">            my_user = session.get(User, 5)</span>
</span><span data-line="3597">
</span><span data-line="3598"><span class="sd">            some_object = session.get(VersionedFoo, (5, 10))</span>
</span><span data-line="3599">
</span><span data-line="3600"><span class="sd">            some_object = session.get(</span>
</span><span data-line="3601"><span class="sd">                VersionedFoo,</span>
</span><span data-line="3602"><span class="sd">                {&quot;id&quot;: 5, &quot;version_id&quot;: 10}</span>
</span><span data-line="3603"><span class="sd">            )</span>
</span><span data-line="3604">
</span><span data-line="3605"><span class="sd">        .. versionadded:: 1.4 Added :meth:`_orm.Session.get`, which is moved</span>
</span><span data-line="3606"><span class="sd">           from the now legacy :meth:`_orm.Query.get` method.</span>
</span><span data-line="3607">
</span><span data-line="3608"><span class="sd">        :meth:`_orm.Session.get` is special in that it provides direct</span>
</span><span data-line="3609"><span class="sd">        access to the identity map of the :class:`.Session`.</span>
</span><span data-line="3610"><span class="sd">        If the given primary key identifier is present</span>
</span><span data-line="3611"><span class="sd">        in the local identity map, the object is returned</span>
</span><span data-line="3612"><span class="sd">        directly from this collection and no SQL is emitted,</span>
</span><span data-line="3613"><span class="sd">        unless the object has been marked fully expired.</span>
</span><span data-line="3614"><span class="sd">        If not present,</span>
</span><span data-line="3615"><span class="sd">        a SELECT is performed in order to locate the object.</span>
</span><span data-line="3616">
</span><span data-line="3617"><span class="sd">        :meth:`_orm.Session.get` also will perform a check if</span>
</span><span data-line="3618"><span class="sd">        the object is present in the identity map and</span>
</span><span data-line="3619"><span class="sd">        marked as expired - a SELECT</span>
</span><span data-line="3620"><span class="sd">        is emitted to refresh the object as well as to</span>
</span><span data-line="3621"><span class="sd">        ensure that the row is still present.</span>
</span><span data-line="3622"><span class="sd">        If not, :class:`~sqlalchemy.orm.exc.ObjectDeletedError` is raised.</span>
</span><span data-line="3623">
</span><span data-line="3624"><span class="sd">        :param entity: a mapped class or :class:`.Mapper` indicating the</span>
</span><span data-line="3625"><span class="sd">         type of entity to be loaded.</span>
</span><span data-line="3626">
</span><span data-line="3627"><span class="sd">        :param ident: A scalar, tuple, or dictionary representing the</span>
</span><span data-line="3628"><span class="sd">         primary key.  For a composite (e.g. multiple column) primary key,</span>
</span><span data-line="3629"><span class="sd">         a tuple or dictionary should be passed.</span>
</span><span data-line="3630">
</span><span data-line="3631"><span class="sd">         For a single-column primary key, the scalar calling form is typically</span>
</span><span data-line="3632"><span class="sd">         the most expedient.  If the primary key of a row is the value &quot;5&quot;,</span>
</span><span data-line="3633"><span class="sd">         the call looks like::</span>
</span><span data-line="3634">
</span><span data-line="3635"><span class="sd">            my_object = session.get(SomeClass, 5)</span>
</span><span data-line="3636">
</span><span data-line="3637"><span class="sd">         The tuple form contains primary key values typically in</span>
</span><span data-line="3638"><span class="sd">         the order in which they correspond to the mapped</span>
</span><span data-line="3639"><span class="sd">         :class:`_schema.Table`</span>
</span><span data-line="3640"><span class="sd">         object&#39;s primary key columns, or if the</span>
</span><span data-line="3641"><span class="sd">         :paramref:`_orm.Mapper.primary_key` configuration parameter were</span>
</span><span data-line="3642"><span class="sd">         used, in</span>
</span><span data-line="3643"><span class="sd">         the order used for that parameter. For example, if the primary key</span>
</span><span data-line="3644"><span class="sd">         of a row is represented by the integer</span>
</span><span data-line="3645"><span class="sd">         digits &quot;5, 10&quot; the call would look like::</span>
</span><span data-line="3646">
</span><span data-line="3647"><span class="sd">             my_object = session.get(SomeClass, (5, 10))</span>
</span><span data-line="3648">
</span><span data-line="3649"><span class="sd">         The dictionary form should include as keys the mapped attribute names</span>
</span><span data-line="3650"><span class="sd">         corresponding to each element of the primary key.  If the mapped class</span>
</span><span data-line="3651"><span class="sd">         has the attributes ``id``, ``version_id`` as the attributes which</span>
</span><span data-line="3652"><span class="sd">         store the object&#39;s primary key value, the call would look like::</span>
</span><span data-line="3653">
</span><span data-line="3654"><span class="sd">            my_object = session.get(SomeClass, {&quot;id&quot;: 5, &quot;version_id&quot;: 10})</span>
</span><span data-line="3655">
</span><span data-line="3656"><span class="sd">        :param options: optional sequence of loader options which will be</span>
</span><span data-line="3657"><span class="sd">         applied to the query, if one is emitted.</span>
</span><span data-line="3658">
</span><span data-line="3659"><span class="sd">        :param populate_existing: causes the method to unconditionally emit</span>
</span><span data-line="3660"><span class="sd">         a SQL query and refresh the object with the newly loaded data,</span>
</span><span data-line="3661"><span class="sd">         regardless of whether or not the object is already present.</span>
</span><span data-line="3662">
</span><span data-line="3663"><span class="sd">        :param with_for_update: optional boolean ``True`` indicating FOR UPDATE</span>
</span><span data-line="3664"><span class="sd">          should be used, or may be a dictionary containing flags to</span>
</span><span data-line="3665"><span class="sd">          indicate a more specific set of FOR UPDATE flags for the SELECT;</span>
</span><span data-line="3666"><span class="sd">          flags should match the parameters of</span>
</span><span data-line="3667"><span class="sd">          :meth:`_query.Query.with_for_update`.</span>
</span><span data-line="3668"><span class="sd">          Supersedes the :paramref:`.Session.refresh.lockmode` parameter.</span>
</span><span data-line="3669">
</span><span data-line="3670"><span class="sd">        :param execution_options: optional dictionary of execution options,</span>
</span><span data-line="3671"><span class="sd">         which will be associated with the query execution if one is emitted.</span>
</span><span data-line="3672"><span class="sd">         This dictionary can provide a subset of the options that are</span>
</span><span data-line="3673"><span class="sd">         accepted by :meth:`_engine.Connection.execution_options`, and may</span>
</span><span data-line="3674"><span class="sd">         also provide additional options understood only in an ORM context.</span>
</span><span data-line="3675">
</span><span data-line="3676"><span class="sd">         .. versionadded:: 1.4.29</span>
</span><span data-line="3677">
</span><span data-line="3678"><span class="sd">         .. seealso::</span>
</span><span data-line="3679">
</span><span data-line="3680"><span class="sd">            :ref:`orm_queryguide_execution_options` - ORM-specific execution</span>
</span><span data-line="3681"><span class="sd">            options</span>
</span><span data-line="3682">
</span><span data-line="3683"><span class="sd">        :param bind_arguments: dictionary of additional arguments to determine</span>
</span><span data-line="3684"><span class="sd">         the bind.  May include &quot;mapper&quot;, &quot;bind&quot;, or other custom arguments.</span>
</span><span data-line="3685"><span class="sd">         Contents of this dictionary are passed to the</span>
</span><span data-line="3686"><span class="sd">         :meth:`.Session.get_bind` method.</span>
</span><span data-line="3687">
</span><span data-line="3688"><span class="sd">         .. versionadded: 2.0.0rc1</span>
</span><span data-line="3689">
</span><span data-line="3690"><span class="sd">        :return: The object instance, or ``None``.</span>
</span><span data-line="3691">
</span><span data-line="3692"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3693">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_impl</span><span class="p">(</span>
</span><span data-line="3694">            <span class="n">entity</span><span class="p">,</span>
</span><span data-line="3695">            <span class="n">ident</span><span class="p">,</span>
</span><span data-line="3696">            <span class="n">loading</span><span class="o">.</span><span class="n">load_on_pk_identity</span><span class="p">,</span>
</span><span data-line="3697">            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span><span data-line="3698">            <span class="n">populate_existing</span><span class="o">=</span><span class="n">populate_existing</span><span class="p">,</span>
</span><span data-line="3699">            <span class="n">with_for_update</span><span class="o">=</span><span class="n">with_for_update</span><span class="p">,</span>
</span><span data-line="3700">            <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span data-line="3701">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="3702">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span data-line="3703">        <span class="p">)</span>
</span><span data-line="3704">
</span><span data-line="3705">    <span class="k">def</span> <span class="nf">get_one</span><span class="p">(</span>
</span><span data-line="3706">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="3707">        <span class="n">entity</span><span class="p">:</span> <span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="3708">        <span class="n">ident</span><span class="p">:</span> <span class="n">_PKIdentityArgument</span><span class="p">,</span>
</span><span data-line="3709">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="3710">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3711">        <span class="n">populate_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="3712">        <span class="n">with_for_update</span><span class="p">:</span> <span class="n">ForUpdateParameter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3713">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3714">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="3715">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3716">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_O</span><span class="p">:</span>
</span><span data-line="3717"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return exactly one instance based on the given primary key</span>
</span><span data-line="3718"><span class="sd">        identifier, or raise an exception if not found.</span>
</span><span data-line="3719">
</span><span data-line="3720"><span class="sd">        Raises ``sqlalchemy.orm.exc.NoResultFound`` if the query</span>
</span><span data-line="3721"><span class="sd">        selects no rows.</span>
</span><span data-line="3722">
</span><span data-line="3723"><span class="sd">        For a detailed documentation of the arguments see the</span>
</span><span data-line="3724"><span class="sd">        method :meth:`.Session.get`.</span>
</span><span data-line="3725">
</span><span data-line="3726"><span class="sd">        .. versionadded:: 2.0.22</span>
</span><span data-line="3727">
</span><span data-line="3728"><span class="sd">        :return: The object instance.</span>
</span><span data-line="3729">
</span><span data-line="3730"><span class="sd">        .. seealso::</span>
</span><span data-line="3731">
</span><span data-line="3732"><span class="sd">            :meth:`.Session.get` - equivalent method that instead</span>
</span><span data-line="3733"><span class="sd">              returns ``None`` if no row was found with the provided primary</span>
</span><span data-line="3734"><span class="sd">              key</span>
</span><span data-line="3735">
</span><span data-line="3736"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3737">
</span><span data-line="3738">        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="3739">            <span class="n">entity</span><span class="p">,</span>
</span><span data-line="3740">            <span class="n">ident</span><span class="p">,</span>
</span><span data-line="3741">            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span><span data-line="3742">            <span class="n">populate_existing</span><span class="o">=</span><span class="n">populate_existing</span><span class="p">,</span>
</span><span data-line="3743">            <span class="n">with_for_update</span><span class="o">=</span><span class="n">with_for_update</span><span class="p">,</span>
</span><span data-line="3744">            <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span data-line="3745">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="3746">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span data-line="3747">        <span class="p">)</span>
</span><span data-line="3748">
</span><span data-line="3749">        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3750">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">NoResultFound</span><span class="p">(</span>
</span><span data-line="3751">                <span class="s2">&quot;No row was found when one was required&quot;</span>
</span><span data-line="3752">            <span class="p">)</span>
</span><span data-line="3753">
</span><span data-line="3754">        <span class="k">return</span> <span class="n">instance</span>
</span><span data-line="3755">
</span><span data-line="3756">    <span class="k">def</span> <span class="nf">_get_impl</span><span class="p">(</span>
</span><span data-line="3757">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="3758">        <span class="n">entity</span><span class="p">:</span> <span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="3759">        <span class="n">primary_key_identity</span><span class="p">:</span> <span class="n">_PKIdentityArgument</span><span class="p">,</span>
</span><span data-line="3760">        <span class="n">db_load_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">_O</span><span class="p">],</span>
</span><span data-line="3761">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="3762">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ExecutableOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3763">        <span class="n">populate_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="3764">        <span class="n">with_for_update</span><span class="p">:</span> <span class="n">ForUpdateParameter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3765">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3766">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span data-line="3767">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3768">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span data-line="3769">        <span class="c1"># convert composite types to individual args</span>
</span><span data-line="3770">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="3771">            <span class="n">is_composite_class</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">)</span>
</span><span data-line="3772">            <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">)</span>
</span><span data-line="3773">            <span class="ow">in</span> <span class="n">descriptor_props</span><span class="o">.</span><span class="n">_composite_getters</span>
</span><span data-line="3774">        <span class="p">):</span>
</span><span data-line="3775">            <span class="n">getter</span> <span class="o">=</span> <span class="n">descriptor_props</span><span class="o">.</span><span class="n">_composite_getters</span><span class="p">[</span>
</span><span data-line="3776">                <span class="nb">type</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">)</span>
</span><span data-line="3777">            <span class="p">]</span>
</span><span data-line="3778">            <span class="n">primary_key_identity</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">)</span>
</span><span data-line="3779">
</span><span data-line="3780">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]]</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
</span><span data-line="3781">
</span><span data-line="3782">        <span class="k">if</span> <span class="n">mapper</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">mapper</span><span class="o">.</span><span class="n">is_mapper</span><span class="p">:</span>
</span><span data-line="3783">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="3784">                <span class="s2">&quot;Expected mapped class or mapper, got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">entity</span>
</span><span data-line="3785">            <span class="p">)</span>
</span><span data-line="3786">
</span><span data-line="3787">        <span class="n">is_dict</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span data-line="3788">        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dict</span><span class="p">:</span>
</span><span data-line="3789">            <span class="n">primary_key_identity</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span>
</span><span data-line="3790">                <span class="n">primary_key_identity</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
</span><span data-line="3791">            <span class="p">)</span>
</span><span data-line="3792">
</span><span data-line="3793">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">primary_key</span><span class="p">):</span>
</span><span data-line="3794">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="3795">                <span class="s2">&quot;Incorrect number of values in identifier to formulate &quot;</span>
</span><span data-line="3796">                <span class="s2">&quot;primary key for session.get(); primary key columns &quot;</span>
</span><span data-line="3797">                <span class="s2">&quot;are </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
</span><span data-line="3798">            <span class="p">)</span>
</span><span data-line="3799">
</span><span data-line="3800">        <span class="k">if</span> <span class="n">is_dict</span><span class="p">:</span>
</span><span data-line="3801">            <span class="n">pk_synonyms</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_pk_synonyms</span>
</span><span data-line="3802">
</span><span data-line="3803">            <span class="k">if</span> <span class="n">pk_synonyms</span><span class="p">:</span>
</span><span data-line="3804">                <span class="n">correct_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pk_synonyms</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
</span><span data-line="3805">                    <span class="n">primary_key_identity</span>
</span><span data-line="3806">                <span class="p">)</span>
</span><span data-line="3807">
</span><span data-line="3808">                <span class="k">if</span> <span class="n">correct_keys</span><span class="p">:</span>
</span><span data-line="3809">                    <span class="n">primary_key_identity</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">)</span>
</span><span data-line="3810">                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">correct_keys</span><span class="p">:</span>
</span><span data-line="3811">                        <span class="n">primary_key_identity</span><span class="p">[</span><span class="n">pk_synonyms</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="3812">                            <span class="n">primary_key_identity</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span data-line="3813">                        <span class="p">)</span>
</span><span data-line="3814">
</span><span data-line="3815">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="3816">                <span class="n">primary_key_identity</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span data-line="3817">                    <span class="n">primary_key_identity</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="3818">                    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_identity_key_props</span>
</span><span data-line="3819">                <span class="p">)</span>
</span><span data-line="3820">
</span><span data-line="3821">            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="3822">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="3823">                    <span class="s2">&quot;Incorrect names of values in identifier to formulate &quot;</span>
</span><span data-line="3824">                    <span class="s2">&quot;primary key for session.get(); primary key attribute &quot;</span>
</span><span data-line="3825">                    <span class="s2">&quot;names are </span><span class="si">%s</span><span class="s2"> (synonym names are also accepted)&quot;</span>
</span><span data-line="3826">                    <span class="o">%</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span data-line="3827">                        <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">prop</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="3828">                        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_identity_key_props</span>
</span><span data-line="3829">                    <span class="p">)</span>
</span><span data-line="3830">                <span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span data-line="3831">
</span><span data-line="3832">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="3833">            <span class="ow">not</span> <span class="n">populate_existing</span>
</span><span data-line="3834">            <span class="ow">and</span> <span class="ow">not</span> <span class="n">mapper</span><span class="o">.</span><span class="n">always_refresh</span>
</span><span data-line="3835">            <span class="ow">and</span> <span class="n">with_for_update</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="3836">        <span class="p">):</span>
</span><span data-line="3837">            <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identity_lookup</span><span class="p">(</span>
</span><span data-line="3838">                <span class="n">mapper</span><span class="p">,</span>
</span><span data-line="3839">                <span class="n">primary_key_identity</span><span class="p">,</span>
</span><span data-line="3840">                <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span data-line="3841">                <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="3842">                <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span data-line="3843">            <span class="p">)</span>
</span><span data-line="3844">
</span><span data-line="3845">            <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3846">                <span class="c1"># reject calls for id in identity map but class</span>
</span><span data-line="3847">                <span class="c1"># mismatch.</span>
</span><span data-line="3848">                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">mapper</span><span class="o">.</span><span class="n">class_</span><span class="p">):</span>
</span><span data-line="3849">                    <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="3850">                <span class="k">return</span> <span class="n">instance</span>
</span><span data-line="3851">
</span><span data-line="3852">            <span class="c1"># TODO: this was being tested before, but this is not possible</span>
</span><span data-line="3853">            <span class="k">assert</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_CLASS_MISMATCH</span>
</span><span data-line="3854">
</span><span data-line="3855">        <span class="c1"># set_label_style() not strictly necessary, however this will ensure</span>
</span><span data-line="3856">        <span class="c1"># that tablename_colname style is used which at the moment is</span>
</span><span data-line="3857">        <span class="c1"># asserted in a lot of unit tests :)</span>
</span><span data-line="3858">
</span><span data-line="3859">        <span class="n">load_options</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">QueryContext</span><span class="o">.</span><span class="n">default_load_options</span>
</span><span data-line="3860">
</span><span data-line="3861">        <span class="k">if</span> <span class="n">populate_existing</span><span class="p">:</span>
</span><span data-line="3862">            <span class="n">load_options</span> <span class="o">+=</span> <span class="p">{</span><span class="s2">&quot;_populate_existing&quot;</span><span class="p">:</span> <span class="n">populate_existing</span><span class="p">}</span>
</span><span data-line="3863">        <span class="n">statement</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span><span class="o">.</span><span class="n">set_label_style</span><span class="p">(</span>
</span><span data-line="3864">            <span class="n">LABEL_STYLE_TABLENAME_PLUS_COL</span>
</span><span data-line="3865">        <span class="p">)</span>
</span><span data-line="3866">        <span class="k">if</span> <span class="n">with_for_update</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3867">            <span class="n">statement</span><span class="o">.</span><span class="n">_for_update_arg</span> <span class="o">=</span> <span class="n">ForUpdateArg</span><span class="o">.</span><span class="n">_from_argument</span><span class="p">(</span>
</span><span data-line="3868">                <span class="n">with_for_update</span>
</span><span data-line="3869">            <span class="p">)</span>
</span><span data-line="3870">
</span><span data-line="3871">        <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
</span><span data-line="3872">            <span class="n">statement</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
</span><span data-line="3873">        <span class="k">return</span> <span class="n">db_load_fn</span><span class="p">(</span>
</span><span data-line="3874">            <span class="bp">self</span><span class="p">,</span>
</span><span data-line="3875">            <span class="n">statement</span><span class="p">,</span>
</span><span data-line="3876">            <span class="n">primary_key_identity</span><span class="p">,</span>
</span><span data-line="3877">            <span class="n">load_options</span><span class="o">=</span><span class="n">load_options</span><span class="p">,</span>
</span><span data-line="3878">            <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span data-line="3879">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span data-line="3880">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span data-line="3881">        <span class="p">)</span>
</span><span data-line="3882">
</span><span data-line="3883">    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span>
</span><span data-line="3884">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="3885">        <span class="n">instance</span><span class="p">:</span> <span class="n">_O</span><span class="p">,</span>
</span><span data-line="3886">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="3887">        <span class="n">load</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="3888">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3889">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_O</span><span class="p">:</span>
</span><span data-line="3890"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy the state of a given instance into a corresponding instance</span>
</span><span data-line="3891"><span class="sd">        within this :class:`.Session`.</span>
</span><span data-line="3892">
</span><span data-line="3893"><span class="sd">        :meth:`.Session.merge` examines the primary key attributes of the</span>
</span><span data-line="3894"><span class="sd">        source instance, and attempts to reconcile it with an instance of the</span>
</span><span data-line="3895"><span class="sd">        same primary key in the session.   If not found locally, it attempts</span>
</span><span data-line="3896"><span class="sd">        to load the object from the database based on primary key, and if</span>
</span><span data-line="3897"><span class="sd">        none can be located, creates a new instance.  The state of each</span>
</span><span data-line="3898"><span class="sd">        attribute on the source instance is then copied to the target</span>
</span><span data-line="3899"><span class="sd">        instance.  The resulting target instance is then returned by the</span>
</span><span data-line="3900"><span class="sd">        method; the original source instance is left unmodified, and</span>
</span><span data-line="3901"><span class="sd">        un-associated with the :class:`.Session` if not already.</span>
</span><span data-line="3902">
</span><span data-line="3903"><span class="sd">        This operation cascades to associated instances if the association is</span>
</span><span data-line="3904"><span class="sd">        mapped with ``cascade=&quot;merge&quot;``.</span>
</span><span data-line="3905">
</span><span data-line="3906"><span class="sd">        See :ref:`unitofwork_merging` for a detailed discussion of merging.</span>
</span><span data-line="3907">
</span><span data-line="3908"><span class="sd">        :param instance: Instance to be merged.</span>
</span><span data-line="3909"><span class="sd">        :param load: Boolean, when False, :meth:`.merge` switches into</span>
</span><span data-line="3910"><span class="sd">         a &quot;high performance&quot; mode which causes it to forego emitting history</span>
</span><span data-line="3911"><span class="sd">         events as well as all database access.  This flag is used for</span>
</span><span data-line="3912"><span class="sd">         cases such as transferring graphs of objects into a :class:`.Session`</span>
</span><span data-line="3913"><span class="sd">         from a second level cache, or to transfer just-loaded objects</span>
</span><span data-line="3914"><span class="sd">         into the :class:`.Session` owned by a worker thread or process</span>
</span><span data-line="3915"><span class="sd">         without re-querying the database.</span>
</span><span data-line="3916">
</span><span data-line="3917"><span class="sd">         The ``load=False`` use case adds the caveat that the given</span>
</span><span data-line="3918"><span class="sd">         object has to be in a &quot;clean&quot; state, that is, has no pending changes</span>
</span><span data-line="3919"><span class="sd">         to be flushed - even if the incoming object is detached from any</span>
</span><span data-line="3920"><span class="sd">         :class:`.Session`.   This is so that when</span>
</span><span data-line="3921"><span class="sd">         the merge operation populates local attributes and</span>
</span><span data-line="3922"><span class="sd">         cascades to related objects and</span>
</span><span data-line="3923"><span class="sd">         collections, the values can be &quot;stamped&quot; onto the</span>
</span><span data-line="3924"><span class="sd">         target object as is, without generating any history or attribute</span>
</span><span data-line="3925"><span class="sd">         events, and without the need to reconcile the incoming data with</span>
</span><span data-line="3926"><span class="sd">         any existing related objects or collections that might not</span>
</span><span data-line="3927"><span class="sd">         be loaded.  The resulting objects from ``load=False`` are always</span>
</span><span data-line="3928"><span class="sd">         produced as &quot;clean&quot;, so it is only appropriate that the given objects</span>
</span><span data-line="3929"><span class="sd">         should be &quot;clean&quot; as well, else this suggests a mis-use of the</span>
</span><span data-line="3930"><span class="sd">         method.</span>
</span><span data-line="3931"><span class="sd">        :param options: optional sequence of loader options which will be</span>
</span><span data-line="3932"><span class="sd">         applied to the :meth:`_orm.Session.get` method when the merge</span>
</span><span data-line="3933"><span class="sd">         operation loads the existing version of the object from the database.</span>
</span><span data-line="3934">
</span><span data-line="3935"><span class="sd">         .. versionadded:: 1.4.24</span>
</span><span data-line="3936">
</span><span data-line="3937">
</span><span data-line="3938"><span class="sd">        .. seealso::</span>
</span><span data-line="3939">
</span><span data-line="3940"><span class="sd">            :func:`.make_transient_to_detached` - provides for an alternative</span>
</span><span data-line="3941"><span class="sd">            means of &quot;merging&quot; a single object into the :class:`.Session`</span>
</span><span data-line="3942">
</span><span data-line="3943"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="3944">
</span><span data-line="3945">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span><span class="p">:</span>
</span><span data-line="3946">            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_warning</span><span class="p">(</span><span class="s2">&quot;Session.merge()&quot;</span><span class="p">)</span>
</span><span data-line="3947">
</span><span data-line="3948">        <span class="n">_recursive</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="3949">        <span class="n">_resolve_conflict_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">_IdentityKeyType</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="3950">
</span><span data-line="3951">        <span class="k">if</span> <span class="n">load</span><span class="p">:</span>
</span><span data-line="3952">            <span class="c1"># flush current contents if we expect to load data</span>
</span><span data-line="3953">            <span class="bp">self</span><span class="o">.</span><span class="n">_autoflush</span><span class="p">()</span>
</span><span data-line="3954">
</span><span data-line="3955">        <span class="n">object_mapper</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>  <span class="c1"># verify mapped</span>
</span><span data-line="3956">        <span class="n">autoflush</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span>
</span><span data-line="3957">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="3958">            <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="3959">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge</span><span class="p">(</span>
</span><span data-line="3960">                <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span>
</span><span data-line="3961">                <span class="n">attributes</span><span class="o">.</span><span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span>
</span><span data-line="3962">                <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span>
</span><span data-line="3963">                <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span><span data-line="3964">                <span class="n">_recursive</span><span class="o">=</span><span class="n">_recursive</span><span class="p">,</span>
</span><span data-line="3965">                <span class="n">_resolve_conflict_map</span><span class="o">=</span><span class="n">_resolve_conflict_map</span><span class="p">,</span>
</span><span data-line="3966">            <span class="p">)</span>
</span><span data-line="3967">        <span class="k">finally</span><span class="p">:</span>
</span><span data-line="3968">            <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span> <span class="o">=</span> <span class="n">autoflush</span>
</span><span data-line="3969">
</span><span data-line="3970">    <span class="k">def</span> <span class="nf">_merge</span><span class="p">(</span>
</span><span data-line="3971">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="3972">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="3973">        <span class="n">state_dict</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span data-line="3974">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="3975">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="3976">        <span class="n">load</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="3977">        <span class="n">_recursive</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
</span><span data-line="3978">        <span class="n">_resolve_conflict_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">_IdentityKeyType</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">],</span>
</span><span data-line="3979">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_O</span><span class="p">:</span>
</span><span data-line="3980">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span> <span class="o">=</span> <span class="n">_state_mapper</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3981">        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">_recursive</span><span class="p">:</span>
</span><span data-line="3982">            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">_O</span><span class="p">,</span> <span class="n">_recursive</span><span class="p">[</span><span class="n">state</span><span class="p">])</span>
</span><span data-line="3983">
</span><span data-line="3984">        <span class="n">new_instance</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="3985">        <span class="n">key</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="3986">
</span><span data-line="3987">        <span class="n">merged</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
</span><span data-line="3988">
</span><span data-line="3989">        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="3990">            <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
</span><span data-line="3991">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="3992">                    <span class="s2">&quot;Instance </span><span class="si">%s</span><span class="s2"> is already pending in this Session yet is &quot;</span>
</span><span data-line="3993">                    <span class="s2">&quot;being merged again; this is probably not what you want &quot;</span>
</span><span data-line="3994">                    <span class="s2">&quot;to do&quot;</span> <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="3995">                <span class="p">)</span>
</span><span data-line="3996">
</span><span data-line="3997">            <span class="k">if</span> <span class="ow">not</span> <span class="n">load</span><span class="p">:</span>
</span><span data-line="3998">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="3999">                    <span class="s2">&quot;merge() with load=False option does not support &quot;</span>
</span><span data-line="4000">                    <span class="s2">&quot;objects transient (i.e. unpersisted) objects.  flush() &quot;</span>
</span><span data-line="4001">                    <span class="s2">&quot;all changes on mapped instances before merging with &quot;</span>
</span><span data-line="4002">                    <span class="s2">&quot;load=False.&quot;</span>
</span><span data-line="4003">                <span class="p">)</span>
</span><span data-line="4004">            <span class="n">key</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_identity_key_from_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4005">            <span class="n">key_is_persistent</span> <span class="o">=</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">NEVER_SET</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">[</span>
</span><span data-line="4006">                <span class="mi">1</span>
</span><span data-line="4007">            <span class="p">]</span> <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="4008">                <span class="ow">not</span> <span class="n">_none_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span data-line="4009">                <span class="ow">or</span> <span class="p">(</span>
</span><span data-line="4010">                    <span class="n">mapper</span><span class="o">.</span><span class="n">allow_partial_pks</span>
</span><span data-line="4011">                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">_none_set</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span data-line="4012">                <span class="p">)</span>
</span><span data-line="4013">            <span class="p">)</span>
</span><span data-line="4014">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="4015">            <span class="n">key_is_persistent</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="4016">
</span><span data-line="4017">        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="p">:</span>
</span><span data-line="4018">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="4019">                <span class="n">merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="4020">            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span data-line="4021">                <span class="c1"># object was GC&#39;ed right as we checked for it</span>
</span><span data-line="4022">                <span class="n">merged</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="4023">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="4024">            <span class="n">merged</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="4025">
</span><span data-line="4026">        <span class="k">if</span> <span class="n">merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4027">            <span class="k">if</span> <span class="n">key_is_persistent</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_resolve_conflict_map</span><span class="p">:</span>
</span><span data-line="4028">                <span class="n">merged</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">_O</span><span class="p">,</span> <span class="n">_resolve_conflict_map</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span data-line="4029">
</span><span data-line="4030">            <span class="k">elif</span> <span class="ow">not</span> <span class="n">load</span><span class="p">:</span>
</span><span data-line="4031">                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span>
</span><span data-line="4032">                    <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="4033">                        <span class="s2">&quot;merge() with load=False option does not support &quot;</span>
</span><span data-line="4034">                        <span class="s2">&quot;objects marked as &#39;dirty&#39;.  flush() all changes on &quot;</span>
</span><span data-line="4035">                        <span class="s2">&quot;mapped instances before merging with load=False.&quot;</span>
</span><span data-line="4036">                    <span class="p">)</span>
</span><span data-line="4037">                <span class="n">merged</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">class_manager</span><span class="o">.</span><span class="n">new_instance</span><span class="p">()</span>
</span><span data-line="4038">                <span class="n">merged_state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span data-line="4039">                <span class="n">merged_state</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
</span><span data-line="4040">                <span class="bp">self</span><span class="o">.</span><span class="n">_update_impl</span><span class="p">(</span><span class="n">merged_state</span><span class="p">)</span>
</span><span data-line="4041">                <span class="n">new_instance</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="4042">
</span><span data-line="4043">            <span class="k">elif</span> <span class="n">key_is_persistent</span><span class="p">:</span>
</span><span data-line="4044">                <span class="n">merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="4045">                    <span class="n">mapper</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span data-line="4046">                    <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span data-line="4047">                    <span class="n">identity_token</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span data-line="4048">                    <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span><span data-line="4049">                <span class="p">)</span>
</span><span data-line="4050">
</span><span data-line="4051">        <span class="k">if</span> <span class="n">merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4052">            <span class="n">merged</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">class_manager</span><span class="o">.</span><span class="n">new_instance</span><span class="p">()</span>
</span><span data-line="4053">            <span class="n">merged_state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span data-line="4054">            <span class="n">merged_dict</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_dict</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span data-line="4055">            <span class="n">new_instance</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="4056">            <span class="bp">self</span><span class="o">.</span><span class="n">_save_or_update_state</span><span class="p">(</span><span class="n">merged_state</span><span class="p">)</span>
</span><span data-line="4057">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="4058">            <span class="n">merged_state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span data-line="4059">            <span class="n">merged_dict</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_dict</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span data-line="4060">
</span><span data-line="4061">        <span class="n">_recursive</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span>
</span><span data-line="4062">        <span class="n">_resolve_conflict_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span>
</span><span data-line="4063">
</span><span data-line="4064">        <span class="c1"># check that we didn&#39;t just pull the exact same</span>
</span><span data-line="4065">        <span class="c1"># state out.</span>
</span><span data-line="4066">        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">merged_state</span><span class="p">:</span>
</span><span data-line="4067">            <span class="c1"># version check if applicable</span>
</span><span data-line="4068">            <span class="k">if</span> <span class="n">mapper</span><span class="o">.</span><span class="n">version_id_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4069">                <span class="n">existing_version</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_get_state_attr_by_column</span><span class="p">(</span>
</span><span data-line="4070">                    <span class="n">state</span><span class="p">,</span>
</span><span data-line="4071">                    <span class="n">state_dict</span><span class="p">,</span>
</span><span data-line="4072">                    <span class="n">mapper</span><span class="o">.</span><span class="n">version_id_col</span><span class="p">,</span>
</span><span data-line="4073">                    <span class="n">passive</span><span class="o">=</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_NO_INITIALIZE</span><span class="p">,</span>
</span><span data-line="4074">                <span class="p">)</span>
</span><span data-line="4075">
</span><span data-line="4076">                <span class="n">merged_version</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_get_state_attr_by_column</span><span class="p">(</span>
</span><span data-line="4077">                    <span class="n">merged_state</span><span class="p">,</span>
</span><span data-line="4078">                    <span class="n">merged_dict</span><span class="p">,</span>
</span><span data-line="4079">                    <span class="n">mapper</span><span class="o">.</span><span class="n">version_id_col</span><span class="p">,</span>
</span><span data-line="4080">                    <span class="n">passive</span><span class="o">=</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_NO_INITIALIZE</span><span class="p">,</span>
</span><span data-line="4081">                <span class="p">)</span>
</span><span data-line="4082">
</span><span data-line="4083">                <span class="k">if</span> <span class="p">(</span>
</span><span data-line="4084">                    <span class="n">existing_version</span>
</span><span data-line="4085">                    <span class="ow">is</span> <span class="ow">not</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span>
</span><span data-line="4086">                    <span class="ow">and</span> <span class="n">merged_version</span>
</span><span data-line="4087">                    <span class="ow">is</span> <span class="ow">not</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span>
</span><span data-line="4088">                    <span class="ow">and</span> <span class="n">existing_version</span> <span class="o">!=</span> <span class="n">merged_version</span>
</span><span data-line="4089">                <span class="p">):</span>
</span><span data-line="4090">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">StaleDataError</span><span class="p">(</span>
</span><span data-line="4091">                        <span class="s2">&quot;Version id &#39;</span><span class="si">%s</span><span class="s2">&#39; on merged state </span><span class="si">%s</span><span class="s2"> &quot;</span>
</span><span data-line="4092">                        <span class="s2">&quot;does not match existing version &#39;</span><span class="si">%s</span><span class="s2">&#39;. &quot;</span>
</span><span data-line="4093">                        <span class="s2">&quot;Leave the version attribute unset when &quot;</span>
</span><span data-line="4094">                        <span class="s2">&quot;merging to update the most recent version.&quot;</span>
</span><span data-line="4095">                        <span class="o">%</span> <span class="p">(</span>
</span><span data-line="4096">                            <span class="n">existing_version</span><span class="p">,</span>
</span><span data-line="4097">                            <span class="n">state_str</span><span class="p">(</span><span class="n">merged_state</span><span class="p">),</span>
</span><span data-line="4098">                            <span class="n">merged_version</span><span class="p">,</span>
</span><span data-line="4099">                        <span class="p">)</span>
</span><span data-line="4100">                    <span class="p">)</span>
</span><span data-line="4101">
</span><span data-line="4102">            <span class="n">merged_state</span><span class="o">.</span><span class="n">load_path</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">load_path</span>
</span><span data-line="4103">            <span class="n">merged_state</span><span class="o">.</span><span class="n">load_options</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">load_options</span>
</span><span data-line="4104">
</span><span data-line="4105">            <span class="c1"># since we are copying load_options, we need to copy</span>
</span><span data-line="4106">            <span class="c1"># the callables_ that would have been generated by those</span>
</span><span data-line="4107">            <span class="c1"># load_options.</span>
</span><span data-line="4108">            <span class="c1"># assumes that the callables we put in state.callables_</span>
</span><span data-line="4109">            <span class="c1"># are not instance-specific (which they should not be)</span>
</span><span data-line="4110">            <span class="n">merged_state</span><span class="o">.</span><span class="n">_copy_callables</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4111">
</span><span data-line="4112">            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">iterate_properties</span><span class="p">:</span>
</span><span data-line="4113">                <span class="n">prop</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span data-line="4114">                    <span class="bp">self</span><span class="p">,</span>
</span><span data-line="4115">                    <span class="n">state</span><span class="p">,</span>
</span><span data-line="4116">                    <span class="n">state_dict</span><span class="p">,</span>
</span><span data-line="4117">                    <span class="n">merged_state</span><span class="p">,</span>
</span><span data-line="4118">                    <span class="n">merged_dict</span><span class="p">,</span>
</span><span data-line="4119">                    <span class="n">load</span><span class="p">,</span>
</span><span data-line="4120">                    <span class="n">_recursive</span><span class="p">,</span>
</span><span data-line="4121">                    <span class="n">_resolve_conflict_map</span><span class="p">,</span>
</span><span data-line="4122">                <span class="p">)</span>
</span><span data-line="4123">
</span><span data-line="4124">        <span class="k">if</span> <span class="ow">not</span> <span class="n">load</span><span class="p">:</span>
</span><span data-line="4125">            <span class="c1"># remove any history</span>
</span><span data-line="4126">            <span class="n">merged_state</span><span class="o">.</span><span class="n">_commit_all</span><span class="p">(</span><span class="n">merged_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="p">)</span>
</span><span data-line="4127">            <span class="n">merged_state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_sa_event_merge_wo_load</span><span class="p">(</span>
</span><span data-line="4128">                <span class="n">merged_state</span><span class="p">,</span> <span class="kc">None</span>
</span><span data-line="4129">            <span class="p">)</span>
</span><span data-line="4130">
</span><span data-line="4131">        <span class="k">if</span> <span class="n">new_instance</span><span class="p">:</span>
</span><span data-line="4132">            <span class="n">merged_state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">merged_state</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="4133">
</span><span data-line="4134">        <span class="k">return</span> <span class="n">merged</span>
</span><span data-line="4135">
</span><span data-line="4136">    <span class="k">def</span> <span class="nf">_validate_persistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4137">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">contains_state</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
</span><span data-line="4138">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="4139">                <span class="s2">&quot;Instance &#39;</span><span class="si">%s</span><span class="s2">&#39; is not persistent within this Session&quot;</span>
</span><span data-line="4140">                <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4141">            <span class="p">)</span>
</span><span data-line="4142">
</span><span data-line="4143">    <span class="k">def</span> <span class="nf">_save_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4144">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4145">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="4146">                <span class="s2">&quot;Object &#39;</span><span class="si">%s</span><span class="s2">&#39; already has an identity - &quot;</span>
</span><span data-line="4147">                <span class="s2">&quot;it can&#39;t be registered as pending&quot;</span> <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4148">            <span class="p">)</span>
</span><span data-line="4149">
</span><span data-line="4150">        <span class="n">obj</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span>
</span><span data-line="4151">        <span class="n">to_attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="4152">        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
</span><span data-line="4153">            <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span><span data-line="4154">            <span class="n">state</span><span class="o">.</span><span class="n">insert_order</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">)</span>
</span><span data-line="4155">        <span class="k">if</span> <span class="n">to_attach</span><span class="p">:</span>
</span><span data-line="4156">            <span class="bp">self</span><span class="o">.</span><span class="n">_after_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="4157">
</span><span data-line="4158">    <span class="k">def</span> <span class="nf">_update_impl</span><span class="p">(</span>
</span><span data-line="4159">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">revert_deletion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="4160">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4161">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4162">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="4163">                <span class="s2">&quot;Instance &#39;</span><span class="si">%s</span><span class="s2">&#39; is not persisted&quot;</span> <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4164">            <span class="p">)</span>
</span><span data-line="4165">
</span><span data-line="4166">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span><span class="p">:</span>
</span><span data-line="4167">            <span class="k">if</span> <span class="n">revert_deletion</span><span class="p">:</span>
</span><span data-line="4168">                <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">_attached</span><span class="p">:</span>
</span><span data-line="4169">                    <span class="k">return</span>
</span><span data-line="4170">                <span class="k">del</span> <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span>
</span><span data-line="4171">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="4172">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="4173">                    <span class="s2">&quot;Instance &#39;</span><span class="si">%s</span><span class="s2">&#39; has been deleted.  &quot;</span>
</span><span data-line="4174">                    <span class="s2">&quot;Use the make_transient() &quot;</span>
</span><span data-line="4175">                    <span class="s2">&quot;function to send this object back &quot;</span>
</span><span data-line="4176">                    <span class="s2">&quot;to the transient state.&quot;</span> <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4177">                <span class="p">)</span>
</span><span data-line="4178">
</span><span data-line="4179">        <span class="n">obj</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span>
</span><span data-line="4180">
</span><span data-line="4181">        <span class="c1"># check for late gc</span>
</span><span data-line="4182">        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4183">            <span class="k">return</span>
</span><span data-line="4184">
</span><span data-line="4185">        <span class="n">to_attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="4186">
</span><span data-line="4187">        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="4188">        <span class="k">if</span> <span class="n">revert_deletion</span><span class="p">:</span>
</span><span data-line="4189">            <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4190">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="4191">            <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4192">
</span><span data-line="4193">        <span class="k">if</span> <span class="n">to_attach</span><span class="p">:</span>
</span><span data-line="4194">            <span class="bp">self</span><span class="o">.</span><span class="n">_after_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="4195">        <span class="k">elif</span> <span class="n">revert_deletion</span><span class="p">:</span>
</span><span data-line="4196">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">deleted_to_persistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span data-line="4197">
</span><span data-line="4198">    <span class="k">def</span> <span class="nf">_save_or_update_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4199">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4200">            <span class="bp">self</span><span class="o">.</span><span class="n">_save_impl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4201">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="4202">            <span class="bp">self</span><span class="o">.</span><span class="n">_update_impl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4203">
</span><span data-line="4204">    <span class="k">def</span> <span class="nf">enable_relationship_loading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4205"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Associate an object with this :class:`.Session` for related</span>
</span><span data-line="4206"><span class="sd">        object loading.</span>
</span><span data-line="4207">
</span><span data-line="4208"><span class="sd">        .. warning::</span>
</span><span data-line="4209">
</span><span data-line="4210"><span class="sd">            :meth:`.enable_relationship_loading` exists to serve special</span>
</span><span data-line="4211"><span class="sd">            use cases and is not recommended for general use.</span>
</span><span data-line="4212">
</span><span data-line="4213"><span class="sd">        Accesses of attributes mapped with :func:`_orm.relationship`</span>
</span><span data-line="4214"><span class="sd">        will attempt to load a value from the database using this</span>
</span><span data-line="4215"><span class="sd">        :class:`.Session` as the source of connectivity.  The values</span>
</span><span data-line="4216"><span class="sd">        will be loaded based on foreign key and primary key values</span>
</span><span data-line="4217"><span class="sd">        present on this object - if not present, then those relationships</span>
</span><span data-line="4218"><span class="sd">        will be unavailable.</span>
</span><span data-line="4219">
</span><span data-line="4220"><span class="sd">        The object will be attached to this session, but will</span>
</span><span data-line="4221"><span class="sd">        **not** participate in any persistence operations; its state</span>
</span><span data-line="4222"><span class="sd">        for almost all purposes will remain either &quot;transient&quot; or</span>
</span><span data-line="4223"><span class="sd">        &quot;detached&quot;, except for the case of relationship loading.</span>
</span><span data-line="4224">
</span><span data-line="4225"><span class="sd">        Also note that backrefs will often not work as expected.</span>
</span><span data-line="4226"><span class="sd">        Altering a relationship-bound attribute on the target object</span>
</span><span data-line="4227"><span class="sd">        may not fire off a backref event, if the effective value</span>
</span><span data-line="4228"><span class="sd">        is what was already loaded from a foreign-key-holding value.</span>
</span><span data-line="4229">
</span><span data-line="4230"><span class="sd">        The :meth:`.Session.enable_relationship_loading` method is</span>
</span><span data-line="4231"><span class="sd">        similar to the ``load_on_pending`` flag on :func:`_orm.relationship`.</span>
</span><span data-line="4232"><span class="sd">        Unlike that flag, :meth:`.Session.enable_relationship_loading` allows</span>
</span><span data-line="4233"><span class="sd">        an object to remain transient while still being able to load</span>
</span><span data-line="4234"><span class="sd">        related items.</span>
</span><span data-line="4235">
</span><span data-line="4236"><span class="sd">        To make a transient object associated with a :class:`.Session`</span>
</span><span data-line="4237"><span class="sd">        via :meth:`.Session.enable_relationship_loading` pending, add</span>
</span><span data-line="4238"><span class="sd">        it to the :class:`.Session` using :meth:`.Session.add` normally.</span>
</span><span data-line="4239"><span class="sd">        If the object instead represents an existing identity in the database,</span>
</span><span data-line="4240"><span class="sd">        it should be merged using :meth:`.Session.merge`.</span>
</span><span data-line="4241">
</span><span data-line="4242"><span class="sd">        :meth:`.Session.enable_relationship_loading` does not improve</span>
</span><span data-line="4243"><span class="sd">        behavior when the ORM is used normally - object references should be</span>
</span><span data-line="4244"><span class="sd">        constructed at the object level, not at the foreign key level, so</span>
</span><span data-line="4245"><span class="sd">        that they are present in an ordinary way before flush()</span>
</span><span data-line="4246"><span class="sd">        proceeds.  This method is not intended for general use.</span>
</span><span data-line="4247">
</span><span data-line="4248"><span class="sd">        .. seealso::</span>
</span><span data-line="4249">
</span><span data-line="4250"><span class="sd">            :paramref:`_orm.relationship.load_on_pending` - this flag</span>
</span><span data-line="4251"><span class="sd">            allows per-relationship loading of many-to-ones on items that</span>
</span><span data-line="4252"><span class="sd">            are pending.</span>
</span><span data-line="4253">
</span><span data-line="4254"><span class="sd">            :func:`.make_transient_to_detached` - allows for an object to</span>
</span><span data-line="4255"><span class="sd">            be added to a :class:`.Session` without SQL emitted, which then</span>
</span><span data-line="4256"><span class="sd">            will unexpire attributes on access.</span>
</span><span data-line="4257">
</span><span data-line="4258"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="4259">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="4260">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span data-line="4261">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="4262">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span data-line="4263">
</span><span data-line="4264">        <span class="n">to_attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="4265">        <span class="n">state</span><span class="o">.</span><span class="n">_load_pending</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="4266">        <span class="k">if</span> <span class="n">to_attach</span><span class="p">:</span>
</span><span data-line="4267">            <span class="bp">self</span><span class="o">.</span><span class="n">_after_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="4268">
</span><span data-line="4269">    <span class="k">def</span> <span class="nf">_before_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="4270">        <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">()</span>
</span><span data-line="4271">
</span><span data-line="4272">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span><span class="p">:</span>
</span><span data-line="4273">            <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="4274">
</span><span data-line="4275">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">in</span> <span class="n">_sessions</span><span class="p">:</span>
</span><span data-line="4276">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="4277">                <span class="s2">&quot;Object &#39;</span><span class="si">%s</span><span class="s2">&#39; is already attached to session &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>
</span><span data-line="4278">                <span class="s2">&quot;(this is &#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span>
</span><span data-line="4279">                <span class="o">%</span> <span class="p">(</span><span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">state</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span><span class="p">)</span>
</span><span data-line="4280">            <span class="p">)</span>
</span><span data-line="4281">
</span><span data-line="4282">        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span data-line="4283">
</span><span data-line="4284">        <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="4285">
</span><span data-line="4286">    <span class="k">def</span> <span class="nf">_after_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4287">        <span class="n">state</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span>
</span><span data-line="4288">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">modified</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">_strong_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4289">            <span class="n">state</span><span class="o">.</span><span class="n">_strong_obj</span> <span class="o">=</span> <span class="n">obj</span>
</span><span data-line="4290">        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span data-line="4291">
</span><span data-line="4292">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span data-line="4293">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">detached_to_persistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span data-line="4294">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="4295">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">transient_to_pending</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span data-line="4296">
</span><span data-line="4297">    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="4298"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the instance is associated with this session.</span>
</span><span data-line="4299">
</span><span data-line="4300"><span class="sd">        The instance may be pending or persistent within the Session for a</span>
</span><span data-line="4301"><span class="sd">        result of True.</span>
</span><span data-line="4302">
</span><span data-line="4303"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="4304">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="4305">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="4306">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="4307">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span data-line="4308">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4309">
</span><span data-line="4310">    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">object</span><span class="p">]:</span>
</span><span data-line="4311"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all pending or persistent instances within this</span>
</span><span data-line="4312"><span class="sd">        Session.</span>
</span><span data-line="4313">
</span><span data-line="4314"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="4315">        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span>
</span><span data-line="4316">            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span data-line="4317">        <span class="p">)</span>
</span><span data-line="4318">
</span><span data-line="4319">    <span class="k">def</span> <span class="nf">_contains_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="4320">        <span class="k">return</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">contains_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4321">
</span><span data-line="4322">    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4323"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Flush all the object changes to the database.</span>
</span><span data-line="4324">
</span><span data-line="4325"><span class="sd">        Writes out all pending object creations, deletions and modifications</span>
</span><span data-line="4326"><span class="sd">        to the database as INSERTs, DELETEs, UPDATEs, etc.  Operations are</span>
</span><span data-line="4327"><span class="sd">        automatically ordered by the Session&#39;s unit of work dependency</span>
</span><span data-line="4328"><span class="sd">        solver.</span>
</span><span data-line="4329">
</span><span data-line="4330"><span class="sd">        Database operations will be issued in the current transactional</span>
</span><span data-line="4331"><span class="sd">        context and do not affect the state of the transaction, unless an</span>
</span><span data-line="4332"><span class="sd">        error occurs, in which case the entire transaction is rolled back.</span>
</span><span data-line="4333"><span class="sd">        You may flush() as often as you like within a transaction to move</span>
</span><span data-line="4334"><span class="sd">        changes from Python to the database&#39;s transaction buffer.</span>
</span><span data-line="4335">
</span><span data-line="4336"><span class="sd">        :param objects: Optional; restricts the flush operation to operate</span>
</span><span data-line="4337"><span class="sd">          only on elements that are in the given collection.</span>
</span><span data-line="4338">
</span><span data-line="4339"><span class="sd">          This feature is for an extremely narrow set of use cases where</span>
</span><span data-line="4340"><span class="sd">          particular objects may need to be operated upon before the</span>
</span><span data-line="4341"><span class="sd">          full flush() occurs.  It is not intended for general use.</span>
</span><span data-line="4342">
</span><span data-line="4343"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="4344">
</span><span data-line="4345">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span><span class="p">:</span>
</span><span data-line="4346">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">&quot;Session is already flushing&quot;</span><span class="p">)</span>
</span><span data-line="4347">
</span><span data-line="4348">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_clean</span><span class="p">():</span>
</span><span data-line="4349">            <span class="k">return</span>
</span><span data-line="4350">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="4351">            <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="4352">            <span class="bp">self</span><span class="o">.</span><span class="n">_flush</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
</span><span data-line="4353">        <span class="k">finally</span><span class="p">:</span>
</span><span data-line="4354">            <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="4355">
</span><span data-line="4356">    <span class="k">def</span> <span class="nf">_flush_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4357">        <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="4358">            <span class="s2">&quot;Usage of the &#39;</span><span class="si">%s</span><span class="s2">&#39; operation is not currently supported &quot;</span>
</span><span data-line="4359">            <span class="s2">&quot;within the execution stage of the flush process. &quot;</span>
</span><span data-line="4360">            <span class="s2">&quot;Results may not be consistent.  Consider using alternative &quot;</span>
</span><span data-line="4361">            <span class="s2">&quot;event listeners or connection-level operations instead.&quot;</span> <span class="o">%</span> <span class="n">method</span>
</span><span data-line="4362">        <span class="p">)</span>
</span><span data-line="4363">
</span><span data-line="4364">    <span class="k">def</span> <span class="nf">_is_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="4365">        <span class="k">return</span> <span class="p">(</span>
</span><span data-line="4366">            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">check_modified</span><span class="p">()</span>
</span><span data-line="4367">            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span>
</span><span data-line="4368">            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span>
</span><span data-line="4369">        <span class="p">)</span>
</span><span data-line="4370">
</span><span data-line="4371">    <span class="k">def</span> <span class="nf">_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">object</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4372">        <span class="n">dirty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty_states</span>
</span><span data-line="4373">        <span class="k">if</span> <span class="ow">not</span> <span class="n">dirty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
</span><span data-line="4374">            <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span data-line="4375">            <span class="k">return</span>
</span><span data-line="4376">
</span><span data-line="4377">        <span class="n">flush_context</span> <span class="o">=</span> <span class="n">UOWTransaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="4378">
</span><span data-line="4379">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_flush</span><span class="p">:</span>
</span><span data-line="4380">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flush_context</span><span class="p">,</span> <span class="n">objects</span><span class="p">)</span>
</span><span data-line="4381">            <span class="c1"># re-establish &quot;dirty states&quot; in case the listeners</span>
</span><span data-line="4382">            <span class="c1"># added</span>
</span><span data-line="4383">            <span class="n">dirty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty_states</span>
</span><span data-line="4384">
</span><span data-line="4385">        <span class="n">deleted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="p">)</span>
</span><span data-line="4386">        <span class="n">new</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">)</span>
</span><span data-line="4387">
</span><span data-line="4388">        <span class="n">dirty</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dirty</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span>
</span><span data-line="4389">
</span><span data-line="4390">        <span class="c1"># create the set of all objects we want to operate upon</span>
</span><span data-line="4391">        <span class="k">if</span> <span class="n">objects</span><span class="p">:</span>
</span><span data-line="4392">            <span class="c1"># specific list passed in</span>
</span><span data-line="4393">            <span class="n">objset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="4394">            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
</span><span data-line="4395">                <span class="k">try</span><span class="p">:</span>
</span><span data-line="4396">                    <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</span><span data-line="4397">
</span><span data-line="4398">                <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="4399">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span data-line="4400">                <span class="n">objset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4401">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="4402">            <span class="n">objset</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="4403">
</span><span data-line="4404">        <span class="c1"># store objects whose fate has been decided</span>
</span><span data-line="4405">        <span class="n">processed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="4406">
</span><span data-line="4407">        <span class="c1"># put all saves/updates into the flush context.  detect top-level</span>
</span><span data-line="4408">        <span class="c1"># orphans and throw them into deleted.</span>
</span><span data-line="4409">        <span class="k">if</span> <span class="n">objset</span><span class="p">:</span>
</span><span data-line="4410">            <span class="n">proc</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">dirty</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">objset</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span>
</span><span data-line="4411">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="4412">            <span class="n">proc</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">dirty</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span>
</span><span data-line="4413">
</span><span data-line="4414">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">proc</span><span class="p">:</span>
</span><span data-line="4415">            <span class="n">is_orphan</span> <span class="o">=</span> <span class="n">_state_mapper</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">_is_orphan</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4416">
</span><span data-line="4417">            <span class="n">is_persistent_orphan</span> <span class="o">=</span> <span class="n">is_orphan</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">has_identity</span>
</span><span data-line="4418">
</span><span data-line="4419">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="4420">                <span class="n">is_orphan</span>
</span><span data-line="4421">                <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_persistent_orphan</span>
</span><span data-line="4422">                <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">_orphaned_outside_of_session</span>
</span><span data-line="4423">            <span class="p">):</span>
</span><span data-line="4424">                <span class="bp">self</span><span class="o">.</span><span class="n">_expunge_states</span><span class="p">([</span><span class="n">state</span><span class="p">])</span>
</span><span data-line="4425">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="4426">                <span class="n">_reg</span> <span class="o">=</span> <span class="n">flush_context</span><span class="o">.</span><span class="n">register_object</span><span class="p">(</span>
</span><span data-line="4427">                    <span class="n">state</span><span class="p">,</span> <span class="n">isdelete</span><span class="o">=</span><span class="n">is_persistent_orphan</span>
</span><span data-line="4428">                <span class="p">)</span>
</span><span data-line="4429">                <span class="k">assert</span> <span class="n">_reg</span><span class="p">,</span> <span class="s2">&quot;Failed to add object to the flush context!&quot;</span>
</span><span data-line="4430">                <span class="n">processed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="4431">
</span><span data-line="4432">        <span class="c1"># put all remaining deletes into the flush context.</span>
</span><span data-line="4433">        <span class="k">if</span> <span class="n">objset</span><span class="p">:</span>
</span><span data-line="4434">            <span class="n">proc</span> <span class="o">=</span> <span class="n">deleted</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">objset</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
</span><span data-line="4435">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="4436">            <span class="n">proc</span> <span class="o">=</span> <span class="n">deleted</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
</span><span data-line="4437">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">proc</span><span class="p">:</span>
</span><span data-line="4438">            <span class="n">_reg</span> <span class="o">=</span> <span class="n">flush_context</span><span class="o">.</span><span class="n">register_object</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">isdelete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="4439">            <span class="k">assert</span> <span class="n">_reg</span><span class="p">,</span> <span class="s2">&quot;Failed to add object to the flush context!&quot;</span>
</span><span data-line="4440">
</span><span data-line="4441">        <span class="k">if</span> <span class="ow">not</span> <span class="n">flush_context</span><span class="o">.</span><span class="n">has_work</span><span class="p">:</span>
</span><span data-line="4442">            <span class="k">return</span>
</span><span data-line="4443">
</span><span data-line="4444">        <span class="n">flush_context</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">()</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>
</span><span data-line="4445">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="4446">            <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="4447">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="4448">                <span class="n">flush_context</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span data-line="4449">            <span class="k">finally</span><span class="p">:</span>
</span><span data-line="4450">                <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="4451">
</span><span data-line="4452">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flush_context</span><span class="p">)</span>
</span><span data-line="4453">
</span><span data-line="4454">            <span class="n">flush_context</span><span class="o">.</span><span class="n">finalize_flush_changes</span><span class="p">()</span>
</span><span data-line="4455">
</span><span data-line="4456">            <span class="k">if</span> <span class="ow">not</span> <span class="n">objects</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="p">:</span>
</span><span data-line="4457">                <span class="n">len_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="p">)</span>
</span><span data-line="4458">
</span><span data-line="4459">                <span class="n">statelib</span><span class="o">.</span><span class="n">InstanceState</span><span class="o">.</span><span class="n">_commit_all_states</span><span class="p">(</span>
</span><span data-line="4460">                    <span class="p">[</span>
</span><span data-line="4461">                        <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">)</span>
</span><span data-line="4462">                        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span>
</span><span data-line="4463">                    <span class="p">],</span>
</span><span data-line="4464">                    <span class="n">instance_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="p">,</span>
</span><span data-line="4465">                <span class="p">)</span>
</span><span data-line="4466">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="4467">                    <span class="s2">&quot;Attribute history events accumulated on </span><span class="si">%d</span><span class="s2"> &quot;</span>
</span><span data-line="4468">                    <span class="s2">&quot;previously clean instances &quot;</span>
</span><span data-line="4469">                    <span class="s2">&quot;within inner-flush event handlers have been &quot;</span>
</span><span data-line="4470">                    <span class="s2">&quot;reset, and will not result in database updates. &quot;</span>
</span><span data-line="4471">                    <span class="s2">&quot;Consider using set_committed_value() within &quot;</span>
</span><span data-line="4472">                    <span class="s2">&quot;inner-flush event handlers to avoid this warning.&quot;</span> <span class="o">%</span> <span class="n">len_</span>
</span><span data-line="4473">                <span class="p">)</span>
</span><span data-line="4474">
</span><span data-line="4475">            <span class="c1"># useful assertions:</span>
</span><span data-line="4476">            <span class="c1"># if not objects:</span>
</span><span data-line="4477">            <span class="c1">#    assert not self.identity_map._modified</span>
</span><span data-line="4478">            <span class="c1"># else:</span>
</span><span data-line="4479">            <span class="c1">#    assert self.identity_map._modified == \</span>
</span><span data-line="4480">            <span class="c1">#            self.identity_map._modified.difference(objects)</span>
</span><span data-line="4481">
</span><span data-line="4482">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_flush_postexec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flush_context</span><span class="p">)</span>
</span><span data-line="4483">
</span><span data-line="4484">            <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="4485">
</span><span data-line="4486">        <span class="k">except</span><span class="p">:</span>
</span><span data-line="4487">            <span class="k">with</span> <span class="n">util</span><span class="o">.</span><span class="n">safe_reraise</span><span class="p">():</span>
</span><span data-line="4488">                <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">_capture_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="4489">
</span><span data-line="4490">    <span class="k">def</span> <span class="nf">bulk_save_objects</span><span class="p">(</span>
</span><span data-line="4491">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="4492">        <span class="n">objects</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span>
</span><span data-line="4493">        <span class="n">return_defaults</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="4494">        <span class="n">update_changed_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="4495">        <span class="n">preserve_order</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="4496">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4497"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a bulk save of the given list of objects.</span>
</span><span data-line="4498">
</span><span data-line="4499"><span class="sd">        .. legacy::</span>
</span><span data-line="4500">
</span><span data-line="4501"><span class="sd">            This method is a legacy feature as of the 2.0 series of</span>
</span><span data-line="4502"><span class="sd">            SQLAlchemy.   For modern bulk INSERT and UPDATE, see</span>
</span><span data-line="4503"><span class="sd">            the sections :ref:`orm_queryguide_bulk_insert` and</span>
</span><span data-line="4504"><span class="sd">            :ref:`orm_queryguide_bulk_update`.</span>
</span><span data-line="4505">
</span><span data-line="4506"><span class="sd">            For general INSERT and UPDATE of existing ORM mapped objects,</span>
</span><span data-line="4507"><span class="sd">            prefer standard :term:`unit of work` data management patterns,</span>
</span><span data-line="4508"><span class="sd">            introduced in the :ref:`unified_tutorial` at</span>
</span><span data-line="4509"><span class="sd">            :ref:`tutorial_orm_data_manipulation`.  SQLAlchemy 2.0</span>
</span><span data-line="4510"><span class="sd">            now uses :ref:`engine_insertmanyvalues` with modern dialects</span>
</span><span data-line="4511"><span class="sd">            which solves previous issues of bulk INSERT slowness.</span>
</span><span data-line="4512">
</span><span data-line="4513"><span class="sd">        :param objects: a sequence of mapped object instances.  The mapped</span>
</span><span data-line="4514"><span class="sd">         objects are persisted as is, and are **not** associated with the</span>
</span><span data-line="4515"><span class="sd">         :class:`.Session` afterwards.</span>
</span><span data-line="4516">
</span><span data-line="4517"><span class="sd">         For each object, whether the object is sent as an INSERT or an</span>
</span><span data-line="4518"><span class="sd">         UPDATE is dependent on the same rules used by the :class:`.Session`</span>
</span><span data-line="4519"><span class="sd">         in traditional operation; if the object has the</span>
</span><span data-line="4520"><span class="sd">         :attr:`.InstanceState.key`</span>
</span><span data-line="4521"><span class="sd">         attribute set, then the object is assumed to be &quot;detached&quot; and</span>
</span><span data-line="4522"><span class="sd">         will result in an UPDATE.  Otherwise, an INSERT is used.</span>
</span><span data-line="4523">
</span><span data-line="4524"><span class="sd">         In the case of an UPDATE, statements are grouped based on which</span>
</span><span data-line="4525"><span class="sd">         attributes have changed, and are thus to be the subject of each</span>
</span><span data-line="4526"><span class="sd">         SET clause.  If ``update_changed_only`` is False, then all</span>
</span><span data-line="4527"><span class="sd">         attributes present within each object are applied to the UPDATE</span>
</span><span data-line="4528"><span class="sd">         statement, which may help in allowing the statements to be grouped</span>
</span><span data-line="4529"><span class="sd">         together into a larger executemany(), and will also reduce the</span>
</span><span data-line="4530"><span class="sd">         overhead of checking history on attributes.</span>
</span><span data-line="4531">
</span><span data-line="4532"><span class="sd">        :param return_defaults: when True, rows that are missing values which</span>
</span><span data-line="4533"><span class="sd">         generate defaults, namely integer primary key defaults and sequences,</span>
</span><span data-line="4534"><span class="sd">         will be inserted **one at a time**, so that the primary key value</span>
</span><span data-line="4535"><span class="sd">         is available.  In particular this will allow joined-inheritance</span>
</span><span data-line="4536"><span class="sd">         and other multi-table mappings to insert correctly without the need</span>
</span><span data-line="4537"><span class="sd">         to provide primary key values ahead of time; however,</span>
</span><span data-line="4538"><span class="sd">         :paramref:`.Session.bulk_save_objects.return_defaults` **greatly</span>
</span><span data-line="4539"><span class="sd">         reduces the performance gains** of the method overall.  It is strongly</span>
</span><span data-line="4540"><span class="sd">         advised to please use the standard :meth:`_orm.Session.add_all`</span>
</span><span data-line="4541"><span class="sd">         approach.</span>
</span><span data-line="4542">
</span><span data-line="4543"><span class="sd">        :param update_changed_only: when True, UPDATE statements are rendered</span>
</span><span data-line="4544"><span class="sd">         based on those attributes in each state that have logged changes.</span>
</span><span data-line="4545"><span class="sd">         When False, all attributes present are rendered into the SET clause</span>
</span><span data-line="4546"><span class="sd">         with the exception of primary key attributes.</span>
</span><span data-line="4547">
</span><span data-line="4548"><span class="sd">        :param preserve_order: when True, the order of inserts and updates</span>
</span><span data-line="4549"><span class="sd">         matches exactly the order in which the objects are given.   When</span>
</span><span data-line="4550"><span class="sd">         False, common types of objects are grouped into inserts</span>
</span><span data-line="4551"><span class="sd">         and updates, to allow for more batching opportunities.</span>
</span><span data-line="4552">
</span><span data-line="4553"><span class="sd">        .. seealso::</span>
</span><span data-line="4554">
</span><span data-line="4555"><span class="sd">            :doc:`queryguide/dml`</span>
</span><span data-line="4556">
</span><span data-line="4557"><span class="sd">            :meth:`.Session.bulk_insert_mappings`</span>
</span><span data-line="4558">
</span><span data-line="4559"><span class="sd">            :meth:`.Session.bulk_update_mappings`</span>
</span><span data-line="4560">
</span><span data-line="4561"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="4562">
</span><span data-line="4563">        <span class="n">obj_states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="4564">
</span><span data-line="4565">        <span class="n">obj_states</span> <span class="o">=</span> <span class="p">(</span><span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">)</span>
</span><span data-line="4566">
</span><span data-line="4567">        <span class="k">if</span> <span class="ow">not</span> <span class="n">preserve_order</span><span class="p">:</span>
</span><span data-line="4568">            <span class="c1"># the purpose of this sort is just so that common mappers</span>
</span><span data-line="4569">            <span class="c1"># and persistence states are grouped together, so that groupby</span>
</span><span data-line="4570">            <span class="c1"># will return a single group for a particular type of mapper.</span>
</span><span data-line="4571">            <span class="c1"># it&#39;s not trying to be deterministic beyond that.</span>
</span><span data-line="4572">            <span class="n">obj_states</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span data-line="4573">                <span class="n">obj_states</span><span class="p">,</span>
</span><span data-line="4574">                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">mapper</span><span class="p">),</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
</span><span data-line="4575">            <span class="p">)</span>
</span><span data-line="4576">
</span><span data-line="4577">        <span class="k">def</span> <span class="nf">grouping_key</span><span class="p">(</span>
</span><span data-line="4578">            <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="4579">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="4580">            <span class="k">return</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">mapper</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="4581">
</span><span data-line="4582">        <span class="k">for</span> <span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">isupdate</span><span class="p">),</span> <span class="n">states</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
</span><span data-line="4583">            <span class="n">obj_states</span><span class="p">,</span> <span class="n">grouping_key</span>
</span><span data-line="4584">        <span class="p">):</span>
</span><span data-line="4585">            <span class="bp">self</span><span class="o">.</span><span class="n">_bulk_save_mappings</span><span class="p">(</span>
</span><span data-line="4586">                <span class="n">mapper</span><span class="p">,</span>
</span><span data-line="4587">                <span class="n">states</span><span class="p">,</span>
</span><span data-line="4588">                <span class="n">isupdate</span><span class="o">=</span><span class="n">isupdate</span><span class="p">,</span>
</span><span data-line="4589">                <span class="n">isstates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="4590">                <span class="n">return_defaults</span><span class="o">=</span><span class="n">return_defaults</span><span class="p">,</span>
</span><span data-line="4591">                <span class="n">update_changed_only</span><span class="o">=</span><span class="n">update_changed_only</span><span class="p">,</span>
</span><span data-line="4592">                <span class="n">render_nulls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="4593">            <span class="p">)</span>
</span><span data-line="4594">
</span><span data-line="4595">    <span class="k">def</span> <span class="nf">bulk_insert_mappings</span><span class="p">(</span>
</span><span data-line="4596">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="4597">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="4598">        <span class="n">mappings</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span data-line="4599">        <span class="n">return_defaults</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="4600">        <span class="n">render_nulls</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="4601">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4602"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a bulk insert of the given list of mapping dictionaries.</span>
</span><span data-line="4603">
</span><span data-line="4604"><span class="sd">        .. legacy::</span>
</span><span data-line="4605">
</span><span data-line="4606"><span class="sd">            This method is a legacy feature as of the 2.0 series of</span>
</span><span data-line="4607"><span class="sd">            SQLAlchemy.   For modern bulk INSERT and UPDATE, see</span>
</span><span data-line="4608"><span class="sd">            the sections :ref:`orm_queryguide_bulk_insert` and</span>
</span><span data-line="4609"><span class="sd">            :ref:`orm_queryguide_bulk_update`.  The 2.0 API shares</span>
</span><span data-line="4610"><span class="sd">            implementation details with this method and adds new features</span>
</span><span data-line="4611"><span class="sd">            as well.</span>
</span><span data-line="4612">
</span><span data-line="4613"><span class="sd">        :param mapper: a mapped class, or the actual :class:`_orm.Mapper`</span>
</span><span data-line="4614"><span class="sd">         object,</span>
</span><span data-line="4615"><span class="sd">         representing the single kind of object represented within the mapping</span>
</span><span data-line="4616"><span class="sd">         list.</span>
</span><span data-line="4617">
</span><span data-line="4618"><span class="sd">        :param mappings: a sequence of dictionaries, each one containing the</span>
</span><span data-line="4619"><span class="sd">         state of the mapped row to be inserted, in terms of the attribute</span>
</span><span data-line="4620"><span class="sd">         names on the mapped class.   If the mapping refers to multiple tables,</span>
</span><span data-line="4621"><span class="sd">         such as a joined-inheritance mapping, each dictionary must contain all</span>
</span><span data-line="4622"><span class="sd">         keys to be populated into all tables.</span>
</span><span data-line="4623">
</span><span data-line="4624"><span class="sd">        :param return_defaults: when True, the INSERT process will be altered</span>
</span><span data-line="4625"><span class="sd">         to ensure that newly generated primary key values will be fetched.</span>
</span><span data-line="4626"><span class="sd">         The rationale for this parameter is typically to enable</span>
</span><span data-line="4627"><span class="sd">         :ref:`Joined Table Inheritance &lt;joined_inheritance&gt;` mappings to</span>
</span><span data-line="4628"><span class="sd">         be bulk inserted.</span>
</span><span data-line="4629">
</span><span data-line="4630"><span class="sd">         .. note:: for backends that don&#39;t support RETURNING, the</span>
</span><span data-line="4631"><span class="sd">            :paramref:`_orm.Session.bulk_insert_mappings.return_defaults`</span>
</span><span data-line="4632"><span class="sd">            parameter can significantly decrease performance as INSERT</span>
</span><span data-line="4633"><span class="sd">            statements can no longer be batched.   See</span>
</span><span data-line="4634"><span class="sd">            :ref:`engine_insertmanyvalues`</span>
</span><span data-line="4635"><span class="sd">            for background on which backends are affected.</span>
</span><span data-line="4636">
</span><span data-line="4637"><span class="sd">        :param render_nulls: When True, a value of ``None`` will result</span>
</span><span data-line="4638"><span class="sd">         in a NULL value being included in the INSERT statement, rather</span>
</span><span data-line="4639"><span class="sd">         than the column being omitted from the INSERT.   This allows all</span>
</span><span data-line="4640"><span class="sd">         the rows being INSERTed to have the identical set of columns which</span>
</span><span data-line="4641"><span class="sd">         allows the full set of rows to be batched to the DBAPI.  Normally,</span>
</span><span data-line="4642"><span class="sd">         each column-set that contains a different combination of NULL values</span>
</span><span data-line="4643"><span class="sd">         than the previous row must omit a different series of columns from</span>
</span><span data-line="4644"><span class="sd">         the rendered INSERT statement, which means it must be emitted as a</span>
</span><span data-line="4645"><span class="sd">         separate statement.   By passing this flag, the full set of rows</span>
</span><span data-line="4646"><span class="sd">         are guaranteed to be batchable into one batch; the cost however is</span>
</span><span data-line="4647"><span class="sd">         that server-side defaults which are invoked by an omitted column will</span>
</span><span data-line="4648"><span class="sd">         be skipped, so care must be taken to ensure that these are not</span>
</span><span data-line="4649"><span class="sd">         necessary.</span>
</span><span data-line="4650">
</span><span data-line="4651"><span class="sd">         .. warning::</span>
</span><span data-line="4652">
</span><span data-line="4653"><span class="sd">            When this flag is set, **server side default SQL values will</span>
</span><span data-line="4654"><span class="sd">            not be invoked** for those columns that are inserted as NULL;</span>
</span><span data-line="4655"><span class="sd">            the NULL value will be sent explicitly.   Care must be taken</span>
</span><span data-line="4656"><span class="sd">            to ensure that no server-side default functions need to be</span>
</span><span data-line="4657"><span class="sd">            invoked for the operation as a whole.</span>
</span><span data-line="4658">
</span><span data-line="4659"><span class="sd">        .. seealso::</span>
</span><span data-line="4660">
</span><span data-line="4661"><span class="sd">            :doc:`queryguide/dml`</span>
</span><span data-line="4662">
</span><span data-line="4663"><span class="sd">            :meth:`.Session.bulk_save_objects`</span>
</span><span data-line="4664">
</span><span data-line="4665"><span class="sd">            :meth:`.Session.bulk_update_mappings`</span>
</span><span data-line="4666">
</span><span data-line="4667"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="4668">        <span class="bp">self</span><span class="o">.</span><span class="n">_bulk_save_mappings</span><span class="p">(</span>
</span><span data-line="4669">            <span class="n">mapper</span><span class="p">,</span>
</span><span data-line="4670">            <span class="n">mappings</span><span class="p">,</span>
</span><span data-line="4671">            <span class="n">isupdate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="4672">            <span class="n">isstates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="4673">            <span class="n">return_defaults</span><span class="o">=</span><span class="n">return_defaults</span><span class="p">,</span>
</span><span data-line="4674">            <span class="n">update_changed_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="4675">            <span class="n">render_nulls</span><span class="o">=</span><span class="n">render_nulls</span><span class="p">,</span>
</span><span data-line="4676">        <span class="p">)</span>
</span><span data-line="4677">
</span><span data-line="4678">    <span class="k">def</span> <span class="nf">bulk_update_mappings</span><span class="p">(</span>
</span><span data-line="4679">        <span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">mappings</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
</span><span data-line="4680">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4681"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a bulk update of the given list of mapping dictionaries.</span>
</span><span data-line="4682">
</span><span data-line="4683"><span class="sd">        .. legacy::</span>
</span><span data-line="4684">
</span><span data-line="4685"><span class="sd">            This method is a legacy feature as of the 2.0 series of</span>
</span><span data-line="4686"><span class="sd">            SQLAlchemy.   For modern bulk INSERT and UPDATE, see</span>
</span><span data-line="4687"><span class="sd">            the sections :ref:`orm_queryguide_bulk_insert` and</span>
</span><span data-line="4688"><span class="sd">            :ref:`orm_queryguide_bulk_update`.  The 2.0 API shares</span>
</span><span data-line="4689"><span class="sd">            implementation details with this method and adds new features</span>
</span><span data-line="4690"><span class="sd">            as well.</span>
</span><span data-line="4691">
</span><span data-line="4692"><span class="sd">        :param mapper: a mapped class, or the actual :class:`_orm.Mapper`</span>
</span><span data-line="4693"><span class="sd">         object,</span>
</span><span data-line="4694"><span class="sd">         representing the single kind of object represented within the mapping</span>
</span><span data-line="4695"><span class="sd">         list.</span>
</span><span data-line="4696">
</span><span data-line="4697"><span class="sd">        :param mappings: a sequence of dictionaries, each one containing the</span>
</span><span data-line="4698"><span class="sd">         state of the mapped row to be updated, in terms of the attribute names</span>
</span><span data-line="4699"><span class="sd">         on the mapped class.   If the mapping refers to multiple tables, such</span>
</span><span data-line="4700"><span class="sd">         as a joined-inheritance mapping, each dictionary may contain keys</span>
</span><span data-line="4701"><span class="sd">         corresponding to all tables.   All those keys which are present and</span>
</span><span data-line="4702"><span class="sd">         are not part of the primary key are applied to the SET clause of the</span>
</span><span data-line="4703"><span class="sd">         UPDATE statement; the primary key values, which are required, are</span>
</span><span data-line="4704"><span class="sd">         applied to the WHERE clause.</span>
</span><span data-line="4705">
</span><span data-line="4706">
</span><span data-line="4707"><span class="sd">        .. seealso::</span>
</span><span data-line="4708">
</span><span data-line="4709"><span class="sd">            :doc:`queryguide/dml`</span>
</span><span data-line="4710">
</span><span data-line="4711"><span class="sd">            :meth:`.Session.bulk_insert_mappings`</span>
</span><span data-line="4712">
</span><span data-line="4713"><span class="sd">            :meth:`.Session.bulk_save_objects`</span>
</span><span data-line="4714">
</span><span data-line="4715"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="4716">        <span class="bp">self</span><span class="o">.</span><span class="n">_bulk_save_mappings</span><span class="p">(</span>
</span><span data-line="4717">            <span class="n">mapper</span><span class="p">,</span>
</span><span data-line="4718">            <span class="n">mappings</span><span class="p">,</span>
</span><span data-line="4719">            <span class="n">isupdate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="4720">            <span class="n">isstates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="4721">            <span class="n">return_defaults</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="4722">            <span class="n">update_changed_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="4723">            <span class="n">render_nulls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="4724">        <span class="p">)</span>
</span><span data-line="4725">
</span><span data-line="4726">    <span class="k">def</span> <span class="nf">_bulk_save_mappings</span><span class="p">(</span>
</span><span data-line="4727">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="4728">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="4729">        <span class="n">mappings</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">_O</span><span class="p">]],</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
</span><span data-line="4730">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="4731">        <span class="n">isupdate</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="4732">        <span class="n">isstates</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="4733">        <span class="n">return_defaults</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="4734">        <span class="n">update_changed_only</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="4735">        <span class="n">render_nulls</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="4736">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="4737">        <span class="n">mapper</span> <span class="o">=</span> <span class="n">_class_to_mapper</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
</span><span data-line="4738">        <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="4739">
</span><span data-line="4740">        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">()</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>
</span><span data-line="4741">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="4742">            <span class="k">if</span> <span class="n">isupdate</span><span class="p">:</span>
</span><span data-line="4743">                <span class="n">bulk_persistence</span><span class="o">.</span><span class="n">_bulk_update</span><span class="p">(</span>
</span><span data-line="4744">                    <span class="n">mapper</span><span class="p">,</span>
</span><span data-line="4745">                    <span class="n">mappings</span><span class="p">,</span>
</span><span data-line="4746">                    <span class="n">transaction</span><span class="p">,</span>
</span><span data-line="4747">                    <span class="n">isstates</span><span class="o">=</span><span class="n">isstates</span><span class="p">,</span>
</span><span data-line="4748">                    <span class="n">update_changed_only</span><span class="o">=</span><span class="n">update_changed_only</span><span class="p">,</span>
</span><span data-line="4749">                <span class="p">)</span>
</span><span data-line="4750">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="4751">                <span class="n">bulk_persistence</span><span class="o">.</span><span class="n">_bulk_insert</span><span class="p">(</span>
</span><span data-line="4752">                    <span class="n">mapper</span><span class="p">,</span>
</span><span data-line="4753">                    <span class="n">mappings</span><span class="p">,</span>
</span><span data-line="4754">                    <span class="n">transaction</span><span class="p">,</span>
</span><span data-line="4755">                    <span class="n">isstates</span><span class="o">=</span><span class="n">isstates</span><span class="p">,</span>
</span><span data-line="4756">                    <span class="n">return_defaults</span><span class="o">=</span><span class="n">return_defaults</span><span class="p">,</span>
</span><span data-line="4757">                    <span class="n">render_nulls</span><span class="o">=</span><span class="n">render_nulls</span><span class="p">,</span>
</span><span data-line="4758">                <span class="p">)</span>
</span><span data-line="4759">            <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span data-line="4760">
</span><span data-line="4761">        <span class="k">except</span><span class="p">:</span>
</span><span data-line="4762">            <span class="k">with</span> <span class="n">util</span><span class="o">.</span><span class="n">safe_reraise</span><span class="p">():</span>
</span><span data-line="4763">                <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">_capture_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="4764">        <span class="k">finally</span><span class="p">:</span>
</span><span data-line="4765">            <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="4766">
</span><span data-line="4767">    <span class="k">def</span> <span class="nf">is_modified</span><span class="p">(</span>
</span><span data-line="4768">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">include_collections</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="4769">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="4770"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return ``True`` if the given instance has locally</span>
</span><span data-line="4771"><span class="sd">        modified attributes.</span>
</span><span data-line="4772">
</span><span data-line="4773"><span class="sd">        This method retrieves the history for each instrumented</span>
</span><span data-line="4774"><span class="sd">        attribute on the instance and performs a comparison of the current</span>
</span><span data-line="4775"><span class="sd">        value to its previously flushed or committed value, if any.</span>
</span><span data-line="4776">
</span><span data-line="4777"><span class="sd">        It is in effect a more expensive and accurate</span>
</span><span data-line="4778"><span class="sd">        version of checking for the given instance in the</span>
</span><span data-line="4779"><span class="sd">        :attr:`.Session.dirty` collection; a full test for</span>
</span><span data-line="4780"><span class="sd">        each attribute&#39;s net &quot;dirty&quot; status is performed.</span>
</span><span data-line="4781">
</span><span data-line="4782"><span class="sd">        E.g.::</span>
</span><span data-line="4783">
</span><span data-line="4784"><span class="sd">            return session.is_modified(someobject)</span>
</span><span data-line="4785">
</span><span data-line="4786"><span class="sd">        A few caveats to this method apply:</span>
</span><span data-line="4787">
</span><span data-line="4788"><span class="sd">        * Instances present in the :attr:`.Session.dirty` collection may</span>
</span><span data-line="4789"><span class="sd">          report ``False`` when tested with this method.  This is because</span>
</span><span data-line="4790"><span class="sd">          the object may have received change events via attribute mutation,</span>
</span><span data-line="4791"><span class="sd">          thus placing it in :attr:`.Session.dirty`, but ultimately the state</span>
</span><span data-line="4792"><span class="sd">          is the same as that loaded from the database, resulting in no net</span>
</span><span data-line="4793"><span class="sd">          change here.</span>
</span><span data-line="4794"><span class="sd">        * Scalar attributes may not have recorded the previously set</span>
</span><span data-line="4795"><span class="sd">          value when a new value was applied, if the attribute was not loaded,</span>
</span><span data-line="4796"><span class="sd">          or was expired, at the time the new value was received - in these</span>
</span><span data-line="4797"><span class="sd">          cases, the attribute is assumed to have a change, even if there is</span>
</span><span data-line="4798"><span class="sd">          ultimately no net change against its database value. SQLAlchemy in</span>
</span><span data-line="4799"><span class="sd">          most cases does not need the &quot;old&quot; value when a set event occurs, so</span>
</span><span data-line="4800"><span class="sd">          it skips the expense of a SQL call if the old value isn&#39;t present,</span>
</span><span data-line="4801"><span class="sd">          based on the assumption that an UPDATE of the scalar value is</span>
</span><span data-line="4802"><span class="sd">          usually needed, and in those few cases where it isn&#39;t, is less</span>
</span><span data-line="4803"><span class="sd">          expensive on average than issuing a defensive SELECT.</span>
</span><span data-line="4804">
</span><span data-line="4805"><span class="sd">          The &quot;old&quot; value is fetched unconditionally upon set only if the</span>
</span><span data-line="4806"><span class="sd">          attribute container has the ``active_history`` flag set to ``True``.</span>
</span><span data-line="4807"><span class="sd">          This flag is set typically for primary key attributes and scalar</span>
</span><span data-line="4808"><span class="sd">          object references that are not a simple many-to-one.  To set this</span>
</span><span data-line="4809"><span class="sd">          flag for any arbitrary mapped column, use the ``active_history``</span>
</span><span data-line="4810"><span class="sd">          argument with :func:`.column_property`.</span>
</span><span data-line="4811">
</span><span data-line="4812"><span class="sd">        :param instance: mapped instance to be tested for pending changes.</span>
</span><span data-line="4813"><span class="sd">        :param include_collections: Indicates if multivalued collections</span>
</span><span data-line="4814"><span class="sd">         should be included in the operation.  Setting this to ``False`` is a</span>
</span><span data-line="4815"><span class="sd">         way to detect only local-column based properties (i.e. scalar columns</span>
</span><span data-line="4816"><span class="sd">         or many-to-one foreign keys) that would result in an UPDATE for this</span>
</span><span data-line="4817"><span class="sd">         instance upon flush.</span>
</span><span data-line="4818">
</span><span data-line="4819"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="4820">        <span class="n">state</span> <span class="o">=</span> <span class="n">object_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="4821">
</span><span data-line="4822">        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span>
</span><span data-line="4823">            <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="4824">
</span><span data-line="4825">        <span class="n">dict_</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span>
</span><span data-line="4826">
</span><span data-line="4827">        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
</span><span data-line="4828">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="4829">                <span class="ow">not</span> <span class="n">include_collections</span>
</span><span data-line="4830">                <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span> <span class="s2">&quot;get_collection&quot;</span><span class="p">)</span>
</span><span data-line="4831">            <span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span> <span class="s2">&quot;get_history&quot;</span><span class="p">):</span>
</span><span data-line="4832">                <span class="k">continue</span>
</span><span data-line="4833">
</span><span data-line="4834">            <span class="p">(</span><span class="n">added</span><span class="p">,</span> <span class="n">unchanged</span><span class="p">,</span> <span class="n">deleted</span><span class="p">)</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get_history</span><span class="p">(</span>
</span><span data-line="4835">                <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">NO_CHANGE</span>
</span><span data-line="4836">            <span class="p">)</span>
</span><span data-line="4837">
</span><span data-line="4838">            <span class="k">if</span> <span class="n">added</span> <span class="ow">or</span> <span class="n">deleted</span><span class="p">:</span>
</span><span data-line="4839">                <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="4840">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="4841">            <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="4842">
</span><span data-line="4843">    <span class="nd">@property</span>
</span><span data-line="4844">    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="4845"><span class="w">        </span><span class="sd">&quot;&quot;&quot;True if this :class:`.Session` not in &quot;partial rollback&quot; state.</span>
</span><span data-line="4846">
</span><span data-line="4847"><span class="sd">        .. versionchanged:: 1.4 The :class:`_orm.Session` no longer begins</span>
</span><span data-line="4848"><span class="sd">           a new transaction immediately, so this attribute will be False</span>
</span><span data-line="4849"><span class="sd">           when the :class:`_orm.Session` is first instantiated.</span>
</span><span data-line="4850">
</span><span data-line="4851"><span class="sd">        &quot;partial rollback&quot; state typically indicates that the flush process</span>
</span><span data-line="4852"><span class="sd">        of the :class:`_orm.Session` has failed, and that the</span>
</span><span data-line="4853"><span class="sd">        :meth:`_orm.Session.rollback` method must be emitted in order to</span>
</span><span data-line="4854"><span class="sd">        fully roll back the transaction.</span>
</span><span data-line="4855">
</span><span data-line="4856"><span class="sd">        If this :class:`_orm.Session` is not in a transaction at all, the</span>
</span><span data-line="4857"><span class="sd">        :class:`_orm.Session` will autobegin when it is first used, so in this</span>
</span><span data-line="4858"><span class="sd">        case :attr:`_orm.Session.is_active` will return True.</span>
</span><span data-line="4859">
</span><span data-line="4860"><span class="sd">        Otherwise, if this :class:`_orm.Session` is within a transaction,</span>
</span><span data-line="4861"><span class="sd">        and that transaction has not been rolled back internally, the</span>
</span><span data-line="4862"><span class="sd">        :attr:`_orm.Session.is_active` will also return True.</span>
</span><span data-line="4863">
</span><span data-line="4864"><span class="sd">        .. seealso::</span>
</span><span data-line="4865">
</span><span data-line="4866"><span class="sd">            :ref:`faq_session_rollback`</span>
</span><span data-line="4867">
</span><span data-line="4868"><span class="sd">            :meth:`_orm.Session.in_transaction`</span>
</span><span data-line="4869">
</span><span data-line="4870"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="4871">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">is_active</span>
</span><span data-line="4872">
</span><span data-line="4873">    <span class="nd">@property</span>
</span><span data-line="4874">    <span class="k">def</span> <span class="nf">_dirty_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="4875"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The set of all persistent states considered dirty.</span>
</span><span data-line="4876">
</span><span data-line="4877"><span class="sd">        This method returns all states that were modified including</span>
</span><span data-line="4878"><span class="sd">        those that were possibly deleted.</span>
</span><span data-line="4879">
</span><span data-line="4880"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="4881">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_dirty_states</span><span class="p">()</span>
</span><span data-line="4882">
</span><span data-line="4883">    <span class="nd">@property</span>
</span><span data-line="4884">    <span class="k">def</span> <span class="nf">dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdentitySet</span><span class="p">:</span>
</span><span data-line="4885"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The set of all persistent instances considered dirty.</span>
</span><span data-line="4886">
</span><span data-line="4887"><span class="sd">        E.g.::</span>
</span><span data-line="4888">
</span><span data-line="4889"><span class="sd">            some_mapped_object in session.dirty</span>
</span><span data-line="4890">
</span><span data-line="4891"><span class="sd">        Instances are considered dirty when they were modified but not</span>
</span><span data-line="4892"><span class="sd">        deleted.</span>
</span><span data-line="4893">
</span><span data-line="4894"><span class="sd">        Note that this &#39;dirty&#39; calculation is &#39;optimistic&#39;; most</span>
</span><span data-line="4895"><span class="sd">        attribute-setting or collection modification operations will</span>
</span><span data-line="4896"><span class="sd">        mark an instance as &#39;dirty&#39; and place it in this set, even if</span>
</span><span data-line="4897"><span class="sd">        there is no net change to the attribute&#39;s value.  At flush</span>
</span><span data-line="4898"><span class="sd">        time, the value of each attribute is compared to its</span>
</span><span data-line="4899"><span class="sd">        previously saved value, and if there&#39;s no net change, no SQL</span>
</span><span data-line="4900"><span class="sd">        operation will occur (this is a more expensive operation so</span>
</span><span data-line="4901"><span class="sd">        it&#39;s only done at flush time).</span>
</span><span data-line="4902">
</span><span data-line="4903"><span class="sd">        To check if an instance has actionable net changes to its</span>
</span><span data-line="4904"><span class="sd">        attributes, use the :meth:`.Session.is_modified` method.</span>
</span><span data-line="4905">
</span><span data-line="4906"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="4907">        <span class="k">return</span> <span class="n">IdentitySet</span><span class="p">(</span>
</span><span data-line="4908">            <span class="p">[</span>
</span><span data-line="4909">                <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span>
</span><span data-line="4910">                <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty_states</span>
</span><span data-line="4911">                <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span>
</span><span data-line="4912">            <span class="p">]</span>
</span><span data-line="4913">        <span class="p">)</span>
</span><span data-line="4914">
</span><span data-line="4915">    <span class="nd">@property</span>
</span><span data-line="4916">    <span class="k">def</span> <span class="nf">deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdentitySet</span><span class="p">:</span>
</span><span data-line="4917">        <span class="s2">&quot;The set of all instances marked as &#39;deleted&#39; within this ``Session``&quot;</span>
</span><span data-line="4918">
</span><span data-line="4919">        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">IdentitySet</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span><span data-line="4920">
</span><span data-line="4921">    <span class="nd">@property</span>
</span><span data-line="4922">    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdentitySet</span><span class="p">:</span>
</span><span data-line="4923">        <span class="s2">&quot;The set of all instances marked as &#39;new&#39; within this ``Session``.&quot;</span>
</span><span data-line="4924">
</span><span data-line="4925">        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">IdentitySet</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span><span data-line="4926">
</span><span data-line="4927">
</span><span data-line="4928"><span class="n">_S</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_S&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;Session&quot;</span><span class="p">)</span>
</span><span data-line="4929">
</span><span data-line="4930">
</span><span data-line="4931"><span class="k">class</span> <span class="nc">sessionmaker</span><span class="p">(</span><span class="n">_SessionClassMethods</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">_S</span><span class="p">]):</span>
</span><span data-line="4932"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A configurable :class:`.Session` factory.</span>
</span><span data-line="4933">
</span><span data-line="4934"><span class="sd">    The :class:`.sessionmaker` factory generates new</span>
</span><span data-line="4935"><span class="sd">    :class:`.Session` objects when called, creating them given</span>
</span><span data-line="4936"><span class="sd">    the configurational arguments established here.</span>
</span><span data-line="4937">
</span><span data-line="4938"><span class="sd">    e.g.::</span>
</span><span data-line="4939">
</span><span data-line="4940"><span class="sd">        from sqlalchemy import create_engine</span>
</span><span data-line="4941"><span class="sd">        from sqlalchemy.orm import sessionmaker</span>
</span><span data-line="4942">
</span><span data-line="4943"><span class="sd">        # an Engine, which the Session will use for connection</span>
</span><span data-line="4944"><span class="sd">        # resources</span>
</span><span data-line="4945"><span class="sd">        engine = create_engine(&#39;postgresql+psycopg2://scott:tiger@localhost/&#39;)</span>
</span><span data-line="4946">
</span><span data-line="4947"><span class="sd">        Session = sessionmaker(engine)</span>
</span><span data-line="4948">
</span><span data-line="4949"><span class="sd">        with Session() as session:</span>
</span><span data-line="4950"><span class="sd">            session.add(some_object)</span>
</span><span data-line="4951"><span class="sd">            session.add(some_other_object)</span>
</span><span data-line="4952"><span class="sd">            session.commit()</span>
</span><span data-line="4953">
</span><span data-line="4954"><span class="sd">    Context manager use is optional; otherwise, the returned</span>
</span><span data-line="4955"><span class="sd">    :class:`_orm.Session` object may be closed explicitly via the</span>
</span><span data-line="4956"><span class="sd">    :meth:`_orm.Session.close` method.   Using a</span>
</span><span data-line="4957"><span class="sd">    ``try:/finally:`` block is optional, however will ensure that the close</span>
</span><span data-line="4958"><span class="sd">    takes place even if there are database errors::</span>
</span><span data-line="4959">
</span><span data-line="4960"><span class="sd">        session = Session()</span>
</span><span data-line="4961"><span class="sd">        try:</span>
</span><span data-line="4962"><span class="sd">            session.add(some_object)</span>
</span><span data-line="4963"><span class="sd">            session.add(some_other_object)</span>
</span><span data-line="4964"><span class="sd">            session.commit()</span>
</span><span data-line="4965"><span class="sd">        finally:</span>
</span><span data-line="4966"><span class="sd">            session.close()</span>
</span><span data-line="4967">
</span><span data-line="4968"><span class="sd">    :class:`.sessionmaker` acts as a factory for :class:`_orm.Session`</span>
</span><span data-line="4969"><span class="sd">    objects in the same way as an :class:`_engine.Engine` acts as a factory</span>
</span><span data-line="4970"><span class="sd">    for :class:`_engine.Connection` objects.  In this way it also includes</span>
</span><span data-line="4971"><span class="sd">    a :meth:`_orm.sessionmaker.begin` method, that provides a context</span>
</span><span data-line="4972"><span class="sd">    manager which both begins and commits a transaction, as well as closes</span>
</span><span data-line="4973"><span class="sd">    out the :class:`_orm.Session` when complete, rolling back the transaction</span>
</span><span data-line="4974"><span class="sd">    if any errors occur::</span>
</span><span data-line="4975">
</span><span data-line="4976"><span class="sd">        Session = sessionmaker(engine)</span>
</span><span data-line="4977">
</span><span data-line="4978"><span class="sd">        with Session.begin() as session:</span>
</span><span data-line="4979"><span class="sd">            session.add(some_object)</span>
</span><span data-line="4980"><span class="sd">            session.add(some_other_object)</span>
</span><span data-line="4981"><span class="sd">        # commits transaction, closes session</span>
</span><span data-line="4982">
</span><span data-line="4983"><span class="sd">    .. versionadded:: 1.4</span>
</span><span data-line="4984">
</span><span data-line="4985"><span class="sd">    When calling upon :class:`_orm.sessionmaker` to construct a</span>
</span><span data-line="4986"><span class="sd">    :class:`_orm.Session`, keyword arguments may also be passed to the</span>
</span><span data-line="4987"><span class="sd">    method; these arguments will override that of the globally configured</span>
</span><span data-line="4988"><span class="sd">    parameters.  Below we use a :class:`_orm.sessionmaker` bound to a certain</span>
</span><span data-line="4989"><span class="sd">    :class:`_engine.Engine` to produce a :class:`_orm.Session` that is instead</span>
</span><span data-line="4990"><span class="sd">    bound to a specific :class:`_engine.Connection` procured from that engine::</span>
</span><span data-line="4991">
</span><span data-line="4992"><span class="sd">        Session = sessionmaker(engine)</span>
</span><span data-line="4993">
</span><span data-line="4994"><span class="sd">        # bind an individual session to a connection</span>
</span><span data-line="4995">
</span><span data-line="4996"><span class="sd">        with engine.connect() as connection:</span>
</span><span data-line="4997"><span class="sd">            with Session(bind=connection) as session:</span>
</span><span data-line="4998"><span class="sd">                # work with session</span>
</span><span data-line="4999">
</span><span data-line="5000"><span class="sd">    The class also includes a method :meth:`_orm.sessionmaker.configure`, which</span>
</span><span data-line="5001"><span class="sd">    can be used to specify additional keyword arguments to the factory, which</span>
</span><span data-line="5002"><span class="sd">    will take effect for subsequent :class:`.Session` objects generated. This</span>
</span><span data-line="5003"><span class="sd">    is usually used to associate one or more :class:`_engine.Engine` objects</span>
</span><span data-line="5004"><span class="sd">    with an existing</span>
</span><span data-line="5005"><span class="sd">    :class:`.sessionmaker` factory before it is first used::</span>
</span><span data-line="5006">
</span><span data-line="5007"><span class="sd">        # application starts, sessionmaker does not have</span>
</span><span data-line="5008"><span class="sd">        # an engine bound yet</span>
</span><span data-line="5009"><span class="sd">        Session = sessionmaker()</span>
</span><span data-line="5010">
</span><span data-line="5011"><span class="sd">        # ... later, when an engine URL is read from a configuration</span>
</span><span data-line="5012"><span class="sd">        # file or other events allow the engine to be created</span>
</span><span data-line="5013"><span class="sd">        engine = create_engine(&#39;sqlite:///foo.db&#39;)</span>
</span><span data-line="5014"><span class="sd">        Session.configure(bind=engine)</span>
</span><span data-line="5015">
</span><span data-line="5016"><span class="sd">        sess = Session()</span>
</span><span data-line="5017"><span class="sd">        # work with session</span>
</span><span data-line="5018">
</span><span data-line="5019"><span class="sd">    .. seealso::</span>
</span><span data-line="5020">
</span><span data-line="5021"><span class="sd">        :ref:`session_getting` - introductory text on creating</span>
</span><span data-line="5022"><span class="sd">        sessions using :class:`.sessionmaker`.</span>
</span><span data-line="5023">
</span><span data-line="5024"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="5025">
</span><span data-line="5026">    <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_S</span><span class="p">]</span>
</span><span data-line="5027">
</span><span data-line="5028">    <span class="nd">@overload</span>
</span><span data-line="5029">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="5030">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="5031">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_SessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="5032">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="5033">        <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_S</span><span class="p">],</span>
</span><span data-line="5034">        <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="5035">        <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="5036">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="5037">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="5038">    <span class="p">):</span> <span class="o">...</span>
</span><span data-line="5039">
</span><span data-line="5040">    <span class="nd">@overload</span>
</span><span data-line="5041">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="5042">        <span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;sessionmaker[Session]&quot;</span><span class="p">,</span>
</span><span data-line="5043">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_SessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="5044">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="5045">        <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="5046">        <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="5047">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="5048">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="5049">    <span class="p">):</span> <span class="o">...</span>
</span><span data-line="5050">
</span><span data-line="5051">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="5052">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="5053">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_SessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="5054">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="5055">        <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_S</span><span class="p">]</span> <span class="o">=</span> <span class="n">Session</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
</span><span data-line="5056">        <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="5057">        <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="5058">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="5059">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="5060">    <span class="p">):</span>
</span><span data-line="5061"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct a new :class:`.sessionmaker`.</span>
</span><span data-line="5062">
</span><span data-line="5063"><span class="sd">        All arguments here except for ``class_`` correspond to arguments</span>
</span><span data-line="5064"><span class="sd">        accepted by :class:`.Session` directly.  See the</span>
</span><span data-line="5065"><span class="sd">        :meth:`.Session.__init__` docstring for more details on parameters.</span>
</span><span data-line="5066">
</span><span data-line="5067"><span class="sd">        :param bind: a :class:`_engine.Engine` or other :class:`.Connectable`</span>
</span><span data-line="5068"><span class="sd">         with</span>
</span><span data-line="5069"><span class="sd">         which newly created :class:`.Session` objects will be associated.</span>
</span><span data-line="5070"><span class="sd">        :param class\_: class to use in order to create new :class:`.Session`</span>
</span><span data-line="5071"><span class="sd">         objects.  Defaults to :class:`.Session`.</span>
</span><span data-line="5072"><span class="sd">        :param autoflush: The autoflush setting to use with newly created</span>
</span><span data-line="5073"><span class="sd">         :class:`.Session` objects.</span>
</span><span data-line="5074">
</span><span data-line="5075"><span class="sd">         .. seealso::</span>
</span><span data-line="5076">
</span><span data-line="5077"><span class="sd">            :ref:`session_flushing` - additional background on autoflush</span>
</span><span data-line="5078">
</span><span data-line="5079"><span class="sd">        :param expire_on_commit=True: the</span>
</span><span data-line="5080"><span class="sd">         :paramref:`_orm.Session.expire_on_commit` setting to use</span>
</span><span data-line="5081"><span class="sd">         with newly created :class:`.Session` objects.</span>
</span><span data-line="5082">
</span><span data-line="5083"><span class="sd">        :param info: optional dictionary of information that will be available</span>
</span><span data-line="5084"><span class="sd">         via :attr:`.Session.info`.  Note this dictionary is *updated*, not</span>
</span><span data-line="5085"><span class="sd">         replaced, when the ``info`` parameter is specified to the specific</span>
</span><span data-line="5086"><span class="sd">         :class:`.Session` construction operation.</span>
</span><span data-line="5087">
</span><span data-line="5088"><span class="sd">        :param \**kw: all other keyword arguments are passed to the</span>
</span><span data-line="5089"><span class="sd">         constructor of newly created :class:`.Session` objects.</span>
</span><span data-line="5090">
</span><span data-line="5091"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="5092">        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;bind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
</span><span data-line="5093">        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;autoflush&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">autoflush</span>
</span><span data-line="5094">        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;expire_on_commit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expire_on_commit</span>
</span><span data-line="5095">        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="5096">            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
</span><span data-line="5097">        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span> <span class="o">=</span> <span class="n">kw</span>
</span><span data-line="5098">        <span class="c1"># make our own subclass of the given class, so that</span>
</span><span data-line="5099">        <span class="c1"># events can be associated with it specifically.</span>
</span><span data-line="5100">        <span class="bp">self</span><span class="o">.</span><span class="n">class_</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span><span class="n">class_</span><span class="p">,),</span> <span class="p">{})</span>
</span><span data-line="5101">
</span><span data-line="5102">    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">AbstractContextManager</span><span class="p">[</span><span class="n">_S</span><span class="p">]:</span>
</span><span data-line="5103"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a context manager that both provides a new</span>
</span><span data-line="5104"><span class="sd">        :class:`_orm.Session` as well as a transaction that commits.</span>
</span><span data-line="5105">
</span><span data-line="5106">
</span><span data-line="5107"><span class="sd">        e.g.::</span>
</span><span data-line="5108">
</span><span data-line="5109"><span class="sd">            Session = sessionmaker(some_engine)</span>
</span><span data-line="5110">
</span><span data-line="5111"><span class="sd">            with Session.begin() as session:</span>
</span><span data-line="5112"><span class="sd">                session.add(some_object)</span>
</span><span data-line="5113">
</span><span data-line="5114"><span class="sd">            # commits transaction, closes session</span>
</span><span data-line="5115">
</span><span data-line="5116"><span class="sd">        .. versionadded:: 1.4</span>
</span><span data-line="5117">
</span><span data-line="5118">
</span><span data-line="5119"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="5120">
</span><span data-line="5121">        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="p">()</span>
</span><span data-line="5122">        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">_maker_context_manager</span><span class="p">()</span>
</span><span data-line="5123">
</span><span data-line="5124">    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">local_kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_S</span><span class="p">:</span>
</span><span data-line="5125"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a new :class:`.Session` object using the configuration</span>
</span><span data-line="5126"><span class="sd">        established in this :class:`.sessionmaker`.</span>
</span><span data-line="5127">
</span><span data-line="5128"><span class="sd">        In Python, the ``__call__`` method is invoked on an object when</span>
</span><span data-line="5129"><span class="sd">        it is &quot;called&quot; in the same way as a function::</span>
</span><span data-line="5130">
</span><span data-line="5131"><span class="sd">            Session = sessionmaker(some_engine)</span>
</span><span data-line="5132"><span class="sd">            session = Session()  # invokes sessionmaker.__call__()</span>
</span><span data-line="5133">
</span><span data-line="5134"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="5135">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="5136">            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span> <span class="ow">and</span> <span class="s2">&quot;info&quot;</span> <span class="ow">in</span> <span class="n">local_kw</span><span class="p">:</span>
</span><span data-line="5137">                <span class="n">d</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span data-line="5138">                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">local_kw</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">])</span>
</span><span data-line="5139">                <span class="n">local_kw</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
</span><span data-line="5140">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="5141">                <span class="n">local_kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span data-line="5142">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">(</span><span class="o">**</span><span class="n">local_kw</span><span class="p">)</span>
</span><span data-line="5143">
</span><span data-line="5144">    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">new_kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="5145"><span class="w">        </span><span class="sd">&quot;&quot;&quot;(Re)configure the arguments for this sessionmaker.</span>
</span><span data-line="5146">
</span><span data-line="5147"><span class="sd">        e.g.::</span>
</span><span data-line="5148">
</span><span data-line="5149"><span class="sd">            Session = sessionmaker()</span>
</span><span data-line="5150">
</span><span data-line="5151"><span class="sd">            Session.configure(bind=create_engine(&#39;sqlite://&#39;))</span>
</span><span data-line="5152"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="5153">        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
</span><span data-line="5154">
</span><span data-line="5155">    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="5156">        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(class_=</span><span class="si">%r</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span data-line="5157">            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span data-line="5158">            <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span data-line="5159">            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
</span><span data-line="5160">        <span class="p">)</span>
</span><span data-line="5161">
</span><span data-line="5162">
</span><span data-line="5163"><span class="k">def</span> <span class="nf">close_all_sessions</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="5164"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Close all sessions in memory.</span>
</span><span data-line="5165">
</span><span data-line="5166"><span class="sd">    This function consults a global registry of all :class:`.Session` objects</span>
</span><span data-line="5167"><span class="sd">    and calls :meth:`.Session.close` on them, which resets them to a clean</span>
</span><span data-line="5168"><span class="sd">    state.</span>
</span><span data-line="5169">
</span><span data-line="5170"><span class="sd">    This function is not for general use but may be useful for test suites</span>
</span><span data-line="5171"><span class="sd">    within the teardown scheme.</span>
</span><span data-line="5172">
</span><span data-line="5173"><span class="sd">    .. versionadded:: 1.3</span>
</span><span data-line="5174">
</span><span data-line="5175"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="5176">
</span><span data-line="5177">    <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="n">_sessions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span data-line="5178">        <span class="n">sess</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="5179">
</span><span data-line="5180">
</span><span data-line="5181"><span class="k">def</span> <span class="nf">make_transient</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="5182"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Alter the state of the given instance so that it is :term:`transient`.</span>
</span><span data-line="5183">
</span><span data-line="5184"><span class="sd">    .. note::</span>
</span><span data-line="5185">
</span><span data-line="5186"><span class="sd">        :func:`.make_transient` is a special-case function for</span>
</span><span data-line="5187"><span class="sd">        advanced use cases only.</span>
</span><span data-line="5188">
</span><span data-line="5189"><span class="sd">    The given mapped instance is assumed to be in the :term:`persistent` or</span>
</span><span data-line="5190"><span class="sd">    :term:`detached` state.   The function will remove its association with any</span>
</span><span data-line="5191"><span class="sd">    :class:`.Session` as well as its :attr:`.InstanceState.identity`. The</span>
</span><span data-line="5192"><span class="sd">    effect is that the object will behave as though it were newly constructed,</span>
</span><span data-line="5193"><span class="sd">    except retaining any attribute / collection values that were loaded at the</span>
</span><span data-line="5194"><span class="sd">    time of the call.   The :attr:`.InstanceState.deleted` flag is also reset</span>
</span><span data-line="5195"><span class="sd">    if this object had been deleted as a result of using</span>
</span><span data-line="5196"><span class="sd">    :meth:`.Session.delete`.</span>
</span><span data-line="5197">
</span><span data-line="5198"><span class="sd">    .. warning::</span>
</span><span data-line="5199">
</span><span data-line="5200"><span class="sd">        :func:`.make_transient` does **not** &quot;unexpire&quot; or otherwise eagerly</span>
</span><span data-line="5201"><span class="sd">        load ORM-mapped attributes that are not currently loaded at the time</span>
</span><span data-line="5202"><span class="sd">        the function is called.   This includes attributes which:</span>
</span><span data-line="5203">
</span><span data-line="5204"><span class="sd">        * were expired via :meth:`.Session.expire`</span>
</span><span data-line="5205">
</span><span data-line="5206"><span class="sd">        * were expired as the natural effect of committing a session</span>
</span><span data-line="5207"><span class="sd">          transaction, e.g. :meth:`.Session.commit`</span>
</span><span data-line="5208">
</span><span data-line="5209"><span class="sd">        * are normally :term:`lazy loaded` but are not currently loaded</span>
</span><span data-line="5210">
</span><span data-line="5211"><span class="sd">        * are &quot;deferred&quot; (see :ref:`orm_queryguide_column_deferral`) and are</span>
</span><span data-line="5212"><span class="sd">          not yet loaded</span>
</span><span data-line="5213">
</span><span data-line="5214"><span class="sd">        * were not present in the query which loaded this object, such as that</span>
</span><span data-line="5215"><span class="sd">          which is common in joined table inheritance and other scenarios.</span>
</span><span data-line="5216">
</span><span data-line="5217"><span class="sd">        After :func:`.make_transient` is called, unloaded attributes such</span>
</span><span data-line="5218"><span class="sd">        as those above will normally resolve to the value ``None`` when</span>
</span><span data-line="5219"><span class="sd">        accessed, or an empty collection for a collection-oriented attribute.</span>
</span><span data-line="5220"><span class="sd">        As the object is transient and un-associated with any database</span>
</span><span data-line="5221"><span class="sd">        identity, it will no longer retrieve these values.</span>
</span><span data-line="5222">
</span><span data-line="5223"><span class="sd">    .. seealso::</span>
</span><span data-line="5224">
</span><span data-line="5225"><span class="sd">        :func:`.make_transient_to_detached`</span>
</span><span data-line="5226">
</span><span data-line="5227"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="5228">    <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="5229">    <span class="n">s</span> <span class="o">=</span> <span class="n">_state_session</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="5230">    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
</span><span data-line="5231">        <span class="n">s</span><span class="o">.</span><span class="n">_expunge_states</span><span class="p">([</span><span class="n">state</span><span class="p">])</span>
</span><span data-line="5232">
</span><span data-line="5233">    <span class="c1"># remove expired state</span>
</span><span data-line="5234">    <span class="n">state</span><span class="o">.</span><span class="n">expired_attributes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span data-line="5235">
</span><span data-line="5236">    <span class="c1"># remove deferred callables</span>
</span><span data-line="5237">    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">callables</span><span class="p">:</span>
</span><span data-line="5238">        <span class="k">del</span> <span class="n">state</span><span class="o">.</span><span class="n">callables</span>
</span><span data-line="5239">
</span><span data-line="5240">    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span data-line="5241">        <span class="k">del</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="5242">    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span><span class="p">:</span>
</span><span data-line="5243">        <span class="k">del</span> <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span>
</span><span data-line="5244">
</span><span data-line="5245">
</span><span data-line="5246"><span class="k">def</span> <span class="nf">make_transient_to_detached</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="5247"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Make the given transient instance :term:`detached`.</span>
</span><span data-line="5248">
</span><span data-line="5249"><span class="sd">    .. note::</span>
</span><span data-line="5250">
</span><span data-line="5251"><span class="sd">        :func:`.make_transient_to_detached` is a special-case function for</span>
</span><span data-line="5252"><span class="sd">        advanced use cases only.</span>
</span><span data-line="5253">
</span><span data-line="5254"><span class="sd">    All attribute history on the given instance</span>
</span><span data-line="5255"><span class="sd">    will be reset as though the instance were freshly loaded</span>
</span><span data-line="5256"><span class="sd">    from a query.  Missing attributes will be marked as expired.</span>
</span><span data-line="5257"><span class="sd">    The primary key attributes of the object, which are required, will be made</span>
</span><span data-line="5258"><span class="sd">    into the &quot;key&quot; of the instance.</span>
</span><span data-line="5259">
</span><span data-line="5260"><span class="sd">    The object can then be added to a session, or merged</span>
</span><span data-line="5261"><span class="sd">    possibly with the load=False flag, at which point it will look</span>
</span><span data-line="5262"><span class="sd">    as if it were loaded that way, without emitting SQL.</span>
</span><span data-line="5263">
</span><span data-line="5264"><span class="sd">    This is a special use case function that differs from a normal</span>
</span><span data-line="5265"><span class="sd">    call to :meth:`.Session.merge` in that a given persistent state</span>
</span><span data-line="5266"><span class="sd">    can be manufactured without any SQL calls.</span>
</span><span data-line="5267">
</span><span data-line="5268"><span class="sd">    .. seealso::</span>
</span><span data-line="5269">
</span><span data-line="5270"><span class="sd">        :func:`.make_transient`</span>
</span><span data-line="5271">
</span><span data-line="5272"><span class="sd">        :meth:`.Session.enable_relationship_loading`</span>
</span><span data-line="5273">
</span><span data-line="5274"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="5275">    <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="5276">    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">or</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span data-line="5277">        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">&quot;Given object must be transient&quot;</span><span class="p">)</span>
</span><span data-line="5278">    <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">_identity_key_from_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="5279">    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span><span class="p">:</span>
</span><span data-line="5280">        <span class="k">del</span> <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span>
</span><span data-line="5281">    <span class="n">state</span><span class="o">.</span><span class="n">_commit_all</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">)</span>
</span><span data-line="5282">    <span class="n">state</span><span class="o">.</span><span class="n">_expire_attributes</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">unloaded</span><span class="p">)</span>
</span><span data-line="5283">
</span><span data-line="5284">
</span><span data-line="5285"><span class="k">def</span> <span class="nf">object_session</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]:</span>
</span><span data-line="5286"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the :class:`.Session` to which the given instance belongs.</span>
</span><span data-line="5287">
</span><span data-line="5288"><span class="sd">    This is essentially the same as the :attr:`.InstanceState.session`</span>
</span><span data-line="5289"><span class="sd">    accessor.  See that attribute for details.</span>
</span><span data-line="5290">
</span><span data-line="5291"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="5292">
</span><span data-line="5293">    <span class="k">try</span><span class="p">:</span>
</span><span data-line="5294">        <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span data-line="5295">    <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span data-line="5296">        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span data-line="5297">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="5298">        <span class="k">return</span> <span class="n">_state_session</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span data-line="5299">
</span><span data-line="5300">
</span><span data-line="5301"><span class="n">_new_sessionid</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">counter</span><span class="p">()</span>
</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2024, Litestar Organization</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials">
<a href="https://github.com/litestar-org/advanced-alchemy" aria-label="GitHub">
  <iconify-icon icon="simple-icons:github"></iconify-icon>
</a>
<a href="https://twitter.com/LitestarAPI" aria-label="X (Twitter)">
  <iconify-icon icon="prime:twitter"></iconify-icon>
</a>
<a href="https://discord.gg/litestar" aria-label="Discord">
  <iconify-icon icon="simple-icons:discord"></iconify-icon>
</a>
<a href="https://www.reddit.com/r/LitestarAPI" aria-label="Reddit">
  <iconify-icon icon="simple-icons:reddit"></iconify-icon>
</a></div>
    </div>
  </div>
</footer>
      <script src="../../../_static/documentation_options.js?v=c6cf4326"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../_static/litestar-theme.js?v=ab2dcc9e"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../../../_static/shibuya.js?v=e2e99575"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../../../_static/versioning.js"></script></body>
</html>