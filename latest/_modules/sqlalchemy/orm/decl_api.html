<!DOCTYPE html>
<html lang="en" data-accent-color="amber" data-content_root="../../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>sqlalchemy.orm.decl_api - Advanced Alchemy</title><link rel="shortcut icon" href="../../../_static/favicon.svg"/><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/shibuya.css?v=83eaa723" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_paramlinks.css" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../../../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/litestar-sphinx-theme.css?v=e9f54662" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sqlalchemy.orm.decl_api"/>
<meta name="twitter:card" content="summary"/>
<meta property="og:image" content="_static/logo-light.png"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="/">
      <img class="light-logo" src="../../../_static/logo-light.png" alt="advanced_alchemy" height="28" loading="lazy" />
      <img class="dark-logo" src="../../../_static/logo-dark.png" alt="advanced_alchemy" height="28" loading="lazy" />
      <strong>advanced_alchemy</strong>
    </a>
    <div class="sy-head-nav" id="HeadNav">
      <nav class="sy-head-links"><ul><li class="link"><a href="../../../index.html">Home</a></li>
      <li class="link"><button type="button">
            <span>Community</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="../../../contribution-guide.html">
                <span>Contributing</span>
                <small>Learn how to contribute to the Advanced Alchemy project</small>
              </a></li><li><a href="https://github.com/litestar-org/.github?tab=coc-ov-file">
                <span>Code of Conduct</span>
                <small>Review the etiquette for interacting with the Advanced Alchemy community</small>
              </a></li><li><a href="https://github.com/litestar-org/.github?tab=coc-ov-file#security-ov-file">
                <span>Security</span>
                <small>Overview of Advanced Alchemy's security protocols</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>About</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://litestar.dev/about/organization">
                <span>Litestar Organization</span>
                <small>Details about the Litestar organization</small>
              </a></li><li><a href="../../../releases.html">
                <span>Releases</span>
                <small>Explore the release process, versioning, and deprecation policy for Advanced Alchemy</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>Release notes</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="../../../changelog.html">
                <span>Changelog</span>
                <small>All changes for Advanced Alchemy</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>Help</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://discord.gg/litestar">
                <span>Discord Help Forum</span>
                <small>Dedicated Discord help forum</small>
              </a></li><li><a href="https://github.com/litestar-org/advanced-alchemy/discussions">
                <span>GitHub Discussions</span>
                <small>GitHub Discussions</small>
              </a></li><li><a href="https://stackoverflow.com/questions/tagged/litestar">
                <span>Stack Overflow</span>
                <small>We monitor the <code><b>litestar</b></code> tag on Stack Overflow</small>
              </a></li></ul>
      </li><li class="link">
          <a href="https://github.com/sponsors/Litestar-Org">
            <span>Sponsor</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials">
  <a href="https://github.com/litestar-org/advanced-alchemy" aria-label="GitHub">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </a>
<a href="https://twitter.com/LitestarAPI" aria-label="X (Twitter)">
  <iconify-icon icon="prime:twitter"></iconify-icon>
</a>
  <a href="https://discord.gg/litestar" aria-label="Discord">
    <iconify-icon icon="simple-icons:discord"></iconify-icon>
  </a></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="HeadNav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6"><div class="sidebar-links">
  <ul>
    <li><a class="icon-link" href="https://github.com/orgs/litestar-org/discussions">
  <span class="icon">
    <svg viewBox="0 0 24 24" fill="none">
      <path fill="var(--accent-9)" fill-rule="evenodd" clip-rule="evenodd" d="M11 5a6 6 0 0 0-4.687 9.746c.215.27.315.62.231.954l-.514 2.058a1 1 0 0 0 1.485 1.1l2.848-1.71c.174-.104.374-.15.576-.148H13a6 6 0 0 0 0-12h-2Z"/>
      <circle fill="white" cx="12" cy="11" r="1"/>
      <circle fill="white" cx="9" cy="11" r="1"/>
      <circle fill="white" cx="15" cy="11" r="1"/>
    </svg>
  </span>
  <span class="text">Discussion</span>
</a></li>
  </ul>
</div>
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/index.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/modeling.html">Modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/repositories.html">Repositories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/services.html">Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/utilities.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/frameworks/litestar.html">Litestar Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/frameworks/fastapi.html">FastAPI Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/base.html">base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/mixins/index.html">mixins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/mixins/unique.html">unique</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/config/index.html">config</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/asyncio.html">asyncio</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/common.html">common</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/engine.html">engine</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/sync.html">sync</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/types.html">types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/operations.html">operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/types.html">types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/exceptions.html">exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/utils.html">utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/repository.html">repositories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/filters.html">filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/service.html">services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/extensions/index.html">extensions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/litestar/index.html">litestar</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/alembic.html">alembic</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/dto.html">dto</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/plugins.html">plugin</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/sanic.html">sanic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/starlette.html">starlette</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/alembic/index.html">alembic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/alembic/commands.html">commands</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribution-guide.html">Contribution guide</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/search?q=user%3Alitestar-org+state%3Aopen+label%3A%22good+first+issue%22+++no%3Aassignee+repo%3A%22advanced-alchemy%22&amp;type=issues">Available Issues</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/litestar-org/.github?tab=coc-ov-file#readme">Code of Conduct</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/litestar-org/advanced-alchemy"
  data-type="github" data-user="litestar-org" data-repo="advanced-alchemy">
  <span class="w-8 flex items-center justify-around shrink-0 text-3xl">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </span>
  <span class="flex-grow px-2 break-all">
    <span>litestar-org/advanced-alchemy</span>
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <iconify-icon icon="lucide:star"></iconify-icon>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <iconify-icon icon="lucide:git-fork"></iconify-icon>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6"><div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../../index.html"><span itemprop="name">advanced_alchemy</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">sqlalchemy.orm.decl_api</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sqlalchemy.orm.decl_api</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="c1"># orm/decl_api.py</span>
</span><span data-line="2"><span class="c1"># Copyright (C) 2005-2024 the SQLAlchemy authors and contributors</span>
</span><span data-line="3"><span class="c1"># &lt;see AUTHORS file&gt;</span>
</span><span data-line="4"><span class="c1">#</span>
</span><span data-line="5"><span class="c1"># This module is part of SQLAlchemy and is released under</span>
</span><span data-line="6"><span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
</span><span data-line="7">
</span><span data-line="8"><span class="sd">&quot;&quot;&quot;Public API functions and helpers for declarative.&quot;&quot;&quot;</span>
</span><span data-line="9">
</span><span data-line="10"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="11">
</span><span data-line="12"><span class="kn">import</span> <span class="nn">itertools</span>
</span><span data-line="13"><span class="kn">import</span> <span class="nn">re</span>
</span><span data-line="14"><span class="kn">import</span> <span class="nn">typing</span>
</span><span data-line="15"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span><span data-line="16"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
</span><span data-line="17"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>
</span><span data-line="18"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">ClassVar</span>
</span><span data-line="19"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</span><span data-line="20"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">FrozenSet</span>
</span><span data-line="21"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generic</span>
</span><span data-line="22"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
</span><span data-line="23"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span>
</span><span data-line="24"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span>
</span><span data-line="25"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span><span data-line="26"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">overload</span>
</span><span data-line="27"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Set</span>
</span><span data-line="28"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
</span><span data-line="29"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
</span><span data-line="30"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span data-line="31"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>
</span><span data-line="32"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
</span><span data-line="33"><span class="kn">import</span> <span class="nn">weakref</span>
</span><span data-line="34">
</span><span data-line="35"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">attributes</span>
</span><span data-line="36"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">clsregistry</span>
</span><span data-line="37"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">instrumentation</span>
</span><span data-line="38"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">interfaces</span>
</span><span data-line="39"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">mapperlib</span>
</span><span data-line="40"><span class="kn">from</span> <span class="nn">._orm_constructors</span> <span class="kn">import</span> <span class="n">composite</span>
</span><span data-line="41"><span class="kn">from</span> <span class="nn">._orm_constructors</span> <span class="kn">import</span> <span class="n">deferred</span>
</span><span data-line="42"><span class="kn">from</span> <span class="nn">._orm_constructors</span> <span class="kn">import</span> <span class="n">mapped_column</span>
</span><span data-line="43"><span class="kn">from</span> <span class="nn">._orm_constructors</span> <span class="kn">import</span> <span class="n">relationship</span>
</span><span data-line="44"><span class="kn">from</span> <span class="nn">._orm_constructors</span> <span class="kn">import</span> <span class="n">synonym</span>
</span><span data-line="45"><span class="kn">from</span> <span class="nn">.attributes</span> <span class="kn">import</span> <span class="n">InstrumentedAttribute</span>
</span><span data-line="46"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_inspect_mapped_class</span>
</span><span data-line="47"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_is_mapped_class</span>
</span><span data-line="48"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">Mapped</span>
</span><span data-line="49"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">ORMDescriptor</span>
</span><span data-line="50"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_add_attribute</span>
</span><span data-line="51"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_as_declarative</span>
</span><span data-line="52"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_ClassScanMapperConfig</span>
</span><span data-line="53"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_declarative_constructor</span>
</span><span data-line="54"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_DeferredMapperConfig</span>
</span><span data-line="55"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_del_attribute</span>
</span><span data-line="56"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_mapper</span>
</span><span data-line="57"><span class="kn">from</span> <span class="nn">.descriptor_props</span> <span class="kn">import</span> <span class="n">Composite</span>
</span><span data-line="58"><span class="kn">from</span> <span class="nn">.descriptor_props</span> <span class="kn">import</span> <span class="n">Synonym</span>
</span><span data-line="59"><span class="kn">from</span> <span class="nn">.descriptor_props</span> <span class="kn">import</span> <span class="n">Synonym</span> <span class="k">as</span> <span class="n">_orm_synonym</span>
</span><span data-line="60"><span class="kn">from</span> <span class="nn">.mapper</span> <span class="kn">import</span> <span class="n">Mapper</span>
</span><span data-line="61"><span class="kn">from</span> <span class="nn">.properties</span> <span class="kn">import</span> <span class="n">MappedColumn</span>
</span><span data-line="62"><span class="kn">from</span> <span class="nn">.relationships</span> <span class="kn">import</span> <span class="n">RelationshipProperty</span>
</span><span data-line="63"><span class="kn">from</span> <span class="nn">.state</span> <span class="kn">import</span> <span class="n">InstanceState</span>
</span><span data-line="64"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">exc</span>
</span><span data-line="65"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">inspection</span>
</span><span data-line="66"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">util</span>
</span><span data-line="67"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">sqltypes</span>
</span><span data-line="68"><span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">_NoArg</span>
</span><span data-line="69"><span class="kn">from</span> <span class="nn">..sql.elements</span> <span class="kn">import</span> <span class="n">SQLCoreOperations</span>
</span><span data-line="70"><span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">MetaData</span>
</span><span data-line="71"><span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">FromClause</span>
</span><span data-line="72"><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">hybridmethod</span>
</span><span data-line="73"><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">hybridproperty</span>
</span><span data-line="74"><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">typing</span> <span class="k">as</span> <span class="n">compat_typing</span>
</span><span data-line="75"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">CallableReference</span>
</span><span data-line="76"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">flatten_newtype</span>
</span><span data-line="77"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_generic</span>
</span><span data-line="78"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_literal</span>
</span><span data-line="79"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_newtype</span>
</span><span data-line="80"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_pep695</span>
</span><span data-line="81"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">Literal</span>
</span><span data-line="82"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">Self</span>
</span><span data-line="83">
</span><span data-line="84"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="85">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_O</span>
</span><span data-line="86">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_RegistryType</span>
</span><span data-line="87">    <span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_DataclassArguments</span>
</span><span data-line="88">    <span class="kn">from</span> <span class="nn">.instrumentation</span> <span class="kn">import</span> <span class="n">ClassManager</span>
</span><span data-line="89">    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">MapperProperty</span>
</span><span data-line="90">    <span class="kn">from</span> <span class="nn">.state</span> <span class="kn">import</span> <span class="n">InstanceState</span>  <span class="c1"># noqa</span>
</span><span data-line="91">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_TypeEngineArgument</span>
</span><span data-line="92">    <span class="kn">from</span> <span class="nn">..sql.type_api</span> <span class="kn">import</span> <span class="n">_MatchedOnType</span>
</span><span data-line="93">
</span><span data-line="94"><span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="95">
</span><span data-line="96"><span class="n">_TT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_TT&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="97">
</span><span data-line="98"><span class="c1"># it&#39;s not clear how to have Annotated, Union objects etc. as keys here</span>
</span><span data-line="99"><span class="c1"># from a typing perspective so just leave it open ended for now</span>
</span><span data-line="100"><span class="n">_TypeAnnotationMapType</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="s2">&quot;_TypeEngineArgument[Any]&quot;</span><span class="p">]</span>
</span><span data-line="101"><span class="n">_MutableTypeAnnotationMapType</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="s2">&quot;_TypeEngineArgument[Any]&quot;</span><span class="p">]</span>
</span><span data-line="102">
</span><span data-line="103"><span class="n">_DeclaredAttrDecorated</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[</span>
</span><span data-line="104">    <span class="o">...</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Mapped</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">ORMDescriptor</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">SQLCoreOperations</span><span class="p">[</span><span class="n">_T</span><span class="p">]]</span>
</span><span data-line="105"><span class="p">]</span>
</span><span data-line="106">
</span><span data-line="107">
</span><span data-line="108"><span class="k">def</span> <span class="nf">has_inherited_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="109"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a class, return True if any of the classes it inherits from has a</span>
</span><span data-line="110"><span class="sd">    mapped table, otherwise return False.</span>
</span><span data-line="111">
</span><span data-line="112"><span class="sd">    This is used in declarative mixins to build attributes that behave</span>
</span><span data-line="113"><span class="sd">    differently for the base class vs. a subclass in an inheritance</span>
</span><span data-line="114"><span class="sd">    hierarchy.</span>
</span><span data-line="115">
</span><span data-line="116"><span class="sd">    .. seealso::</span>
</span><span data-line="117">
</span><span data-line="118"><span class="sd">        :ref:`decl_mixin_inheritance`</span>
</span><span data-line="119">
</span><span data-line="120"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="121">    <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span data-line="122">        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="s2">&quot;__table__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="123">            <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="124">    <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="125">
</span><span data-line="126">
</span><span data-line="127"><span class="k">class</span> <span class="nc">_DynamicAttributesType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
</span><span data-line="128">    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="129">        <span class="k">if</span> <span class="s2">&quot;__mapper__&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span data-line="130">            <span class="n">_add_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="131">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="132">            <span class="nb">type</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="133">
</span><span data-line="134">    <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="135">        <span class="k">if</span> <span class="s2">&quot;__mapper__&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span data-line="136">            <span class="n">_del_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span data-line="137">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="138">            <span class="nb">type</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span data-line="139">
</span><span data-line="140">
</span><span data-line="141"><span class="k">class</span> <span class="nc">DeclarativeAttributeIntercept</span><span class="p">(</span>
</span><span data-line="142">    <span class="n">_DynamicAttributesType</span><span class="p">,</span>
</span><span data-line="143">    <span class="c1"># Inspectable is used only by the mypy plugin</span>
</span><span data-line="144">    <span class="n">inspection</span><span class="o">.</span><span class="n">Inspectable</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="145"><span class="p">):</span>
</span><span data-line="146"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Metaclass that may be used in conjunction with the</span>
</span><span data-line="147"><span class="sd">    :class:`_orm.DeclarativeBase` class to support addition of class</span>
</span><span data-line="148"><span class="sd">    attributes dynamically.</span>
</span><span data-line="149">
</span><span data-line="150"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="151">
</span><span data-line="152">
</span><span data-line="153"><span class="nd">@compat_typing</span><span class="o">.</span><span class="n">dataclass_transform</span><span class="p">(</span>
</span><span data-line="154">    <span class="n">field_specifiers</span><span class="o">=</span><span class="p">(</span>
</span><span data-line="155">        <span class="n">MappedColumn</span><span class="p">,</span>
</span><span data-line="156">        <span class="n">RelationshipProperty</span><span class="p">,</span>
</span><span data-line="157">        <span class="n">Composite</span><span class="p">,</span>
</span><span data-line="158">        <span class="n">Synonym</span><span class="p">,</span>
</span><span data-line="159">        <span class="n">mapped_column</span><span class="p">,</span>
</span><span data-line="160">        <span class="n">relationship</span><span class="p">,</span>
</span><span data-line="161">        <span class="n">composite</span><span class="p">,</span>
</span><span data-line="162">        <span class="n">synonym</span><span class="p">,</span>
</span><span data-line="163">        <span class="n">deferred</span><span class="p">,</span>
</span><span data-line="164">    <span class="p">),</span>
</span><span data-line="165"><span class="p">)</span>
</span><span data-line="166"><span class="k">class</span> <span class="nc">DCTransformDeclarative</span><span class="p">(</span><span class="n">DeclarativeAttributeIntercept</span><span class="p">):</span>
</span><span data-line="167"><span class="w">    </span><span class="sd">&quot;&quot;&quot;metaclass that includes @dataclass_transforms&quot;&quot;&quot;</span>
</span><span data-line="168">
</span><span data-line="169">
</span><span data-line="170"><span class="k">class</span> <span class="nc">DeclarativeMeta</span><span class="p">(</span><span class="n">DeclarativeAttributeIntercept</span><span class="p">):</span>
</span><span data-line="171">    <span class="n">metadata</span><span class="p">:</span> <span class="n">MetaData</span>
</span><span data-line="172">    <span class="n">registry</span><span class="p">:</span> <span class="n">RegistryType</span>
</span><span data-line="173">
</span><span data-line="174">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="175">        <span class="bp">cls</span><span class="p">,</span> <span class="n">classname</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">bases</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="176">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="177">        <span class="c1"># use cls.__dict__, which can be modified by an</span>
</span><span data-line="178">        <span class="c1"># __init_subclass__() method (#7900)</span>
</span><span data-line="179">        <span class="n">dict_</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
</span><span data-line="180">
</span><span data-line="181">        <span class="c1"># early-consume registry from the initial declarative base,</span>
</span><span data-line="182">        <span class="c1"># assign privately to not conflict with subclass attributes named</span>
</span><span data-line="183">        <span class="c1"># &quot;registry&quot;</span>
</span><span data-line="184">        <span class="n">reg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_sa_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="185">        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="186">            <span class="n">reg</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="187">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">registry</span><span class="p">):</span>
</span><span data-line="188">                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="189">                    <span class="s2">&quot;Declarative base class has no &#39;registry&#39; attribute, &quot;</span>
</span><span data-line="190">                    <span class="s2">&quot;or registry is not a sqlalchemy.orm.registry() object&quot;</span>
</span><span data-line="191">                <span class="p">)</span>
</span><span data-line="192">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="193">                <span class="bp">cls</span><span class="o">.</span><span class="n">_sa_registry</span> <span class="o">=</span> <span class="n">reg</span>
</span><span data-line="194">
</span><span data-line="195">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__abstract__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span data-line="196">            <span class="n">_as_declarative</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span data-line="197">        <span class="nb">type</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">classname</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span data-line="198">
</span><span data-line="199">
</span><span data-line="200"><span class="k">def</span> <span class="nf">synonym_for</span><span class="p">(</span>
</span><span data-line="201">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">map_column</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="202"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Synonym</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="203"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that produces an :func:`_orm.synonym`</span>
</span><span data-line="204"><span class="sd">    attribute in conjunction with a Python descriptor.</span>
</span><span data-line="205">
</span><span data-line="206"><span class="sd">    The function being decorated is passed to :func:`_orm.synonym` as the</span>
</span><span data-line="207"><span class="sd">    :paramref:`.orm.synonym.descriptor` parameter::</span>
</span><span data-line="208">
</span><span data-line="209"><span class="sd">        class MyClass(Base):</span>
</span><span data-line="210"><span class="sd">            __tablename__ = &#39;my_table&#39;</span>
</span><span data-line="211">
</span><span data-line="212"><span class="sd">            id = Column(Integer, primary_key=True)</span>
</span><span data-line="213"><span class="sd">            _job_status = Column(&quot;job_status&quot;, String(50))</span>
</span><span data-line="214">
</span><span data-line="215"><span class="sd">            @synonym_for(&quot;job_status&quot;)</span>
</span><span data-line="216"><span class="sd">            @property</span>
</span><span data-line="217"><span class="sd">            def job_status(self):</span>
</span><span data-line="218"><span class="sd">                return &quot;Status: %s&quot; % self._job_status</span>
</span><span data-line="219">
</span><span data-line="220"><span class="sd">    The :ref:`hybrid properties &lt;mapper_hybrids&gt;` feature of SQLAlchemy</span>
</span><span data-line="221"><span class="sd">    is typically preferred instead of synonyms, which is a more legacy</span>
</span><span data-line="222"><span class="sd">    feature.</span>
</span><span data-line="223">
</span><span data-line="224"><span class="sd">    .. seealso::</span>
</span><span data-line="225">
</span><span data-line="226"><span class="sd">        :ref:`synonyms` - Overview of synonyms</span>
</span><span data-line="227">
</span><span data-line="228"><span class="sd">        :func:`_orm.synonym` - the mapper-level function</span>
</span><span data-line="229">
</span><span data-line="230"><span class="sd">        :ref:`mapper_hybrids` - The Hybrid Attribute extension provides an</span>
</span><span data-line="231"><span class="sd">        updated approach to augmenting attribute behavior more flexibly than</span>
</span><span data-line="232"><span class="sd">        can be achieved with synonyms.</span>
</span><span data-line="233">
</span><span data-line="234"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="235">
</span><span data-line="236">    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Synonym</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="237">        <span class="k">return</span> <span class="n">_orm_synonym</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">map_column</span><span class="o">=</span><span class="n">map_column</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>
</span><span data-line="238">
</span><span data-line="239">    <span class="k">return</span> <span class="n">decorate</span>
</span><span data-line="240">
</span><span data-line="241">
</span><span data-line="242"><span class="k">class</span> <span class="nc">_declared_attr_common</span><span class="p">:</span>
</span><span data-line="243">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="244">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="245">        <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span data-line="246">        <span class="n">cascading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="247">        <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="248">    <span class="p">):</span>
</span><span data-line="249">        <span class="c1"># suppport</span>
</span><span data-line="250">        <span class="c1"># @declared_attr</span>
</span><span data-line="251">        <span class="c1"># @classmethod</span>
</span><span data-line="252">        <span class="c1"># def foo(cls) -&gt; Mapped[thing]:</span>
</span><span data-line="253">        <span class="c1">#    ...</span>
</span><span data-line="254">        <span class="c1"># which seems to help typing tools interpret the fn as a classmethod</span>
</span><span data-line="255">        <span class="c1"># for situations where needed</span>
</span><span data-line="256">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">classmethod</span><span class="p">):</span>
</span><span data-line="257">            <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__func__</span>
</span><span data-line="258">
</span><span data-line="259">        <span class="bp">self</span><span class="o">.</span><span class="n">fget</span> <span class="o">=</span> <span class="n">fn</span>
</span><span data-line="260">        <span class="bp">self</span><span class="o">.</span><span class="n">_cascading</span> <span class="o">=</span> <span class="n">cascading</span>
</span><span data-line="261">        <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="o">=</span> <span class="n">quiet</span>
</span><span data-line="262">        <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span data-line="263">
</span><span data-line="264">    <span class="k">def</span> <span class="nf">_collect_return_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="265">        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return&quot;</span><span class="p">)</span>
</span><span data-line="266">
</span><span data-line="267">    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="268">        <span class="c1"># the declared_attr needs to make use of a cache that exists</span>
</span><span data-line="269">        <span class="c1"># for the span of the declarative scan_attributes() phase.</span>
</span><span data-line="270">        <span class="c1"># to achieve this we look at the class manager that&#39;s configured.</span>
</span><span data-line="271">
</span><span data-line="272">        <span class="c1"># note this method should not be called outside of the declarative</span>
</span><span data-line="273">        <span class="c1"># setup phase</span>
</span><span data-line="274">
</span><span data-line="275">        <span class="bp">cls</span> <span class="o">=</span> <span class="n">owner</span>
</span><span data-line="276">        <span class="n">manager</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">opt_manager_of_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="277">        <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="278">            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^__.+__$&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>
</span><span data-line="279">                <span class="c1"># if there is no manager at all, then this class hasn&#39;t been</span>
</span><span data-line="280">                <span class="c1"># run through declarative or mapper() at all, emit a warning.</span>
</span><span data-line="281">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="282">                    <span class="s2">&quot;Unmanaged access of declarative attribute </span><span class="si">%s</span><span class="s2"> from &quot;</span>
</span><span data-line="283">                    <span class="s2">&quot;non-mapped class </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span data-line="284">                <span class="p">)</span>
</span><span data-line="285">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="286">        <span class="k">elif</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
</span><span data-line="287">            <span class="c1"># the class is mapped, which means we&#39;re outside of the declarative</span>
</span><span data-line="288">            <span class="c1"># scan setup, just run the function.</span>
</span><span data-line="289">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="290">
</span><span data-line="291">        <span class="c1"># here, we are inside of the declarative scan.  use the registry</span>
</span><span data-line="292">        <span class="c1"># that is tracking the values of these attributes.</span>
</span><span data-line="293">        <span class="n">declarative_scan</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">declarative_scan</span><span class="p">()</span>
</span><span data-line="294">
</span><span data-line="295">        <span class="c1"># assert that we are in fact in the declarative scan</span>
</span><span data-line="296">        <span class="k">assert</span> <span class="n">declarative_scan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="297">
</span><span data-line="298">        <span class="n">reg</span> <span class="o">=</span> <span class="n">declarative_scan</span><span class="o">.</span><span class="n">declared_attr_reg</span>
</span><span data-line="299">
</span><span data-line="300">        <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">:</span>
</span><span data-line="301">            <span class="k">return</span> <span class="n">reg</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>
</span><span data-line="302">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="303">            <span class="n">reg</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="304">            <span class="k">return</span> <span class="n">obj</span>
</span><span data-line="305">
</span><span data-line="306">
</span><span data-line="307"><span class="k">class</span> <span class="nc">_declared_directive</span><span class="p">(</span><span class="n">_declared_attr_common</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span data-line="308">    <span class="c1"># see mapping_api.rst for docstring</span>
</span><span data-line="309">
</span><span data-line="310">    <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="311">
</span><span data-line="312">        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="313">            <span class="bp">self</span><span class="p">,</span>
</span><span data-line="314">            <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">_T</span><span class="p">],</span>
</span><span data-line="315">            <span class="n">cascading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="316">        <span class="p">):</span> <span class="o">...</span>
</span><span data-line="317">
</span><span data-line="318">        <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="319">
</span><span data-line="320">        <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="321">
</span><span data-line="322">        <span class="k">def</span> <span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="323">
</span><span data-line="324">        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">_TT</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">_declared_directive</span><span class="p">[</span><span class="n">_TT</span><span class="p">]:</span>
</span><span data-line="325">            <span class="c1"># extensive fooling of mypy underway...</span>
</span><span data-line="326">            <span class="o">...</span>
</span><span data-line="327">
</span><span data-line="328">
</span><span data-line="329"><span class="k">class</span> <span class="nc">declared_attr</span><span class="p">(</span><span class="n">interfaces</span><span class="o">.</span><span class="n">_MappedAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">_declared_attr_common</span><span class="p">):</span>
</span><span data-line="330"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mark a class-level method as representing the definition of</span>
</span><span data-line="331"><span class="sd">    a mapped property or Declarative directive.</span>
</span><span data-line="332">
</span><span data-line="333"><span class="sd">    :class:`_orm.declared_attr` is typically applied as a decorator to a class</span>
</span><span data-line="334"><span class="sd">    level method, turning the attribute into a scalar-like property that can be</span>
</span><span data-line="335"><span class="sd">    invoked from the uninstantiated class. The Declarative mapping process</span>
</span><span data-line="336"><span class="sd">    looks for these :class:`_orm.declared_attr` callables as it scans classes,</span>
</span><span data-line="337"><span class="sd">    and assumes any attribute marked with :class:`_orm.declared_attr` will be a</span>
</span><span data-line="338"><span class="sd">    callable that will produce an object specific to the Declarative mapping or</span>
</span><span data-line="339"><span class="sd">    table configuration.</span>
</span><span data-line="340">
</span><span data-line="341"><span class="sd">    :class:`_orm.declared_attr` is usually applicable to</span>
</span><span data-line="342"><span class="sd">    :ref:`mixins &lt;orm_mixins_toplevel&gt;`, to define relationships that are to be</span>
</span><span data-line="343"><span class="sd">    applied to different implementors of the class. It may also be used to</span>
</span><span data-line="344"><span class="sd">    define dynamically generated column expressions and other Declarative</span>
</span><span data-line="345"><span class="sd">    attributes.</span>
</span><span data-line="346">
</span><span data-line="347"><span class="sd">    Example::</span>
</span><span data-line="348">
</span><span data-line="349"><span class="sd">        class ProvidesUserMixin:</span>
</span><span data-line="350"><span class="sd">            &quot;A mixin that adds a &#39;user&#39; relationship to classes.&quot;</span>
</span><span data-line="351">
</span><span data-line="352"><span class="sd">            user_id: Mapped[int] = mapped_column(ForeignKey(&quot;user_table.id&quot;))</span>
</span><span data-line="353">
</span><span data-line="354"><span class="sd">            @declared_attr</span>
</span><span data-line="355"><span class="sd">            def user(cls) -&gt; Mapped[&quot;User&quot;]:</span>
</span><span data-line="356"><span class="sd">                return relationship(&quot;User&quot;)</span>
</span><span data-line="357">
</span><span data-line="358"><span class="sd">    When used with Declarative directives such as ``__tablename__``, the</span>
</span><span data-line="359"><span class="sd">    :meth:`_orm.declared_attr.directive` modifier may be used which indicates</span>
</span><span data-line="360"><span class="sd">    to :pep:`484` typing tools that the given method is not dealing with</span>
</span><span data-line="361"><span class="sd">    :class:`_orm.Mapped` attributes::</span>
</span><span data-line="362">
</span><span data-line="363"><span class="sd">        class CreateTableName:</span>
</span><span data-line="364"><span class="sd">            @declared_attr.directive</span>
</span><span data-line="365"><span class="sd">            def __tablename__(cls) -&gt; str:</span>
</span><span data-line="366"><span class="sd">                return cls.__name__.lower()</span>
</span><span data-line="367">
</span><span data-line="368"><span class="sd">    :class:`_orm.declared_attr` can also be applied directly to mapped</span>
</span><span data-line="369"><span class="sd">    classes, to allow for attributes that dynamically configure themselves</span>
</span><span data-line="370"><span class="sd">    on subclasses when using mapped inheritance schemes.   Below</span>
</span><span data-line="371"><span class="sd">    illustrates :class:`_orm.declared_attr` to create a dynamic scheme</span>
</span><span data-line="372"><span class="sd">    for generating the :paramref:`_orm.Mapper.polymorphic_identity` parameter</span>
</span><span data-line="373"><span class="sd">    for subclasses::</span>
</span><span data-line="374">
</span><span data-line="375"><span class="sd">        class Employee(Base):</span>
</span><span data-line="376"><span class="sd">            __tablename__ = &#39;employee&#39;</span>
</span><span data-line="377">
</span><span data-line="378"><span class="sd">            id: Mapped[int] = mapped_column(primary_key=True)</span>
</span><span data-line="379"><span class="sd">            type: Mapped[str] = mapped_column(String(50))</span>
</span><span data-line="380">
</span><span data-line="381"><span class="sd">            @declared_attr.directive</span>
</span><span data-line="382"><span class="sd">            def __mapper_args__(cls) -&gt; Dict[str, Any]:</span>
</span><span data-line="383"><span class="sd">                if cls.__name__ == &#39;Employee&#39;:</span>
</span><span data-line="384"><span class="sd">                    return {</span>
</span><span data-line="385"><span class="sd">                            &quot;polymorphic_on&quot;:cls.type,</span>
</span><span data-line="386"><span class="sd">                            &quot;polymorphic_identity&quot;:&quot;Employee&quot;</span>
</span><span data-line="387"><span class="sd">                    }</span>
</span><span data-line="388"><span class="sd">                else:</span>
</span><span data-line="389"><span class="sd">                    return {&quot;polymorphic_identity&quot;:cls.__name__}</span>
</span><span data-line="390">
</span><span data-line="391"><span class="sd">        class Engineer(Employee):</span>
</span><span data-line="392"><span class="sd">            pass</span>
</span><span data-line="393">
</span><span data-line="394"><span class="sd">    :class:`_orm.declared_attr` supports decorating functions that are</span>
</span><span data-line="395"><span class="sd">    explicitly decorated with ``@classmethod``. This is never necessary from a</span>
</span><span data-line="396"><span class="sd">    runtime perspective, however may be needed in order to support :pep:`484`</span>
</span><span data-line="397"><span class="sd">    typing tools that don&#39;t otherwise recognize the decorated function as</span>
</span><span data-line="398"><span class="sd">    having class-level behaviors for the ``cls`` parameter::</span>
</span><span data-line="399">
</span><span data-line="400"><span class="sd">        class SomethingMixin:</span>
</span><span data-line="401"><span class="sd">            x: Mapped[int]</span>
</span><span data-line="402"><span class="sd">            y: Mapped[int]</span>
</span><span data-line="403">
</span><span data-line="404"><span class="sd">            @declared_attr</span>
</span><span data-line="405"><span class="sd">            @classmethod</span>
</span><span data-line="406"><span class="sd">            def x_plus_y(cls) -&gt; Mapped[int]:</span>
</span><span data-line="407"><span class="sd">                return column_property(cls.x + cls.y)</span>
</span><span data-line="408">
</span><span data-line="409"><span class="sd">    .. versionadded:: 2.0 - :class:`_orm.declared_attr` can accommodate a</span>
</span><span data-line="410"><span class="sd">       function decorated with ``@classmethod`` to help with :pep:`484`</span>
</span><span data-line="411"><span class="sd">       integration where needed.</span>
</span><span data-line="412">
</span><span data-line="413">
</span><span data-line="414"><span class="sd">    .. seealso::</span>
</span><span data-line="415">
</span><span data-line="416"><span class="sd">        :ref:`orm_mixins_toplevel` - Declarative Mixin documentation with</span>
</span><span data-line="417"><span class="sd">        background on use patterns for :class:`_orm.declared_attr`.</span>
</span><span data-line="418">
</span><span data-line="419"><span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span data-line="420">
</span><span data-line="421">    <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="422">
</span><span data-line="423">        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="424">            <span class="bp">self</span><span class="p">,</span>
</span><span data-line="425">            <span class="n">fn</span><span class="p">:</span> <span class="n">_DeclaredAttrDecorated</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span data-line="426">            <span class="n">cascading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="427">        <span class="p">):</span> <span class="o">...</span>
</span><span data-line="428">
</span><span data-line="429">        <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="430">
</span><span data-line="431">        <span class="k">def</span> <span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="432">
</span><span data-line="433">        <span class="c1"># this is the Mapped[] API where at class descriptor get time we want</span>
</span><span data-line="434">        <span class="c1"># the type checker to see InstrumentedAttribute[_T].   However the</span>
</span><span data-line="435">        <span class="c1"># callable function prior to mapping in fact calls the given</span>
</span><span data-line="436">        <span class="c1"># declarative function that does not return InstrumentedAttribute</span>
</span><span data-line="437">        <span class="nd">@overload</span>
</span><span data-line="438">        <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span>
</span><span data-line="439">            <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="440">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstrumentedAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="441">
</span><span data-line="442">        <span class="nd">@overload</span>
</span><span data-line="443">        <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="444">
</span><span data-line="445">        <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span>
</span><span data-line="446">            <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="447">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">InstrumentedAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">_T</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="448">
</span><span data-line="449">    <span class="nd">@hybridmethod</span>
</span><span data-line="450">    <span class="k">def</span> <span class="nf">_stateful</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_stateful_declared_attr</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="451">        <span class="k">return</span> <span class="n">_stateful_declared_attr</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span data-line="452">
</span><span data-line="453">    <span class="nd">@hybridproperty</span>
</span><span data-line="454">    <span class="k">def</span> <span class="nf">directive</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_declared_directive</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="455">        <span class="c1"># see mapping_api.rst for docstring</span>
</span><span data-line="456">        <span class="k">return</span> <span class="n">_declared_directive</span>  <span class="c1"># type: ignore</span>
</span><span data-line="457">
</span><span data-line="458">    <span class="nd">@hybridproperty</span>
</span><span data-line="459">    <span class="k">def</span> <span class="nf">cascading</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_stateful_declared_attr</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="460">        <span class="c1"># see mapping_api.rst for docstring</span>
</span><span data-line="461">        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_stateful</span><span class="p">(</span><span class="n">cascading</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="462">
</span><span data-line="463">
</span><span data-line="464"><span class="k">class</span> <span class="nc">_stateful_declared_attr</span><span class="p">(</span><span class="n">declared_attr</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span data-line="465">    <span class="n">kw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="466">
</span><span data-line="467">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span><span data-line="468">        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span> <span class="o">=</span> <span class="n">kw</span>
</span><span data-line="469">
</span><span data-line="470">    <span class="nd">@hybridmethod</span>
</span><span data-line="471">    <span class="k">def</span> <span class="nf">_stateful</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_stateful_declared_attr</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="472">        <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span data-line="473">        <span class="n">new_kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
</span><span data-line="474">        <span class="k">return</span> <span class="n">_stateful_declared_attr</span><span class="p">(</span><span class="o">**</span><span class="n">new_kw</span><span class="p">)</span>
</span><span data-line="475">
</span><span data-line="476">    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">_DeclaredAttrDecorated</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">declared_attr</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="477">        <span class="k">return</span> <span class="n">declared_attr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">)</span>
</span><span data-line="478">
</span><span data-line="479">
</span><span data-line="480"><span class="k">def</span> <span class="nf">declarative_mixin</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="481"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mark a class as providing the feature of &quot;declarative mixin&quot;.</span>
</span><span data-line="482">
</span><span data-line="483"><span class="sd">    E.g.::</span>
</span><span data-line="484">
</span><span data-line="485"><span class="sd">        from sqlalchemy.orm import declared_attr</span>
</span><span data-line="486"><span class="sd">        from sqlalchemy.orm import declarative_mixin</span>
</span><span data-line="487">
</span><span data-line="488"><span class="sd">        @declarative_mixin</span>
</span><span data-line="489"><span class="sd">        class MyMixin:</span>
</span><span data-line="490">
</span><span data-line="491"><span class="sd">            @declared_attr</span>
</span><span data-line="492"><span class="sd">            def __tablename__(cls):</span>
</span><span data-line="493"><span class="sd">                return cls.__name__.lower()</span>
</span><span data-line="494">
</span><span data-line="495"><span class="sd">            __table_args__ = {&#39;mysql_engine&#39;: &#39;InnoDB&#39;}</span>
</span><span data-line="496"><span class="sd">            __mapper_args__= {&#39;always_refresh&#39;: True}</span>
</span><span data-line="497">
</span><span data-line="498"><span class="sd">            id =  Column(Integer, primary_key=True)</span>
</span><span data-line="499">
</span><span data-line="500"><span class="sd">        class MyModel(MyMixin, Base):</span>
</span><span data-line="501"><span class="sd">            name = Column(String(1000))</span>
</span><span data-line="502">
</span><span data-line="503"><span class="sd">    The :func:`_orm.declarative_mixin` decorator currently does not modify</span>
</span><span data-line="504"><span class="sd">    the given class in any way; it&#39;s current purpose is strictly to assist</span>
</span><span data-line="505"><span class="sd">    the :ref:`Mypy plugin &lt;mypy_toplevel&gt;` in being able to identify</span>
</span><span data-line="506"><span class="sd">    SQLAlchemy declarative mixin classes when no other context is present.</span>
</span><span data-line="507">
</span><span data-line="508"><span class="sd">    .. versionadded:: 1.4.6</span>
</span><span data-line="509">
</span><span data-line="510"><span class="sd">    .. seealso::</span>
</span><span data-line="511">
</span><span data-line="512"><span class="sd">        :ref:`orm_mixins_toplevel`</span>
</span><span data-line="513">
</span><span data-line="514"><span class="sd">        :ref:`mypy_declarative_mixins` - in the</span>
</span><span data-line="515"><span class="sd">        :ref:`Mypy plugin documentation &lt;mypy_toplevel&gt;`</span>
</span><span data-line="516">
</span><span data-line="517"><span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span data-line="518">
</span><span data-line="519">    <span class="k">return</span> <span class="bp">cls</span>
</span><span data-line="520">
</span><span data-line="521">
</span><span data-line="522"><span class="k">def</span> <span class="nf">_setup_declarative_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="523">    <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span data-line="524">        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>
</span><span data-line="525">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="526">        <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="527">
</span><span data-line="528">    <span class="k">if</span> <span class="s2">&quot;type_annotation_map&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span data-line="529">        <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;type_annotation_map&quot;</span><span class="p">]</span>
</span><span data-line="530">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="531">        <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="532">
</span><span data-line="533">    <span class="n">reg</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="534">    <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="535">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">registry</span><span class="p">):</span>
</span><span data-line="536">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="537">                <span class="s2">&quot;Declarative base class has a &#39;registry&#39; attribute that is &quot;</span>
</span><span data-line="538">                <span class="s2">&quot;not an instance of sqlalchemy.orm.registry()&quot;</span>
</span><span data-line="539">            <span class="p">)</span>
</span><span data-line="540">        <span class="k">elif</span> <span class="n">type_annotation_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="541">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="542">                <span class="s2">&quot;Declarative base class has both a &#39;registry&#39; attribute and a &quot;</span>
</span><span data-line="543">                <span class="s2">&quot;type_annotation_map entry.  Per-base type_annotation_maps &quot;</span>
</span><span data-line="544">                <span class="s2">&quot;are not supported.  Please apply the type_annotation_map &quot;</span>
</span><span data-line="545">                <span class="s2">&quot;to this registry directly.&quot;</span>
</span><span data-line="546">            <span class="p">)</span>
</span><span data-line="547">
</span><span data-line="548">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="549">        <span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span>
</span><span data-line="550">            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">type_annotation_map</span><span class="o">=</span><span class="n">type_annotation_map</span>
</span><span data-line="551">        <span class="p">)</span>
</span><span data-line="552">        <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">reg</span>
</span><span data-line="553">
</span><span data-line="554">    <span class="bp">cls</span><span class="o">.</span><span class="n">_sa_registry</span> <span class="o">=</span> <span class="n">reg</span>
</span><span data-line="555">
</span><span data-line="556">    <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span data-line="557">        <span class="bp">cls</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">metadata</span>
</span><span data-line="558">
</span><span data-line="559">    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">:</span>
</span><span data-line="560">        <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">constructor</span>
</span><span data-line="561">
</span><span data-line="562">
</span><span data-line="563"><span class="k">class</span> <span class="nc">MappedAsDataclass</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">DCTransformDeclarative</span><span class="p">):</span>
</span><span data-line="564"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mixin class to indicate when mapping this class, also convert it to be</span>
</span><span data-line="565"><span class="sd">    a dataclass.</span>
</span><span data-line="566">
</span><span data-line="567"><span class="sd">    .. seealso::</span>
</span><span data-line="568">
</span><span data-line="569"><span class="sd">        :ref:`orm_declarative_native_dataclasses` - complete background</span>
</span><span data-line="570"><span class="sd">        on SQLAlchemy native dataclass mapping</span>
</span><span data-line="571">
</span><span data-line="572"><span class="sd">    .. versionadded:: 2.0</span>
</span><span data-line="573">
</span><span data-line="574"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="575">
</span><span data-line="576">    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span>
</span><span data-line="577">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="578">        <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="579">        <span class="nb">repr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
</span><span data-line="580">        <span class="n">eq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="581">        <span class="n">order</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="582">        <span class="n">unsafe_hash</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="583">        <span class="n">match_args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="584">        <span class="n">kw_only</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="585">        <span class="n">dataclass_callable</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="586">            <span class="n">_NoArg</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="587">        <span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="588">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="589">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="590">        <span class="n">apply_dc_transforms</span><span class="p">:</span> <span class="n">_DataclassArguments</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="591">            <span class="s2">&quot;init&quot;</span><span class="p">:</span> <span class="n">init</span><span class="p">,</span>
</span><span data-line="592">            <span class="s2">&quot;repr&quot;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">,</span>
</span><span data-line="593">            <span class="s2">&quot;eq&quot;</span><span class="p">:</span> <span class="n">eq</span><span class="p">,</span>
</span><span data-line="594">            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span>
</span><span data-line="595">            <span class="s2">&quot;unsafe_hash&quot;</span><span class="p">:</span> <span class="n">unsafe_hash</span><span class="p">,</span>
</span><span data-line="596">            <span class="s2">&quot;match_args&quot;</span><span class="p">:</span> <span class="n">match_args</span><span class="p">,</span>
</span><span data-line="597">            <span class="s2">&quot;kw_only&quot;</span><span class="p">:</span> <span class="n">kw_only</span><span class="p">,</span>
</span><span data-line="598">            <span class="s2">&quot;dataclass_callable&quot;</span><span class="p">:</span> <span class="n">dataclass_callable</span><span class="p">,</span>
</span><span data-line="599">        <span class="p">}</span>
</span><span data-line="600">
</span><span data-line="601">        <span class="n">current_transforms</span><span class="p">:</span> <span class="n">_DataclassArguments</span>
</span><span data-line="602">
</span><span data-line="603">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_sa_apply_dc_transforms&quot;</span><span class="p">):</span>
</span><span data-line="604">            <span class="n">current</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sa_apply_dc_transforms</span>
</span><span data-line="605">
</span><span data-line="606">            <span class="n">_ClassScanMapperConfig</span><span class="o">.</span><span class="n">_assert_dc_arguments</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span><span data-line="607">
</span><span data-line="608">            <span class="bp">cls</span><span class="o">.</span><span class="n">_sa_apply_dc_transforms</span> <span class="o">=</span> <span class="n">current_transforms</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># type: ignore  # noqa: E501</span>
</span><span data-line="609">                <span class="n">k</span><span class="p">:</span> <span class="n">current</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span> <span class="k">else</span> <span class="n">v</span>
</span><span data-line="610">                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">apply_dc_transforms</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span data-line="611">            <span class="p">}</span>
</span><span data-line="612">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="613">            <span class="bp">cls</span><span class="o">.</span><span class="n">_sa_apply_dc_transforms</span> <span class="o">=</span> <span class="n">current_transforms</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="614">                <span class="n">apply_dc_transforms</span>
</span><span data-line="615">            <span class="p">)</span>
</span><span data-line="616">
</span><span data-line="617">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span data-line="618">
</span><span data-line="619">        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_mapped_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span data-line="620">            <span class="n">new_anno</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="621">                <span class="n">_ClassScanMapperConfig</span><span class="o">.</span><span class="n">_update_annotations_for_non_mapped_class</span>
</span><span data-line="622">            <span class="p">)(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="623">            <span class="n">_ClassScanMapperConfig</span><span class="o">.</span><span class="n">_apply_dataclasses_to_any_class</span><span class="p">(</span>
</span><span data-line="624">                <span class="n">current_transforms</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">new_anno</span>
</span><span data-line="625">            <span class="p">)</span>
</span><span data-line="626">
</span><span data-line="627">
</span><span data-line="628"><span class="k">class</span> <span class="nc">DeclarativeBase</span><span class="p">(</span>
</span><span data-line="629">    <span class="c1"># Inspectable is used only by the mypy plugin</span>
</span><span data-line="630">    <span class="n">inspection</span><span class="o">.</span><span class="n">Inspectable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="631">    <span class="n">metaclass</span><span class="o">=</span><span class="n">DeclarativeAttributeIntercept</span><span class="p">,</span>
</span><span data-line="632"><span class="p">):</span>
</span><span data-line="633"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class used for declarative class definitions.</span>
</span><span data-line="634">
</span><span data-line="635"><span class="sd">    The :class:`_orm.DeclarativeBase` allows for the creation of new</span>
</span><span data-line="636"><span class="sd">    declarative bases in such a way that is compatible with type checkers::</span>
</span><span data-line="637">
</span><span data-line="638">
</span><span data-line="639"><span class="sd">        from sqlalchemy.orm import DeclarativeBase</span>
</span><span data-line="640">
</span><span data-line="641"><span class="sd">        class Base(DeclarativeBase):</span>
</span><span data-line="642"><span class="sd">            pass</span>
</span><span data-line="643">
</span><span data-line="644">
</span><span data-line="645"><span class="sd">    The above ``Base`` class is now usable as the base for new declarative</span>
</span><span data-line="646"><span class="sd">    mappings.  The superclass makes use of the ``__init_subclass__()``</span>
</span><span data-line="647"><span class="sd">    method to set up new classes and metaclasses aren&#39;t used.</span>
</span><span data-line="648">
</span><span data-line="649"><span class="sd">    When first used, the :class:`_orm.DeclarativeBase` class instantiates a new</span>
</span><span data-line="650"><span class="sd">    :class:`_orm.registry` to be used with the base, assuming one was not</span>
</span><span data-line="651"><span class="sd">    provided explicitly. The :class:`_orm.DeclarativeBase` class supports</span>
</span><span data-line="652"><span class="sd">    class-level attributes which act as parameters for the construction of this</span>
</span><span data-line="653"><span class="sd">    registry; such as to indicate a specific :class:`_schema.MetaData`</span>
</span><span data-line="654"><span class="sd">    collection as well as a specific value for</span>
</span><span data-line="655"><span class="sd">    :paramref:`_orm.registry.type_annotation_map`::</span>
</span><span data-line="656">
</span><span data-line="657"><span class="sd">        from typing_extensions import Annotated</span>
</span><span data-line="658">
</span><span data-line="659"><span class="sd">        from sqlalchemy import BigInteger</span>
</span><span data-line="660"><span class="sd">        from sqlalchemy import MetaData</span>
</span><span data-line="661"><span class="sd">        from sqlalchemy import String</span>
</span><span data-line="662"><span class="sd">        from sqlalchemy.orm import DeclarativeBase</span>
</span><span data-line="663">
</span><span data-line="664"><span class="sd">        bigint = Annotated[int, &quot;bigint&quot;]</span>
</span><span data-line="665"><span class="sd">        my_metadata = MetaData()</span>
</span><span data-line="666">
</span><span data-line="667"><span class="sd">        class Base(DeclarativeBase):</span>
</span><span data-line="668"><span class="sd">            metadata = my_metadata</span>
</span><span data-line="669"><span class="sd">            type_annotation_map = {</span>
</span><span data-line="670"><span class="sd">                str: String().with_variant(String(255), &quot;mysql&quot;, &quot;mariadb&quot;),</span>
</span><span data-line="671"><span class="sd">                bigint: BigInteger()</span>
</span><span data-line="672"><span class="sd">            }</span>
</span><span data-line="673">
</span><span data-line="674"><span class="sd">    Class-level attributes which may be specified include:</span>
</span><span data-line="675">
</span><span data-line="676"><span class="sd">    :param metadata: optional :class:`_schema.MetaData` collection.</span>
</span><span data-line="677"><span class="sd">     If a :class:`_orm.registry` is constructed automatically, this</span>
</span><span data-line="678"><span class="sd">     :class:`_schema.MetaData` collection will be used to construct it.</span>
</span><span data-line="679"><span class="sd">     Otherwise, the local :class:`_schema.MetaData` collection will supercede</span>
</span><span data-line="680"><span class="sd">     that used by an existing :class:`_orm.registry` passed using the</span>
</span><span data-line="681"><span class="sd">     :paramref:`_orm.DeclarativeBase.registry` parameter.</span>
</span><span data-line="682"><span class="sd">    :param type_annotation_map: optional type annotation map that will be</span>
</span><span data-line="683"><span class="sd">     passed to the :class:`_orm.registry` as</span>
</span><span data-line="684"><span class="sd">     :paramref:`_orm.registry.type_annotation_map`.</span>
</span><span data-line="685"><span class="sd">    :param registry: supply a pre-existing :class:`_orm.registry` directly.</span>
</span><span data-line="686">
</span><span data-line="687"><span class="sd">    .. versionadded:: 2.0  Added :class:`.DeclarativeBase`, so that declarative</span>
</span><span data-line="688"><span class="sd">       base classes may be constructed in such a way that is also recognized</span>
</span><span data-line="689"><span class="sd">       by :pep:`484` type checkers.   As a result, :class:`.DeclarativeBase`</span>
</span><span data-line="690"><span class="sd">       and other subclassing-oriented APIs should be seen as</span>
</span><span data-line="691"><span class="sd">       superseding previous &quot;class returned by a function&quot; APIs, namely</span>
</span><span data-line="692"><span class="sd">       :func:`_orm.declarative_base` and :meth:`_orm.registry.generate_base`,</span>
</span><span data-line="693"><span class="sd">       where the base class returned cannot be recognized by type checkers</span>
</span><span data-line="694"><span class="sd">       without using plugins.</span>
</span><span data-line="695">
</span><span data-line="696"><span class="sd">    **__init__ behavior**</span>
</span><span data-line="697">
</span><span data-line="698"><span class="sd">    In a plain Python class, the base-most ``__init__()`` method in the class</span>
</span><span data-line="699"><span class="sd">    hierarchy is ``object.__init__()``, which accepts no arguments. However,</span>
</span><span data-line="700"><span class="sd">    when the :class:`_orm.DeclarativeBase` subclass is first declared, the</span>
</span><span data-line="701"><span class="sd">    class is given an ``__init__()`` method that links to the</span>
</span><span data-line="702"><span class="sd">    :paramref:`_orm.registry.constructor` constructor function, if no</span>
</span><span data-line="703"><span class="sd">    ``__init__()`` method is already present; this is the usual declarative</span>
</span><span data-line="704"><span class="sd">    constructor that will assign keyword arguments as attributes on the</span>
</span><span data-line="705"><span class="sd">    instance, assuming those attributes are established at the class level</span>
</span><span data-line="706"><span class="sd">    (i.e. are mapped, or are linked to a descriptor). This constructor is</span>
</span><span data-line="707"><span class="sd">    **never accessed by a mapped class without being called explicitly via</span>
</span><span data-line="708"><span class="sd">    super()**, as mapped classes are themselves given an ``__init__()`` method</span>
</span><span data-line="709"><span class="sd">    directly which calls :paramref:`_orm.registry.constructor`, so in the</span>
</span><span data-line="710"><span class="sd">    default case works independently of what the base-most ``__init__()``</span>
</span><span data-line="711"><span class="sd">    method does.</span>
</span><span data-line="712">
</span><span data-line="713"><span class="sd">    .. versionchanged:: 2.0.1  :class:`_orm.DeclarativeBase` has a default</span>
</span><span data-line="714"><span class="sd">       constructor that links to :paramref:`_orm.registry.constructor` by</span>
</span><span data-line="715"><span class="sd">       default, so that calls to ``super().__init__()`` can access this</span>
</span><span data-line="716"><span class="sd">       constructor. Previously, due to an implementation mistake, this default</span>
</span><span data-line="717"><span class="sd">       constructor was missing, and calling ``super().__init__()`` would invoke</span>
</span><span data-line="718"><span class="sd">       ``object.__init__()``.</span>
</span><span data-line="719">
</span><span data-line="720"><span class="sd">    The :class:`_orm.DeclarativeBase` subclass may also declare an explicit</span>
</span><span data-line="721"><span class="sd">    ``__init__()`` method which will replace the use of the</span>
</span><span data-line="722"><span class="sd">    :paramref:`_orm.registry.constructor` function at this level::</span>
</span><span data-line="723">
</span><span data-line="724"><span class="sd">        class Base(DeclarativeBase):</span>
</span><span data-line="725"><span class="sd">            def __init__(self, id=None):</span>
</span><span data-line="726"><span class="sd">                self.id = id</span>
</span><span data-line="727">
</span><span data-line="728"><span class="sd">    Mapped classes still will not invoke this constructor implicitly; it</span>
</span><span data-line="729"><span class="sd">    remains only accessible by calling ``super().__init__()``::</span>
</span><span data-line="730">
</span><span data-line="731"><span class="sd">        class MyClass(Base):</span>
</span><span data-line="732"><span class="sd">            def __init__(self, id=None, name=None):</span>
</span><span data-line="733"><span class="sd">                self.name = name</span>
</span><span data-line="734"><span class="sd">                super().__init__(id=id)</span>
</span><span data-line="735">
</span><span data-line="736"><span class="sd">    Note that this is a different behavior from what functions like the legacy</span>
</span><span data-line="737"><span class="sd">    :func:`_orm.declarative_base` would do; the base created by those functions</span>
</span><span data-line="738"><span class="sd">    would always install :paramref:`_orm.registry.constructor` for</span>
</span><span data-line="739"><span class="sd">    ``__init__()``.</span>
</span><span data-line="740">
</span><span data-line="741">
</span><span data-line="742"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="743">
</span><span data-line="744">    <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="745">
</span><span data-line="746">        <span class="k">def</span> <span class="nf">_sa_inspect_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="747">
</span><span data-line="748">        <span class="k">def</span> <span class="nf">_sa_inspect_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="749">
</span><span data-line="750">        <span class="n">_sa_registry</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">_RegistryType</span><span class="p">]</span>
</span><span data-line="751">
</span><span data-line="752">        <span class="n">registry</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">_RegistryType</span><span class="p">]</span>
</span><span data-line="753"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Refers to the :class:`_orm.registry` in use where new</span>
</span><span data-line="754"><span class="sd">        :class:`_orm.Mapper` objects will be associated.&quot;&quot;&quot;</span>
</span><span data-line="755">
</span><span data-line="756">        <span class="n">metadata</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">MetaData</span><span class="p">]</span>
</span><span data-line="757"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Refers to the :class:`_schema.MetaData` collection that will be used</span>
</span><span data-line="758"><span class="sd">        for new :class:`_schema.Table` objects.</span>
</span><span data-line="759">
</span><span data-line="760"><span class="sd">        .. seealso::</span>
</span><span data-line="761">
</span><span data-line="762"><span class="sd">            :ref:`orm_declarative_metadata`</span>
</span><span data-line="763">
</span><span data-line="764"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="765">
</span><span data-line="766">        <span class="vm">__name__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span data-line="767">
</span><span data-line="768">        <span class="c1"># this ideally should be Mapper[Self], but mypy as of 1.4.1 does not</span>
</span><span data-line="769">        <span class="c1"># like it, and breaks the declared_attr_one test. Pyright/pylance is</span>
</span><span data-line="770">        <span class="c1"># ok with it.</span>
</span><span data-line="771">        <span class="n">__mapper__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="772"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The :class:`_orm.Mapper` object to which a particular class is</span>
</span><span data-line="773"><span class="sd">        mapped.</span>
</span><span data-line="774">
</span><span data-line="775"><span class="sd">        May also be acquired using :func:`_sa.inspect`, e.g.</span>
</span><span data-line="776"><span class="sd">        ``inspect(klass)``.</span>
</span><span data-line="777">
</span><span data-line="778"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="779">
</span><span data-line="780">        <span class="n">__table__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span>
</span><span data-line="781"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The :class:`_sql.FromClause` to which a particular subclass is</span>
</span><span data-line="782"><span class="sd">        mapped.</span>
</span><span data-line="783">
</span><span data-line="784"><span class="sd">        This is usually an instance of :class:`_schema.Table` but may also</span>
</span><span data-line="785"><span class="sd">        refer to other kinds of :class:`_sql.FromClause` such as</span>
</span><span data-line="786"><span class="sd">        :class:`_sql.Subquery`, depending on how the class is mapped.</span>
</span><span data-line="787">
</span><span data-line="788"><span class="sd">        .. seealso::</span>
</span><span data-line="789">
</span><span data-line="790"><span class="sd">            :ref:`orm_declarative_metadata`</span>
</span><span data-line="791">
</span><span data-line="792"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="793">
</span><span data-line="794">        <span class="c1"># pyright/pylance do not consider a classmethod a ClassVar so use Any</span>
</span><span data-line="795">        <span class="c1"># https://github.com/microsoft/pylance-release/issues/3484</span>
</span><span data-line="796">        <span class="n">__tablename__</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="797"><span class="w">        </span><span class="sd">&quot;&quot;&quot;String name to assign to the generated</span>
</span><span data-line="798"><span class="sd">        :class:`_schema.Table` object, if not specified directly via</span>
</span><span data-line="799"><span class="sd">        :attr:`_orm.DeclarativeBase.__table__`.</span>
</span><span data-line="800">
</span><span data-line="801"><span class="sd">        .. seealso::</span>
</span><span data-line="802">
</span><span data-line="803"><span class="sd">            :ref:`orm_declarative_table`</span>
</span><span data-line="804">
</span><span data-line="805"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="806">
</span><span data-line="807">        <span class="n">__mapper_args__</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="808"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Dictionary of arguments which will be passed to the</span>
</span><span data-line="809"><span class="sd">        :class:`_orm.Mapper` constructor.</span>
</span><span data-line="810">
</span><span data-line="811"><span class="sd">        .. seealso::</span>
</span><span data-line="812">
</span><span data-line="813"><span class="sd">            :ref:`orm_declarative_mapper_options`</span>
</span><span data-line="814">
</span><span data-line="815"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="816">
</span><span data-line="817">        <span class="n">__table_args__</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="818"><span class="w">        </span><span class="sd">&quot;&quot;&quot;A dictionary or tuple of arguments that will be passed to the</span>
</span><span data-line="819"><span class="sd">        :class:`_schema.Table` constructor.  See</span>
</span><span data-line="820"><span class="sd">        :ref:`orm_declarative_table_configuration`</span>
</span><span data-line="821"><span class="sd">        for background on the specific structure of this collection.</span>
</span><span data-line="822">
</span><span data-line="823"><span class="sd">        .. seealso::</span>
</span><span data-line="824">
</span><span data-line="825"><span class="sd">            :ref:`orm_declarative_table_configuration`</span>
</span><span data-line="826">
</span><span data-line="827"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="828">
</span><span data-line="829">        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span> <span class="o">...</span>
</span><span data-line="830">
</span><span data-line="831">    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="832">        <span class="k">if</span> <span class="n">DeclarativeBase</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
</span><span data-line="833">            <span class="n">_check_not_declarative</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">DeclarativeBase</span><span class="p">)</span>
</span><span data-line="834">            <span class="n">_setup_declarative_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="835">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="836">            <span class="n">_as_declarative</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_sa_registry</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span data-line="837">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span data-line="838">
</span><span data-line="839">
</span><span data-line="840"><span class="k">def</span> <span class="nf">_check_not_declarative</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">base</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="841">    <span class="n">cls_dict</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
</span><span data-line="842">    <span class="k">if</span> <span class="p">(</span>
</span><span data-line="843">        <span class="s2">&quot;__table__&quot;</span> <span class="ow">in</span> <span class="n">cls_dict</span>
</span><span data-line="844">        <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
</span><span data-line="845">            <span class="nb">callable</span><span class="p">(</span><span class="n">cls_dict</span><span class="p">[</span><span class="s2">&quot;__table__&quot;</span><span class="p">])</span>
</span><span data-line="846">            <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls_dict</span><span class="p">[</span><span class="s2">&quot;__table__&quot;</span><span class="p">],</span> <span class="s2">&quot;__get__&quot;</span><span class="p">)</span>
</span><span data-line="847">        <span class="p">)</span>
</span><span data-line="848">    <span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cls_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__tablename__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">):</span>
</span><span data-line="849">        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="850">            <span class="sa">f</span><span class="s2">&quot;Cannot use </span><span class="si">{</span><span class="n">base</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2"> directly as a declarative base &quot;</span>
</span><span data-line="851">            <span class="s2">&quot;class. Create a Base by creating a subclass of it.&quot;</span>
</span><span data-line="852">        <span class="p">)</span>
</span><span data-line="853">
</span><span data-line="854">
</span><span data-line="855"><span class="k">class</span> <span class="nc">DeclarativeBaseNoMeta</span><span class="p">(</span>
</span><span data-line="856">    <span class="c1"># Inspectable is used only by the mypy plugin</span>
</span><span data-line="857">    <span class="n">inspection</span><span class="o">.</span><span class="n">Inspectable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="858"><span class="p">):</span>
</span><span data-line="859"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Same as :class:`_orm.DeclarativeBase`, but does not use a metaclass</span>
</span><span data-line="860"><span class="sd">    to intercept new attributes.</span>
</span><span data-line="861">
</span><span data-line="862"><span class="sd">    The :class:`_orm.DeclarativeBaseNoMeta` base may be used when use of</span>
</span><span data-line="863"><span class="sd">    custom metaclasses is desirable.</span>
</span><span data-line="864">
</span><span data-line="865"><span class="sd">    .. versionadded:: 2.0</span>
</span><span data-line="866">
</span><span data-line="867">
</span><span data-line="868"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="869">
</span><span data-line="870">    <span class="n">_sa_registry</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">_RegistryType</span><span class="p">]</span>
</span><span data-line="871">
</span><span data-line="872">    <span class="n">registry</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">_RegistryType</span><span class="p">]</span>
</span><span data-line="873"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Refers to the :class:`_orm.registry` in use where new</span>
</span><span data-line="874"><span class="sd">    :class:`_orm.Mapper` objects will be associated.&quot;&quot;&quot;</span>
</span><span data-line="875">
</span><span data-line="876">    <span class="n">metadata</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">MetaData</span><span class="p">]</span>
</span><span data-line="877"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Refers to the :class:`_schema.MetaData` collection that will be used</span>
</span><span data-line="878"><span class="sd">    for new :class:`_schema.Table` objects.</span>
</span><span data-line="879">
</span><span data-line="880"><span class="sd">    .. seealso::</span>
</span><span data-line="881">
</span><span data-line="882"><span class="sd">        :ref:`orm_declarative_metadata`</span>
</span><span data-line="883">
</span><span data-line="884"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="885">
</span><span data-line="886">    <span class="c1"># this ideally should be Mapper[Self], but mypy as of 1.4.1 does not</span>
</span><span data-line="887">    <span class="c1"># like it, and breaks the declared_attr_one test. Pyright/pylance is</span>
</span><span data-line="888">    <span class="c1"># ok with it.</span>
</span><span data-line="889">    <span class="n">__mapper__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="890"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The :class:`_orm.Mapper` object to which a particular class is</span>
</span><span data-line="891"><span class="sd">    mapped.</span>
</span><span data-line="892">
</span><span data-line="893"><span class="sd">    May also be acquired using :func:`_sa.inspect`, e.g.</span>
</span><span data-line="894"><span class="sd">    ``inspect(klass)``.</span>
</span><span data-line="895">
</span><span data-line="896"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="897">
</span><span data-line="898">    <span class="n">__table__</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span>
</span><span data-line="899"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The :class:`_sql.FromClause` to which a particular subclass is</span>
</span><span data-line="900"><span class="sd">    mapped.</span>
</span><span data-line="901">
</span><span data-line="902"><span class="sd">    This is usually an instance of :class:`_schema.Table` but may also</span>
</span><span data-line="903"><span class="sd">    refer to other kinds of :class:`_sql.FromClause` such as</span>
</span><span data-line="904"><span class="sd">    :class:`_sql.Subquery`, depending on how the class is mapped.</span>
</span><span data-line="905">
</span><span data-line="906"><span class="sd">    .. seealso::</span>
</span><span data-line="907">
</span><span data-line="908"><span class="sd">        :ref:`orm_declarative_metadata`</span>
</span><span data-line="909">
</span><span data-line="910"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="911">
</span><span data-line="912">    <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="913">
</span><span data-line="914">        <span class="k">def</span> <span class="nf">_sa_inspect_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="915">
</span><span data-line="916">        <span class="k">def</span> <span class="nf">_sa_inspect_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="917">
</span><span data-line="918">        <span class="n">__tablename__</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="919"><span class="w">        </span><span class="sd">&quot;&quot;&quot;String name to assign to the generated</span>
</span><span data-line="920"><span class="sd">        :class:`_schema.Table` object, if not specified directly via</span>
</span><span data-line="921"><span class="sd">        :attr:`_orm.DeclarativeBase.__table__`.</span>
</span><span data-line="922">
</span><span data-line="923"><span class="sd">        .. seealso::</span>
</span><span data-line="924">
</span><span data-line="925"><span class="sd">            :ref:`orm_declarative_table`</span>
</span><span data-line="926">
</span><span data-line="927"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="928">
</span><span data-line="929">        <span class="n">__mapper_args__</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="930"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Dictionary of arguments which will be passed to the</span>
</span><span data-line="931"><span class="sd">        :class:`_orm.Mapper` constructor.</span>
</span><span data-line="932">
</span><span data-line="933"><span class="sd">        .. seealso::</span>
</span><span data-line="934">
</span><span data-line="935"><span class="sd">            :ref:`orm_declarative_mapper_options`</span>
</span><span data-line="936">
</span><span data-line="937"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="938">
</span><span data-line="939">        <span class="n">__table_args__</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="940"><span class="w">        </span><span class="sd">&quot;&quot;&quot;A dictionary or tuple of arguments that will be passed to the</span>
</span><span data-line="941"><span class="sd">        :class:`_schema.Table` constructor.  See</span>
</span><span data-line="942"><span class="sd">        :ref:`orm_declarative_table_configuration`</span>
</span><span data-line="943"><span class="sd">        for background on the specific structure of this collection.</span>
</span><span data-line="944">
</span><span data-line="945"><span class="sd">        .. seealso::</span>
</span><span data-line="946">
</span><span data-line="947"><span class="sd">            :ref:`orm_declarative_table_configuration`</span>
</span><span data-line="948">
</span><span data-line="949"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="950">
</span><span data-line="951">        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span> <span class="o">...</span>
</span><span data-line="952">
</span><span data-line="953">    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="954">        <span class="k">if</span> <span class="n">DeclarativeBaseNoMeta</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
</span><span data-line="955">            <span class="n">_check_not_declarative</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">DeclarativeBaseNoMeta</span><span class="p">)</span>
</span><span data-line="956">            <span class="n">_setup_declarative_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="957">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="958">            <span class="n">_as_declarative</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_sa_registry</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span data-line="959">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span data-line="960">
</span><span data-line="961">
</span><span data-line="962"><span class="k">def</span> <span class="nf">add_mapped_attribute</span><span class="p">(</span>
</span><span data-line="963">    <span class="n">target</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">MapperProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="964"><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="965"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new mapped attribute to an ORM mapped class.</span>
</span><span data-line="966">
</span><span data-line="967"><span class="sd">    E.g.::</span>
</span><span data-line="968">
</span><span data-line="969"><span class="sd">        add_mapped_attribute(User, &quot;addresses&quot;, relationship(Address))</span>
</span><span data-line="970">
</span><span data-line="971"><span class="sd">    This may be used for ORM mappings that aren&#39;t using a declarative</span>
</span><span data-line="972"><span class="sd">    metaclass that intercepts attribute set operations.</span>
</span><span data-line="973">
</span><span data-line="974"><span class="sd">    .. versionadded:: 2.0</span>
</span><span data-line="975">
</span><span data-line="976">
</span><span data-line="977"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="978">    <span class="n">_add_attribute</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span><span data-line="979">
</span><span data-line="980">
</span><span data-line="981"><span class="k">def</span> <span class="nf">declarative_base</span><span class="p">(</span>
</span><span data-line="982">    <span class="o">*</span><span class="p">,</span>
</span><span data-line="983">    <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MetaData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="984">    <span class="n">mapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="985">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">object</span><span class="p">,</span>
</span><span data-line="986">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Base&quot;</span><span class="p">,</span>
</span><span data-line="987">    <span class="n">class_registry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">clsregistry</span><span class="o">.</span><span class="n">_ClsRegistryType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="988">    <span class="n">type_annotation_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_TypeAnnotationMapType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="989">    <span class="n">constructor</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">_declarative_constructor</span><span class="p">,</span>
</span><span data-line="990">    <span class="n">metaclass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeclarativeMeta</span><span class="p">,</span>
</span><span data-line="991"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="992"><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct a base class for declarative class definitions.</span>
</span><span data-line="993">
</span><span data-line="994"><span class="sd">    The new base class will be given a metaclass that produces</span>
</span><span data-line="995"><span class="sd">    appropriate :class:`~sqlalchemy.schema.Table` objects and makes</span>
</span><span data-line="996"><span class="sd">    the appropriate :class:`_orm.Mapper` calls based on the</span>
</span><span data-line="997"><span class="sd">    information provided declaratively in the class and any subclasses</span>
</span><span data-line="998"><span class="sd">    of the class.</span>
</span><span data-line="999">
</span><span data-line="1000"><span class="sd">    .. versionchanged:: 2.0 Note that the :func:`_orm.declarative_base`</span>
</span><span data-line="1001"><span class="sd">       function is superseded by the new :class:`_orm.DeclarativeBase` class,</span>
</span><span data-line="1002"><span class="sd">       which generates a new &quot;base&quot; class using subclassing, rather than</span>
</span><span data-line="1003"><span class="sd">       return value of a function.  This allows an approach that is compatible</span>
</span><span data-line="1004"><span class="sd">       with :pep:`484` typing tools.</span>
</span><span data-line="1005">
</span><span data-line="1006"><span class="sd">    The :func:`_orm.declarative_base` function is a shorthand version</span>
</span><span data-line="1007"><span class="sd">    of using the :meth:`_orm.registry.generate_base`</span>
</span><span data-line="1008"><span class="sd">    method.  That is, the following::</span>
</span><span data-line="1009">
</span><span data-line="1010"><span class="sd">        from sqlalchemy.orm import declarative_base</span>
</span><span data-line="1011">
</span><span data-line="1012"><span class="sd">        Base = declarative_base()</span>
</span><span data-line="1013">
</span><span data-line="1014"><span class="sd">    Is equivalent to::</span>
</span><span data-line="1015">
</span><span data-line="1016"><span class="sd">        from sqlalchemy.orm import registry</span>
</span><span data-line="1017">
</span><span data-line="1018"><span class="sd">        mapper_registry = registry()</span>
</span><span data-line="1019"><span class="sd">        Base = mapper_registry.generate_base()</span>
</span><span data-line="1020">
</span><span data-line="1021"><span class="sd">    See the docstring for :class:`_orm.registry`</span>
</span><span data-line="1022"><span class="sd">    and :meth:`_orm.registry.generate_base`</span>
</span><span data-line="1023"><span class="sd">    for more details.</span>
</span><span data-line="1024">
</span><span data-line="1025"><span class="sd">    .. versionchanged:: 1.4  The :func:`_orm.declarative_base`</span>
</span><span data-line="1026"><span class="sd">       function is now a specialization of the more generic</span>
</span><span data-line="1027"><span class="sd">       :class:`_orm.registry` class.  The function also moves to the</span>
</span><span data-line="1028"><span class="sd">       ``sqlalchemy.orm`` package from the ``declarative.ext`` package.</span>
</span><span data-line="1029">
</span><span data-line="1030">
</span><span data-line="1031"><span class="sd">    :param metadata:</span>
</span><span data-line="1032"><span class="sd">      An optional :class:`~sqlalchemy.schema.MetaData` instance.  All</span>
</span><span data-line="1033"><span class="sd">      :class:`~sqlalchemy.schema.Table` objects implicitly declared by</span>
</span><span data-line="1034"><span class="sd">      subclasses of the base will share this MetaData.  A MetaData instance</span>
</span><span data-line="1035"><span class="sd">      will be created if none is provided.  The</span>
</span><span data-line="1036"><span class="sd">      :class:`~sqlalchemy.schema.MetaData` instance will be available via the</span>
</span><span data-line="1037"><span class="sd">      ``metadata`` attribute of the generated declarative base class.</span>
</span><span data-line="1038">
</span><span data-line="1039"><span class="sd">    :param mapper:</span>
</span><span data-line="1040"><span class="sd">      An optional callable, defaults to :class:`_orm.Mapper`. Will</span>
</span><span data-line="1041"><span class="sd">      be used to map subclasses to their Tables.</span>
</span><span data-line="1042">
</span><span data-line="1043"><span class="sd">    :param cls:</span>
</span><span data-line="1044"><span class="sd">      Defaults to :class:`object`. A type to use as the base for the generated</span>
</span><span data-line="1045"><span class="sd">      declarative base class. May be a class or tuple of classes.</span>
</span><span data-line="1046">
</span><span data-line="1047"><span class="sd">    :param name:</span>
</span><span data-line="1048"><span class="sd">      Defaults to ``Base``.  The display name for the generated</span>
</span><span data-line="1049"><span class="sd">      class.  Customizing this is not required, but can improve clarity in</span>
</span><span data-line="1050"><span class="sd">      tracebacks and debugging.</span>
</span><span data-line="1051">
</span><span data-line="1052"><span class="sd">    :param constructor:</span>
</span><span data-line="1053"><span class="sd">      Specify the implementation for the ``__init__`` function on a mapped</span>
</span><span data-line="1054"><span class="sd">      class that has no ``__init__`` of its own.  Defaults to an</span>
</span><span data-line="1055"><span class="sd">      implementation that assigns \**kwargs for declared</span>
</span><span data-line="1056"><span class="sd">      fields and relationships to an instance.  If ``None`` is supplied,</span>
</span><span data-line="1057"><span class="sd">      no __init__ will be provided and construction will fall back to</span>
</span><span data-line="1058"><span class="sd">      cls.__init__ by way of the normal Python semantics.</span>
</span><span data-line="1059">
</span><span data-line="1060"><span class="sd">    :param class_registry: optional dictionary that will serve as the</span>
</span><span data-line="1061"><span class="sd">      registry of class names-&gt; mapped classes when string names</span>
</span><span data-line="1062"><span class="sd">      are used to identify classes inside of :func:`_orm.relationship`</span>
</span><span data-line="1063"><span class="sd">      and others.  Allows two or more declarative base classes</span>
</span><span data-line="1064"><span class="sd">      to share the same registry of class names for simplified</span>
</span><span data-line="1065"><span class="sd">      inter-base relationships.</span>
</span><span data-line="1066">
</span><span data-line="1067"><span class="sd">    :param type_annotation_map: optional dictionary of Python types to</span>
</span><span data-line="1068"><span class="sd">        SQLAlchemy :class:`_types.TypeEngine` classes or instances.  This</span>
</span><span data-line="1069"><span class="sd">        is used exclusively by the :class:`_orm.MappedColumn` construct</span>
</span><span data-line="1070"><span class="sd">        to produce column types based on annotations within the</span>
</span><span data-line="1071"><span class="sd">        :class:`_orm.Mapped` type.</span>
</span><span data-line="1072">
</span><span data-line="1073">
</span><span data-line="1074"><span class="sd">        .. versionadded:: 2.0</span>
</span><span data-line="1075">
</span><span data-line="1076"><span class="sd">        .. seealso::</span>
</span><span data-line="1077">
</span><span data-line="1078"><span class="sd">            :ref:`orm_declarative_mapped_column_type_map`</span>
</span><span data-line="1079">
</span><span data-line="1080"><span class="sd">    :param metaclass:</span>
</span><span data-line="1081"><span class="sd">      Defaults to :class:`.DeclarativeMeta`.  A metaclass or __metaclass__</span>
</span><span data-line="1082"><span class="sd">      compatible callable to use as the meta type of the generated</span>
</span><span data-line="1083"><span class="sd">      declarative base class.</span>
</span><span data-line="1084">
</span><span data-line="1085"><span class="sd">    .. seealso::</span>
</span><span data-line="1086">
</span><span data-line="1087"><span class="sd">        :class:`_orm.registry`</span>
</span><span data-line="1088">
</span><span data-line="1089"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1090">
</span><span data-line="1091">    <span class="k">return</span> <span class="n">registry</span><span class="p">(</span>
</span><span data-line="1092">        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
</span><span data-line="1093">        <span class="n">class_registry</span><span class="o">=</span><span class="n">class_registry</span><span class="p">,</span>
</span><span data-line="1094">        <span class="n">constructor</span><span class="o">=</span><span class="n">constructor</span><span class="p">,</span>
</span><span data-line="1095">        <span class="n">type_annotation_map</span><span class="o">=</span><span class="n">type_annotation_map</span><span class="p">,</span>
</span><span data-line="1096">    <span class="p">)</span><span class="o">.</span><span class="n">generate_base</span><span class="p">(</span>
</span><span data-line="1097">        <span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
</span><span data-line="1098">        <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span>
</span><span data-line="1099">        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span><span data-line="1100">        <span class="n">metaclass</span><span class="o">=</span><span class="n">metaclass</span><span class="p">,</span>
</span><span data-line="1101">    <span class="p">)</span>
</span><span data-line="1102">
</span><span data-line="1103">
</span><span data-line="1104"><span class="k">class</span> <span class="nc">registry</span><span class="p">:</span>
</span><span data-line="1105"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generalized registry for mapping classes.</span>
</span><span data-line="1106">
</span><span data-line="1107"><span class="sd">    The :class:`_orm.registry` serves as the basis for maintaining a collection</span>
</span><span data-line="1108"><span class="sd">    of mappings, and provides configurational hooks used to map classes.</span>
</span><span data-line="1109">
</span><span data-line="1110"><span class="sd">    The three general kinds of mappings supported are Declarative Base,</span>
</span><span data-line="1111"><span class="sd">    Declarative Decorator, and Imperative Mapping.   All of these mapping</span>
</span><span data-line="1112"><span class="sd">    styles may be used interchangeably:</span>
</span><span data-line="1113">
</span><span data-line="1114"><span class="sd">    * :meth:`_orm.registry.generate_base` returns a new declarative base</span>
</span><span data-line="1115"><span class="sd">      class, and is the underlying implementation of the</span>
</span><span data-line="1116"><span class="sd">      :func:`_orm.declarative_base` function.</span>
</span><span data-line="1117">
</span><span data-line="1118"><span class="sd">    * :meth:`_orm.registry.mapped` provides a class decorator that will</span>
</span><span data-line="1119"><span class="sd">      apply declarative mapping to a class without the use of a declarative</span>
</span><span data-line="1120"><span class="sd">      base class.</span>
</span><span data-line="1121">
</span><span data-line="1122"><span class="sd">    * :meth:`_orm.registry.map_imperatively` will produce a</span>
</span><span data-line="1123"><span class="sd">      :class:`_orm.Mapper` for a class without scanning the class for</span>
</span><span data-line="1124"><span class="sd">      declarative class attributes. This method suits the use case historically</span>
</span><span data-line="1125"><span class="sd">      provided by the ``sqlalchemy.orm.mapper()`` classical mapping function,</span>
</span><span data-line="1126"><span class="sd">      which is removed as of SQLAlchemy 2.0.</span>
</span><span data-line="1127">
</span><span data-line="1128"><span class="sd">    .. versionadded:: 1.4</span>
</span><span data-line="1129">
</span><span data-line="1130"><span class="sd">    .. seealso::</span>
</span><span data-line="1131">
</span><span data-line="1132"><span class="sd">        :ref:`orm_mapping_classes_toplevel` - overview of class mapping</span>
</span><span data-line="1133"><span class="sd">        styles.</span>
</span><span data-line="1134">
</span><span data-line="1135"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1136">
</span><span data-line="1137">    <span class="n">_class_registry</span><span class="p">:</span> <span class="n">clsregistry</span><span class="o">.</span><span class="n">_ClsRegistryType</span>
</span><span data-line="1138">    <span class="n">_managers</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span><span class="n">ClassManager</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]]</span>
</span><span data-line="1139">    <span class="n">_non_primary_mappers</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]]</span>
</span><span data-line="1140">    <span class="n">metadata</span><span class="p">:</span> <span class="n">MetaData</span>
</span><span data-line="1141">    <span class="n">constructor</span><span class="p">:</span> <span class="n">CallableReference</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span>
</span><span data-line="1142">    <span class="n">type_annotation_map</span><span class="p">:</span> <span class="n">_MutableTypeAnnotationMapType</span>
</span><span data-line="1143">    <span class="n">_dependents</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">_RegistryType</span><span class="p">]</span>
</span><span data-line="1144">    <span class="n">_dependencies</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">_RegistryType</span><span class="p">]</span>
</span><span data-line="1145">    <span class="n">_new_mappers</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="1146">
</span><span data-line="1147">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="1148">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1149">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="1150">        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MetaData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1151">        <span class="n">class_registry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">clsregistry</span><span class="o">.</span><span class="n">_ClsRegistryType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1152">        <span class="n">type_annotation_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_TypeAnnotationMapType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1153">        <span class="n">constructor</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">_declarative_constructor</span><span class="p">,</span>
</span><span data-line="1154">    <span class="p">):</span>
</span><span data-line="1155"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct a new :class:`_orm.registry`</span>
</span><span data-line="1156">
</span><span data-line="1157"><span class="sd">        :param metadata:</span>
</span><span data-line="1158"><span class="sd">          An optional :class:`_schema.MetaData` instance.  All</span>
</span><span data-line="1159"><span class="sd">          :class:`_schema.Table` objects generated using declarative</span>
</span><span data-line="1160"><span class="sd">          table mapping will make use of this :class:`_schema.MetaData`</span>
</span><span data-line="1161"><span class="sd">          collection.  If this argument is left at its default of ``None``,</span>
</span><span data-line="1162"><span class="sd">          a blank :class:`_schema.MetaData` collection is created.</span>
</span><span data-line="1163">
</span><span data-line="1164"><span class="sd">        :param constructor:</span>
</span><span data-line="1165"><span class="sd">          Specify the implementation for the ``__init__`` function on a mapped</span>
</span><span data-line="1166"><span class="sd">          class that has no ``__init__`` of its own.  Defaults to an</span>
</span><span data-line="1167"><span class="sd">          implementation that assigns \**kwargs for declared</span>
</span><span data-line="1168"><span class="sd">          fields and relationships to an instance.  If ``None`` is supplied,</span>
</span><span data-line="1169"><span class="sd">          no __init__ will be provided and construction will fall back to</span>
</span><span data-line="1170"><span class="sd">          cls.__init__ by way of the normal Python semantics.</span>
</span><span data-line="1171">
</span><span data-line="1172"><span class="sd">        :param class_registry: optional dictionary that will serve as the</span>
</span><span data-line="1173"><span class="sd">          registry of class names-&gt; mapped classes when string names</span>
</span><span data-line="1174"><span class="sd">          are used to identify classes inside of :func:`_orm.relationship`</span>
</span><span data-line="1175"><span class="sd">          and others.  Allows two or more declarative base classes</span>
</span><span data-line="1176"><span class="sd">          to share the same registry of class names for simplified</span>
</span><span data-line="1177"><span class="sd">          inter-base relationships.</span>
</span><span data-line="1178">
</span><span data-line="1179"><span class="sd">        :param type_annotation_map: optional dictionary of Python types to</span>
</span><span data-line="1180"><span class="sd">          SQLAlchemy :class:`_types.TypeEngine` classes or instances.</span>
</span><span data-line="1181"><span class="sd">          The provided dict will update the default type mapping.  This</span>
</span><span data-line="1182"><span class="sd">          is used exclusively by the :class:`_orm.MappedColumn` construct</span>
</span><span data-line="1183"><span class="sd">          to produce column types based on annotations within the</span>
</span><span data-line="1184"><span class="sd">          :class:`_orm.Mapped` type.</span>
</span><span data-line="1185">
</span><span data-line="1186"><span class="sd">          .. versionadded:: 2.0</span>
</span><span data-line="1187">
</span><span data-line="1188"><span class="sd">          .. seealso::</span>
</span><span data-line="1189">
</span><span data-line="1190"><span class="sd">              :ref:`orm_declarative_mapped_column_type_map`</span>
</span><span data-line="1191">
</span><span data-line="1192">
</span><span data-line="1193"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1194">        <span class="n">lcl_metadata</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="n">MetaData</span><span class="p">()</span>
</span><span data-line="1195">
</span><span data-line="1196">        <span class="k">if</span> <span class="n">class_registry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1197">            <span class="n">class_registry</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
</span><span data-line="1198">
</span><span data-line="1199">        <span class="bp">self</span><span class="o">.</span><span class="n">_class_registry</span> <span class="o">=</span> <span class="n">class_registry</span>
</span><span data-line="1200">        <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span data-line="1201">        <span class="bp">self</span><span class="o">.</span><span class="n">_non_primary_mappers</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span data-line="1202">        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">lcl_metadata</span>
</span><span data-line="1203">        <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">constructor</span>
</span><span data-line="1204">        <span class="bp">self</span><span class="o">.</span><span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1205">        <span class="k">if</span> <span class="n">type_annotation_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1206">            <span class="bp">self</span><span class="o">.</span><span class="n">update_type_annotation_map</span><span class="p">(</span><span class="n">type_annotation_map</span><span class="p">)</span>
</span><span data-line="1207">        <span class="bp">self</span><span class="o">.</span><span class="n">_dependents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="1208">        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="1209">
</span><span data-line="1210">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_mappers</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1211">
</span><span data-line="1212">        <span class="k">with</span> <span class="n">mapperlib</span><span class="o">.</span><span class="n">_CONFIGURE_MUTEX</span><span class="p">:</span>
</span><span data-line="1213">            <span class="n">mapperlib</span><span class="o">.</span><span class="n">_mapper_registries</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1214">
</span><span data-line="1215">    <span class="k">def</span> <span class="nf">update_type_annotation_map</span><span class="p">(</span>
</span><span data-line="1216">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1217">        <span class="n">type_annotation_map</span><span class="p">:</span> <span class="n">_TypeAnnotationMapType</span><span class="p">,</span>
</span><span data-line="1218">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1219"><span class="w">        </span><span class="sd">&quot;&quot;&quot;update the :paramref:`_orm.registry.type_annotation_map` with new</span>
</span><span data-line="1220"><span class="sd">        values.&quot;&quot;&quot;</span>
</span><span data-line="1221">
</span><span data-line="1222">        <span class="bp">self</span><span class="o">.</span><span class="n">type_annotation_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span data-line="1223">            <span class="p">{</span>
</span><span data-line="1224">                <span class="n">sub_type</span><span class="p">:</span> <span class="n">sqltype</span>
</span><span data-line="1225">                <span class="k">for</span> <span class="n">typ</span><span class="p">,</span> <span class="n">sqltype</span> <span class="ow">in</span> <span class="n">type_annotation_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span data-line="1226">                <span class="k">for</span> <span class="n">sub_type</span> <span class="ow">in</span> <span class="n">compat_typing</span><span class="o">.</span><span class="n">expand_unions</span><span class="p">(</span>
</span><span data-line="1227">                    <span class="n">typ</span><span class="p">,</span> <span class="n">include_union</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">discard_none</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="1228">                <span class="p">)</span>
</span><span data-line="1229">            <span class="p">}</span>
</span><span data-line="1230">        <span class="p">)</span>
</span><span data-line="1231">
</span><span data-line="1232">    <span class="k">def</span> <span class="nf">_resolve_type</span><span class="p">(</span>
</span><span data-line="1233">        <span class="bp">self</span><span class="p">,</span> <span class="n">python_type</span><span class="p">:</span> <span class="n">_MatchedOnType</span>
</span><span data-line="1234">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeEngine</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="1235">
</span><span data-line="1236">        <span class="n">python_type_to_check</span> <span class="o">=</span> <span class="n">python_type</span>
</span><span data-line="1237">        <span class="k">while</span> <span class="n">is_pep695</span><span class="p">(</span><span class="n">python_type_to_check</span><span class="p">):</span>
</span><span data-line="1238">            <span class="n">python_type_to_check</span> <span class="o">=</span> <span class="n">python_type_to_check</span><span class="o">.</span><span class="n">__value__</span>
</span><span data-line="1239">
</span><span data-line="1240">        <span class="n">check_is_pt</span> <span class="o">=</span> <span class="n">python_type</span> <span class="ow">is</span> <span class="n">python_type_to_check</span>
</span><span data-line="1241">
</span><span data-line="1242">        <span class="n">python_type_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="1243">        <span class="n">search</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_MatchedOnType</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
</span><span data-line="1244">
</span><span data-line="1245">        <span class="k">if</span> <span class="n">is_generic</span><span class="p">(</span><span class="n">python_type_to_check</span><span class="p">):</span>
</span><span data-line="1246">            <span class="k">if</span> <span class="n">is_literal</span><span class="p">(</span><span class="n">python_type_to_check</span><span class="p">):</span>
</span><span data-line="1247">                <span class="n">python_type_type</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Type[Any]&quot;</span><span class="p">,</span> <span class="n">python_type_to_check</span><span class="p">)</span>
</span><span data-line="1248">
</span><span data-line="1249">                <span class="n">search</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># type: ignore[assignment]</span>
</span><span data-line="1250">                    <span class="p">(</span><span class="n">python_type</span><span class="p">,</span> <span class="n">python_type_type</span><span class="p">),</span>
</span><span data-line="1251">                    <span class="p">(</span><span class="n">Literal</span><span class="p">,</span> <span class="n">python_type_type</span><span class="p">),</span>
</span><span data-line="1252">                <span class="p">)</span>
</span><span data-line="1253">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1254">                <span class="n">python_type_type</span> <span class="o">=</span> <span class="n">python_type_to_check</span><span class="o">.</span><span class="n">__origin__</span>
</span><span data-line="1255">                <span class="n">search</span> <span class="o">=</span> <span class="p">((</span><span class="n">python_type</span><span class="p">,</span> <span class="n">python_type_type</span><span class="p">),)</span>
</span><span data-line="1256">        <span class="k">elif</span> <span class="n">is_newtype</span><span class="p">(</span><span class="n">python_type_to_check</span><span class="p">):</span>
</span><span data-line="1257">            <span class="n">python_type_type</span> <span class="o">=</span> <span class="n">flatten_newtype</span><span class="p">(</span><span class="n">python_type_to_check</span><span class="p">)</span>
</span><span data-line="1258">            <span class="n">search</span> <span class="o">=</span> <span class="p">((</span><span class="n">python_type</span><span class="p">,</span> <span class="n">python_type_type</span><span class="p">),)</span>
</span><span data-line="1259">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">python_type_to_check</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
</span><span data-line="1260">            <span class="n">python_type_type</span> <span class="o">=</span> <span class="n">python_type_to_check</span>
</span><span data-line="1261">            <span class="n">search</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1262">                <span class="p">(</span><span class="n">pt</span> <span class="k">if</span> <span class="n">check_is_pt</span> <span class="k">else</span> <span class="n">python_type</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>
</span><span data-line="1263">                <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">python_type_type</span><span class="o">.</span><span class="vm">__mro__</span>
</span><span data-line="1264">            <span class="p">)</span>
</span><span data-line="1265">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1266">            <span class="n">python_type_type</span> <span class="o">=</span> <span class="n">python_type_to_check</span>  <span class="c1"># type: ignore[assignment]</span>
</span><span data-line="1267">            <span class="n">search</span> <span class="o">=</span> <span class="p">((</span><span class="n">python_type</span><span class="p">,</span> <span class="n">python_type_type</span><span class="p">),)</span>
</span><span data-line="1268">
</span><span data-line="1269">        <span class="k">for</span> <span class="n">pt</span><span class="p">,</span> <span class="n">flattened</span> <span class="ow">in</span> <span class="n">search</span><span class="p">:</span>
</span><span data-line="1270">            <span class="c1"># we search through full __mro__ for types.  however...</span>
</span><span data-line="1271">            <span class="n">sql_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_annotation_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
</span><span data-line="1272">            <span class="k">if</span> <span class="n">sql_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1273">                <span class="n">sql_type</span> <span class="o">=</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">_type_map_get</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>  <span class="c1"># type: ignore  # noqa: E501</span>
</span><span data-line="1274">
</span><span data-line="1275">            <span class="k">if</span> <span class="n">sql_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1276">                <span class="n">sql_type_inst</span> <span class="o">=</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">to_instance</span><span class="p">(</span><span class="n">sql_type</span><span class="p">)</span>
</span><span data-line="1277">
</span><span data-line="1278">                <span class="c1"># ... this additional step will reject most</span>
</span><span data-line="1279">                <span class="c1"># type -&gt; supertype matches, such as if we had</span>
</span><span data-line="1280">                <span class="c1"># a MyInt(int) subclass.  note also we pass NewType()</span>
</span><span data-line="1281">                <span class="c1"># here directly; these always have to be in the</span>
</span><span data-line="1282">                <span class="c1"># type_annotation_map to be useful</span>
</span><span data-line="1283">                <span class="n">resolved_sql_type</span> <span class="o">=</span> <span class="n">sql_type_inst</span><span class="o">.</span><span class="n">_resolve_for_python_type</span><span class="p">(</span>
</span><span data-line="1284">                    <span class="n">python_type_type</span><span class="p">,</span>
</span><span data-line="1285">                    <span class="n">pt</span><span class="p">,</span>
</span><span data-line="1286">                    <span class="n">flattened</span><span class="p">,</span>
</span><span data-line="1287">                <span class="p">)</span>
</span><span data-line="1288">                <span class="k">if</span> <span class="n">resolved_sql_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1289">                    <span class="k">return</span> <span class="n">resolved_sql_type</span>
</span><span data-line="1290">
</span><span data-line="1291">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="1292">
</span><span data-line="1293">    <span class="nd">@property</span>
</span><span data-line="1294">    <span class="k">def</span> <span class="nf">mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="1295"><span class="w">        </span><span class="sd">&quot;&quot;&quot;read only collection of all :class:`_orm.Mapper` objects.&quot;&quot;&quot;</span>
</span><span data-line="1296">
</span><span data-line="1297">        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">mapper</span> <span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
</span><span data-line="1298">            <span class="bp">self</span><span class="o">.</span><span class="n">_non_primary_mappers</span>
</span><span data-line="1299">        <span class="p">)</span>
</span><span data-line="1300">
</span><span data-line="1301">    <span class="k">def</span> <span class="nf">_set_depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">RegistryType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1302">        <span class="k">if</span> <span class="n">registry</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
</span><span data-line="1303">            <span class="k">return</span>
</span><span data-line="1304">        <span class="n">registry</span><span class="o">.</span><span class="n">_dependents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1305">        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
</span><span data-line="1306">
</span><span data-line="1307">    <span class="k">def</span> <span class="nf">_flag_new_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1308">        <span class="n">mapper</span><span class="o">.</span><span class="n">_ready_for_configure</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1309">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_mappers</span><span class="p">:</span>
</span><span data-line="1310">            <span class="k">return</span>
</span><span data-line="1311">
</span><span data-line="1312">        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurse_with_dependents</span><span class="p">({</span><span class="bp">self</span><span class="p">}):</span>
</span><span data-line="1313">            <span class="n">reg</span><span class="o">.</span><span class="n">_new_mappers</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1314">
</span><span data-line="1315">    <span class="nd">@classmethod</span>
</span><span data-line="1316">    <span class="k">def</span> <span class="nf">_recurse_with_dependents</span><span class="p">(</span>
</span><span data-line="1317">        <span class="bp">cls</span><span class="p">,</span> <span class="n">registries</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">RegistryType</span><span class="p">]</span>
</span><span data-line="1318">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RegistryType</span><span class="p">]:</span>
</span><span data-line="1319">        <span class="n">todo</span> <span class="o">=</span> <span class="n">registries</span>
</span><span data-line="1320">        <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="1321">        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
</span><span data-line="1322">            <span class="n">reg</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span data-line="1323">            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
</span><span data-line="1324">
</span><span data-line="1325">            <span class="c1"># if yielding would remove dependents, make sure we have</span>
</span><span data-line="1326">            <span class="c1"># them before</span>
</span><span data-line="1327">            <span class="n">todo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">_dependents</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">done</span><span class="p">))</span>
</span><span data-line="1328">            <span class="k">yield</span> <span class="n">reg</span>
</span><span data-line="1329">
</span><span data-line="1330">            <span class="c1"># if yielding would add dependents, make sure we have them</span>
</span><span data-line="1331">            <span class="c1"># after</span>
</span><span data-line="1332">            <span class="n">todo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">_dependents</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">done</span><span class="p">))</span>
</span><span data-line="1333">
</span><span data-line="1334">    <span class="nd">@classmethod</span>
</span><span data-line="1335">    <span class="k">def</span> <span class="nf">_recurse_with_dependencies</span><span class="p">(</span>
</span><span data-line="1336">        <span class="bp">cls</span><span class="p">,</span> <span class="n">registries</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">RegistryType</span><span class="p">]</span>
</span><span data-line="1337">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RegistryType</span><span class="p">]:</span>
</span><span data-line="1338">        <span class="n">todo</span> <span class="o">=</span> <span class="n">registries</span>
</span><span data-line="1339">        <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span data-line="1340">        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
</span><span data-line="1341">            <span class="n">reg</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span data-line="1342">            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
</span><span data-line="1343">
</span><span data-line="1344">            <span class="c1"># if yielding would remove dependencies, make sure we have</span>
</span><span data-line="1345">            <span class="c1"># them before</span>
</span><span data-line="1346">            <span class="n">todo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">_dependencies</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">done</span><span class="p">))</span>
</span><span data-line="1347">
</span><span data-line="1348">            <span class="k">yield</span> <span class="n">reg</span>
</span><span data-line="1349">
</span><span data-line="1350">            <span class="c1"># if yielding would remove dependencies, make sure we have</span>
</span><span data-line="1351">            <span class="c1"># them before</span>
</span><span data-line="1352">            <span class="n">todo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">_dependencies</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">done</span><span class="p">))</span>
</span><span data-line="1353">
</span><span data-line="1354">    <span class="k">def</span> <span class="nf">_mappers_to_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="1355">        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
</span><span data-line="1356">            <span class="p">(</span>
</span><span data-line="1357">                <span class="n">manager</span><span class="o">.</span><span class="n">mapper</span>
</span><span data-line="1358">                <span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">)</span>
</span><span data-line="1359">                <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_mapped</span>
</span><span data-line="1360">                <span class="ow">and</span> <span class="ow">not</span> <span class="n">manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">configured</span>
</span><span data-line="1361">                <span class="ow">and</span> <span class="n">manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">_ready_for_configure</span>
</span><span data-line="1362">            <span class="p">),</span>
</span><span data-line="1363">            <span class="p">(</span>
</span><span data-line="1364">                <span class="n">npm</span>
</span><span data-line="1365">                <span class="k">for</span> <span class="n">npm</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_non_primary_mappers</span><span class="p">)</span>
</span><span data-line="1366">                <span class="k">if</span> <span class="ow">not</span> <span class="n">npm</span><span class="o">.</span><span class="n">configured</span> <span class="ow">and</span> <span class="n">npm</span><span class="o">.</span><span class="n">_ready_for_configure</span>
</span><span data-line="1367">            <span class="p">),</span>
</span><span data-line="1368">        <span class="p">)</span>
</span><span data-line="1369">
</span><span data-line="1370">    <span class="k">def</span> <span class="nf">_add_non_primary_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">np_mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1371">        <span class="bp">self</span><span class="o">.</span><span class="n">_non_primary_mappers</span><span class="p">[</span><span class="n">np_mapper</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1372">
</span><span data-line="1373">    <span class="k">def</span> <span class="nf">_dispose_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1374">        <span class="n">clsregistry</span><span class="o">.</span><span class="n">remove_class</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_registry</span><span class="p">)</span>
</span><span data-line="1375">
</span><span data-line="1376">    <span class="k">def</span> <span class="nf">_add_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">ClassManager</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1377">        <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">manager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1378">        <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
</span><span data-line="1379">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1380">                <span class="s2">&quot;Class &#39;</span><span class="si">%s</span><span class="s2">&#39; already has a primary mapper defined. &quot;</span>
</span><span data-line="1381">                <span class="o">%</span> <span class="n">manager</span><span class="o">.</span><span class="n">class_</span>
</span><span data-line="1382">            <span class="p">)</span>
</span><span data-line="1383">        <span class="k">assert</span> <span class="n">manager</span><span class="o">.</span><span class="n">registry</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1384">        <span class="n">manager</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span>
</span><span data-line="1385">
</span><span data-line="1386">    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cascade</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1387"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure all as-yet unconfigured mappers in this</span>
</span><span data-line="1388"><span class="sd">        :class:`_orm.registry`.</span>
</span><span data-line="1389">
</span><span data-line="1390"><span class="sd">        The configure step is used to reconcile and initialize the</span>
</span><span data-line="1391"><span class="sd">        :func:`_orm.relationship` linkages between mapped classes, as well as</span>
</span><span data-line="1392"><span class="sd">        to invoke configuration events such as the</span>
</span><span data-line="1393"><span class="sd">        :meth:`_orm.MapperEvents.before_configured` and</span>
</span><span data-line="1394"><span class="sd">        :meth:`_orm.MapperEvents.after_configured`, which may be used by ORM</span>
</span><span data-line="1395"><span class="sd">        extensions or user-defined extension hooks.</span>
</span><span data-line="1396">
</span><span data-line="1397"><span class="sd">        If one or more mappers in this registry contain</span>
</span><span data-line="1398"><span class="sd">        :func:`_orm.relationship` constructs that refer to mapped classes in</span>
</span><span data-line="1399"><span class="sd">        other registries, this registry is said to be *dependent* on those</span>
</span><span data-line="1400"><span class="sd">        registries. In order to configure those dependent registries</span>
</span><span data-line="1401"><span class="sd">        automatically, the :paramref:`_orm.registry.configure.cascade` flag</span>
</span><span data-line="1402"><span class="sd">        should be set to ``True``. Otherwise, if they are not configured, an</span>
</span><span data-line="1403"><span class="sd">        exception will be raised.  The rationale behind this behavior is to</span>
</span><span data-line="1404"><span class="sd">        allow an application to programmatically invoke configuration of</span>
</span><span data-line="1405"><span class="sd">        registries while controlling whether or not the process implicitly</span>
</span><span data-line="1406"><span class="sd">        reaches other registries.</span>
</span><span data-line="1407">
</span><span data-line="1408"><span class="sd">        As an alternative to invoking :meth:`_orm.registry.configure`, the ORM</span>
</span><span data-line="1409"><span class="sd">        function :func:`_orm.configure_mappers` function may be used to ensure</span>
</span><span data-line="1410"><span class="sd">        configuration is complete for all :class:`_orm.registry` objects in</span>
</span><span data-line="1411"><span class="sd">        memory. This is generally simpler to use and also predates the usage of</span>
</span><span data-line="1412"><span class="sd">        :class:`_orm.registry` objects overall. However, this function will</span>
</span><span data-line="1413"><span class="sd">        impact all mappings throughout the running Python process and may be</span>
</span><span data-line="1414"><span class="sd">        more memory/time consuming for an application that has many registries</span>
</span><span data-line="1415"><span class="sd">        in use for different purposes that may not be needed immediately.</span>
</span><span data-line="1416">
</span><span data-line="1417"><span class="sd">        .. seealso::</span>
</span><span data-line="1418">
</span><span data-line="1419"><span class="sd">            :func:`_orm.configure_mappers`</span>
</span><span data-line="1420">
</span><span data-line="1421">
</span><span data-line="1422"><span class="sd">        .. versionadded:: 1.4.0b2</span>
</span><span data-line="1423">
</span><span data-line="1424"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1425">        <span class="n">mapperlib</span><span class="o">.</span><span class="n">_configure_registries</span><span class="p">({</span><span class="bp">self</span><span class="p">},</span> <span class="n">cascade</span><span class="o">=</span><span class="n">cascade</span><span class="p">)</span>
</span><span data-line="1426">
</span><span data-line="1427">    <span class="k">def</span> <span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cascade</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1428"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Dispose of all mappers in this :class:`_orm.registry`.</span>
</span><span data-line="1429">
</span><span data-line="1430"><span class="sd">        After invocation, all the classes that were mapped within this registry</span>
</span><span data-line="1431"><span class="sd">        will no longer have class instrumentation associated with them. This</span>
</span><span data-line="1432"><span class="sd">        method is the per-:class:`_orm.registry` analogue to the</span>
</span><span data-line="1433"><span class="sd">        application-wide :func:`_orm.clear_mappers` function.</span>
</span><span data-line="1434">
</span><span data-line="1435"><span class="sd">        If this registry contains mappers that are dependencies of other</span>
</span><span data-line="1436"><span class="sd">        registries, typically via :func:`_orm.relationship` links, then those</span>
</span><span data-line="1437"><span class="sd">        registries must be disposed as well. When such registries exist in</span>
</span><span data-line="1438"><span class="sd">        relation to this one, their :meth:`_orm.registry.dispose` method will</span>
</span><span data-line="1439"><span class="sd">        also be called, if the :paramref:`_orm.registry.dispose.cascade` flag</span>
</span><span data-line="1440"><span class="sd">        is set to ``True``; otherwise, an error is raised if those registries</span>
</span><span data-line="1441"><span class="sd">        were not already disposed.</span>
</span><span data-line="1442">
</span><span data-line="1443"><span class="sd">        .. versionadded:: 1.4.0b2</span>
</span><span data-line="1444">
</span><span data-line="1445"><span class="sd">        .. seealso::</span>
</span><span data-line="1446">
</span><span data-line="1447"><span class="sd">            :func:`_orm.clear_mappers`</span>
</span><span data-line="1448">
</span><span data-line="1449"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1450">
</span><span data-line="1451">        <span class="n">mapperlib</span><span class="o">.</span><span class="n">_dispose_registries</span><span class="p">({</span><span class="bp">self</span><span class="p">},</span> <span class="n">cascade</span><span class="o">=</span><span class="n">cascade</span><span class="p">)</span>
</span><span data-line="1452">
</span><span data-line="1453">    <span class="k">def</span> <span class="nf">_dispose_manager_and_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">ClassManager</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1454">        <span class="k">if</span> <span class="s2">&quot;mapper&quot;</span> <span class="ow">in</span> <span class="n">manager</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span data-line="1455">            <span class="n">mapper</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">mapper</span>
</span><span data-line="1456">
</span><span data-line="1457">            <span class="n">mapper</span><span class="o">.</span><span class="n">_set_dispose_flags</span><span class="p">()</span>
</span><span data-line="1458">
</span><span data-line="1459">        <span class="n">class_</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">class_</span>
</span><span data-line="1460">        <span class="bp">self</span><span class="o">.</span><span class="n">_dispose_cls</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
</span><span data-line="1461">        <span class="n">instrumentation</span><span class="o">.</span><span class="n">_instrumentation_factory</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
</span><span data-line="1462">
</span><span data-line="1463">    <span class="k">def</span> <span class="nf">generate_base</span><span class="p">(</span>
</span><span data-line="1464">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1465">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1466">        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">object</span><span class="p">,</span>
</span><span data-line="1467">        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Base&quot;</span><span class="p">,</span>
</span><span data-line="1468">        <span class="n">metaclass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeclarativeMeta</span><span class="p">,</span>
</span><span data-line="1469">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="1470"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a declarative base class.</span>
</span><span data-line="1471">
</span><span data-line="1472"><span class="sd">        Classes that inherit from the returned class object will be</span>
</span><span data-line="1473"><span class="sd">        automatically mapped using declarative mapping.</span>
</span><span data-line="1474">
</span><span data-line="1475"><span class="sd">        E.g.::</span>
</span><span data-line="1476">
</span><span data-line="1477"><span class="sd">            from sqlalchemy.orm import registry</span>
</span><span data-line="1478">
</span><span data-line="1479"><span class="sd">            mapper_registry = registry()</span>
</span><span data-line="1480">
</span><span data-line="1481"><span class="sd">            Base = mapper_registry.generate_base()</span>
</span><span data-line="1482">
</span><span data-line="1483"><span class="sd">            class MyClass(Base):</span>
</span><span data-line="1484"><span class="sd">                __tablename__ = &quot;my_table&quot;</span>
</span><span data-line="1485"><span class="sd">                id = Column(Integer, primary_key=True)</span>
</span><span data-line="1486">
</span><span data-line="1487"><span class="sd">        The above dynamically generated class is equivalent to the</span>
</span><span data-line="1488"><span class="sd">        non-dynamic example below::</span>
</span><span data-line="1489">
</span><span data-line="1490"><span class="sd">            from sqlalchemy.orm import registry</span>
</span><span data-line="1491"><span class="sd">            from sqlalchemy.orm.decl_api import DeclarativeMeta</span>
</span><span data-line="1492">
</span><span data-line="1493"><span class="sd">            mapper_registry = registry()</span>
</span><span data-line="1494">
</span><span data-line="1495"><span class="sd">            class Base(metaclass=DeclarativeMeta):</span>
</span><span data-line="1496"><span class="sd">                __abstract__ = True</span>
</span><span data-line="1497"><span class="sd">                registry = mapper_registry</span>
</span><span data-line="1498"><span class="sd">                metadata = mapper_registry.metadata</span>
</span><span data-line="1499">
</span><span data-line="1500"><span class="sd">                __init__ = mapper_registry.constructor</span>
</span><span data-line="1501">
</span><span data-line="1502"><span class="sd">        .. versionchanged:: 2.0 Note that the</span>
</span><span data-line="1503"><span class="sd">           :meth:`_orm.registry.generate_base` method is superseded by the new</span>
</span><span data-line="1504"><span class="sd">           :class:`_orm.DeclarativeBase` class, which generates a new &quot;base&quot;</span>
</span><span data-line="1505"><span class="sd">           class using subclassing, rather than return value of a function.</span>
</span><span data-line="1506"><span class="sd">           This allows an approach that is compatible with :pep:`484` typing</span>
</span><span data-line="1507"><span class="sd">           tools.</span>
</span><span data-line="1508">
</span><span data-line="1509"><span class="sd">        The :meth:`_orm.registry.generate_base` method provides the</span>
</span><span data-line="1510"><span class="sd">        implementation for the :func:`_orm.declarative_base` function, which</span>
</span><span data-line="1511"><span class="sd">        creates the :class:`_orm.registry` and base class all at once.</span>
</span><span data-line="1512">
</span><span data-line="1513"><span class="sd">        See the section :ref:`orm_declarative_mapping` for background and</span>
</span><span data-line="1514"><span class="sd">        examples.</span>
</span><span data-line="1515">
</span><span data-line="1516"><span class="sd">        :param mapper:</span>
</span><span data-line="1517"><span class="sd">          An optional callable, defaults to :class:`_orm.Mapper`.</span>
</span><span data-line="1518"><span class="sd">          This function is used to generate new :class:`_orm.Mapper` objects.</span>
</span><span data-line="1519">
</span><span data-line="1520"><span class="sd">        :param cls:</span>
</span><span data-line="1521"><span class="sd">          Defaults to :class:`object`. A type to use as the base for the</span>
</span><span data-line="1522"><span class="sd">          generated declarative base class. May be a class or tuple of classes.</span>
</span><span data-line="1523">
</span><span data-line="1524"><span class="sd">        :param name:</span>
</span><span data-line="1525"><span class="sd">          Defaults to ``Base``.  The display name for the generated</span>
</span><span data-line="1526"><span class="sd">          class.  Customizing this is not required, but can improve clarity in</span>
</span><span data-line="1527"><span class="sd">          tracebacks and debugging.</span>
</span><span data-line="1528">
</span><span data-line="1529"><span class="sd">        :param metaclass:</span>
</span><span data-line="1530"><span class="sd">          Defaults to :class:`.DeclarativeMeta`.  A metaclass or __metaclass__</span>
</span><span data-line="1531"><span class="sd">          compatible callable to use as the meta type of the generated</span>
</span><span data-line="1532"><span class="sd">          declarative base class.</span>
</span><span data-line="1533">
</span><span data-line="1534"><span class="sd">        .. seealso::</span>
</span><span data-line="1535">
</span><span data-line="1536"><span class="sd">            :ref:`orm_declarative_mapping`</span>
</span><span data-line="1537">
</span><span data-line="1538"><span class="sd">            :func:`_orm.declarative_base`</span>
</span><span data-line="1539">
</span><span data-line="1540"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1541">        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>
</span><span data-line="1542">
</span><span data-line="1543">        <span class="n">bases</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,)</span> <span class="ow">or</span> <span class="bp">cls</span>
</span><span data-line="1544">
</span><span data-line="1545">        <span class="n">class_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
</span><span data-line="1546">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
</span><span data-line="1547">            <span class="n">class_dict</span><span class="p">[</span><span class="s2">&quot;__doc__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span data-line="1548">
</span><span data-line="1549">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1550">            <span class="n">class_dict</span><span class="p">[</span><span class="s2">&quot;__init__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span>
</span><span data-line="1551">
</span><span data-line="1552">        <span class="n">class_dict</span><span class="p">[</span><span class="s2">&quot;__abstract__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1553">        <span class="k">if</span> <span class="n">mapper</span><span class="p">:</span>
</span><span data-line="1554">            <span class="n">class_dict</span><span class="p">[</span><span class="s2">&quot;__mapper_cls__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapper</span>
</span><span data-line="1555">
</span><span data-line="1556">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__class_getitem__&quot;</span><span class="p">):</span>
</span><span data-line="1557">
</span><span data-line="1558">            <span class="k">def</span> <span class="nf">__class_getitem__</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1559">                <span class="c1"># allow generic classes in py3.9+</span>
</span><span data-line="1560">                <span class="k">return</span> <span class="bp">cls</span>
</span><span data-line="1561">
</span><span data-line="1562">            <span class="n">class_dict</span><span class="p">[</span><span class="s2">&quot;__class_getitem__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__class_getitem__</span>
</span><span data-line="1563">
</span><span data-line="1564">        <span class="k">return</span> <span class="n">metaclass</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">)</span>
</span><span data-line="1565">
</span><span data-line="1566">    <span class="nd">@compat_typing</span><span class="o">.</span><span class="n">dataclass_transform</span><span class="p">(</span>
</span><span data-line="1567">        <span class="n">field_specifiers</span><span class="o">=</span><span class="p">(</span>
</span><span data-line="1568">            <span class="n">MappedColumn</span><span class="p">,</span>
</span><span data-line="1569">            <span class="n">RelationshipProperty</span><span class="p">,</span>
</span><span data-line="1570">            <span class="n">Composite</span><span class="p">,</span>
</span><span data-line="1571">            <span class="n">Synonym</span><span class="p">,</span>
</span><span data-line="1572">            <span class="n">mapped_column</span><span class="p">,</span>
</span><span data-line="1573">            <span class="n">relationship</span><span class="p">,</span>
</span><span data-line="1574">            <span class="n">composite</span><span class="p">,</span>
</span><span data-line="1575">            <span class="n">synonym</span><span class="p">,</span>
</span><span data-line="1576">            <span class="n">deferred</span><span class="p">,</span>
</span><span data-line="1577">        <span class="p">),</span>
</span><span data-line="1578">    <span class="p">)</span>
</span><span data-line="1579">    <span class="nd">@overload</span>
</span><span data-line="1580">    <span class="k">def</span> <span class="nf">mapped_as_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span> <span class="o">...</span>
</span><span data-line="1581">
</span><span data-line="1582">    <span class="nd">@overload</span>
</span><span data-line="1583">    <span class="k">def</span> <span class="nf">mapped_as_dataclass</span><span class="p">(</span>
</span><span data-line="1584">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1585">        <span class="n">__cls</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1586">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="1587">        <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1588">        <span class="nb">repr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
</span><span data-line="1589">        <span class="n">eq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1590">        <span class="n">order</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1591">        <span class="n">unsafe_hash</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1592">        <span class="n">match_args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1593">        <span class="n">kw_only</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1594">        <span class="n">dataclass_callable</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span data-line="1595">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]]:</span> <span class="o">...</span>
</span><span data-line="1596">
</span><span data-line="1597">    <span class="k">def</span> <span class="nf">mapped_as_dataclass</span><span class="p">(</span>
</span><span data-line="1598">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1599">        <span class="n">__cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1600">        <span class="o">*</span><span class="p">,</span>
</span><span data-line="1601">        <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="1602">        <span class="nb">repr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
</span><span data-line="1603">        <span class="n">eq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="1604">        <span class="n">order</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="1605">        <span class="n">unsafe_hash</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="1606">        <span class="n">match_args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="1607">        <span class="n">kw_only</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="1608">        <span class="n">dataclass_callable</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span data-line="1609">            <span class="n">_NoArg</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="1610">        <span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span data-line="1611">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]]]:</span>
</span><span data-line="1612"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Class decorator that will apply the Declarative mapping process</span>
</span><span data-line="1613"><span class="sd">        to a given class, and additionally convert the class to be a</span>
</span><span data-line="1614"><span class="sd">        Python dataclass.</span>
</span><span data-line="1615">
</span><span data-line="1616"><span class="sd">        .. seealso::</span>
</span><span data-line="1617">
</span><span data-line="1618"><span class="sd">            :ref:`orm_declarative_native_dataclasses` - complete background</span>
</span><span data-line="1619"><span class="sd">            on SQLAlchemy native dataclass mapping</span>
</span><span data-line="1620">
</span><span data-line="1621">
</span><span data-line="1622"><span class="sd">        .. versionadded:: 2.0</span>
</span><span data-line="1623">
</span><span data-line="1624">
</span><span data-line="1625"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1626">
</span><span data-line="1627">        <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span data-line="1628">            <span class="nb">setattr</span><span class="p">(</span>
</span><span data-line="1629">                <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="1630">                <span class="s2">&quot;_sa_apply_dc_transforms&quot;</span><span class="p">,</span>
</span><span data-line="1631">                <span class="p">{</span>
</span><span data-line="1632">                    <span class="s2">&quot;init&quot;</span><span class="p">:</span> <span class="n">init</span><span class="p">,</span>
</span><span data-line="1633">                    <span class="s2">&quot;repr&quot;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">,</span>
</span><span data-line="1634">                    <span class="s2">&quot;eq&quot;</span><span class="p">:</span> <span class="n">eq</span><span class="p">,</span>
</span><span data-line="1635">                    <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span>
</span><span data-line="1636">                    <span class="s2">&quot;unsafe_hash&quot;</span><span class="p">:</span> <span class="n">unsafe_hash</span><span class="p">,</span>
</span><span data-line="1637">                    <span class="s2">&quot;match_args&quot;</span><span class="p">:</span> <span class="n">match_args</span><span class="p">,</span>
</span><span data-line="1638">                    <span class="s2">&quot;kw_only&quot;</span><span class="p">:</span> <span class="n">kw_only</span><span class="p">,</span>
</span><span data-line="1639">                    <span class="s2">&quot;dataclass_callable&quot;</span><span class="p">:</span> <span class="n">dataclass_callable</span><span class="p">,</span>
</span><span data-line="1640">                <span class="p">},</span>
</span><span data-line="1641">            <span class="p">)</span>
</span><span data-line="1642">            <span class="n">_as_declarative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span data-line="1643">            <span class="k">return</span> <span class="bp">cls</span>
</span><span data-line="1644">
</span><span data-line="1645">        <span class="k">if</span> <span class="n">__cls</span><span class="p">:</span>
</span><span data-line="1646">            <span class="k">return</span> <span class="n">decorate</span><span class="p">(</span><span class="n">__cls</span><span class="p">)</span>
</span><span data-line="1647">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1648">            <span class="k">return</span> <span class="n">decorate</span>
</span><span data-line="1649">
</span><span data-line="1650">    <span class="k">def</span> <span class="nf">mapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span data-line="1651"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Class decorator that will apply the Declarative mapping process</span>
</span><span data-line="1652"><span class="sd">        to a given class.</span>
</span><span data-line="1653">
</span><span data-line="1654"><span class="sd">        E.g.::</span>
</span><span data-line="1655">
</span><span data-line="1656"><span class="sd">            from sqlalchemy.orm import registry</span>
</span><span data-line="1657">
</span><span data-line="1658"><span class="sd">            mapper_registry = registry()</span>
</span><span data-line="1659">
</span><span data-line="1660"><span class="sd">            @mapper_registry.mapped</span>
</span><span data-line="1661"><span class="sd">            class Foo:</span>
</span><span data-line="1662"><span class="sd">                __tablename__ = &#39;some_table&#39;</span>
</span><span data-line="1663">
</span><span data-line="1664"><span class="sd">                id = Column(Integer, primary_key=True)</span>
</span><span data-line="1665"><span class="sd">                name = Column(String)</span>
</span><span data-line="1666">
</span><span data-line="1667"><span class="sd">        See the section :ref:`orm_declarative_mapping` for complete</span>
</span><span data-line="1668"><span class="sd">        details and examples.</span>
</span><span data-line="1669">
</span><span data-line="1670"><span class="sd">        :param cls: class to be mapped.</span>
</span><span data-line="1671">
</span><span data-line="1672"><span class="sd">        :return: the class that was passed.</span>
</span><span data-line="1673">
</span><span data-line="1674"><span class="sd">        .. seealso::</span>
</span><span data-line="1675">
</span><span data-line="1676"><span class="sd">            :ref:`orm_declarative_mapping`</span>
</span><span data-line="1677">
</span><span data-line="1678"><span class="sd">            :meth:`_orm.registry.generate_base` - generates a base class</span>
</span><span data-line="1679"><span class="sd">            that will apply Declarative mapping to subclasses automatically</span>
</span><span data-line="1680"><span class="sd">            using a Python metaclass.</span>
</span><span data-line="1681">
</span><span data-line="1682"><span class="sd">        .. seealso::</span>
</span><span data-line="1683">
</span><span data-line="1684"><span class="sd">            :meth:`_orm.registry.mapped_as_dataclass`</span>
</span><span data-line="1685">
</span><span data-line="1686"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1687">        <span class="n">_as_declarative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span data-line="1688">        <span class="k">return</span> <span class="bp">cls</span>
</span><span data-line="1689">
</span><span data-line="1690">    <span class="k">def</span> <span class="nf">as_declarative_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span data-line="1691"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1692"><span class="sd">        Class decorator which will invoke</span>
</span><span data-line="1693"><span class="sd">        :meth:`_orm.registry.generate_base`</span>
</span><span data-line="1694"><span class="sd">        for a given base class.</span>
</span><span data-line="1695">
</span><span data-line="1696"><span class="sd">        E.g.::</span>
</span><span data-line="1697">
</span><span data-line="1698"><span class="sd">            from sqlalchemy.orm import registry</span>
</span><span data-line="1699">
</span><span data-line="1700"><span class="sd">            mapper_registry = registry()</span>
</span><span data-line="1701">
</span><span data-line="1702"><span class="sd">            @mapper_registry.as_declarative_base()</span>
</span><span data-line="1703"><span class="sd">            class Base:</span>
</span><span data-line="1704"><span class="sd">                @declared_attr</span>
</span><span data-line="1705"><span class="sd">                def __tablename__(cls):</span>
</span><span data-line="1706"><span class="sd">                    return cls.__name__.lower()</span>
</span><span data-line="1707"><span class="sd">                id = Column(Integer, primary_key=True)</span>
</span><span data-line="1708">
</span><span data-line="1709"><span class="sd">            class MyMappedClass(Base):</span>
</span><span data-line="1710"><span class="sd">                # ...</span>
</span><span data-line="1711">
</span><span data-line="1712"><span class="sd">        All keyword arguments passed to</span>
</span><span data-line="1713"><span class="sd">        :meth:`_orm.registry.as_declarative_base` are passed</span>
</span><span data-line="1714"><span class="sd">        along to :meth:`_orm.registry.generate_base`.</span>
</span><span data-line="1715">
</span><span data-line="1716"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1717">
</span><span data-line="1718">        <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span data-line="1719">            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;cls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
</span><span data-line="1720">            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
</span><span data-line="1721">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_base</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span data-line="1722">
</span><span data-line="1723">        <span class="k">return</span> <span class="n">decorate</span>
</span><span data-line="1724">
</span><span data-line="1725">    <span class="k">def</span> <span class="nf">map_declaratively</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span data-line="1726"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Map a class declaratively.</span>
</span><span data-line="1727">
</span><span data-line="1728"><span class="sd">        In this form of mapping, the class is scanned for mapping information,</span>
</span><span data-line="1729"><span class="sd">        including for columns to be associated with a table, and/or an</span>
</span><span data-line="1730"><span class="sd">        actual table object.</span>
</span><span data-line="1731">
</span><span data-line="1732"><span class="sd">        Returns the :class:`_orm.Mapper` object.</span>
</span><span data-line="1733">
</span><span data-line="1734"><span class="sd">        E.g.::</span>
</span><span data-line="1735">
</span><span data-line="1736"><span class="sd">            from sqlalchemy.orm import registry</span>
</span><span data-line="1737">
</span><span data-line="1738"><span class="sd">            mapper_registry = registry()</span>
</span><span data-line="1739">
</span><span data-line="1740"><span class="sd">            class Foo:</span>
</span><span data-line="1741"><span class="sd">                __tablename__ = &#39;some_table&#39;</span>
</span><span data-line="1742">
</span><span data-line="1743"><span class="sd">                id = Column(Integer, primary_key=True)</span>
</span><span data-line="1744"><span class="sd">                name = Column(String)</span>
</span><span data-line="1745">
</span><span data-line="1746"><span class="sd">            mapper = mapper_registry.map_declaratively(Foo)</span>
</span><span data-line="1747">
</span><span data-line="1748"><span class="sd">        This function is more conveniently invoked indirectly via either the</span>
</span><span data-line="1749"><span class="sd">        :meth:`_orm.registry.mapped` class decorator or by subclassing a</span>
</span><span data-line="1750"><span class="sd">        declarative metaclass generated from</span>
</span><span data-line="1751"><span class="sd">        :meth:`_orm.registry.generate_base`.</span>
</span><span data-line="1752">
</span><span data-line="1753"><span class="sd">        See the section :ref:`orm_declarative_mapping` for complete</span>
</span><span data-line="1754"><span class="sd">        details and examples.</span>
</span><span data-line="1755">
</span><span data-line="1756"><span class="sd">        :param cls: class to be mapped.</span>
</span><span data-line="1757">
</span><span data-line="1758"><span class="sd">        :return: a :class:`_orm.Mapper` object.</span>
</span><span data-line="1759">
</span><span data-line="1760"><span class="sd">        .. seealso::</span>
</span><span data-line="1761">
</span><span data-line="1762"><span class="sd">            :ref:`orm_declarative_mapping`</span>
</span><span data-line="1763">
</span><span data-line="1764"><span class="sd">            :meth:`_orm.registry.mapped` - more common decorator interface</span>
</span><span data-line="1765"><span class="sd">            to this function.</span>
</span><span data-line="1766">
</span><span data-line="1767"><span class="sd">            :meth:`_orm.registry.map_imperatively`</span>
</span><span data-line="1768">
</span><span data-line="1769"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1770">        <span class="n">_as_declarative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span data-line="1771">        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__mapper__</span>  <span class="c1"># type: ignore</span>
</span><span data-line="1772">
</span><span data-line="1773">    <span class="k">def</span> <span class="nf">map_imperatively</span><span class="p">(</span>
</span><span data-line="1774">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1775">        <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="1776">        <span class="n">local_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="1777">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1778">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span data-line="1779"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Map a class imperatively.</span>
</span><span data-line="1780">
</span><span data-line="1781"><span class="sd">        In this form of mapping, the class is not scanned for any mapping</span>
</span><span data-line="1782"><span class="sd">        information.  Instead, all mapping constructs are passed as</span>
</span><span data-line="1783"><span class="sd">        arguments.</span>
</span><span data-line="1784">
</span><span data-line="1785"><span class="sd">        This method is intended to be fully equivalent to the now-removed</span>
</span><span data-line="1786"><span class="sd">        SQLAlchemy ``mapper()`` function, except that it&#39;s in terms of</span>
</span><span data-line="1787"><span class="sd">        a particular registry.</span>
</span><span data-line="1788">
</span><span data-line="1789"><span class="sd">        E.g.::</span>
</span><span data-line="1790">
</span><span data-line="1791"><span class="sd">            from sqlalchemy.orm import registry</span>
</span><span data-line="1792">
</span><span data-line="1793"><span class="sd">            mapper_registry = registry()</span>
</span><span data-line="1794">
</span><span data-line="1795"><span class="sd">            my_table = Table(</span>
</span><span data-line="1796"><span class="sd">                &quot;my_table&quot;,</span>
</span><span data-line="1797"><span class="sd">                mapper_registry.metadata,</span>
</span><span data-line="1798"><span class="sd">                Column(&#39;id&#39;, Integer, primary_key=True)</span>
</span><span data-line="1799"><span class="sd">            )</span>
</span><span data-line="1800">
</span><span data-line="1801"><span class="sd">            class MyClass:</span>
</span><span data-line="1802"><span class="sd">                pass</span>
</span><span data-line="1803">
</span><span data-line="1804"><span class="sd">            mapper_registry.map_imperatively(MyClass, my_table)</span>
</span><span data-line="1805">
</span><span data-line="1806"><span class="sd">        See the section :ref:`orm_imperative_mapping` for complete background</span>
</span><span data-line="1807"><span class="sd">        and usage examples.</span>
</span><span data-line="1808">
</span><span data-line="1809"><span class="sd">        :param class\_: The class to be mapped.  Corresponds to the</span>
</span><span data-line="1810"><span class="sd">         :paramref:`_orm.Mapper.class_` parameter.</span>
</span><span data-line="1811">
</span><span data-line="1812"><span class="sd">        :param local_table: the :class:`_schema.Table` or other</span>
</span><span data-line="1813"><span class="sd">         :class:`_sql.FromClause` object that is the subject of the mapping.</span>
</span><span data-line="1814"><span class="sd">         Corresponds to the</span>
</span><span data-line="1815"><span class="sd">         :paramref:`_orm.Mapper.local_table` parameter.</span>
</span><span data-line="1816">
</span><span data-line="1817"><span class="sd">        :param \**kw: all other keyword arguments are passed to the</span>
</span><span data-line="1818"><span class="sd">         :class:`_orm.Mapper` constructor directly.</span>
</span><span data-line="1819">
</span><span data-line="1820"><span class="sd">        .. seealso::</span>
</span><span data-line="1821">
</span><span data-line="1822"><span class="sd">            :ref:`orm_imperative_mapping`</span>
</span><span data-line="1823">
</span><span data-line="1824"><span class="sd">            :ref:`orm_declarative_mapping`</span>
</span><span data-line="1825">
</span><span data-line="1826"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1827">        <span class="k">return</span> <span class="n">_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">,</span> <span class="n">local_table</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
</span><span data-line="1828">
</span><span data-line="1829">
</span><span data-line="1830"><span class="n">RegistryType</span> <span class="o">=</span> <span class="n">registry</span>
</span><span data-line="1831">
</span><span data-line="1832"><span class="k">if</span> <span class="ow">not</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="1833">    <span class="c1"># allow for runtime type resolution of ``ClassVar[_RegistryType]``</span>
</span><span data-line="1834">    <span class="n">_RegistryType</span> <span class="o">=</span> <span class="n">registry</span>  <span class="c1"># noqa</span>
</span><span data-line="1835">
</span><span data-line="1836">
</span><span data-line="1837"><span class="k">def</span> <span class="nf">as_declarative</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span data-line="1838"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1839"><span class="sd">    Class decorator which will adapt a given class into a</span>
</span><span data-line="1840"><span class="sd">    :func:`_orm.declarative_base`.</span>
</span><span data-line="1841">
</span><span data-line="1842"><span class="sd">    This function makes use of the :meth:`_orm.registry.as_declarative_base`</span>
</span><span data-line="1843"><span class="sd">    method, by first creating a :class:`_orm.registry` automatically</span>
</span><span data-line="1844"><span class="sd">    and then invoking the decorator.</span>
</span><span data-line="1845">
</span><span data-line="1846"><span class="sd">    E.g.::</span>
</span><span data-line="1847">
</span><span data-line="1848"><span class="sd">        from sqlalchemy.orm import as_declarative</span>
</span><span data-line="1849">
</span><span data-line="1850"><span class="sd">        @as_declarative()</span>
</span><span data-line="1851"><span class="sd">        class Base:</span>
</span><span data-line="1852"><span class="sd">            @declared_attr</span>
</span><span data-line="1853"><span class="sd">            def __tablename__(cls):</span>
</span><span data-line="1854"><span class="sd">                return cls.__name__.lower()</span>
</span><span data-line="1855"><span class="sd">            id = Column(Integer, primary_key=True)</span>
</span><span data-line="1856">
</span><span data-line="1857"><span class="sd">        class MyMappedClass(Base):</span>
</span><span data-line="1858"><span class="sd">            # ...</span>
</span><span data-line="1859">
</span><span data-line="1860"><span class="sd">    .. seealso::</span>
</span><span data-line="1861">
</span><span data-line="1862"><span class="sd">        :meth:`_orm.registry.as_declarative_base`</span>
</span><span data-line="1863">
</span><span data-line="1864"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="1865">    <span class="n">metadata</span><span class="p">,</span> <span class="n">class_registry</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1866">        <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span><span data-line="1867">        <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;class_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span><span data-line="1868">    <span class="p">)</span>
</span><span data-line="1869">
</span><span data-line="1870">    <span class="k">return</span> <span class="n">registry</span><span class="p">(</span>
</span><span data-line="1871">        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">class_registry</span><span class="o">=</span><span class="n">class_registry</span>
</span><span data-line="1872">    <span class="p">)</span><span class="o">.</span><span class="n">as_declarative_base</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span data-line="1873">
</span><span data-line="1874">
</span><span data-line="1875"><span class="nd">@inspection</span><span class="o">.</span><span class="n">_inspects</span><span class="p">(</span>
</span><span data-line="1876">    <span class="n">DeclarativeMeta</span><span class="p">,</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">DeclarativeAttributeIntercept</span>
</span><span data-line="1877"><span class="p">)</span>
</span><span data-line="1878"><span class="k">def</span> <span class="nf">_inspect_decl_meta</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="1879">    <span class="n">mp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_inspect_mapped_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="1880">    <span class="k">if</span> <span class="n">mp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1881">        <span class="k">if</span> <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">has_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span data-line="1882">            <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">raise_unmapped_for_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="1883">    <span class="k">return</span> <span class="n">mp</span>
</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2024, Litestar Organization</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials">
<a href="https://github.com/litestar-org/advanced-alchemy" aria-label="GitHub">
  <iconify-icon icon="simple-icons:github"></iconify-icon>
</a>
<a href="https://twitter.com/LitestarAPI" aria-label="X (Twitter)">
  <iconify-icon icon="prime:twitter"></iconify-icon>
</a>
<a href="https://discord.gg/litestar" aria-label="Discord">
  <iconify-icon icon="simple-icons:discord"></iconify-icon>
</a>
<a href="https://www.reddit.com/r/LitestarAPI" aria-label="Reddit">
  <iconify-icon icon="simple-icons:reddit"></iconify-icon>
</a></div>
    </div>
  </div>
</footer>
      <script src="../../../_static/documentation_options.js?v=c6cf4326"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../_static/litestar-theme.js?v=ab2dcc9e"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../../../_static/shibuya.js?v=e2e99575"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../../../_static/versioning.js"></script></body>
</html>