<!DOCTYPE html>
<html lang="en" data-accent-color="amber" data-content_root="../../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>sqlalchemy.orm.decl_base - Advanced Alchemy</title><link rel="shortcut icon" href="../../../_static/favicon.svg"/><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/shibuya.css?v=83eaa723" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_paramlinks.css" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../../../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/litestar-sphinx-theme.css?v=e9f54662" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sqlalchemy.orm.decl_base"/>
<meta name="twitter:card" content="summary"/>
<meta property="og:image" content="_static/logo-light.png"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="/">
      <img class="light-logo" src="../../../_static/logo-light.png" alt="advanced_alchemy" height="28" loading="lazy" />
      <img class="dark-logo" src="../../../_static/logo-dark.png" alt="advanced_alchemy" height="28" loading="lazy" />
      <strong>advanced_alchemy</strong>
    </a>
    <div class="sy-head-nav" id="HeadNav">
      <nav class="sy-head-links"><ul><li class="link"><a href="../../../index.html">Home</a></li>
      <li class="link"><button type="button">
            <span>Community</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="../../../contribution-guide.html">
                <span>Contributing</span>
                <small>Learn how to contribute to the Advanced Alchemy project</small>
              </a></li><li><a href="https://github.com/litestar-org/.github?tab=coc-ov-file">
                <span>Code of Conduct</span>
                <small>Review the etiquette for interacting with the Advanced Alchemy community</small>
              </a></li><li><a href="https://github.com/litestar-org/.github?tab=coc-ov-file#security-ov-file">
                <span>Security</span>
                <small>Overview of Advanced Alchemy's security protocols</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>About</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://litestar.dev/about/organization">
                <span>Litestar Organization</span>
                <small>Details about the Litestar organization</small>
              </a></li><li><a href="../../../releases.html">
                <span>Releases</span>
                <small>Explore the release process, versioning, and deprecation policy for Advanced Alchemy</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>Release notes</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="../../../changelog.html">
                <span>Changelog</span>
                <small>All changes for Advanced Alchemy</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>Help</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://discord.gg/litestar">
                <span>Discord Help Forum</span>
                <small>Dedicated Discord help forum</small>
              </a></li><li><a href="https://github.com/litestar-org/advanced-alchemy/discussions">
                <span>GitHub Discussions</span>
                <small>GitHub Discussions</small>
              </a></li><li><a href="https://stackoverflow.com/questions/tagged/litestar">
                <span>Stack Overflow</span>
                <small>We monitor the <code><b>litestar</b></code> tag on Stack Overflow</small>
              </a></li></ul>
      </li><li class="link">
          <a href="https://github.com/sponsors/Litestar-Org">
            <span>Sponsor</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials">
  <a href="https://github.com/litestar-org/advanced-alchemy" aria-label="GitHub">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </a>
<a href="https://twitter.com/LitestarAPI" aria-label="X (Twitter)">
  <iconify-icon icon="prime:twitter"></iconify-icon>
</a>
  <a href="https://discord.gg/litestar" aria-label="Discord">
    <iconify-icon icon="simple-icons:discord"></iconify-icon>
  </a></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="HeadNav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6"><div class="sidebar-links">
  <ul>
    <li><a class="icon-link" href="https://github.com/orgs/litestar-org/discussions">
  <span class="icon">
    <svg viewBox="0 0 24 24" fill="none">
      <path fill="var(--accent-9)" fill-rule="evenodd" clip-rule="evenodd" d="M11 5a6 6 0 0 0-4.687 9.746c.215.27.315.62.231.954l-.514 2.058a1 1 0 0 0 1.485 1.1l2.848-1.71c.174-.104.374-.15.576-.148H13a6 6 0 0 0 0-12h-2Z"/>
      <circle fill="white" cx="12" cy="11" r="1"/>
      <circle fill="white" cx="9" cy="11" r="1"/>
      <circle fill="white" cx="15" cy="11" r="1"/>
    </svg>
  </span>
  <span class="text">Discussion</span>
</a></li>
  </ul>
</div>
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/index.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/modeling.html">Modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/repositories.html">Repositories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/services.html">Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/utilities.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/frameworks/litestar.html">Litestar Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/frameworks/fastapi.html">FastAPI Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/base.html">base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/mixins/index.html">mixins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/mixins/unique.html">unique</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/config/index.html">config</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/asyncio.html">asyncio</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/common.html">common</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/engine.html">engine</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/sync.html">sync</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/types.html">types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/operations.html">operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/types.html">types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/exceptions.html">exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/utils.html">utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/repository.html">repositories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/filters.html">filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/service.html">services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/extensions/index.html">extensions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/litestar/index.html">litestar</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/alembic.html">alembic</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/dto.html">dto</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/plugins.html">plugin</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/sanic.html">sanic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/starlette.html">starlette</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/alembic/index.html">alembic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/alembic/commands.html">commands</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribution-guide.html">Contribution guide</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/search?q=user%3Alitestar-org+state%3Aopen+label%3A%22good+first+issue%22+++no%3Aassignee+repo%3A%22advanced-alchemy%22&amp;type=issues">Available Issues</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/litestar-org/.github?tab=coc-ov-file#readme">Code of Conduct</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/litestar-org/advanced-alchemy"
  data-type="github" data-user="litestar-org" data-repo="advanced-alchemy">
  <span class="w-8 flex items-center justify-around shrink-0 text-3xl">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </span>
  <span class="flex-grow px-2 break-all">
    <span>litestar-org/advanced-alchemy</span>
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <iconify-icon icon="lucide:star"></iconify-icon>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <iconify-icon icon="lucide:git-fork"></iconify-icon>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6"><div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../../index.html"><span itemprop="name">advanced_alchemy</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">sqlalchemy.orm.decl_base</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sqlalchemy.orm.decl_base</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="c1"># orm/decl_base.py</span>
</span><span data-line="2"><span class="c1"># Copyright (C) 2005-2024 the SQLAlchemy authors and contributors</span>
</span><span data-line="3"><span class="c1"># &lt;see AUTHORS file&gt;</span>
</span><span data-line="4"><span class="c1">#</span>
</span><span data-line="5"><span class="c1"># This module is part of SQLAlchemy and is released under</span>
</span><span data-line="6"><span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
</span><span data-line="7">
</span><span data-line="8"><span class="sd">&quot;&quot;&quot;Internal implementation for declarative.&quot;&quot;&quot;</span>
</span><span data-line="9">
</span><span data-line="10"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span><span data-line="11">
</span><span data-line="12"><span class="kn">import</span> <span class="nn">collections</span>
</span><span data-line="13"><span class="kn">import</span> <span class="nn">dataclasses</span>
</span><span data-line="14"><span class="kn">import</span> <span class="nn">re</span>
</span><span data-line="15"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span><span data-line="16"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
</span><span data-line="17"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>
</span><span data-line="18"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</span><span data-line="19"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
</span><span data-line="20"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</span><span data-line="21"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span>
</span><span data-line="22"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>
</span><span data-line="23"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NoReturn</span>
</span><span data-line="24"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span><span data-line="25"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
</span><span data-line="26"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
</span><span data-line="27"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
</span><span data-line="28"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span data-line="29"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>
</span><span data-line="30"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
</span><span data-line="31"><span class="kn">import</span> <span class="nn">weakref</span>
</span><span data-line="32">
</span><span data-line="33"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">attributes</span>
</span><span data-line="34"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">clsregistry</span>
</span><span data-line="35"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">orm_exc</span>
</span><span data-line="36"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">instrumentation</span>
</span><span data-line="37"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">mapperlib</span>
</span><span data-line="38"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_O</span>
</span><span data-line="39"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">attr_is_internal_proxy</span>
</span><span data-line="40"><span class="kn">from</span> <span class="nn">.attributes</span> <span class="kn">import</span> <span class="n">InstrumentedAttribute</span>
</span><span data-line="41"><span class="kn">from</span> <span class="nn">.attributes</span> <span class="kn">import</span> <span class="n">QueryableAttribute</span>
</span><span data-line="42"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_is_mapped_class</span>
</span><span data-line="43"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">InspectionAttr</span>
</span><span data-line="44"><span class="kn">from</span> <span class="nn">.descriptor_props</span> <span class="kn">import</span> <span class="n">CompositeProperty</span>
</span><span data-line="45"><span class="kn">from</span> <span class="nn">.descriptor_props</span> <span class="kn">import</span> <span class="n">SynonymProperty</span>
</span><span data-line="46"><span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_AttributeOptions</span>
</span><span data-line="47"><span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_DCAttributeOptions</span>
</span><span data-line="48"><span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_IntrospectsAnnotations</span>
</span><span data-line="49"><span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_MappedAttribute</span>
</span><span data-line="50"><span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_MapsColumns</span>
</span><span data-line="51"><span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">MapperProperty</span>
</span><span data-line="52"><span class="kn">from</span> <span class="nn">.mapper</span> <span class="kn">import</span> <span class="n">Mapper</span>
</span><span data-line="53"><span class="kn">from</span> <span class="nn">.properties</span> <span class="kn">import</span> <span class="n">ColumnProperty</span>
</span><span data-line="54"><span class="kn">from</span> <span class="nn">.properties</span> <span class="kn">import</span> <span class="n">MappedColumn</span>
</span><span data-line="55"><span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">_extract_mapped_subtype</span>
</span><span data-line="56"><span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">_is_mapped_annotation</span>
</span><span data-line="57"><span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">class_mapper</span>
</span><span data-line="58"><span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">de_stringify_annotation</span>
</span><span data-line="59"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">event</span>
</span><span data-line="60"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">exc</span>
</span><span data-line="61"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">util</span>
</span><span data-line="62"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">expression</span>
</span><span data-line="63"><span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">_NoArg</span>
</span><span data-line="64"><span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">Column</span>
</span><span data-line="65"><span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">Table</span>
</span><span data-line="66"><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">topological</span>
</span><span data-line="67"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">_AnnotationScanType</span>
</span><span data-line="68"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_fwd_ref</span>
</span><span data-line="69"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_literal</span>
</span><span data-line="70"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">Protocol</span>
</span><span data-line="71"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">TypedDict</span>
</span><span data-line="72"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">typing_get_args</span>
</span><span data-line="73">
</span><span data-line="74"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="75">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_ClassDict</span>
</span><span data-line="76">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_RegistryType</span>
</span><span data-line="77">    <span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">Mapped</span>
</span><span data-line="78">    <span class="kn">from</span> <span class="nn">.decl_api</span> <span class="kn">import</span> <span class="n">declared_attr</span>
</span><span data-line="79">    <span class="kn">from</span> <span class="nn">.instrumentation</span> <span class="kn">import</span> <span class="n">ClassManager</span>
</span><span data-line="80">    <span class="kn">from</span> <span class="nn">..sql.elements</span> <span class="kn">import</span> <span class="n">NamedColumn</span>
</span><span data-line="81">    <span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">MetaData</span>
</span><span data-line="82">    <span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">FromClause</span>
</span><span data-line="83">
</span><span data-line="84"><span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span data-line="85">
</span><span data-line="86"><span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="87"><span class="n">_TableArgsType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
</span><span data-line="88">
</span><span data-line="89">
</span><span data-line="90"><span class="k">class</span> <span class="nc">MappedClassProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">[</span><span class="n">_O</span><span class="p">]):</span>
</span><span data-line="91"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A protocol representing a SQLAlchemy mapped class.</span>
</span><span data-line="92">
</span><span data-line="93"><span class="sd">    The protocol is generic on the type of class, use</span>
</span><span data-line="94"><span class="sd">    ``MappedClassProtocol[Any]`` to allow any mapped class.</span>
</span><span data-line="95"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="96">
</span><span data-line="97">    <span class="vm">__name__</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="98">    <span class="n">__mapper__</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
</span><span data-line="99">    <span class="n">__table__</span><span class="p">:</span> <span class="n">FromClause</span>
</span><span data-line="100">
</span><span data-line="101">    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_O</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="102">
</span><span data-line="103">
</span><span data-line="104"><span class="k">class</span> <span class="nc">_DeclMappedClassProtocol</span><span class="p">(</span><span class="n">MappedClassProtocol</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">Protocol</span><span class="p">):</span>
</span><span data-line="105">    <span class="s2">&quot;Internal more detailed version of ``MappedClassProtocol``.&quot;</span>
</span><span data-line="106">    <span class="n">metadata</span><span class="p">:</span> <span class="n">MetaData</span>
</span><span data-line="107">    <span class="n">__tablename__</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="108">    <span class="n">__mapper_args__</span><span class="p">:</span> <span class="n">_MapperKwArgs</span>
</span><span data-line="109">    <span class="n">__table_args__</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_TableArgsType</span><span class="p">]</span>
</span><span data-line="110">
</span><span data-line="111">    <span class="n">_sa_apply_dc_transforms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_DataclassArguments</span><span class="p">]</span>
</span><span data-line="112">
</span><span data-line="113">    <span class="k">def</span> <span class="nf">__declare_first__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="114">
</span><span data-line="115">    <span class="k">def</span> <span class="nf">__declare_last__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span data-line="116">
</span><span data-line="117">
</span><span data-line="118"><span class="k">class</span> <span class="nc">_DataclassArguments</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span><span data-line="119">    <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span data-line="120">    <span class="nb">repr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span data-line="121">    <span class="n">eq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span data-line="122">    <span class="n">order</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span data-line="123">    <span class="n">unsafe_hash</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span data-line="124">    <span class="n">match_args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span data-line="125">    <span class="n">kw_only</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span data-line="126">    <span class="n">dataclass_callable</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
</span><span data-line="127">
</span><span data-line="128">
</span><span data-line="129"><span class="k">def</span> <span class="nf">_declared_mapping_info</span><span class="p">(</span>
</span><span data-line="130">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="131"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">_DeferredMapperConfig</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
</span><span data-line="132">    <span class="c1"># deferred mapping</span>
</span><span data-line="133">    <span class="k">if</span> <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">has_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span data-line="134">        <span class="k">return</span> <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">config_for_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="135">    <span class="c1"># regular mapping</span>
</span><span data-line="136">    <span class="k">elif</span> <span class="n">_is_mapped_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span data-line="137">        <span class="k">return</span> <span class="n">class_mapper</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">configure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="138">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="139">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="140">
</span><span data-line="141">
</span><span data-line="142"><span class="k">def</span> <span class="nf">_is_supercls_for_inherits</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="143"><span class="w">    </span><span class="sd">&quot;&quot;&quot;return True if this class will be used as a superclass to set in</span>
</span><span data-line="144"><span class="sd">    &#39;inherits&#39;.</span>
</span><span data-line="145">
</span><span data-line="146"><span class="sd">    This includes deferred mapper configs that aren&#39;t mapped yet, however does</span>
</span><span data-line="147"><span class="sd">    not include classes with _sa_decl_prepare_nocascade (e.g.</span>
</span><span data-line="148"><span class="sd">    ``AbstractConcreteBase``); these concrete-only classes are not set up as</span>
</span><span data-line="149"><span class="sd">    &quot;inherits&quot; until after mappers are configured using</span>
</span><span data-line="150"><span class="sd">    mapper._set_concrete_base()</span>
</span><span data-line="151">
</span><span data-line="152"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="153">    <span class="k">if</span> <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">has_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span data-line="154">        <span class="k">return</span> <span class="ow">not</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
</span><span data-line="155">            <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_sa_decl_prepare_nocascade&quot;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="156">        <span class="p">)</span>
</span><span data-line="157">    <span class="c1"># regular mapping</span>
</span><span data-line="158">    <span class="k">elif</span> <span class="n">_is_mapped_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span data-line="159">        <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="160">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="161">        <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="162">
</span><span data-line="163">
</span><span data-line="164"><span class="k">def</span> <span class="nf">_resolve_for_abstract_or_classical</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span data-line="165">    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="nb">object</span><span class="p">:</span>
</span><span data-line="166">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="167">
</span><span data-line="168">    <span class="n">sup</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="169">
</span><span data-line="170">    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__abstract__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span data-line="171">        <span class="k">for</span> <span class="n">base_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
</span><span data-line="172">            <span class="n">sup</span> <span class="o">=</span> <span class="n">_resolve_for_abstract_or_classical</span><span class="p">(</span><span class="n">base_</span><span class="p">)</span>
</span><span data-line="173">            <span class="k">if</span> <span class="n">sup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="174">                <span class="k">return</span> <span class="n">sup</span>
</span><span data-line="175">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="176">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="177">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="178">        <span class="n">clsmanager</span> <span class="o">=</span> <span class="n">_dive_for_cls_manager</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="179">
</span><span data-line="180">        <span class="k">if</span> <span class="n">clsmanager</span><span class="p">:</span>
</span><span data-line="181">            <span class="k">return</span> <span class="n">clsmanager</span><span class="o">.</span><span class="n">class_</span>
</span><span data-line="182">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="183">            <span class="k">return</span> <span class="bp">cls</span>
</span><span data-line="184">
</span><span data-line="185">
</span><span data-line="186"><span class="k">def</span> <span class="nf">_get_immediate_cls_attr</span><span class="p">(</span>
</span><span data-line="187">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">attrname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="188"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="189"><span class="w">    </span><span class="sd">&quot;&quot;&quot;return an attribute of the class that is either present directly</span>
</span><span data-line="190"><span class="sd">    on the class, e.g. not on a superclass, or is from a superclass but</span>
</span><span data-line="191"><span class="sd">    this superclass is a non-mapped mixin, that is, not a descendant of</span>
</span><span data-line="192"><span class="sd">    the declarative base and is also not classically mapped.</span>
</span><span data-line="193">
</span><span data-line="194"><span class="sd">    This is used to detect attributes that indicate something about</span>
</span><span data-line="195"><span class="sd">    a mapped class independently from any mapped classes that it may</span>
</span><span data-line="196"><span class="sd">    inherit from.</span>
</span><span data-line="197">
</span><span data-line="198"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="199">
</span><span data-line="200">    <span class="c1"># the rules are different for this name than others,</span>
</span><span data-line="201">    <span class="c1"># make sure we&#39;ve moved it out.  transitional</span>
</span><span data-line="202">    <span class="k">assert</span> <span class="n">attrname</span> <span class="o">!=</span> <span class="s2">&quot;__abstract__&quot;</span>
</span><span data-line="203">
</span><span data-line="204">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
</span><span data-line="205">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="206">
</span><span data-line="207">    <span class="k">if</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span data-line="208">        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
</span><span data-line="209">
</span><span data-line="210">    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span data-line="211">        <span class="n">_is_classical_inherits</span> <span class="o">=</span> <span class="n">_dive_for_cls_manager</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="212">
</span><span data-line="213">        <span class="k">if</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="214">            <span class="n">base</span> <span class="ow">is</span> <span class="bp">cls</span>
</span><span data-line="215">            <span class="ow">or</span> <span class="p">(</span>
</span><span data-line="216">                <span class="p">(</span><span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span> <span class="k">if</span> <span class="n">strict</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="217">                <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_classical_inherits</span>
</span><span data-line="218">            <span class="p">)</span>
</span><span data-line="219">        <span class="p">):</span>
</span><span data-line="220">            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
</span><span data-line="221">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="222">        <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="223">
</span><span data-line="224">
</span><span data-line="225"><span class="k">def</span> <span class="nf">_dive_for_cls_manager</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ClassManager</span><span class="p">[</span><span class="n">_O</span><span class="p">]]:</span>
</span><span data-line="226">    <span class="c1"># because the class manager registration is pluggable,</span>
</span><span data-line="227">    <span class="c1"># we need to do the search for every class in the hierarchy,</span>
</span><span data-line="228">    <span class="c1"># rather than just a simple &quot;cls._sa_class_manager&quot;</span>
</span><span data-line="229">
</span><span data-line="230">    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
</span><span data-line="231">        <span class="n">manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ClassManager</span><span class="p">[</span><span class="n">_O</span><span class="p">]]</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">opt_manager_of_class</span><span class="p">(</span>
</span><span data-line="232">            <span class="n">base</span>
</span><span data-line="233">        <span class="p">)</span>
</span><span data-line="234">        <span class="k">if</span> <span class="n">manager</span><span class="p">:</span>
</span><span data-line="235">            <span class="k">return</span> <span class="n">manager</span>
</span><span data-line="236">    <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="237">
</span><span data-line="238">
</span><span data-line="239"><span class="k">def</span> <span class="nf">_as_declarative</span><span class="p">(</span>
</span><span data-line="240">    <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_ClassDict</span>
</span><span data-line="241"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_MapperConfig</span><span class="p">]:</span>
</span><span data-line="242">    <span class="c1"># declarative scans the class for attributes.  no table or mapper</span>
</span><span data-line="243">    <span class="c1"># args passed separately.</span>
</span><span data-line="244">    <span class="k">return</span> <span class="n">_MapperConfig</span><span class="o">.</span><span class="n">setup_mapping</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{})</span>
</span><span data-line="245">
</span><span data-line="246">
</span><span data-line="247"><span class="k">def</span> <span class="nf">_mapper</span><span class="p">(</span>
</span><span data-line="248">    <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
</span><span data-line="249">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="250">    <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
</span><span data-line="251">    <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
</span><span data-line="252"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span data-line="253">    <span class="n">_ImperativeMapperConfig</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">)</span>
</span><span data-line="254">    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;MappedClassProtocol[_O]&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__mapper__</span>
</span><span data-line="255">
</span><span data-line="256">
</span><span data-line="257"><span class="nd">@util</span><span class="o">.</span><span class="n">preload_module</span><span class="p">(</span><span class="s2">&quot;sqlalchemy.orm.decl_api&quot;</span><span class="p">)</span>
</span><span data-line="258"><span class="k">def</span> <span class="nf">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="259">    <span class="n">_declared_attr_common</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">preloaded</span><span class="o">.</span><span class="n">orm_decl_api</span><span class="o">.</span><span class="n">_declared_attr_common</span>
</span><span data-line="260">
</span><span data-line="261">    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">_declared_attr_common</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">classproperty</span><span class="p">))</span>
</span><span data-line="262">
</span><span data-line="263">
</span><span data-line="264"><span class="k">def</span> <span class="nf">_check_declared_props_nocascade</span><span class="p">(</span>
</span><span data-line="265">    <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
</span><span data-line="266"><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="267">    <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span data-line="268">        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;_cascading&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span data-line="269">            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="270">                <span class="s2">&quot;@declared_attr.cascading is not supported on the </span><span class="si">%s</span><span class="s2"> &quot;</span>
</span><span data-line="271">                <span class="s2">&quot;attribute on class </span><span class="si">%s</span><span class="s2">.  This attribute invokes for &quot;</span>
</span><span data-line="272">                <span class="s2">&quot;subclasses in any case.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span data-line="273">            <span class="p">)</span>
</span><span data-line="274">        <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="275">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="276">        <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="277">
</span><span data-line="278">
</span><span data-line="279"><span class="k">class</span> <span class="nc">_MapperConfig</span><span class="p">:</span>
</span><span data-line="280">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="281">        <span class="s2">&quot;cls&quot;</span><span class="p">,</span>
</span><span data-line="282">        <span class="s2">&quot;classname&quot;</span><span class="p">,</span>
</span><span data-line="283">        <span class="s2">&quot;properties&quot;</span><span class="p">,</span>
</span><span data-line="284">        <span class="s2">&quot;declared_attr_reg&quot;</span><span class="p">,</span>
</span><span data-line="285">        <span class="s2">&quot;__weakref__&quot;</span><span class="p">,</span>
</span><span data-line="286">    <span class="p">)</span>
</span><span data-line="287">
</span><span data-line="288">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="289">    <span class="n">classname</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="290">    <span class="n">properties</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">[</span>
</span><span data-line="291">        <span class="nb">str</span><span class="p">,</span>
</span><span data-line="292">        <span class="n">Union</span><span class="p">[</span>
</span><span data-line="293">            <span class="n">Sequence</span><span class="p">[</span><span class="n">NamedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">NamedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">MapperProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="294">        <span class="p">],</span>
</span><span data-line="295">    <span class="p">]</span>
</span><span data-line="296">    <span class="n">declared_attr_reg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">declared_attr</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="297">
</span><span data-line="298">    <span class="nd">@classmethod</span>
</span><span data-line="299">    <span class="k">def</span> <span class="nf">setup_mapping</span><span class="p">(</span>
</span><span data-line="300">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="301">        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
</span><span data-line="302">        <span class="n">cls_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="303">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_ClassDict</span><span class="p">,</span>
</span><span data-line="304">        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
</span><span data-line="305">        <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
</span><span data-line="306">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_MapperConfig</span><span class="p">]:</span>
</span><span data-line="307">        <span class="n">manager</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">opt_manager_of_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="308">        <span class="k">if</span> <span class="n">manager</span> <span class="ow">and</span> <span class="n">manager</span><span class="o">.</span><span class="n">class_</span> <span class="ow">is</span> <span class="n">cls_</span><span class="p">:</span>
</span><span data-line="309">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="310">                <span class="sa">f</span><span class="s2">&quot;Class </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> already has been instrumented declaratively&quot;</span>
</span><span data-line="311">            <span class="p">)</span>
</span><span data-line="312">
</span><span data-line="313">        <span class="k">if</span> <span class="n">cls_</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__abstract__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span data-line="314">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="315">
</span><span data-line="316">        <span class="n">defer_map</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
</span><span data-line="317">            <span class="n">cls_</span><span class="p">,</span> <span class="s2">&quot;_sa_decl_prepare_nocascade&quot;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="318">        <span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="s2">&quot;_sa_decl_prepare&quot;</span><span class="p">)</span>
</span><span data-line="319">
</span><span data-line="320">        <span class="k">if</span> <span class="n">defer_map</span><span class="p">:</span>
</span><span data-line="321">            <span class="k">return</span> <span class="n">_DeferredMapperConfig</span><span class="p">(</span>
</span><span data-line="322">                <span class="n">registry</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">mapper_kw</span>
</span><span data-line="323">            <span class="p">)</span>
</span><span data-line="324">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="325">            <span class="k">return</span> <span class="n">_ClassScanMapperConfig</span><span class="p">(</span>
</span><span data-line="326">                <span class="n">registry</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">mapper_kw</span>
</span><span data-line="327">            <span class="p">)</span>
</span><span data-line="328">
</span><span data-line="329">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="330">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="331">        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
</span><span data-line="332">        <span class="n">cls_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="333">        <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
</span><span data-line="334">    <span class="p">):</span>
</span><span data-line="335">        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">assert_arg_type</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="s2">&quot;cls_&quot;</span><span class="p">)</span>
</span><span data-line="336">        <span class="bp">self</span><span class="o">.</span><span class="n">classname</span> <span class="o">=</span> <span class="n">cls_</span><span class="o">.</span><span class="vm">__name__</span>
</span><span data-line="337">        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
</span><span data-line="338">        <span class="bp">self</span><span class="o">.</span><span class="n">declared_attr_reg</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="339">
</span><span data-line="340">        <span class="k">if</span> <span class="ow">not</span> <span class="n">mapper_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;non_primary&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span data-line="341">            <span class="n">instrumentation</span><span class="o">.</span><span class="n">register_class</span><span class="p">(</span>
</span><span data-line="342">                <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span>
</span><span data-line="343">                <span class="n">finalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="344">                <span class="n">registry</span><span class="o">=</span><span class="n">registry</span><span class="p">,</span>
</span><span data-line="345">                <span class="n">declarative_scan</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span data-line="346">                <span class="n">init_method</span><span class="o">=</span><span class="n">registry</span><span class="o">.</span><span class="n">constructor</span><span class="p">,</span>
</span><span data-line="347">            <span class="p">)</span>
</span><span data-line="348">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="349">            <span class="n">manager</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">opt_manager_of_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
</span><span data-line="350">            <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
</span><span data-line="351">                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="352">                    <span class="s2">&quot;Class </span><span class="si">%s</span><span class="s2"> has no primary mapper configured.  Configure &quot;</span>
</span><span data-line="353">                    <span class="s2">&quot;a primary mapper first before setting up a non primary &quot;</span>
</span><span data-line="354">                    <span class="s2">&quot;Mapper.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span data-line="355">                <span class="p">)</span>
</span><span data-line="356">
</span><span data-line="357">    <span class="k">def</span> <span class="nf">set_cls_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span data-line="358">        <span class="n">manager</span> <span class="o">=</span> <span class="n">instrumentation</span><span class="o">.</span><span class="n">manager_of_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
</span><span data-line="359">        <span class="n">manager</span><span class="o">.</span><span class="n">install_member</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="360">        <span class="k">return</span> <span class="n">value</span>
</span><span data-line="361">
</span><span data-line="362">    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="363">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span data-line="364">
</span><span data-line="365">    <span class="k">def</span> <span class="nf">_early_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="366">        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span data-line="367">
</span><span data-line="368">
</span><span data-line="369"><span class="k">class</span> <span class="nc">_ImperativeMapperConfig</span><span class="p">(</span><span class="n">_MapperConfig</span><span class="p">):</span>
</span><span data-line="370">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;local_table&quot;</span><span class="p">,</span> <span class="s2">&quot;inherits&quot;</span><span class="p">)</span>
</span><span data-line="371">
</span><span data-line="372">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="373">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="374">        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
</span><span data-line="375">        <span class="n">cls_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="376">        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
</span><span data-line="377">        <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
</span><span data-line="378">    <span class="p">):</span>
</span><span data-line="379">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">)</span>
</span><span data-line="380">
</span><span data-line="381">        <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span><span class="s2">&quot;__table__&quot;</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
</span><span data-line="382">
</span><span data-line="383">        <span class="k">with</span> <span class="n">mapperlib</span><span class="o">.</span><span class="n">_CONFIGURE_MUTEX</span><span class="p">:</span>
</span><span data-line="384">            <span class="k">if</span> <span class="ow">not</span> <span class="n">mapper_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;non_primary&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span data-line="385">                <span class="n">clsregistry</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span>
</span><span data-line="386">                    <span class="bp">self</span><span class="o">.</span><span class="n">classname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">registry</span><span class="o">.</span><span class="n">_class_registry</span>
</span><span data-line="387">                <span class="p">)</span>
</span><span data-line="388">
</span><span data-line="389">            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_inheritance</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span data-line="390">
</span><span data-line="391">            <span class="bp">self</span><span class="o">.</span><span class="n">_early_mapping</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span data-line="392">
</span><span data-line="393">    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="394">        <span class="n">mapper_cls</span> <span class="o">=</span> <span class="n">Mapper</span>
</span><span data-line="395">
</span><span data-line="396">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span>
</span><span data-line="397">            <span class="s2">&quot;__mapper__&quot;</span><span class="p">,</span>
</span><span data-line="398">            <span class="n">mapper_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span> <span class="o">**</span><span class="n">mapper_kw</span><span class="p">),</span>
</span><span data-line="399">        <span class="p">)</span>
</span><span data-line="400">
</span><span data-line="401">    <span class="k">def</span> <span class="nf">_setup_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="402">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span data-line="403">
</span><span data-line="404">        <span class="n">inherits</span> <span class="o">=</span> <span class="n">mapper_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inherits&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="405">
</span><span data-line="406">        <span class="k">if</span> <span class="n">inherits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="407">            <span class="c1"># since we search for classical mappings now, search for</span>
</span><span data-line="408">            <span class="c1"># multiple mapped bases as well and raise an error.</span>
</span><span data-line="409">            <span class="n">inherits_search</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="410">            <span class="k">for</span> <span class="n">base_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
</span><span data-line="411">                <span class="n">c</span> <span class="o">=</span> <span class="n">_resolve_for_abstract_or_classical</span><span class="p">(</span><span class="n">base_</span><span class="p">)</span>
</span><span data-line="412">                <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="413">                    <span class="k">continue</span>
</span><span data-line="414">
</span><span data-line="415">                <span class="k">if</span> <span class="n">_is_supercls_for_inherits</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inherits_search</span><span class="p">:</span>
</span><span data-line="416">                    <span class="n">inherits_search</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="417">
</span><span data-line="418">            <span class="k">if</span> <span class="n">inherits_search</span><span class="p">:</span>
</span><span data-line="419">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inherits_search</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="420">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="421">                        <span class="s2">&quot;Class </span><span class="si">%s</span><span class="s2"> has multiple mapped bases: </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span data-line="422">                        <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inherits_search</span><span class="p">)</span>
</span><span data-line="423">                    <span class="p">)</span>
</span><span data-line="424">                <span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits_search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="425">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherits</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">):</span>
</span><span data-line="426">            <span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span><span class="o">.</span><span class="n">class_</span>
</span><span data-line="427">
</span><span data-line="428">        <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span>
</span><span data-line="429">
</span><span data-line="430">
</span><span data-line="431"><span class="k">class</span> <span class="nc">_CollectedAnnotation</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
</span><span data-line="432">    <span class="n">raw_annotation</span><span class="p">:</span> <span class="n">_AnnotationScanType</span>
</span><span data-line="433">    <span class="n">mapped_container</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Mapped</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
</span><span data-line="434">    <span class="n">extracted_mapped_annotation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_AnnotationScanType</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
</span><span data-line="435">    <span class="n">is_dataclass</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="436">    <span class="n">attr_value</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="437">    <span class="n">originating_module</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="438">    <span class="n">originating_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="439">
</span><span data-line="440">
</span><span data-line="441"><span class="k">class</span> <span class="nc">_ClassScanMapperConfig</span><span class="p">(</span><span class="n">_MapperConfig</span><span class="p">):</span>
</span><span data-line="442">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="443">        <span class="s2">&quot;registry&quot;</span><span class="p">,</span>
</span><span data-line="444">        <span class="s2">&quot;clsdict_view&quot;</span><span class="p">,</span>
</span><span data-line="445">        <span class="s2">&quot;collected_attributes&quot;</span><span class="p">,</span>
</span><span data-line="446">        <span class="s2">&quot;collected_annotations&quot;</span><span class="p">,</span>
</span><span data-line="447">        <span class="s2">&quot;local_table&quot;</span><span class="p">,</span>
</span><span data-line="448">        <span class="s2">&quot;persist_selectable&quot;</span><span class="p">,</span>
</span><span data-line="449">        <span class="s2">&quot;declared_columns&quot;</span><span class="p">,</span>
</span><span data-line="450">        <span class="s2">&quot;column_ordering&quot;</span><span class="p">,</span>
</span><span data-line="451">        <span class="s2">&quot;column_copies&quot;</span><span class="p">,</span>
</span><span data-line="452">        <span class="s2">&quot;table_args&quot;</span><span class="p">,</span>
</span><span data-line="453">        <span class="s2">&quot;tablename&quot;</span><span class="p">,</span>
</span><span data-line="454">        <span class="s2">&quot;mapper_args&quot;</span><span class="p">,</span>
</span><span data-line="455">        <span class="s2">&quot;mapper_args_fn&quot;</span><span class="p">,</span>
</span><span data-line="456">        <span class="s2">&quot;table_fn&quot;</span><span class="p">,</span>
</span><span data-line="457">        <span class="s2">&quot;inherits&quot;</span><span class="p">,</span>
</span><span data-line="458">        <span class="s2">&quot;single&quot;</span><span class="p">,</span>
</span><span data-line="459">        <span class="s2">&quot;allow_dataclass_fields&quot;</span><span class="p">,</span>
</span><span data-line="460">        <span class="s2">&quot;dataclass_setup_arguments&quot;</span><span class="p">,</span>
</span><span data-line="461">        <span class="s2">&quot;is_dataclass_prior_to_mapping&quot;</span><span class="p">,</span>
</span><span data-line="462">        <span class="s2">&quot;allow_unmapped_annotations&quot;</span><span class="p">,</span>
</span><span data-line="463">    <span class="p">)</span>
</span><span data-line="464">
</span><span data-line="465">    <span class="n">is_deferred</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="466">    <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span>
</span><span data-line="467">    <span class="n">clsdict_view</span><span class="p">:</span> <span class="n">_ClassDict</span>
</span><span data-line="468">    <span class="n">collected_annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_CollectedAnnotation</span><span class="p">]</span>
</span><span data-line="469">    <span class="n">collected_attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="470">    <span class="n">local_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span>
</span><span data-line="471">    <span class="n">persist_selectable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span>
</span><span data-line="472">    <span class="n">declared_columns</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">[</span><span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="473">    <span class="n">column_ordering</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span>
</span><span data-line="474">    <span class="n">column_copies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
</span><span data-line="475">        <span class="n">Union</span><span class="p">[</span><span class="n">MappedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="476">        <span class="n">Union</span><span class="p">[</span><span class="n">MappedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span data-line="477">    <span class="p">]</span>
</span><span data-line="478">    <span class="n">tablename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span data-line="479">    <span class="n">mapper_args</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span data-line="480">    <span class="n">table_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_TableArgsType</span><span class="p">]</span>
</span><span data-line="481">    <span class="n">mapper_args_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
</span><span data-line="482">    <span class="n">inherits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="483">    <span class="n">single</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="484">
</span><span data-line="485">    <span class="n">is_dataclass_prior_to_mapping</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="486">    <span class="n">allow_unmapped_annotations</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="487">
</span><span data-line="488">    <span class="n">dataclass_setup_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_DataclassArguments</span><span class="p">]</span>
</span><span data-line="489"><span class="w">    </span><span class="sd">&quot;&quot;&quot;if the class has SQLAlchemy native dataclass parameters, where</span>
</span><span data-line="490"><span class="sd">    we will turn the class into a dataclass within the declarative mapping</span>
</span><span data-line="491"><span class="sd">    process.</span>
</span><span data-line="492">
</span><span data-line="493"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="494">
</span><span data-line="495">    <span class="n">allow_dataclass_fields</span><span class="p">:</span> <span class="nb">bool</span>
</span><span data-line="496"><span class="w">    </span><span class="sd">&quot;&quot;&quot;if true, look for dataclass-processed Field objects on the target</span>
</span><span data-line="497"><span class="sd">    class as well as superclasses and extract ORM mapping directives from</span>
</span><span data-line="498"><span class="sd">    the &quot;metadata&quot; attribute of each Field.</span>
</span><span data-line="499">
</span><span data-line="500"><span class="sd">    if False, dataclass fields can still be used, however they won&#39;t be</span>
</span><span data-line="501"><span class="sd">    mapped.</span>
</span><span data-line="502">
</span><span data-line="503"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="504">
</span><span data-line="505">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="506">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="507">        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
</span><span data-line="508">        <span class="n">cls_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="509">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_ClassDict</span><span class="p">,</span>
</span><span data-line="510">        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
</span><span data-line="511">        <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
</span><span data-line="512">    <span class="p">):</span>
</span><span data-line="513">        <span class="c1"># grab class dict before the instrumentation manager has been added.</span>
</span><span data-line="514">        <span class="c1"># reduces cycles</span>
</span><span data-line="515">        <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="516">            <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span> <span class="k">if</span> <span class="n">dict_</span> <span class="k">else</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span>
</span><span data-line="517">        <span class="p">)</span>
</span><span data-line="518">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">)</span>
</span><span data-line="519">        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>
</span><span data-line="520">        <span class="bp">self</span><span class="o">.</span><span class="n">persist_selectable</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="521">
</span><span data-line="522">        <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="523">        <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="524">        <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">()</span>
</span><span data-line="525">        <span class="bp">self</span><span class="o">.</span><span class="n">column_ordering</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="526">        <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="527">        <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="528">        <span class="bp">self</span><span class="o">.</span><span class="n">dataclass_setup_arguments</span> <span class="o">=</span> <span class="n">dca</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
</span><span data-line="529">            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;_sa_apply_dc_transforms&quot;</span><span class="p">,</span> <span class="kc">None</span>
</span><span data-line="530">        <span class="p">)</span>
</span><span data-line="531">
</span><span data-line="532">        <span class="bp">self</span><span class="o">.</span><span class="n">allow_unmapped_annotations</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
</span><span data-line="533">            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;__allow_unmapped__&quot;</span><span class="p">,</span> <span class="kc">False</span>
</span><span data-line="534">        <span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataclass_setup_arguments</span><span class="p">)</span>
</span><span data-line="535">
</span><span data-line="536">        <span class="bp">self</span><span class="o">.</span><span class="n">is_dataclass_prior_to_mapping</span> <span class="o">=</span> <span class="n">cld</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span>
</span><span data-line="537">            <span class="n">cls_</span>
</span><span data-line="538">        <span class="p">)</span>
</span><span data-line="539">
</span><span data-line="540">        <span class="n">sdk</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="s2">&quot;__sa_dataclass_metadata_key__&quot;</span><span class="p">)</span>
</span><span data-line="541">
</span><span data-line="542">        <span class="c1"># we don&#39;t want to consume Field objects from a not-already-dataclass.</span>
</span><span data-line="543">        <span class="c1"># the Field objects won&#39;t have their &quot;name&quot; or &quot;type&quot; populated,</span>
</span><span data-line="544">        <span class="c1"># and while it seems like we could just set these on Field as we</span>
</span><span data-line="545">        <span class="c1"># read them, Field is documented as &quot;user read only&quot; and we need to</span>
</span><span data-line="546">        <span class="c1"># stay far away from any off-label use of dataclasses APIs.</span>
</span><span data-line="547">        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">cld</span> <span class="ow">or</span> <span class="n">dca</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sdk</span><span class="p">:</span>
</span><span data-line="548">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="549">                <span class="s2">&quot;SQLAlchemy mapped dataclasses can&#39;t consume mapping &quot;</span>
</span><span data-line="550">                <span class="s2">&quot;information from dataclass.Field() objects if the immediate &quot;</span>
</span><span data-line="551">                <span class="s2">&quot;class is not already a dataclass.&quot;</span>
</span><span data-line="552">            <span class="p">)</span>
</span><span data-line="553">
</span><span data-line="554">        <span class="c1"># if already a dataclass, and __sa_dataclass_metadata_key__ present,</span>
</span><span data-line="555">        <span class="c1"># then also look inside of dataclass.Field() objects yielded by</span>
</span><span data-line="556">        <span class="c1"># dataclasses.get_fields(cls) when scanning for attributes</span>
</span><span data-line="557">        <span class="bp">self</span><span class="o">.</span><span class="n">allow_dataclass_fields</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">sdk</span> <span class="ow">and</span> <span class="n">cld</span><span class="p">)</span>
</span><span data-line="558">
</span><span data-line="559">        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_declared_events</span><span class="p">()</span>
</span><span data-line="560">
</span><span data-line="561">        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_attributes</span><span class="p">()</span>
</span><span data-line="562">
</span><span data-line="563">        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_dataclasses_transforms</span><span class="p">()</span>
</span><span data-line="564">
</span><span data-line="565">        <span class="k">with</span> <span class="n">mapperlib</span><span class="o">.</span><span class="n">_CONFIGURE_MUTEX</span><span class="p">:</span>
</span><span data-line="566">            <span class="n">clsregistry</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span>
</span><span data-line="567">                <span class="bp">self</span><span class="o">.</span><span class="n">classname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">registry</span><span class="o">.</span><span class="n">_class_registry</span>
</span><span data-line="568">            <span class="p">)</span>
</span><span data-line="569">
</span><span data-line="570">            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_inheriting_mapper</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span data-line="571">
</span><span data-line="572">            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_mappable_attributes</span><span class="p">()</span>
</span><span data-line="573">
</span><span data-line="574">            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_declared_columns</span><span class="p">()</span>
</span><span data-line="575">
</span><span data-line="576">            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</span><span data-line="577">
</span><span data-line="578">            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_inheriting_columns</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span data-line="579">
</span><span data-line="580">            <span class="bp">self</span><span class="o">.</span><span class="n">_early_mapping</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span data-line="581">
</span><span data-line="582">    <span class="k">def</span> <span class="nf">_setup_declared_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="583">        <span class="k">if</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;__declare_last__&quot;</span><span class="p">):</span>
</span><span data-line="584">
</span><span data-line="585">            <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Mapper</span><span class="p">,</span> <span class="s2">&quot;after_configured&quot;</span><span class="p">)</span>
</span><span data-line="586">            <span class="k">def</span> <span class="nf">after_configured</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="587">                <span class="n">cast</span><span class="p">(</span>
</span><span data-line="588">                    <span class="s2">&quot;_DeclMappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span data-line="589">                <span class="p">)</span><span class="o">.</span><span class="n">__declare_last__</span><span class="p">()</span>
</span><span data-line="590">
</span><span data-line="591">        <span class="k">if</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;__declare_first__&quot;</span><span class="p">):</span>
</span><span data-line="592">
</span><span data-line="593">            <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Mapper</span><span class="p">,</span> <span class="s2">&quot;before_configured&quot;</span><span class="p">)</span>
</span><span data-line="594">            <span class="k">def</span> <span class="nf">before_configured</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="595">                <span class="n">cast</span><span class="p">(</span>
</span><span data-line="596">                    <span class="s2">&quot;_DeclMappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span data-line="597">                <span class="p">)</span><span class="o">.</span><span class="n">__declare_first__</span><span class="p">()</span>
</span><span data-line="598">
</span><span data-line="599">    <span class="k">def</span> <span class="nf">_cls_attr_override_checker</span><span class="p">(</span>
</span><span data-line="600">        <span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
</span><span data-line="601">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
</span><span data-line="602"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a function that checks if a class has overridden an</span>
</span><span data-line="603"><span class="sd">        attribute, taking SQLAlchemy-enabled dataclass fields into account.</span>
</span><span data-line="604">
</span><span data-line="605"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="606">
</span><span data-line="607">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_dataclass_fields</span><span class="p">:</span>
</span><span data-line="608">            <span class="n">sa_dataclass_metadata_key</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
</span><span data-line="609">                <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__sa_dataclass_metadata_key__&quot;</span>
</span><span data-line="610">            <span class="p">)</span>
</span><span data-line="611">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="612">            <span class="n">sa_dataclass_metadata_key</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="613">
</span><span data-line="614">        <span class="k">if</span> <span class="ow">not</span> <span class="n">sa_dataclass_metadata_key</span><span class="p">:</span>
</span><span data-line="615">
</span><span data-line="616">            <span class="k">def</span> <span class="nf">attribute_is_overridden</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="617">                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span>
</span><span data-line="618">
</span><span data-line="619">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="620">            <span class="n">all_datacls_fields</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="621">                <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">sa_dataclass_metadata_key</span><span class="p">]</span>
</span><span data-line="622">                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">dataclass_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="623">                <span class="k">if</span> <span class="n">sa_dataclass_metadata_key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">metadata</span>
</span><span data-line="624">            <span class="p">}</span>
</span><span data-line="625">            <span class="n">local_datacls_fields</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="626">                <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">sa_dataclass_metadata_key</span><span class="p">]</span>
</span><span data-line="627">                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">local_dataclass_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="628">                <span class="k">if</span> <span class="n">sa_dataclass_metadata_key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">metadata</span>
</span><span data-line="629">            <span class="p">}</span>
</span><span data-line="630">
</span><span data-line="631">            <span class="n">absent</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
</span><span data-line="632">
</span><span data-line="633">            <span class="k">def</span> <span class="nf">attribute_is_overridden</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="634">                <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span data-line="635">                    <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fget</span>
</span><span data-line="636">
</span><span data-line="637">                <span class="c1"># this function likely has some failure modes still if</span>
</span><span data-line="638">                <span class="c1"># someone is doing a deep mixing of the same attribute</span>
</span><span data-line="639">                <span class="c1"># name as plain Python attribute vs. dataclass field.</span>
</span><span data-line="640">
</span><span data-line="641">                <span class="n">ret</span> <span class="o">=</span> <span class="n">local_datacls_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">absent</span><span class="p">)</span>
</span><span data-line="642">                <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
</span><span data-line="643">                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">fget</span>
</span><span data-line="644">
</span><span data-line="645">                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
</span><span data-line="646">                    <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="647">                <span class="k">elif</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">absent</span><span class="p">:</span>
</span><span data-line="648">                    <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="649">
</span><span data-line="650">                <span class="n">all_field</span> <span class="o">=</span> <span class="n">all_datacls_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">absent</span><span class="p">)</span>
</span><span data-line="651">
</span><span data-line="652">                <span class="n">ret</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="653">
</span><span data-line="654">                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
</span><span data-line="655">                    <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="656">
</span><span data-line="657">                <span class="c1"># for dataclasses, this could be the</span>
</span><span data-line="658">                <span class="c1"># &#39;default&#39; of the field.  so filter more specifically</span>
</span><span data-line="659">                <span class="c1"># for an already-mapped InstrumentedAttribute</span>
</span><span data-line="660">                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">absent</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span data-line="661">                    <span class="n">ret</span><span class="p">,</span> <span class="n">InstrumentedAttribute</span>
</span><span data-line="662">                <span class="p">):</span>
</span><span data-line="663">                    <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="664">
</span><span data-line="665">                <span class="k">if</span> <span class="n">all_field</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
</span><span data-line="666">                    <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="667">                <span class="k">elif</span> <span class="n">all_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">absent</span><span class="p">:</span>
</span><span data-line="668">                    <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="669">
</span><span data-line="670">                <span class="c1"># can&#39;t find another attribute</span>
</span><span data-line="671">                <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="672">
</span><span data-line="673">        <span class="k">return</span> <span class="n">attribute_is_overridden</span>
</span><span data-line="674">
</span><span data-line="675">    <span class="n">_include_dunders</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="676">        <span class="s2">&quot;__table__&quot;</span><span class="p">,</span>
</span><span data-line="677">        <span class="s2">&quot;__mapper_args__&quot;</span><span class="p">,</span>
</span><span data-line="678">        <span class="s2">&quot;__tablename__&quot;</span><span class="p">,</span>
</span><span data-line="679">        <span class="s2">&quot;__table_args__&quot;</span><span class="p">,</span>
</span><span data-line="680">    <span class="p">}</span>
</span><span data-line="681">
</span><span data-line="682">    <span class="n">_match_exclude_dunders</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?:_sa_|__)&quot;</span><span class="p">)</span>
</span><span data-line="683">
</span><span data-line="684">    <span class="k">def</span> <span class="nf">_cls_attr_resolver</span><span class="p">(</span>
</span><span data-line="685">        <span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="686">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]]:</span>
</span><span data-line="687"><span class="w">        </span><span class="sd">&quot;&quot;&quot;produce a function to iterate the &quot;attributes&quot; of a class</span>
</span><span data-line="688"><span class="sd">        which we want to consider for mapping, adjusting for SQLAlchemy fields</span>
</span><span data-line="689"><span class="sd">        embedded in dataclass fields.</span>
</span><span data-line="690">
</span><span data-line="691"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="692">        <span class="n">cls_annotations</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="693">
</span><span data-line="694">        <span class="n">cls_vars</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="695">
</span><span data-line="696">        <span class="n">_include_dunders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_dunders</span>
</span><span data-line="697">        <span class="n">_match_exclude_dunders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_exclude_dunders</span>
</span><span data-line="698">
</span><span data-line="699">        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="700">            <span class="n">n</span>
</span><span data-line="701">            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">merge_lists_w_ordering</span><span class="p">(</span>
</span><span data-line="702">                <span class="nb">list</span><span class="p">(</span><span class="n">cls_vars</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">cls_annotations</span><span class="p">)</span>
</span><span data-line="703">            <span class="p">)</span>
</span><span data-line="704">            <span class="k">if</span> <span class="ow">not</span> <span class="n">_match_exclude_dunders</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">_include_dunders</span>
</span><span data-line="705">        <span class="p">]</span>
</span><span data-line="706">
</span><span data-line="707">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_dataclass_fields</span><span class="p">:</span>
</span><span data-line="708">            <span class="n">sa_dataclass_metadata_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
</span><span data-line="709">                <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__sa_dataclass_metadata_key__&quot;</span>
</span><span data-line="710">            <span class="p">)</span>
</span><span data-line="711">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="712">            <span class="n">sa_dataclass_metadata_key</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="713">
</span><span data-line="714">        <span class="k">if</span> <span class="ow">not</span> <span class="n">sa_dataclass_metadata_key</span><span class="p">:</span>
</span><span data-line="715">
</span><span data-line="716">            <span class="k">def</span> <span class="nf">local_attributes_for_class</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span>
</span><span data-line="717">                <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
</span><span data-line="718">            <span class="p">):</span>
</span><span data-line="719">                <span class="k">return</span> <span class="p">(</span>
</span><span data-line="720">                    <span class="p">(</span>
</span><span data-line="721">                        <span class="n">name</span><span class="p">,</span>
</span><span data-line="722">                        <span class="n">cls_vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
</span><span data-line="723">                        <span class="n">cls_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
</span><span data-line="724">                        <span class="kc">False</span><span class="p">,</span>
</span><span data-line="725">                    <span class="p">)</span>
</span><span data-line="726">                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span>
</span><span data-line="727">                <span class="p">)</span>
</span><span data-line="728">
</span><span data-line="729">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="730">            <span class="n">dataclass_fields</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="731">                <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">local_dataclass_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="732">            <span class="p">}</span>
</span><span data-line="733">
</span><span data-line="734">            <span class="n">fixed_sa_dataclass_metadata_key</span> <span class="o">=</span> <span class="n">sa_dataclass_metadata_key</span>
</span><span data-line="735">
</span><span data-line="736">            <span class="k">def</span> <span class="nf">local_attributes_for_class</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span>
</span><span data-line="737">                <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
</span><span data-line="738">            <span class="p">):</span>
</span><span data-line="739">                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
</span><span data-line="740">                    <span class="n">field</span> <span class="o">=</span> <span class="n">dataclass_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="741">                    <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">sa_dataclass_metadata_key</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
</span><span data-line="742">                        <span class="k">yield</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_as_dc_declaredattr</span><span class="p">(</span>
</span><span data-line="743">                            <span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">fixed_sa_dataclass_metadata_key</span>
</span><span data-line="744">                        <span class="p">),</span> <span class="n">cls_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="kc">True</span>
</span><span data-line="745">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="746">                        <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">cls_vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">cls_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="747">                            <span class="n">name</span>
</span><span data-line="748">                        <span class="p">),</span> <span class="kc">False</span>
</span><span data-line="749">
</span><span data-line="750">        <span class="k">return</span> <span class="n">local_attributes_for_class</span>
</span><span data-line="751">
</span><span data-line="752">    <span class="k">def</span> <span class="nf">_scan_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="753">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span data-line="754">
</span><span data-line="755">        <span class="n">cls_as_Decl</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;_DeclMappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span data-line="756">
</span><span data-line="757">        <span class="n">clsdict_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span>
</span><span data-line="758">        <span class="n">collected_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span>
</span><span data-line="759">        <span class="n">column_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span>
</span><span data-line="760">        <span class="n">_include_dunders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_dunders</span>
</span><span data-line="761">        <span class="n">mapper_args_fn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="762">        <span class="n">table_args</span> <span class="o">=</span> <span class="n">inherited_table_args</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="763">        <span class="n">table_fn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="764">        <span class="n">tablename</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="765">        <span class="n">fixed_table</span> <span class="o">=</span> <span class="s2">&quot;__table__&quot;</span> <span class="ow">in</span> <span class="n">clsdict_view</span>
</span><span data-line="766">
</span><span data-line="767">        <span class="n">attribute_is_overridden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_attr_override_checker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
</span><span data-line="768">
</span><span data-line="769">        <span class="n">bases</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="770">
</span><span data-line="771">        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
</span><span data-line="772">            <span class="c1"># collect bases and make sure standalone columns are copied</span>
</span><span data-line="773">            <span class="c1"># to be the column they will ultimately be on the class,</span>
</span><span data-line="774">            <span class="c1"># so that declared_attr functions use the right columns.</span>
</span><span data-line="775">            <span class="c1"># need to do this all the way up the hierarchy first</span>
</span><span data-line="776">            <span class="c1"># (see #8190)</span>
</span><span data-line="777">
</span><span data-line="778">            <span class="n">class_mapped</span> <span class="o">=</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span> <span class="ow">and</span> <span class="n">_is_supercls_for_inherits</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span data-line="779">
</span><span data-line="780">            <span class="n">local_attributes_for_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_attr_resolver</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span data-line="781">
</span><span data-line="782">            <span class="k">if</span> <span class="ow">not</span> <span class="n">class_mapped</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">:</span>
</span><span data-line="783">                <span class="n">locally_collected_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_produce_column_copies</span><span class="p">(</span>
</span><span data-line="784">                    <span class="n">local_attributes_for_class</span><span class="p">,</span>
</span><span data-line="785">                    <span class="n">attribute_is_overridden</span><span class="p">,</span>
</span><span data-line="786">                    <span class="n">fixed_table</span><span class="p">,</span>
</span><span data-line="787">                    <span class="n">base</span><span class="p">,</span>
</span><span data-line="788">                <span class="p">)</span>
</span><span data-line="789">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="790">                <span class="n">locally_collected_columns</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="791">
</span><span data-line="792">            <span class="n">bases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span data-line="793">                <span class="p">(</span>
</span><span data-line="794">                    <span class="n">base</span><span class="p">,</span>
</span><span data-line="795">                    <span class="n">class_mapped</span><span class="p">,</span>
</span><span data-line="796">                    <span class="n">local_attributes_for_class</span><span class="p">,</span>
</span><span data-line="797">                    <span class="n">locally_collected_columns</span><span class="p">,</span>
</span><span data-line="798">                <span class="p">)</span>
</span><span data-line="799">            <span class="p">)</span>
</span><span data-line="800">
</span><span data-line="801">        <span class="k">for</span> <span class="p">(</span>
</span><span data-line="802">            <span class="n">base</span><span class="p">,</span>
</span><span data-line="803">            <span class="n">class_mapped</span><span class="p">,</span>
</span><span data-line="804">            <span class="n">local_attributes_for_class</span><span class="p">,</span>
</span><span data-line="805">            <span class="n">locally_collected_columns</span><span class="p">,</span>
</span><span data-line="806">        <span class="p">)</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
</span><span data-line="807">            <span class="c1"># this transfer can also take place as we scan each name</span>
</span><span data-line="808">            <span class="c1"># for finer-grained control of how collected_attributes is</span>
</span><span data-line="809">            <span class="c1"># populated, as this is what impacts column ordering.</span>
</span><span data-line="810">            <span class="c1"># however it&#39;s simpler to get it out of the way here.</span>
</span><span data-line="811">            <span class="n">collected_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">locally_collected_columns</span><span class="p">)</span>
</span><span data-line="812">
</span><span data-line="813">            <span class="k">for</span> <span class="p">(</span>
</span><span data-line="814">                <span class="n">name</span><span class="p">,</span>
</span><span data-line="815">                <span class="n">obj</span><span class="p">,</span>
</span><span data-line="816">                <span class="n">annotation</span><span class="p">,</span>
</span><span data-line="817">                <span class="n">is_dataclass_field</span><span class="p">,</span>
</span><span data-line="818">            <span class="p">)</span> <span class="ow">in</span> <span class="n">local_attributes_for_class</span><span class="p">():</span>
</span><span data-line="819">                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_include_dunders</span><span class="p">:</span>
</span><span data-line="820">                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__mapper_args__&quot;</span><span class="p">:</span>
</span><span data-line="821">                        <span class="n">check_decl</span> <span class="o">=</span> <span class="n">_check_declared_props_nocascade</span><span class="p">(</span>
</span><span data-line="822">                            <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span>
</span><span data-line="823">                        <span class="p">)</span>
</span><span data-line="824">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mapper_args_fn</span> <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="825">                            <span class="ow">not</span> <span class="n">class_mapped</span> <span class="ow">or</span> <span class="n">check_decl</span>
</span><span data-line="826">                        <span class="p">):</span>
</span><span data-line="827">                            <span class="c1"># don&#39;t even invoke __mapper_args__ until</span>
</span><span data-line="828">                            <span class="c1"># after we&#39;ve determined everything about the</span>
</span><span data-line="829">                            <span class="c1"># mapped table.</span>
</span><span data-line="830">                            <span class="c1"># make a copy of it so a class-level dictionary</span>
</span><span data-line="831">                            <span class="c1"># is not overwritten when we update column-based</span>
</span><span data-line="832">                            <span class="c1"># arguments.</span>
</span><span data-line="833">                            <span class="k">def</span> <span class="nf">_mapper_args_fn</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span data-line="834">                                <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__mapper_args__</span><span class="p">)</span>
</span><span data-line="835">
</span><span data-line="836">                            <span class="n">mapper_args_fn</span> <span class="o">=</span> <span class="n">_mapper_args_fn</span>
</span><span data-line="837">
</span><span data-line="838">                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__tablename__&quot;</span><span class="p">:</span>
</span><span data-line="839">                        <span class="n">check_decl</span> <span class="o">=</span> <span class="n">_check_declared_props_nocascade</span><span class="p">(</span>
</span><span data-line="840">                            <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span>
</span><span data-line="841">                        <span class="p">)</span>
</span><span data-line="842">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">tablename</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">class_mapped</span> <span class="ow">or</span> <span class="n">check_decl</span><span class="p">):</span>
</span><span data-line="843">                            <span class="n">tablename</span> <span class="o">=</span> <span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__tablename__</span>
</span><span data-line="844">                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__table__&quot;</span><span class="p">:</span>
</span><span data-line="845">                        <span class="n">check_decl</span> <span class="o">=</span> <span class="n">_check_declared_props_nocascade</span><span class="p">(</span>
</span><span data-line="846">                            <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span>
</span><span data-line="847">                        <span class="p">)</span>
</span><span data-line="848">                        <span class="c1"># if a @declared_attr using &quot;__table__&quot; is detected,</span>
</span><span data-line="849">                        <span class="c1"># wrap up a callable to look for &quot;__table__&quot; from</span>
</span><span data-line="850">                        <span class="c1"># the final concrete class when we set up a table.</span>
</span><span data-line="851">                        <span class="c1"># this was fixed by</span>
</span><span data-line="852">                        <span class="c1"># #11509, regression in 2.0 from version 1.4.</span>
</span><span data-line="853">                        <span class="k">if</span> <span class="n">check_decl</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">table_fn</span><span class="p">:</span>
</span><span data-line="854">                            <span class="c1"># don&#39;t even invoke __table__ until we&#39;re ready</span>
</span><span data-line="855">                            <span class="k">def</span> <span class="nf">_table_fn</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FromClause</span><span class="p">:</span>
</span><span data-line="856">                                <span class="k">return</span> <span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__table__</span>
</span><span data-line="857">
</span><span data-line="858">                            <span class="n">table_fn</span> <span class="o">=</span> <span class="n">_table_fn</span>
</span><span data-line="859">
</span><span data-line="860">                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__table_args__&quot;</span><span class="p">:</span>
</span><span data-line="861">                        <span class="n">check_decl</span> <span class="o">=</span> <span class="n">_check_declared_props_nocascade</span><span class="p">(</span>
</span><span data-line="862">                            <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span>
</span><span data-line="863">                        <span class="p">)</span>
</span><span data-line="864">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">table_args</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">class_mapped</span> <span class="ow">or</span> <span class="n">check_decl</span><span class="p">):</span>
</span><span data-line="865">                            <span class="n">table_args</span> <span class="o">=</span> <span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__table_args__</span>
</span><span data-line="866">                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span data-line="867">                                <span class="n">table_args</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
</span><span data-line="868">                            <span class="p">):</span>
</span><span data-line="869">                                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="870">                                    <span class="s2">&quot;__table_args__ value must be a tuple, &quot;</span>
</span><span data-line="871">                                    <span class="s2">&quot;dict, or None&quot;</span>
</span><span data-line="872">                                <span class="p">)</span>
</span><span data-line="873">                            <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">:</span>
</span><span data-line="874">                                <span class="n">inherited_table_args</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="875">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="876">                        <span class="c1"># any other dunder names; should not be here</span>
</span><span data-line="877">                        <span class="c1"># as we have tested for all four names in</span>
</span><span data-line="878">                        <span class="c1"># _include_dunders</span>
</span><span data-line="879">                        <span class="k">assert</span> <span class="kc">False</span>
</span><span data-line="880">                <span class="k">elif</span> <span class="n">class_mapped</span><span class="p">:</span>
</span><span data-line="881">                    <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">_quiet</span><span class="p">:</span>
</span><span data-line="882">                        <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="883">                            <span class="s2">&quot;Regular (i.e. not __special__) &quot;</span>
</span><span data-line="884">                            <span class="s2">&quot;attribute &#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&#39; uses @declared_attr, &quot;</span>
</span><span data-line="885">                            <span class="s2">&quot;but owning class </span><span class="si">%s</span><span class="s2"> is mapped - &quot;</span>
</span><span data-line="886">                            <span class="s2">&quot;not applying to subclass </span><span class="si">%s</span><span class="s2">.&quot;</span>
</span><span data-line="887">                            <span class="o">%</span> <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span data-line="888">                        <span class="p">)</span>
</span><span data-line="889">
</span><span data-line="890">                    <span class="k">continue</span>
</span><span data-line="891">                <span class="k">elif</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">:</span>
</span><span data-line="892">                    <span class="c1"># we&#39;re a mixin, abstract base, or something that is</span>
</span><span data-line="893">                    <span class="c1"># acting like that for now.</span>
</span><span data-line="894">
</span><span data-line="895">                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">MappedColumn</span><span class="p">)):</span>
</span><span data-line="896">                        <span class="c1"># already copied columns to the mapped class.</span>
</span><span data-line="897">                        <span class="k">continue</span>
</span><span data-line="898">                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">):</span>
</span><span data-line="899">                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="900">                            <span class="s2">&quot;Mapper properties (i.e. deferred,&quot;</span>
</span><span data-line="901">                            <span class="s2">&quot;column_property(), relationship(), etc.) must &quot;</span>
</span><span data-line="902">                            <span class="s2">&quot;be declared as @declared_attr callables &quot;</span>
</span><span data-line="903">                            <span class="s2">&quot;on declarative mixin classes.  For dataclass &quot;</span>
</span><span data-line="904">                            <span class="s2">&quot;field() objects, use a lambda:&quot;</span>
</span><span data-line="905">                        <span class="p">)</span>
</span><span data-line="906">                    <span class="k">elif</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span data-line="907">                        <span class="c1"># tried to get overloads to tell this to</span>
</span><span data-line="908">                        <span class="c1"># pylance, no luck</span>
</span><span data-line="909">                        <span class="k">assert</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="910">
</span><span data-line="911">                        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_cascading</span><span class="p">:</span>
</span><span data-line="912">                            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">clsdict_view</span><span class="p">:</span>
</span><span data-line="913">                                <span class="c1"># unfortunately, while we can use the user-</span>
</span><span data-line="914">                                <span class="c1"># defined attribute here to allow a clean</span>
</span><span data-line="915">                                <span class="c1"># override, if there&#39;s another</span>
</span><span data-line="916">                                <span class="c1"># subclass below then it still tries to use</span>
</span><span data-line="917">                                <span class="c1"># this.  not sure if there is enough</span>
</span><span data-line="918">                                <span class="c1"># information here to add this as a feature</span>
</span><span data-line="919">                                <span class="c1"># later on.</span>
</span><span data-line="920">                                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="921">                                    <span class="s2">&quot;Attribute &#39;</span><span class="si">%s</span><span class="s2">&#39; on class </span><span class="si">%s</span><span class="s2"> cannot be &quot;</span>
</span><span data-line="922">                                    <span class="s2">&quot;processed due to &quot;</span>
</span><span data-line="923">                                    <span class="s2">&quot;@declared_attr.cascading; &quot;</span>
</span><span data-line="924">                                    <span class="s2">&quot;skipping&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span data-line="925">                                <span class="p">)</span>
</span><span data-line="926">                            <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_copies</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="927">                                <span class="n">ret</span>
</span><span data-line="928">                            <span class="p">)</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span data-line="929">                            <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
</span><span data-line="930">                        <span class="k">else</span><span class="p">:</span>
</span><span data-line="931">                            <span class="k">if</span> <span class="n">is_dataclass_field</span><span class="p">:</span>
</span><span data-line="932">                                <span class="c1"># access attribute using normal class access</span>
</span><span data-line="933">                                <span class="c1"># first, to see if it&#39;s been mapped on a</span>
</span><span data-line="934">                                <span class="c1"># superclass.   note if the dataclasses.field()</span>
</span><span data-line="935">                                <span class="c1"># has &quot;default&quot;, this value can be anything.</span>
</span><span data-line="936">                                <span class="n">ret</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="937">
</span><span data-line="938">                                <span class="c1"># so, if it&#39;s anything that&#39;s not ORM</span>
</span><span data-line="939">                                <span class="c1"># mapped, assume we should invoke the</span>
</span><span data-line="940">                                <span class="c1"># declared_attr</span>
</span><span data-line="941">                                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">InspectionAttr</span><span class="p">):</span>
</span><span data-line="942">                                    <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fget</span><span class="p">()</span>
</span><span data-line="943">                            <span class="k">else</span><span class="p">:</span>
</span><span data-line="944">                                <span class="c1"># access attribute using normal class access.</span>
</span><span data-line="945">                                <span class="c1"># if the declared attr already took place</span>
</span><span data-line="946">                                <span class="c1"># on a superclass that is mapped, then</span>
</span><span data-line="947">                                <span class="c1"># this is no longer a declared_attr, it will</span>
</span><span data-line="948">                                <span class="c1"># be the InstrumentedAttribute</span>
</span><span data-line="949">                                <span class="n">ret</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span data-line="950">
</span><span data-line="951">                            <span class="c1"># correct for proxies created from hybrid_property</span>
</span><span data-line="952">                            <span class="c1"># or similar.  note there is no known case that</span>
</span><span data-line="953">                            <span class="c1"># produces nested proxies, so we are only</span>
</span><span data-line="954">                            <span class="c1"># looking one level deep right now.</span>
</span><span data-line="955">
</span><span data-line="956">                            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="957">                                <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">InspectionAttr</span><span class="p">)</span>
</span><span data-line="958">                                <span class="ow">and</span> <span class="n">attr_is_internal_proxy</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span><span data-line="959">                                <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span data-line="960">                                    <span class="n">ret</span><span class="o">.</span><span class="n">original_property</span><span class="p">,</span> <span class="n">MapperProperty</span>
</span><span data-line="961">                                <span class="p">)</span>
</span><span data-line="962">                            <span class="p">):</span>
</span><span data-line="963">                                <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">descriptor</span>
</span><span data-line="964">
</span><span data-line="965">                            <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_copies</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="966">                                <span class="n">ret</span>
</span><span data-line="967">                            <span class="p">)</span>
</span><span data-line="968">
</span><span data-line="969">                        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="970">                            <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">))</span>
</span><span data-line="971">                            <span class="ow">and</span> <span class="n">ret</span><span class="o">.</span><span class="n">doc</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="972">                        <span class="p">):</span>
</span><span data-line="973">                            <span class="n">ret</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span data-line="974">
</span><span data-line="975">                        <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
</span><span data-line="976">                            <span class="n">name</span><span class="p">,</span>
</span><span data-line="977">                            <span class="n">obj</span><span class="o">.</span><span class="n">_collect_return_annotation</span><span class="p">(),</span>
</span><span data-line="978">                            <span class="n">base</span><span class="p">,</span>
</span><span data-line="979">                            <span class="kc">True</span><span class="p">,</span>
</span><span data-line="980">                            <span class="n">obj</span><span class="p">,</span>
</span><span data-line="981">                        <span class="p">)</span>
</span><span data-line="982">                    <span class="k">elif</span> <span class="n">_is_mapped_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
</span><span data-line="983">                        <span class="c1"># Mapped annotation without any object.</span>
</span><span data-line="984">                        <span class="c1"># product_column_copies should have handled this.</span>
</span><span data-line="985">                        <span class="c1"># if future support for other MapperProperty,</span>
</span><span data-line="986">                        <span class="c1"># then test if this name is already handled and</span>
</span><span data-line="987">                        <span class="c1"># otherwise proceed to generate.</span>
</span><span data-line="988">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">fixed_table</span><span class="p">:</span>
</span><span data-line="989">                            <span class="k">assert</span> <span class="p">(</span>
</span><span data-line="990">                                <span class="n">name</span> <span class="ow">in</span> <span class="n">collected_attributes</span>
</span><span data-line="991">                                <span class="ow">or</span> <span class="n">attribute_is_overridden</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="992">                            <span class="p">)</span>
</span><span data-line="993">                        <span class="k">continue</span>
</span><span data-line="994">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="995">                        <span class="c1"># here, the attribute is some other kind of</span>
</span><span data-line="996">                        <span class="c1"># property that we assume is not part of the</span>
</span><span data-line="997">                        <span class="c1"># declarative mapping.  however, check for some</span>
</span><span data-line="998">                        <span class="c1"># more common mistakes</span>
</span><span data-line="999">                        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_for_decl_attributes</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="1000">                <span class="k">elif</span> <span class="n">is_dataclass_field</span> <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="1001">                    <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clsdict_view</span> <span class="ow">or</span> <span class="n">clsdict_view</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span>
</span><span data-line="1002">                <span class="p">):</span>
</span><span data-line="1003">                    <span class="c1"># here, we are definitely looking at the target class</span>
</span><span data-line="1004">                    <span class="c1"># and not a superclass.   this is currently a</span>
</span><span data-line="1005">                    <span class="c1"># dataclass-only path.  if the name is only</span>
</span><span data-line="1006">                    <span class="c1"># a dataclass field and isn&#39;t in local cls.__dict__,</span>
</span><span data-line="1007">                    <span class="c1"># put the object there.</span>
</span><span data-line="1008">                    <span class="c1"># assert that the dataclass-enabled resolver agrees</span>
</span><span data-line="1009">                    <span class="c1"># with what we are seeing</span>
</span><span data-line="1010">
</span><span data-line="1011">                    <span class="k">assert</span> <span class="ow">not</span> <span class="n">attribute_is_overridden</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="1012">
</span><span data-line="1013">                    <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span data-line="1014">                        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fget</span><span class="p">()</span>
</span><span data-line="1015">
</span><span data-line="1016">                    <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span><span data-line="1017">                    <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
</span><span data-line="1018">                        <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">obj</span>
</span><span data-line="1019">                    <span class="p">)</span>
</span><span data-line="1020">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1021">                    <span class="n">collected_annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
</span><span data-line="1022">                        <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">obj</span>
</span><span data-line="1023">                    <span class="p">)</span>
</span><span data-line="1024">                    <span class="n">is_mapped</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1025">                        <span class="n">collected_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1026">                        <span class="ow">and</span> <span class="n">collected_annotation</span><span class="o">.</span><span class="n">mapped_container</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1027">                    <span class="p">)</span>
</span><span data-line="1028">                    <span class="n">generated_obj</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1029">                        <span class="n">collected_annotation</span><span class="o">.</span><span class="n">attr_value</span>
</span><span data-line="1030">                        <span class="k">if</span> <span class="n">collected_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1031">                        <span class="k">else</span> <span class="n">obj</span>
</span><span data-line="1032">                    <span class="p">)</span>
</span><span data-line="1033">                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fixed_table</span> <span class="ow">and</span> <span class="n">is_mapped</span><span class="p">:</span>
</span><span data-line="1034">                        <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1035">                            <span class="n">generated_obj</span>
</span><span data-line="1036">                            <span class="k">if</span> <span class="n">generated_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1037">                            <span class="k">else</span> <span class="n">MappedColumn</span><span class="p">()</span>
</span><span data-line="1038">                        <span class="p">)</span>
</span><span data-line="1039">                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">clsdict_view</span><span class="p">:</span>
</span><span data-line="1040">                        <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span><span data-line="1041">                    <span class="c1"># else if the name is not in the cls.__dict__,</span>
</span><span data-line="1042">                    <span class="c1"># don&#39;t collect it as an attribute.</span>
</span><span data-line="1043">                    <span class="c1"># we will see the annotation only, which is meaningful</span>
</span><span data-line="1044">                    <span class="c1"># both for mapping and dataclasses setup</span>
</span><span data-line="1045">
</span><span data-line="1046">        <span class="k">if</span> <span class="n">inherited_table_args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tablename</span><span class="p">:</span>
</span><span data-line="1047">            <span class="n">table_args</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1048">
</span><span data-line="1049">        <span class="bp">self</span><span class="o">.</span><span class="n">table_args</span> <span class="o">=</span> <span class="n">table_args</span>
</span><span data-line="1050">        <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span> <span class="o">=</span> <span class="n">tablename</span>
</span><span data-line="1051">        <span class="bp">self</span><span class="o">.</span><span class="n">mapper_args_fn</span> <span class="o">=</span> <span class="n">mapper_args_fn</span>
</span><span data-line="1052">        <span class="bp">self</span><span class="o">.</span><span class="n">table_fn</span> <span class="o">=</span> <span class="n">table_fn</span>
</span><span data-line="1053">
</span><span data-line="1054">    <span class="k">def</span> <span class="nf">_setup_dataclasses_transforms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1055">        <span class="n">dataclass_setup_arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclass_setup_arguments</span>
</span><span data-line="1056">        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataclass_setup_arguments</span><span class="p">:</span>
</span><span data-line="1057">            <span class="k">return</span>
</span><span data-line="1058">
</span><span data-line="1059">        <span class="c1"># can&#39;t use is_dataclass since it uses hasattr</span>
</span><span data-line="1060">        <span class="k">if</span> <span class="s2">&quot;__dataclass_fields__&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span data-line="1061">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1062">                <span class="sa">f</span><span class="s2">&quot;Class </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="si">}</span><span class="s2"> is already a dataclass; ensure that &quot;</span>
</span><span data-line="1063">                <span class="s2">&quot;base classes / decorator styles of establishing dataclasses &quot;</span>
</span><span data-line="1064">                <span class="s2">&quot;are not being mixed. &quot;</span>
</span><span data-line="1065">                <span class="s2">&quot;This can happen if a class that inherits from &quot;</span>
</span><span data-line="1066">                <span class="s2">&quot;&#39;MappedAsDataclass&#39;, even indirectly, is been mapped with &quot;</span>
</span><span data-line="1067">                <span class="s2">&quot;&#39;@registry.mapped_as_dataclass&#39;&quot;</span>
</span><span data-line="1068">            <span class="p">)</span>
</span><span data-line="1069">
</span><span data-line="1070">        <span class="c1"># can&#39;t create a dataclass if __table__ is already there. This would</span>
</span><span data-line="1071">        <span class="c1"># fail an assertion when calling _get_arguments_for_make_dataclass:</span>
</span><span data-line="1072">        <span class="c1"># assert False, &quot;Mapped[] received without a mapping declaration&quot;</span>
</span><span data-line="1073">        <span class="k">if</span> <span class="s2">&quot;__table__&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span data-line="1074">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1075">                <span class="sa">f</span><span class="s2">&quot;Class </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="si">}</span><span class="s2"> already defines a &#39;__table__&#39;. &quot;</span>
</span><span data-line="1076">                <span class="s2">&quot;ORM Annotated Dataclasses do not support a pre-existing &quot;</span>
</span><span data-line="1077">                <span class="s2">&quot;&#39;__table__&#39; element&quot;</span>
</span><span data-line="1078">            <span class="p">)</span>
</span><span data-line="1079">
</span><span data-line="1080">        <span class="n">warn_for_non_dc_attrs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span data-line="1081">
</span><span data-line="1082">        <span class="k">def</span> <span class="nf">_allow_dataclass_field</span><span class="p">(</span>
</span><span data-line="1083">            <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="1084">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="1085">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1086">                <span class="n">originating_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span data-line="1087">                <span class="ow">and</span> <span class="s2">&quot;__dataclass_fields__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">originating_class</span><span class="o">.</span><span class="vm">__dict__</span>
</span><span data-line="1088">            <span class="p">):</span>
</span><span data-line="1089">                <span class="n">warn_for_non_dc_attrs</span><span class="p">[</span><span class="n">originating_class</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="1090">
</span><span data-line="1091">            <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="1092">
</span><span data-line="1093">        <span class="n">manager</span> <span class="o">=</span> <span class="n">instrumentation</span><span class="o">.</span><span class="n">manager_of_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
</span><span data-line="1094">        <span class="k">assert</span> <span class="n">manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1095">
</span><span data-line="1096">        <span class="n">field_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="1097">            <span class="n">_AttributeOptions</span><span class="o">.</span><span class="n">_get_arguments_for_make_dataclass</span><span class="p">(</span>
</span><span data-line="1098">                <span class="n">key</span><span class="p">,</span>
</span><span data-line="1099">                <span class="n">anno</span><span class="p">,</span>
</span><span data-line="1100">                <span class="n">mapped_container</span><span class="p">,</span>
</span><span data-line="1101">                <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">),</span>
</span><span data-line="1102">            <span class="p">)</span>
</span><span data-line="1103">            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">anno</span><span class="p">,</span> <span class="n">mapped_container</span> <span class="ow">in</span> <span class="p">(</span>
</span><span data-line="1104">                <span class="p">(</span>
</span><span data-line="1105">                    <span class="n">key</span><span class="p">,</span>
</span><span data-line="1106">                    <span class="n">mapped_anno</span> <span class="k">if</span> <span class="n">mapped_anno</span> <span class="k">else</span> <span class="n">raw_anno</span><span class="p">,</span>
</span><span data-line="1107">                    <span class="n">mapped_container</span><span class="p">,</span>
</span><span data-line="1108">                <span class="p">)</span>
</span><span data-line="1109">                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span>
</span><span data-line="1110">                    <span class="n">raw_anno</span><span class="p">,</span>
</span><span data-line="1111">                    <span class="n">mapped_container</span><span class="p">,</span>
</span><span data-line="1112">                    <span class="n">mapped_anno</span><span class="p">,</span>
</span><span data-line="1113">                    <span class="n">is_dc</span><span class="p">,</span>
</span><span data-line="1114">                    <span class="n">attr_value</span><span class="p">,</span>
</span><span data-line="1115">                    <span class="n">originating_module</span><span class="p">,</span>
</span><span data-line="1116">                    <span class="n">originating_class</span><span class="p">,</span>
</span><span data-line="1117">                <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span data-line="1118">                <span class="k">if</span> <span class="n">_allow_dataclass_field</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">)</span>
</span><span data-line="1119">                <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="1120">                    <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span>
</span><span data-line="1121">                    <span class="c1"># issue #9226; check for attributes that we&#39;ve collected</span>
</span><span data-line="1122">                    <span class="c1"># which are already instrumented, which we would assume</span>
</span><span data-line="1123">                    <span class="c1"># mean we are in an ORM inheritance mapping and this</span>
</span><span data-line="1124">                    <span class="c1"># attribute is already mapped on the superclass.   Under</span>
</span><span data-line="1125">                    <span class="c1"># no circumstance should any QueryableAttribute be sent to</span>
</span><span data-line="1126">                    <span class="c1"># the dataclass() function; anything that&#39;s mapped should</span>
</span><span data-line="1127">                    <span class="c1"># be Field and that&#39;s it</span>
</span><span data-line="1128">                    <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span data-line="1129">                        <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">QueryableAttribute</span>
</span><span data-line="1130">                    <span class="p">)</span>
</span><span data-line="1131">                <span class="p">)</span>
</span><span data-line="1132">            <span class="p">)</span>
</span><span data-line="1133">        <span class="p">]</span>
</span><span data-line="1134">
</span><span data-line="1135">        <span class="k">if</span> <span class="n">warn_for_non_dc_attrs</span><span class="p">:</span>
</span><span data-line="1136">            <span class="k">for</span> <span class="p">(</span>
</span><span data-line="1137">                <span class="n">originating_class</span><span class="p">,</span>
</span><span data-line="1138">                <span class="n">non_dc_attrs</span><span class="p">,</span>
</span><span data-line="1139">            <span class="p">)</span> <span class="ow">in</span> <span class="n">warn_for_non_dc_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="1140">                <span class="n">util</span><span class="o">.</span><span class="n">warn_deprecated</span><span class="p">(</span>
</span><span data-line="1141">                    <span class="sa">f</span><span class="s2">&quot;When transforming </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="si">}</span><span class="s2"> to a dataclass, &quot;</span>
</span><span data-line="1142">                    <span class="sa">f</span><span class="s2">&quot;attribute(s) &quot;</span>
</span><span data-line="1143">                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">non_dc_attrs</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span data-line="1144">                    <span class="sa">f</span><span class="s2">&quot;originates from superclass &quot;</span>
</span><span data-line="1145">                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">originating_class</span><span class="si">}</span><span class="s2">, which is not a dataclass.  This &quot;</span>
</span><span data-line="1146">                    <span class="sa">f</span><span class="s2">&quot;usage is deprecated and will raise an error in &quot;</span>
</span><span data-line="1147">                    <span class="sa">f</span><span class="s2">&quot;SQLAlchemy 2.1.  When declaring SQLAlchemy Declarative &quot;</span>
</span><span data-line="1148">                    <span class="sa">f</span><span class="s2">&quot;Dataclasses, ensure that all mixin classes and other &quot;</span>
</span><span data-line="1149">                    <span class="sa">f</span><span class="s2">&quot;superclasses which include attributes are also a &quot;</span>
</span><span data-line="1150">                    <span class="sa">f</span><span class="s2">&quot;subclass of MappedAsDataclass.&quot;</span><span class="p">,</span>
</span><span data-line="1151">                    <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
</span><span data-line="1152">                    <span class="n">code</span><span class="o">=</span><span class="s2">&quot;dcmx&quot;</span><span class="p">,</span>
</span><span data-line="1153">                <span class="p">)</span>
</span><span data-line="1154">
</span><span data-line="1155">        <span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1156">        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1157">        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">:</span>
</span><span data-line="1158">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span data-line="1159">                <span class="n">name</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">item</span>
</span><span data-line="1160">            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span data-line="1161">                <span class="n">name</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">spec</span> <span class="o">=</span> <span class="n">item</span>
</span><span data-line="1162">                <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
</span><span data-line="1163">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1164">                <span class="k">assert</span> <span class="kc">False</span>
</span><span data-line="1165">            <span class="n">annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span>
</span><span data-line="1166">
</span><span data-line="1167">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="1168">            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span data-line="1169">
</span><span data-line="1170">        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_dataclasses_to_any_class</span><span class="p">(</span>
</span><span data-line="1171">            <span class="n">dataclass_setup_arguments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">annotations</span>
</span><span data-line="1172">        <span class="p">)</span>
</span><span data-line="1173">
</span><span data-line="1174">    <span class="nd">@classmethod</span>
</span><span data-line="1175">    <span class="k">def</span> <span class="nf">_update_annotations_for_non_mapped_class</span><span class="p">(</span>
</span><span data-line="1176">        <span class="bp">cls</span><span class="p">,</span> <span class="n">klass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
</span><span data-line="1177">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_AnnotationScanType</span><span class="p">]:</span>
</span><span data-line="1178">        <span class="n">cls_annotations</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
</span><span data-line="1179">
</span><span data-line="1180">        <span class="n">new_anno</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1181">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">cls_annotations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="1182">            <span class="k">if</span> <span class="n">_is_mapped_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">klass</span><span class="p">):</span>
</span><span data-line="1183">                <span class="n">extracted</span> <span class="o">=</span> <span class="n">_extract_mapped_subtype</span><span class="p">(</span>
</span><span data-line="1184">                    <span class="n">annotation</span><span class="p">,</span>
</span><span data-line="1185">                    <span class="n">klass</span><span class="p">,</span>
</span><span data-line="1186">                    <span class="n">klass</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
</span><span data-line="1187">                    <span class="n">name</span><span class="p">,</span>
</span><span data-line="1188">                    <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
</span><span data-line="1189">                    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="1190">                    <span class="n">is_dataclass_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="1191">                    <span class="n">expect_mapped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="1192">                <span class="p">)</span>
</span><span data-line="1193">                <span class="k">if</span> <span class="n">extracted</span><span class="p">:</span>
</span><span data-line="1194">                    <span class="n">inner</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extracted</span>
</span><span data-line="1195">                    <span class="n">new_anno</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">inner</span>
</span><span data-line="1196">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1197">                <span class="n">new_anno</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation</span>
</span><span data-line="1198">        <span class="k">return</span> <span class="n">new_anno</span>
</span><span data-line="1199">
</span><span data-line="1200">    <span class="nd">@classmethod</span>
</span><span data-line="1201">    <span class="k">def</span> <span class="nf">_apply_dataclasses_to_any_class</span><span class="p">(</span>
</span><span data-line="1202">        <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="1203">        <span class="n">dataclass_setup_arguments</span><span class="p">:</span> <span class="n">_DataclassArguments</span><span class="p">,</span>
</span><span data-line="1204">        <span class="n">klass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span data-line="1205">        <span class="n">use_annotations</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_AnnotationScanType</span><span class="p">],</span>
</span><span data-line="1206">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1207">        <span class="bp">cls</span><span class="o">.</span><span class="n">_assert_dc_arguments</span><span class="p">(</span><span class="n">dataclass_setup_arguments</span><span class="p">)</span>
</span><span data-line="1208">
</span><span data-line="1209">        <span class="n">dataclass_callable</span> <span class="o">=</span> <span class="n">dataclass_setup_arguments</span><span class="p">[</span><span class="s2">&quot;dataclass_callable&quot;</span><span class="p">]</span>
</span><span data-line="1210">        <span class="k">if</span> <span class="n">dataclass_callable</span> <span class="ow">is</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">:</span>
</span><span data-line="1211">            <span class="n">dataclass_callable</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
</span><span data-line="1212">
</span><span data-line="1213">        <span class="n">restored</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="1214">
</span><span data-line="1215">        <span class="k">if</span> <span class="n">use_annotations</span><span class="p">:</span>
</span><span data-line="1216">            <span class="c1"># apply constructed annotations that should look &quot;normal&quot; to a</span>
</span><span data-line="1217">            <span class="c1"># dataclasses callable, based on the fields present.  This</span>
</span><span data-line="1218">            <span class="c1"># means remove the Mapped[] container and ensure all Field</span>
</span><span data-line="1219">            <span class="c1"># entries have an annotation</span>
</span><span data-line="1220">            <span class="n">restored</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="s2">&quot;__annotations__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="1221">            <span class="n">klass</span><span class="o">.</span><span class="vm">__annotations__</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Dict[str, Any]&quot;</span><span class="p">,</span> <span class="n">use_annotations</span><span class="p">)</span>
</span><span data-line="1222">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1223">            <span class="n">restored</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1224">
</span><span data-line="1225">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1226">            <span class="n">dataclass_callable</span><span class="p">(</span>
</span><span data-line="1227">                <span class="n">klass</span><span class="p">,</span>
</span><span data-line="1228">                <span class="o">**</span><span class="p">{</span>
</span><span data-line="1229">                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
</span><span data-line="1230">                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataclass_setup_arguments</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span data-line="1231">                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;dataclass_callable&quot;</span>
</span><span data-line="1232">                <span class="p">},</span>
</span><span data-line="1233">            <span class="p">)</span>
</span><span data-line="1234">        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span><span data-line="1235">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1236">                <span class="sa">f</span><span class="s2">&quot;Python dataclasses error encountered when creating &quot;</span>
</span><span data-line="1237">                <span class="sa">f</span><span class="s2">&quot;dataclass for </span><span class="si">{</span><span class="n">klass</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2">: &quot;</span>
</span><span data-line="1238">                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ex</span><span class="si">!r}</span><span class="s2">. Please refer to Python dataclasses &quot;</span>
</span><span data-line="1239">                <span class="s2">&quot;documentation for additional information.&quot;</span><span class="p">,</span>
</span><span data-line="1240">                <span class="n">code</span><span class="o">=</span><span class="s2">&quot;dcte&quot;</span><span class="p">,</span>
</span><span data-line="1241">            <span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>
</span><span data-line="1242">        <span class="k">finally</span><span class="p">:</span>
</span><span data-line="1243">            <span class="c1"># restore original annotations outside of the dataclasses</span>
</span><span data-line="1244">            <span class="c1"># process; for mixins and __abstract__ superclasses, SQLAlchemy</span>
</span><span data-line="1245">            <span class="c1"># Declarative will need to see the Mapped[] container inside the</span>
</span><span data-line="1246">            <span class="c1"># annotations in order to map subclasses</span>
</span><span data-line="1247">            <span class="k">if</span> <span class="n">use_annotations</span><span class="p">:</span>
</span><span data-line="1248">                <span class="k">if</span> <span class="n">restored</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1249">                    <span class="k">del</span> <span class="n">klass</span><span class="o">.</span><span class="vm">__annotations__</span>
</span><span data-line="1250">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1251">                    <span class="n">klass</span><span class="o">.</span><span class="vm">__annotations__</span> <span class="o">=</span> <span class="n">restored</span>
</span><span data-line="1252">
</span><span data-line="1253">    <span class="nd">@classmethod</span>
</span><span data-line="1254">    <span class="k">def</span> <span class="nf">_assert_dc_arguments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">_DataclassArguments</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1255">        <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="1256">            <span class="s2">&quot;init&quot;</span><span class="p">,</span>
</span><span data-line="1257">            <span class="s2">&quot;repr&quot;</span><span class="p">,</span>
</span><span data-line="1258">            <span class="s2">&quot;order&quot;</span><span class="p">,</span>
</span><span data-line="1259">            <span class="s2">&quot;eq&quot;</span><span class="p">,</span>
</span><span data-line="1260">            <span class="s2">&quot;unsafe_hash&quot;</span><span class="p">,</span>
</span><span data-line="1261">            <span class="s2">&quot;kw_only&quot;</span><span class="p">,</span>
</span><span data-line="1262">            <span class="s2">&quot;match_args&quot;</span><span class="p">,</span>
</span><span data-line="1263">            <span class="s2">&quot;dataclass_callable&quot;</span><span class="p">,</span>
</span><span data-line="1264">        <span class="p">}</span>
</span><span data-line="1265">        <span class="n">disallowed_args</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">allowed</span><span class="p">)</span>
</span><span data-line="1266">        <span class="k">if</span> <span class="n">disallowed_args</span><span class="p">:</span>
</span><span data-line="1267">            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">disallowed_args</span><span class="p">))</span>
</span><span data-line="1268">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1269">                <span class="sa">f</span><span class="s2">&quot;Dataclass argument(s) </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> are not accepted&quot;</span>
</span><span data-line="1270">            <span class="p">)</span>
</span><span data-line="1271">
</span><span data-line="1272">    <span class="k">def</span> <span class="nf">_collect_annotation</span><span class="p">(</span>
</span><span data-line="1273">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1274">        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span data-line="1275">        <span class="n">raw_annotation</span><span class="p">:</span> <span class="n">_AnnotationScanType</span><span class="p">,</span>
</span><span data-line="1276">        <span class="n">originating_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1277">        <span class="n">expect_mapped</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
</span><span data-line="1278">        <span class="n">attr_value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span data-line="1279">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CollectedAnnotation</span><span class="p">]:</span>
</span><span data-line="1280">        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="p">:</span>
</span><span data-line="1281">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span data-line="1282">
</span><span data-line="1283">        <span class="k">if</span> <span class="n">raw_annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1284">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="1285">
</span><span data-line="1286">        <span class="n">is_dataclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dataclass_prior_to_mapping</span>
</span><span data-line="1287">        <span class="n">allow_unmapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unmapped_annotations</span>
</span><span data-line="1288">
</span><span data-line="1289">        <span class="k">if</span> <span class="n">expect_mapped</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1290">            <span class="n">is_dataclass_field</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span><span class="p">)</span>
</span><span data-line="1291">            <span class="n">expect_mapped</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1292">                <span class="ow">not</span> <span class="n">is_dataclass_field</span>
</span><span data-line="1293">                <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_unmapped</span>
</span><span data-line="1294">                <span class="ow">and</span> <span class="p">(</span>
</span><span data-line="1295">                    <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1296">                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="n">_MappedAttribute</span><span class="p">)</span>
</span><span data-line="1297">                <span class="p">)</span>
</span><span data-line="1298">            <span class="p">)</span>
</span><span data-line="1299">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1300">            <span class="n">is_dataclass_field</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1301">
</span><span data-line="1302">        <span class="n">is_dataclass_field</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="1303">        <span class="n">extracted</span> <span class="o">=</span> <span class="n">_extract_mapped_subtype</span><span class="p">(</span>
</span><span data-line="1304">            <span class="n">raw_annotation</span><span class="p">,</span>
</span><span data-line="1305">            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span>
</span><span data-line="1306">            <span class="n">originating_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
</span><span data-line="1307">            <span class="n">name</span><span class="p">,</span>
</span><span data-line="1308">            <span class="nb">type</span><span class="p">(</span><span class="n">attr_value</span><span class="p">),</span>
</span><span data-line="1309">            <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="1310">            <span class="n">is_dataclass_field</span><span class="o">=</span><span class="n">is_dataclass_field</span><span class="p">,</span>
</span><span data-line="1311">            <span class="n">expect_mapped</span><span class="o">=</span><span class="n">expect_mapped</span>
</span><span data-line="1312">            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_dataclass</span><span class="p">,</span>  <span class="c1"># self.allow_dataclass_fields,</span>
</span><span data-line="1313">        <span class="p">)</span>
</span><span data-line="1314">
</span><span data-line="1315">        <span class="k">if</span> <span class="n">extracted</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1316">            <span class="c1"># ClassVar can come out here</span>
</span><span data-line="1317">            <span class="k">return</span> <span class="kc">None</span>
</span><span data-line="1318">
</span><span data-line="1319">        <span class="n">extracted_mapped_annotation</span><span class="p">,</span> <span class="n">mapped_container</span> <span class="o">=</span> <span class="n">extracted</span>
</span><span data-line="1320">
</span><span data-line="1321">        <span class="k">if</span> <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_literal</span><span class="p">(</span><span class="n">extracted_mapped_annotation</span><span class="p">):</span>
</span><span data-line="1322">            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">typing_get_args</span><span class="p">(</span><span class="n">extracted_mapped_annotation</span><span class="p">):</span>
</span><span data-line="1323">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_fwd_ref</span><span class="p">(</span>
</span><span data-line="1324">                    <span class="n">elem</span><span class="p">,</span> <span class="n">check_generic</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="1325">                <span class="p">):</span>
</span><span data-line="1326">                    <span class="n">elem</span> <span class="o">=</span> <span class="n">de_stringify_annotation</span><span class="p">(</span>
</span><span data-line="1327">                        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span>
</span><span data-line="1328">                        <span class="n">elem</span><span class="p">,</span>
</span><span data-line="1329">                        <span class="n">originating_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
</span><span data-line="1330">                        <span class="n">include_generic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="1331">                    <span class="p">)</span>
</span><span data-line="1332">                <span class="c1"># look in Annotated[...] for an ORM construct,</span>
</span><span data-line="1333">                <span class="c1"># such as Annotated[int, mapped_column(primary_key=True)]</span>
</span><span data-line="1334">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">_IntrospectsAnnotations</span><span class="p">):</span>
</span><span data-line="1335">                    <span class="n">attr_value</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">found_in_pep593_annotated</span><span class="p">()</span>
</span><span data-line="1336">
</span><span data-line="1337">        <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">_CollectedAnnotation</span><span class="p">(</span>
</span><span data-line="1338">            <span class="n">raw_annotation</span><span class="p">,</span>
</span><span data-line="1339">            <span class="n">mapped_container</span><span class="p">,</span>
</span><span data-line="1340">            <span class="n">extracted_mapped_annotation</span><span class="p">,</span>
</span><span data-line="1341">            <span class="n">is_dataclass</span><span class="p">,</span>
</span><span data-line="1342">            <span class="n">attr_value</span><span class="p">,</span>
</span><span data-line="1343">            <span class="n">originating_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
</span><span data-line="1344">            <span class="n">originating_class</span><span class="p">,</span>
</span><span data-line="1345">        <span class="p">)</span>
</span><span data-line="1346">        <span class="k">return</span> <span class="n">ca</span>
</span><span data-line="1347">
</span><span data-line="1348">    <span class="k">def</span> <span class="nf">_warn_for_decl_attributes</span><span class="p">(</span>
</span><span data-line="1349">        <span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">Any</span>
</span><span data-line="1350">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1351">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnElement</span><span class="p">):</span>
</span><span data-line="1352">            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="1353">                <span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; on class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2"> appears to &quot;</span>
</span><span data-line="1354">                <span class="s2">&quot;be a non-schema SQLAlchemy expression &quot;</span>
</span><span data-line="1355">                <span class="s2">&quot;object; this won&#39;t be part of the declarative mapping. &quot;</span>
</span><span data-line="1356">                <span class="s2">&quot;To map arbitrary expressions, use ``column_property()`` &quot;</span>
</span><span data-line="1357">                <span class="s2">&quot;or a similar function such as ``deferred()``, &quot;</span>
</span><span data-line="1358">                <span class="s2">&quot;``query_expression()`` etc. &quot;</span>
</span><span data-line="1359">            <span class="p">)</span>
</span><span data-line="1360">
</span><span data-line="1361">    <span class="k">def</span> <span class="nf">_produce_column_copies</span><span class="p">(</span>
</span><span data-line="1362">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1363">        <span class="n">attributes_for_class</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
</span><span data-line="1364">            <span class="p">[],</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
</span><span data-line="1365">        <span class="p">],</span>
</span><span data-line="1366">        <span class="n">attribute_is_overridden</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
</span><span data-line="1367">        <span class="n">fixed_table</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span data-line="1368">        <span class="n">originating_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span data-line="1369">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">MappedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
</span><span data-line="1370">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span data-line="1371">        <span class="n">dict_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span>
</span><span data-line="1372">        <span class="n">locally_collected_attributes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1373">        <span class="n">column_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span>
</span><span data-line="1374">        <span class="c1"># copy mixin columns to the mapped class</span>
</span><span data-line="1375">
</span><span data-line="1376">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">is_dataclass</span> <span class="ow">in</span> <span class="n">attributes_for_class</span><span class="p">():</span>
</span><span data-line="1377">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1378">                <span class="ow">not</span> <span class="n">fixed_table</span>
</span><span data-line="1379">                <span class="ow">and</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1380">                <span class="ow">and</span> <span class="n">_is_mapped_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">)</span>
</span><span data-line="1381">            <span class="p">):</span>
</span><span data-line="1382">                <span class="c1"># obj is None means this is the annotation only path</span>
</span><span data-line="1383">
</span><span data-line="1384">                <span class="k">if</span> <span class="n">attribute_is_overridden</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span><span data-line="1385">                    <span class="c1"># perform same &quot;overridden&quot; check as we do for</span>
</span><span data-line="1386">                    <span class="c1"># Column/MappedColumn, this is how a mixin col is not</span>
</span><span data-line="1387">                    <span class="c1"># applied to an inherited subclass that does not have</span>
</span><span data-line="1388">                    <span class="c1"># the mixin.   the anno-only path added here for</span>
</span><span data-line="1389">                    <span class="c1"># #9564</span>
</span><span data-line="1390">                    <span class="k">continue</span>
</span><span data-line="1391">
</span><span data-line="1392">                <span class="n">collected_annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
</span><span data-line="1393">                    <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">obj</span>
</span><span data-line="1394">                <span class="p">)</span>
</span><span data-line="1395">                <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1396">                    <span class="n">collected_annotation</span><span class="o">.</span><span class="n">attr_value</span>
</span><span data-line="1397">                    <span class="k">if</span> <span class="n">collected_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1398">                    <span class="k">else</span> <span class="n">obj</span>
</span><span data-line="1399">                <span class="p">)</span>
</span><span data-line="1400">                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1401">                    <span class="n">obj</span> <span class="o">=</span> <span class="n">MappedColumn</span><span class="p">()</span>
</span><span data-line="1402">
</span><span data-line="1403">                <span class="n">locally_collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span><span data-line="1404">                <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span data-line="1405">
</span><span data-line="1406">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">MappedColumn</span><span class="p">)):</span>
</span><span data-line="1407">                <span class="k">if</span> <span class="n">attribute_is_overridden</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span><span data-line="1408">                    <span class="c1"># if column has been overridden</span>
</span><span data-line="1409">                    <span class="c1"># (like by the InstrumentedAttribute of the</span>
</span><span data-line="1410">                    <span class="c1"># superclass), skip.  don&#39;t collect the annotation</span>
</span><span data-line="1411">                    <span class="c1"># either (issue #8718)</span>
</span><span data-line="1412">                    <span class="k">continue</span>
</span><span data-line="1413">
</span><span data-line="1414">                <span class="n">collected_annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
</span><span data-line="1415">                    <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">obj</span>
</span><span data-line="1416">                <span class="p">)</span>
</span><span data-line="1417">                <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1418">                    <span class="n">collected_annotation</span><span class="o">.</span><span class="n">attr_value</span>
</span><span data-line="1419">                    <span class="k">if</span> <span class="n">collected_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1420">                    <span class="k">else</span> <span class="n">obj</span>
</span><span data-line="1421">                <span class="p">)</span>
</span><span data-line="1422">
</span><span data-line="1423">                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
</span><span data-line="1424">                    <span class="s2">&quot;__table__&quot;</span> <span class="ow">in</span> <span class="n">dict_</span>
</span><span data-line="1425">                    <span class="ow">and</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>
</span><span data-line="1426">                    <span class="ow">in</span> <span class="n">dict_</span><span class="p">[</span><span class="s2">&quot;__table__&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">c</span>
</span><span data-line="1427">                <span class="p">):</span>
</span><span data-line="1428">                    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
</span><span data-line="1429">                        <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
</span><span data-line="1430">                            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1431">                                <span class="n">fk</span><span class="o">.</span><span class="n">_table_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1432">                                <span class="ow">and</span> <span class="n">fk</span><span class="o">.</span><span class="n">_table_column</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1433">                            <span class="p">):</span>
</span><span data-line="1434">                                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1435">                                    <span class="s2">&quot;Columns with foreign keys to &quot;</span>
</span><span data-line="1436">                                    <span class="s2">&quot;non-table-bound &quot;</span>
</span><span data-line="1437">                                    <span class="s2">&quot;columns must be declared as &quot;</span>
</span><span data-line="1438">                                    <span class="s2">&quot;@declared_attr callables &quot;</span>
</span><span data-line="1439">                                    <span class="s2">&quot;on declarative mixin classes.  &quot;</span>
</span><span data-line="1440">                                    <span class="s2">&quot;For dataclass &quot;</span>
</span><span data-line="1441">                                    <span class="s2">&quot;field() objects, use a lambda:.&quot;</span>
</span><span data-line="1442">                                <span class="p">)</span>
</span><span data-line="1443">
</span><span data-line="1444">                    <span class="n">column_copies</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_copy</span><span class="p">()</span>
</span><span data-line="1445">
</span><span data-line="1446">                    <span class="n">locally_collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy_</span>
</span><span data-line="1447">                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">copy_</span><span class="p">)</span>
</span><span data-line="1448">
</span><span data-line="1449">        <span class="k">return</span> <span class="n">locally_collected_attributes</span>
</span><span data-line="1450">
</span><span data-line="1451">    <span class="k">def</span> <span class="nf">_extract_mappable_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1452">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span data-line="1453">        <span class="n">collected_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span>
</span><span data-line="1454">
</span><span data-line="1455">        <span class="n">our_stuff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
</span><span data-line="1456">
</span><span data-line="1457">        <span class="n">_include_dunders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_dunders</span>
</span><span data-line="1458">
</span><span data-line="1459">        <span class="n">late_mapped</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
</span><span data-line="1460">            <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_sa_decl_prepare_nocascade&quot;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="1461">        <span class="p">)</span>
</span><span data-line="1462">
</span><span data-line="1463">        <span class="n">allow_unmapped_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unmapped_annotations</span>
</span><span data-line="1464">        <span class="n">expect_annotations_wo_mapped</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1465">            <span class="n">allow_unmapped_annotations</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dataclass_prior_to_mapping</span>
</span><span data-line="1466">        <span class="p">)</span>
</span><span data-line="1467">
</span><span data-line="1468">        <span class="n">look_for_dataclass_things</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataclass_setup_arguments</span><span class="p">)</span>
</span><span data-line="1469">
</span><span data-line="1470">        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">collected_attributes</span><span class="p">):</span>
</span><span data-line="1471">            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_include_dunders</span><span class="p">:</span>
</span><span data-line="1472">                <span class="k">continue</span>
</span><span data-line="1473">
</span><span data-line="1474">            <span class="n">value</span> <span class="o">=</span> <span class="n">collected_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span data-line="1475">
</span><span data-line="1476">            <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span><span data-line="1477">                <span class="c1"># @declared_attr in collected_attributes only occurs here for a</span>
</span><span data-line="1478">                <span class="c1"># @declared_attr that&#39;s directly on the mapped class;</span>
</span><span data-line="1479">                <span class="c1"># for a mixin, these have already been evaluated</span>
</span><span data-line="1480">                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">_cascading</span><span class="p">:</span>
</span><span data-line="1481">                    <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="1482">                        <span class="s2">&quot;Use of @declared_attr.cascading only applies to &quot;</span>
</span><span data-line="1483">                        <span class="s2">&quot;Declarative &#39;mixin&#39; and &#39;abstract&#39; classes.  &quot;</span>
</span><span data-line="1484">                        <span class="s2">&quot;Currently, this flag is ignored on mapped class &quot;</span>
</span><span data-line="1485">                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span data-line="1486">                    <span class="p">)</span>
</span><span data-line="1487">
</span><span data-line="1488">                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span data-line="1489">
</span><span data-line="1490">            <span class="k">elif</span> <span class="p">(</span>
</span><span data-line="1491">                <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">QueryableAttribute</span><span class="p">)</span>
</span><span data-line="1492">                <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">class_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span>
</span><span data-line="1493">                <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">k</span>
</span><span data-line="1494">            <span class="p">):</span>
</span><span data-line="1495">                <span class="c1"># detect a QueryableAttribute that&#39;s already mapped being</span>
</span><span data-line="1496">                <span class="c1"># assigned elsewhere in userland, turn into a synonym()</span>
</span><span data-line="1497">                <span class="n">value</span> <span class="o">=</span> <span class="n">SynonymProperty</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="1498">                <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="1499">
</span><span data-line="1500">            <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1501">                <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
</span><span data-line="1502">                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span data-line="1503">                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">_MappedAttribute</span><span class="p">))</span>
</span><span data-line="1504">            <span class="p">):</span>
</span><span data-line="1505">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="1506">                    <span class="s2">&quot;Ignoring declarative-like tuple value of attribute &quot;</span>
</span><span data-line="1507">                    <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;: possibly a copy-and-paste error with a comma &quot;</span>
</span><span data-line="1508">                    <span class="s2">&quot;accidentally placed at the end of the line?&quot;</span> <span class="o">%</span> <span class="n">k</span>
</span><span data-line="1509">                <span class="p">)</span>
</span><span data-line="1510">                <span class="k">continue</span>
</span><span data-line="1511">            <span class="k">elif</span> <span class="n">look_for_dataclass_things</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span data-line="1512">                <span class="n">value</span><span class="p">,</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span>
</span><span data-line="1513">            <span class="p">):</span>
</span><span data-line="1514">                <span class="c1"># we collected a dataclass Field; dataclasses would have</span>
</span><span data-line="1515">                <span class="c1"># set up the correct state on the class</span>
</span><span data-line="1516">                <span class="k">continue</span>
</span><span data-line="1517">            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">_DCAttributeOptions</span><span class="p">)):</span>
</span><span data-line="1518">                <span class="c1"># using @declared_attr for some object that</span>
</span><span data-line="1519">                <span class="c1"># isn&#39;t Column/MapperProperty/_DCAttributeOptions; remove</span>
</span><span data-line="1520">                <span class="c1"># from the clsdict_view</span>
</span><span data-line="1521">                <span class="c1"># and place the evaluated value onto the class.</span>
</span><span data-line="1522">                <span class="n">collected_attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span data-line="1523">                <span class="bp">self</span><span class="o">.</span><span class="n">_warn_for_decl_attributes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="1524">                <span class="k">if</span> <span class="ow">not</span> <span class="n">late_mapped</span><span class="p">:</span>
</span><span data-line="1525">                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="1526">                <span class="k">continue</span>
</span><span data-line="1527">            <span class="c1"># we expect to see the name &#39;metadata&#39; in some valid cases;</span>
</span><span data-line="1528">            <span class="c1"># however at this point we see it&#39;s assigned to something trying</span>
</span><span data-line="1529">            <span class="c1"># to be mapped, so raise for that.</span>
</span><span data-line="1530">            <span class="c1"># TODO: should &quot;registry&quot; here be also?   might be too late</span>
</span><span data-line="1531">            <span class="c1"># to change that now (2.0 betas)</span>
</span><span data-line="1532">            <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,):</span>
</span><span data-line="1533">                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1534">                    <span class="sa">f</span><span class="s2">&quot;Attribute name &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; is reserved when using the &quot;</span>
</span><span data-line="1535">                    <span class="s2">&quot;Declarative API.&quot;</span>
</span><span data-line="1536">                <span class="p">)</span>
</span><span data-line="1537">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
</span><span data-line="1538">                <span class="n">_undefer_column_name</span><span class="p">(</span>
</span><span data-line="1539">                    <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span data-line="1540">                <span class="p">)</span>
</span><span data-line="1541">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1542">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_IntrospectsAnnotations</span><span class="p">):</span>
</span><span data-line="1543">                    <span class="p">(</span>
</span><span data-line="1544">                        <span class="n">annotation</span><span class="p">,</span>
</span><span data-line="1545">                        <span class="n">mapped_container</span><span class="p">,</span>
</span><span data-line="1546">                        <span class="n">extracted_mapped_annotation</span><span class="p">,</span>
</span><span data-line="1547">                        <span class="n">is_dataclass</span><span class="p">,</span>
</span><span data-line="1548">                        <span class="n">attr_value</span><span class="p">,</span>
</span><span data-line="1549">                        <span class="n">originating_module</span><span class="p">,</span>
</span><span data-line="1550">                        <span class="n">originating_class</span><span class="p">,</span>
</span><span data-line="1551">                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span data-line="1552">                        <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="1553">                    <span class="p">)</span>
</span><span data-line="1554">
</span><span data-line="1555">                    <span class="c1"># issue #8692 - don&#39;t do any annotation interpretation if</span>
</span><span data-line="1556">                    <span class="c1"># an annotation were present and a container such as</span>
</span><span data-line="1557">                    <span class="c1"># Mapped[] etc. were not used.  If annotation is None,</span>
</span><span data-line="1558">                    <span class="c1"># do declarative_scan so that the property can raise</span>
</span><span data-line="1559">                    <span class="c1"># for required</span>
</span><span data-line="1560">                    <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1561">                        <span class="n">mapped_container</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1562">                        <span class="ow">or</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1563">                        <span class="c1"># issue #10516: need to do declarative_scan even with</span>
</span><span data-line="1564">                        <span class="c1"># a non-Mapped annotation if we are doing</span>
</span><span data-line="1565">                        <span class="c1"># __allow_unmapped__, for things like col.name</span>
</span><span data-line="1566">                        <span class="c1"># assignment</span>
</span><span data-line="1567">                        <span class="ow">or</span> <span class="n">allow_unmapped_annotations</span>
</span><span data-line="1568">                    <span class="p">):</span>
</span><span data-line="1569">                        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1570">                            <span class="n">value</span><span class="o">.</span><span class="n">declarative_scan</span><span class="p">(</span>
</span><span data-line="1571">                                <span class="bp">self</span><span class="p">,</span>
</span><span data-line="1572">                                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span>
</span><span data-line="1573">                                <span class="bp">cls</span><span class="p">,</span>
</span><span data-line="1574">                                <span class="n">originating_module</span><span class="p">,</span>
</span><span data-line="1575">                                <span class="n">k</span><span class="p">,</span>
</span><span data-line="1576">                                <span class="n">mapped_container</span><span class="p">,</span>
</span><span data-line="1577">                                <span class="n">annotation</span><span class="p">,</span>
</span><span data-line="1578">                                <span class="n">extracted_mapped_annotation</span><span class="p">,</span>
</span><span data-line="1579">                                <span class="n">is_dataclass</span><span class="p">,</span>
</span><span data-line="1580">                            <span class="p">)</span>
</span><span data-line="1581">                        <span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">ne</span><span class="p">:</span>
</span><span data-line="1582">                            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1583">                                <span class="sa">f</span><span class="s2">&quot;Could not resolve all types within mapped &quot;</span>
</span><span data-line="1584">                                <span class="sa">f</span><span class="s1">&#39;annotation: &quot;</span><span class="si">{</span><span class="n">annotation</span><span class="si">}</span><span class="s1">&quot;.  Ensure all &#39;</span>
</span><span data-line="1585">                                <span class="sa">f</span><span class="s2">&quot;types are written correctly and are &quot;</span>
</span><span data-line="1586">                                <span class="sa">f</span><span class="s2">&quot;imported within the module in use.&quot;</span>
</span><span data-line="1587">                            <span class="p">)</span> <span class="kn">from</span> <span class="nn">ne</span>
</span><span data-line="1588">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="1589">                        <span class="c1"># assert that we were expecting annotations</span>
</span><span data-line="1590">                        <span class="c1"># without Mapped[] were going to be passed.</span>
</span><span data-line="1591">                        <span class="c1"># otherwise an error should have been raised</span>
</span><span data-line="1592">                        <span class="c1"># by util._extract_mapped_subtype before we got here.</span>
</span><span data-line="1593">                        <span class="k">assert</span> <span class="n">expect_annotations_wo_mapped</span>
</span><span data-line="1594">
</span><span data-line="1595">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_DCAttributeOptions</span><span class="p">):</span>
</span><span data-line="1596">                    <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1597">                        <span class="n">value</span><span class="o">.</span><span class="n">_has_dataclass_arguments</span>
</span><span data-line="1598">                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">look_for_dataclass_things</span>
</span><span data-line="1599">                    <span class="p">):</span>
</span><span data-line="1600">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">):</span>
</span><span data-line="1601">                            <span class="n">argnames</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="1602">                                <span class="s2">&quot;init&quot;</span><span class="p">,</span>
</span><span data-line="1603">                                <span class="s2">&quot;default_factory&quot;</span><span class="p">,</span>
</span><span data-line="1604">                                <span class="s2">&quot;repr&quot;</span><span class="p">,</span>
</span><span data-line="1605">                                <span class="s2">&quot;default&quot;</span><span class="p">,</span>
</span><span data-line="1606">                            <span class="p">]</span>
</span><span data-line="1607">                        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1608">                            <span class="n">argnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="s2">&quot;default_factory&quot;</span><span class="p">,</span> <span class="s2">&quot;repr&quot;</span><span class="p">]</span>
</span><span data-line="1609">
</span><span data-line="1610">                        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="1611">                            <span class="n">a</span>
</span><span data-line="1612">                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">argnames</span>
</span><span data-line="1613">                            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span>
</span><span data-line="1614">                                <span class="n">value</span><span class="o">.</span><span class="n">_attribute_options</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;dataclasses_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="1615">                            <span class="p">)</span>
</span><span data-line="1616">                            <span class="ow">is</span> <span class="ow">not</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span>
</span><span data-line="1617">                        <span class="p">}</span>
</span><span data-line="1618">
</span><span data-line="1619">                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1620">                            <span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; on class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2"> includes &quot;</span>
</span><span data-line="1621">                            <span class="sa">f</span><span class="s2">&quot;dataclasses argument(s): &quot;</span>
</span><span data-line="1622">                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">args</span><span class="p">))</span><span class="si">}</span><span class="s2"> but &quot;</span>
</span><span data-line="1623">                            <span class="sa">f</span><span class="s2">&quot;class does not specify &quot;</span>
</span><span data-line="1624">                            <span class="s2">&quot;SQLAlchemy native dataclass configuration.&quot;</span>
</span><span data-line="1625">                        <span class="p">)</span>
</span><span data-line="1626">
</span><span data-line="1627">                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">MapperProperty</span><span class="p">,</span> <span class="n">_MapsColumns</span><span class="p">)):</span>
</span><span data-line="1628">                        <span class="c1"># filter for _DCAttributeOptions objects that aren&#39;t</span>
</span><span data-line="1629">                        <span class="c1"># MapperProperty / mapped_column().  Currently this</span>
</span><span data-line="1630">                        <span class="c1"># includes AssociationProxy.   pop it from the things</span>
</span><span data-line="1631">                        <span class="c1"># we&#39;re going to map and set it up as a descriptor</span>
</span><span data-line="1632">                        <span class="c1"># on the class.</span>
</span><span data-line="1633">                        <span class="n">collected_attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span data-line="1634">
</span><span data-line="1635">                        <span class="c1"># Assoc Prox (or other descriptor object that may</span>
</span><span data-line="1636">                        <span class="c1"># use _DCAttributeOptions) is usually here, except if</span>
</span><span data-line="1637">                        <span class="c1"># 1. we&#39;re a</span>
</span><span data-line="1638">                        <span class="c1"># dataclass, dataclasses would have removed the</span>
</span><span data-line="1639">                        <span class="c1"># attr here or 2. assoc proxy is coming from a</span>
</span><span data-line="1640">                        <span class="c1"># superclass, we want it to be direct here so it</span>
</span><span data-line="1641">                        <span class="c1"># tracks state or 3. assoc prox comes from</span>
</span><span data-line="1642">                        <span class="c1"># declared_attr, uncommon case</span>
</span><span data-line="1643">                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="1644">                        <span class="k">continue</span>
</span><span data-line="1645">
</span><span data-line="1646">            <span class="n">our_stuff</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="1647">
</span><span data-line="1648">    <span class="k">def</span> <span class="nf">_extract_declared_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1649">        <span class="n">our_stuff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
</span><span data-line="1650">
</span><span data-line="1651">        <span class="c1"># extract columns from the class dict</span>
</span><span data-line="1652">        <span class="n">declared_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span>
</span><span data-line="1653">        <span class="n">column_ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ordering</span>
</span><span data-line="1654">        <span class="n">name_to_prop_key</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
</span><span data-line="1655">
</span><span data-line="1656">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">our_stuff</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span data-line="1657">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">_MapsColumns</span><span class="p">):</span>
</span><span data-line="1658">                <span class="n">mp_to_assign</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">mapper_property_to_assign</span>
</span><span data-line="1659">                <span class="k">if</span> <span class="n">mp_to_assign</span><span class="p">:</span>
</span><span data-line="1660">                    <span class="n">our_stuff</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp_to_assign</span>
</span><span data-line="1661">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1662">                    <span class="c1"># if no mapper property to assign, this currently means</span>
</span><span data-line="1663">                    <span class="c1"># this is a MappedColumn that will produce a Column for us</span>
</span><span data-line="1664">                    <span class="k">del</span> <span class="n">our_stuff</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1665">
</span><span data-line="1666">                <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">sort_order</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">columns_to_assign</span><span class="p">:</span>
</span><span data-line="1667">                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">CompositeProperty</span><span class="p">):</span>
</span><span data-line="1668">                        <span class="n">name_to_prop_key</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="1669">                    <span class="n">declared_columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
</span><span data-line="1670">
</span><span data-line="1671">                    <span class="c1"># we would assert this, however we want the below</span>
</span><span data-line="1672">                    <span class="c1"># warning to take effect instead.  See #9630</span>
</span><span data-line="1673">                    <span class="c1"># assert col not in column_ordering</span>
</span><span data-line="1674">
</span><span data-line="1675">                    <span class="n">column_ordering</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">sort_order</span>
</span><span data-line="1676">
</span><span data-line="1677">                    <span class="c1"># if this is a MappedColumn and the attribute key we</span>
</span><span data-line="1678">                    <span class="c1"># have is not what the column has for its key, map the</span>
</span><span data-line="1679">                    <span class="c1"># Column explicitly under the attribute key name.</span>
</span><span data-line="1680">                    <span class="c1"># otherwise, Mapper will map it under the column key.</span>
</span><span data-line="1681">                    <span class="k">if</span> <span class="n">mp_to_assign</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">col</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span data-line="1682">                        <span class="n">our_stuff</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
</span><span data-line="1683">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
</span><span data-line="1684">                <span class="c1"># undefer previously occurred here, and now occurs earlier.</span>
</span><span data-line="1685">                <span class="c1"># ensure every column we get here has been named</span>
</span><span data-line="1686">                <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1687">                <span class="n">name_to_prop_key</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="1688">                <span class="n">declared_columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="1689">                <span class="c1"># if the column is the same name as the key,</span>
</span><span data-line="1690">                <span class="c1"># remove it from the explicit properties dict.</span>
</span><span data-line="1691">                <span class="c1"># the normal rules for assigning column-based properties</span>
</span><span data-line="1692">                <span class="c1"># will take over, including precedence of columns</span>
</span><span data-line="1693">                <span class="c1"># in multi-column ColumnProperties.</span>
</span><span data-line="1694">                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span data-line="1695">                    <span class="k">del</span> <span class="n">our_stuff</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="1696">
</span><span data-line="1697">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">name_to_prop_key</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="1698">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="1699">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span data-line="1700">                    <span class="s2">&quot;On class </span><span class="si">%r</span><span class="s2">, Column object </span><span class="si">%r</span><span class="s2"> named &quot;</span>
</span><span data-line="1701">                    <span class="s2">&quot;directly multiple times, &quot;</span>
</span><span data-line="1702">                    <span class="s2">&quot;only one will be used: </span><span class="si">%s</span><span class="s2">. &quot;</span>
</span><span data-line="1703">                    <span class="s2">&quot;Consider using orm.synonym instead&quot;</span>
</span><span data-line="1704">                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classname</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">))))</span>
</span><span data-line="1705">                <span class="p">)</span>
</span><span data-line="1706">
</span><span data-line="1707">    <span class="k">def</span> <span class="nf">_setup_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1708">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span data-line="1709">        <span class="n">cls_as_Decl</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;MappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span data-line="1710">
</span><span data-line="1711">        <span class="n">tablename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span>
</span><span data-line="1712">        <span class="n">table_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_args</span>
</span><span data-line="1713">        <span class="n">clsdict_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span>
</span><span data-line="1714">        <span class="n">declared_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span>
</span><span data-line="1715">        <span class="n">column_ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ordering</span>
</span><span data-line="1716">
</span><span data-line="1717">        <span class="n">manager</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">manager_of_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span data-line="1718">
</span><span data-line="1719">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1720">            <span class="bp">self</span><span class="o">.</span><span class="n">table_fn</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1721">            <span class="ow">and</span> <span class="s2">&quot;__table__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clsdict_view</span>
</span><span data-line="1722">            <span class="ow">and</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1723">        <span class="p">):</span>
</span><span data-line="1724">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__table_cls__&quot;</span><span class="p">):</span>
</span><span data-line="1725">                <span class="n">table_cls</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="1726">                    <span class="n">Type</span><span class="p">[</span><span class="n">Table</span><span class="p">],</span>
</span><span data-line="1727">                    <span class="n">util</span><span class="o">.</span><span class="n">unbound_method_to_callable</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__table_cls__</span><span class="p">),</span>  <span class="c1"># type: ignore  # noqa: E501</span>
</span><span data-line="1728">                <span class="p">)</span>
</span><span data-line="1729">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1730">                <span class="n">table_cls</span> <span class="o">=</span> <span class="n">Table</span>
</span><span data-line="1731">
</span><span data-line="1732">            <span class="k">if</span> <span class="n">tablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1733">                <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
</span><span data-line="1734">                <span class="n">table_kw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1735">
</span><span data-line="1736">                <span class="k">if</span> <span class="n">table_args</span><span class="p">:</span>
</span><span data-line="1737">                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span data-line="1738">                        <span class="n">table_kw</span> <span class="o">=</span> <span class="n">table_args</span>
</span><span data-line="1739">                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
</span><span data-line="1740">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
</span><span data-line="1741">                            <span class="n">args</span><span class="p">,</span> <span class="n">table_kw</span> <span class="o">=</span> <span class="n">table_args</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">table_args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="1742">                        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1743">                            <span class="n">args</span> <span class="o">=</span> <span class="n">table_args</span>
</span><span data-line="1744">
</span><span data-line="1745">                <span class="n">autoload_with</span> <span class="o">=</span> <span class="n">clsdict_view</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__autoload_with__&quot;</span><span class="p">)</span>
</span><span data-line="1746">                <span class="k">if</span> <span class="n">autoload_with</span><span class="p">:</span>
</span><span data-line="1747">                    <span class="n">table_kw</span><span class="p">[</span><span class="s2">&quot;autoload_with&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">autoload_with</span>
</span><span data-line="1748">
</span><span data-line="1749">                <span class="n">autoload</span> <span class="o">=</span> <span class="n">clsdict_view</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__autoload__&quot;</span><span class="p">)</span>
</span><span data-line="1750">                <span class="k">if</span> <span class="n">autoload</span><span class="p">:</span>
</span><span data-line="1751">                    <span class="n">table_kw</span><span class="p">[</span><span class="s2">&quot;autoload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1752">
</span><span data-line="1753">                <span class="n">sorted_columns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span data-line="1754">                    <span class="n">declared_columns</span><span class="p">,</span>
</span><span data-line="1755">                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">column_ordering</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span data-line="1756">                <span class="p">)</span>
</span><span data-line="1757">                <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span>
</span><span data-line="1758">                    <span class="s2">&quot;__table__&quot;</span><span class="p">,</span>
</span><span data-line="1759">                    <span class="n">table_cls</span><span class="p">(</span>
</span><span data-line="1760">                        <span class="n">tablename</span><span class="p">,</span>
</span><span data-line="1761">                        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_for_cls</span><span class="p">(</span><span class="n">manager</span><span class="p">),</span>
</span><span data-line="1762">                        <span class="o">*</span><span class="n">sorted_columns</span><span class="p">,</span>
</span><span data-line="1763">                        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
</span><span data-line="1764">                        <span class="o">**</span><span class="n">table_kw</span><span class="p">,</span>
</span><span data-line="1765">                    <span class="p">),</span>
</span><span data-line="1766">                <span class="p">)</span>
</span><span data-line="1767">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1768">            <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1769">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_fn</span><span class="p">:</span>
</span><span data-line="1770">                    <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span>
</span><span data-line="1771">                        <span class="s2">&quot;__table__&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_fn</span><span class="p">()</span>
</span><span data-line="1772">                    <span class="p">)</span>
</span><span data-line="1773">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1774">                    <span class="n">table</span> <span class="o">=</span> <span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__table__</span>
</span><span data-line="1775">            <span class="k">if</span> <span class="n">declared_columns</span><span class="p">:</span>
</span><span data-line="1776">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">declared_columns</span><span class="p">:</span>
</span><span data-line="1777">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span><span data-line="1778">                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1779">                            <span class="s2">&quot;Can&#39;t add additional column </span><span class="si">%r</span><span class="s2"> when &quot;</span>
</span><span data-line="1780">                            <span class="s2">&quot;specifying __table__&quot;</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="1781">                        <span class="p">)</span>
</span><span data-line="1782">
</span><span data-line="1783">        <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="o">=</span> <span class="n">table</span>
</span><span data-line="1784">
</span><span data-line="1785">    <span class="k">def</span> <span class="nf">_metadata_for_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">ClassManager</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MetaData</span><span class="p">:</span>
</span><span data-line="1786">        <span class="n">meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MetaData</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="1787">        <span class="k">if</span> <span class="n">meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1788">            <span class="k">return</span> <span class="n">meta</span>
</span><span data-line="1789">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1790">            <span class="k">return</span> <span class="n">manager</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">metadata</span>
</span><span data-line="1791">
</span><span data-line="1792">    <span class="k">def</span> <span class="nf">_setup_inheriting_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1793">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span data-line="1794">
</span><span data-line="1795">        <span class="n">inherits</span> <span class="o">=</span> <span class="n">mapper_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inherits&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="1796">
</span><span data-line="1797">        <span class="k">if</span> <span class="n">inherits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1798">            <span class="c1"># since we search for classical mappings now, search for</span>
</span><span data-line="1799">            <span class="c1"># multiple mapped bases as well and raise an error.</span>
</span><span data-line="1800">            <span class="n">inherits_search</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1801">            <span class="k">for</span> <span class="n">base_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
</span><span data-line="1802">                <span class="n">c</span> <span class="o">=</span> <span class="n">_resolve_for_abstract_or_classical</span><span class="p">(</span><span class="n">base_</span><span class="p">)</span>
</span><span data-line="1803">                <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1804">                    <span class="k">continue</span>
</span><span data-line="1805">
</span><span data-line="1806">                <span class="k">if</span> <span class="n">_is_supercls_for_inherits</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inherits_search</span><span class="p">:</span>
</span><span data-line="1807">                    <span class="n">inherits_search</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="1808">
</span><span data-line="1809">            <span class="k">if</span> <span class="n">inherits_search</span><span class="p">:</span>
</span><span data-line="1810">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inherits_search</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="1811">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1812">                        <span class="s2">&quot;Class </span><span class="si">%s</span><span class="s2"> has multiple mapped bases: </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span data-line="1813">                        <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inherits_search</span><span class="p">)</span>
</span><span data-line="1814">                    <span class="p">)</span>
</span><span data-line="1815">                <span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits_search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="1816">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherits</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">):</span>
</span><span data-line="1817">            <span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span><span class="o">.</span><span class="n">class_</span>
</span><span data-line="1818">
</span><span data-line="1819">        <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span>
</span><span data-line="1820">
</span><span data-line="1821">        <span class="n">clsdict_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span>
</span><span data-line="1822">        <span class="k">if</span> <span class="s2">&quot;__table__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clsdict_view</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1823">            <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="1824">
</span><span data-line="1825">    <span class="k">def</span> <span class="nf">_setup_inheriting_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1826">        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span>
</span><span data-line="1827">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span data-line="1828">        <span class="n">table_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_args</span>
</span><span data-line="1829">        <span class="n">declared_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span>
</span><span data-line="1830">
</span><span data-line="1831">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1832">            <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1833">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span data-line="1834">            <span class="ow">and</span> <span class="ow">not</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__no_table__&quot;</span><span class="p">)</span>
</span><span data-line="1835">        <span class="p">):</span>
</span><span data-line="1836">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1837">                <span class="s2">&quot;Class </span><span class="si">%r</span><span class="s2"> does not have a __table__ or __tablename__ &quot;</span>
</span><span data-line="1838">                <span class="s2">&quot;specified and does not inherit from an existing &quot;</span>
</span><span data-line="1839">                <span class="s2">&quot;table-mapped class.&quot;</span> <span class="o">%</span> <span class="bp">cls</span>
</span><span data-line="1840">            <span class="p">)</span>
</span><span data-line="1841">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
</span><span data-line="1842">            <span class="n">inherited_mapper_or_config</span> <span class="o">=</span> <span class="n">_declared_mapping_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">)</span>
</span><span data-line="1843">            <span class="k">assert</span> <span class="n">inherited_mapper_or_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1844">            <span class="n">inherited_table</span> <span class="o">=</span> <span class="n">inherited_mapper_or_config</span><span class="o">.</span><span class="n">local_table</span>
</span><span data-line="1845">            <span class="n">inherited_persist_selectable</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1846">                <span class="n">inherited_mapper_or_config</span><span class="o">.</span><span class="n">persist_selectable</span>
</span><span data-line="1847">            <span class="p">)</span>
</span><span data-line="1848">
</span><span data-line="1849">            <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1850">                <span class="c1"># single table inheritance.</span>
</span><span data-line="1851">                <span class="c1"># ensure no table args</span>
</span><span data-line="1852">                <span class="k">if</span> <span class="n">table_args</span><span class="p">:</span>
</span><span data-line="1853">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1854">                        <span class="s2">&quot;Can&#39;t place __table_args__ on an inherited class &quot;</span>
</span><span data-line="1855">                        <span class="s2">&quot;with no table.&quot;</span>
</span><span data-line="1856">                    <span class="p">)</span>
</span><span data-line="1857">
</span><span data-line="1858">                <span class="c1"># add any columns declared here to the inherited table.</span>
</span><span data-line="1859">                <span class="k">if</span> <span class="n">declared_columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherited_table</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
</span><span data-line="1860">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1861">                        <span class="sa">f</span><span class="s2">&quot;Can&#39;t declare columns on single-table-inherited &quot;</span>
</span><span data-line="1862">                        <span class="sa">f</span><span class="s2">&quot;subclass </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="si">}</span><span class="s2">; superclass </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span data-line="1863">                        <span class="s2">&quot;is not mapped to a Table&quot;</span>
</span><span data-line="1864">                    <span class="p">)</span>
</span><span data-line="1865">
</span><span data-line="1866">                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">declared_columns</span><span class="p">:</span>
</span><span data-line="1867">                    <span class="k">assert</span> <span class="n">inherited_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1868">                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">inherited_table</span><span class="o">.</span><span class="n">c</span><span class="p">:</span>
</span><span data-line="1869">                        <span class="k">if</span> <span class="n">inherited_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="n">col</span><span class="p">:</span>
</span><span data-line="1870">                            <span class="k">continue</span>
</span><span data-line="1871">                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1872">                            <span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; on class </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span data-line="1873">                            <span class="sa">f</span><span class="s2">&quot;conflicts with existing column &quot;</span>
</span><span data-line="1874">                            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">inherited_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;.  If using &quot;</span>
</span><span data-line="1875">                            <span class="sa">f</span><span class="s2">&quot;Declarative, consider using the &quot;</span>
</span><span data-line="1876">                            <span class="s2">&quot;use_existing_column parameter of mapped_column() &quot;</span>
</span><span data-line="1877">                            <span class="s2">&quot;to resolve conflicts.&quot;</span>
</span><span data-line="1878">                        <span class="p">)</span>
</span><span data-line="1879">                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
</span><span data-line="1880">                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span data-line="1881">                            <span class="s2">&quot;Can&#39;t place primary key columns on an inherited &quot;</span>
</span><span data-line="1882">                            <span class="s2">&quot;class with no table.&quot;</span>
</span><span data-line="1883">                        <span class="p">)</span>
</span><span data-line="1884">
</span><span data-line="1885">                    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="1886">                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherited_table</span><span class="p">,</span> <span class="n">Table</span><span class="p">)</span>
</span><span data-line="1887">
</span><span data-line="1888">                    <span class="n">inherited_table</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
</span><span data-line="1889">                    <span class="k">if</span> <span class="p">(</span>
</span><span data-line="1890">                        <span class="n">inherited_persist_selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="1891">                        <span class="ow">and</span> <span class="n">inherited_persist_selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inherited_table</span>
</span><span data-line="1892">                    <span class="p">):</span>
</span><span data-line="1893">                        <span class="n">inherited_persist_selectable</span><span class="o">.</span><span class="n">_refresh_for_new_column</span><span class="p">(</span>
</span><span data-line="1894">                            <span class="n">col</span>
</span><span data-line="1895">                        <span class="p">)</span>
</span><span data-line="1896">
</span><span data-line="1897">    <span class="k">def</span> <span class="nf">_prepare_mapper_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1898">        <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
</span><span data-line="1899">
</span><span data-line="1900">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_args_fn</span><span class="p">:</span>
</span><span data-line="1901">            <span class="n">mapper_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_args_fn</span><span class="p">()</span>
</span><span data-line="1902">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1903">            <span class="n">mapper_args</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1904">
</span><span data-line="1905">        <span class="k">if</span> <span class="n">mapper_kw</span><span class="p">:</span>
</span><span data-line="1906">            <span class="n">mapper_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span data-line="1907">
</span><span data-line="1908">        <span class="k">if</span> <span class="s2">&quot;properties&quot;</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
</span><span data-line="1909">            <span class="n">properties</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
</span><span data-line="1910">            <span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">])</span>
</span><span data-line="1911">
</span><span data-line="1912">        <span class="c1"># make sure that column copies are used rather</span>
</span><span data-line="1913">        <span class="c1"># than the original columns from any mixins</span>
</span><span data-line="1914">        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;version_id_col&quot;</span><span class="p">,</span> <span class="s2">&quot;polymorphic_on&quot;</span><span class="p">):</span>
</span><span data-line="1915">            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
</span><span data-line="1916">                <span class="n">v</span> <span class="o">=</span> <span class="n">mapper_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span data-line="1917">                <span class="n">mapper_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span data-line="1918">
</span><span data-line="1919">        <span class="k">if</span> <span class="s2">&quot;primary_key&quot;</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
</span><span data-line="1920">            <span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;primary_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="1921">                <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span data-line="1922">                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;primary_key&quot;</span><span class="p">])</span>
</span><span data-line="1923">            <span class="p">]</span>
</span><span data-line="1924">
</span><span data-line="1925">        <span class="k">if</span> <span class="s2">&quot;inherits&quot;</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
</span><span data-line="1926">            <span class="n">inherits_arg</span> <span class="o">=</span> <span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;inherits&quot;</span><span class="p">]</span>
</span><span data-line="1927">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherits_arg</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">):</span>
</span><span data-line="1928">                <span class="n">inherits_arg</span> <span class="o">=</span> <span class="n">inherits_arg</span><span class="o">.</span><span class="n">class_</span>
</span><span data-line="1929">
</span><span data-line="1930">            <span class="k">if</span> <span class="n">inherits_arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
</span><span data-line="1931">                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="1932">                    <span class="s2">&quot;mapper inherits argument given for non-inheriting &quot;</span>
</span><span data-line="1933">                    <span class="s2">&quot;class </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;inherits&quot;</span><span class="p">])</span>
</span><span data-line="1934">                <span class="p">)</span>
</span><span data-line="1935">
</span><span data-line="1936">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
</span><span data-line="1937">            <span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;inherits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span>
</span><span data-line="1938">
</span><span data-line="1939">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mapper_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concrete&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span data-line="1940">            <span class="c1"># note the superclass is expected to have a Mapper assigned and</span>
</span><span data-line="1941">            <span class="c1"># not be a deferred config, as this is called within map()</span>
</span><span data-line="1942">            <span class="n">inherited_mapper</span> <span class="o">=</span> <span class="n">class_mapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span data-line="1943">            <span class="n">inherited_table</span> <span class="o">=</span> <span class="n">inherited_mapper</span><span class="o">.</span><span class="n">local_table</span>
</span><span data-line="1944">
</span><span data-line="1945">            <span class="c1"># single or joined inheritance</span>
</span><span data-line="1946">            <span class="c1"># exclude any cols on the inherited table which are</span>
</span><span data-line="1947">            <span class="c1"># not mapped on the parent class, to avoid</span>
</span><span data-line="1948">            <span class="c1"># mapping columns specific to sibling/nephew classes</span>
</span><span data-line="1949">            <span class="k">if</span> <span class="s2">&quot;exclude_properties&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
</span><span data-line="1950">                <span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;exclude_properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exclude_properties</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="1951">                    <span class="n">c</span><span class="o">.</span><span class="n">key</span>
</span><span data-line="1952">                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inherited_table</span><span class="o">.</span><span class="n">c</span>
</span><span data-line="1953">                    <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inherited_mapper</span><span class="o">.</span><span class="n">_columntoproperty</span>
</span><span data-line="1954">                <span class="p">}</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">inherited_mapper</span><span class="o">.</span><span class="n">exclude_properties</span> <span class="ow">or</span> <span class="p">())</span>
</span><span data-line="1955">                <span class="n">exclude_properties</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span>
</span><span data-line="1956">                    <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span><span class="p">]</span>
</span><span data-line="1957">                <span class="p">)</span>
</span><span data-line="1958">
</span><span data-line="1959">            <span class="c1"># look through columns in the current mapper that</span>
</span><span data-line="1960">            <span class="c1"># are keyed to a propname different than the colname</span>
</span><span data-line="1961">            <span class="c1"># (if names were the same, we&#39;d have popped it out above,</span>
</span><span data-line="1962">            <span class="c1"># in which case the mapper makes this combination).</span>
</span><span data-line="1963">            <span class="c1"># See if the superclass has a similar column property.</span>
</span><span data-line="1964">            <span class="c1"># If so, join them together.</span>
</span><span data-line="1965">            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span data-line="1966">                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnElement</span><span class="p">):</span>
</span><span data-line="1967">                    <span class="k">continue</span>
</span><span data-line="1968">                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inherited_mapper</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
</span><span data-line="1969">                    <span class="n">p</span> <span class="o">=</span> <span class="n">inherited_mapper</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span data-line="1970">                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ColumnProperty</span><span class="p">):</span>
</span><span data-line="1971">                        <span class="c1"># note here we place the subclass column</span>
</span><span data-line="1972">                        <span class="c1"># first.  See [ticket:1892] for background.</span>
</span><span data-line="1973">                        <span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">columns</span>
</span><span data-line="1974">        <span class="n">result_mapper_args</span> <span class="o">=</span> <span class="n">mapper_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span data-line="1975">        <span class="n">result_mapper_args</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span>
</span><span data-line="1976">        <span class="bp">self</span><span class="o">.</span><span class="n">mapper_args</span> <span class="o">=</span> <span class="n">result_mapper_args</span>
</span><span data-line="1977">
</span><span data-line="1978">    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="1979">        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_mapper_arguments</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span data-line="1980">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;__mapper_cls__&quot;</span><span class="p">):</span>
</span><span data-line="1981">            <span class="n">mapper_cls</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="1982">                <span class="s2">&quot;Type[Mapper[Any]]&quot;</span><span class="p">,</span>
</span><span data-line="1983">                <span class="n">util</span><span class="o">.</span><span class="n">unbound_method_to_callable</span><span class="p">(</span>
</span><span data-line="1984">                    <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">__mapper_cls__</span>  <span class="c1"># type: ignore</span>
</span><span data-line="1985">                <span class="p">),</span>
</span><span data-line="1986">            <span class="p">)</span>
</span><span data-line="1987">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1988">            <span class="n">mapper_cls</span> <span class="o">=</span> <span class="n">Mapper</span>
</span><span data-line="1989">
</span><span data-line="1990">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span>
</span><span data-line="1991">            <span class="s2">&quot;__mapper__&quot;</span><span class="p">,</span>
</span><span data-line="1992">            <span class="n">mapper_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mapper_args</span><span class="p">),</span>
</span><span data-line="1993">        <span class="p">)</span>
</span><span data-line="1994">
</span><span data-line="1995">
</span><span data-line="1996"><span class="nd">@util</span><span class="o">.</span><span class="n">preload_module</span><span class="p">(</span><span class="s2">&quot;sqlalchemy.orm.decl_api&quot;</span><span class="p">)</span>
</span><span data-line="1997"><span class="k">def</span> <span class="nf">_as_dc_declaredattr</span><span class="p">(</span>
</span><span data-line="1998">    <span class="n">field_metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">sa_dataclass_metadata_key</span><span class="p">:</span> <span class="nb">str</span>
</span><span data-line="1999"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="2000">    <span class="c1"># wrap lambdas inside dataclass fields inside an ad-hoc declared_attr.</span>
</span><span data-line="2001">    <span class="c1"># we can&#39;t write it because field.metadata is immutable :( so we have</span>
</span><span data-line="2002">    <span class="c1"># to go through extra trouble to compare these</span>
</span><span data-line="2003">    <span class="n">decl_api</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">preloaded</span><span class="o">.</span><span class="n">orm_decl_api</span>
</span><span data-line="2004">    <span class="n">obj</span> <span class="o">=</span> <span class="n">field_metadata</span><span class="p">[</span><span class="n">sa_dataclass_metadata_key</span><span class="p">]</span>
</span><span data-line="2005">    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">decl_api</span><span class="o">.</span><span class="n">declared_attr</span><span class="p">):</span>
</span><span data-line="2006">        <span class="k">return</span> <span class="n">decl_api</span><span class="o">.</span><span class="n">declared_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span data-line="2007">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="2008">        <span class="k">return</span> <span class="n">obj</span>
</span><span data-line="2009">
</span><span data-line="2010">
</span><span data-line="2011"><span class="k">class</span> <span class="nc">_DeferredMapperConfig</span><span class="p">(</span><span class="n">_ClassScanMapperConfig</span><span class="p">):</span>
</span><span data-line="2012">    <span class="n">_cls</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span data-line="2013">
</span><span data-line="2014">    <span class="n">is_deferred</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="2015">
</span><span data-line="2016">    <span class="n">_configs</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">[</span>
</span><span data-line="2017">        <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">_DeferredMapperConfig</span>
</span><span data-line="2018">    <span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
</span><span data-line="2019">
</span><span data-line="2020">    <span class="k">def</span> <span class="nf">_early_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2021">        <span class="k">pass</span>
</span><span data-line="2022">
</span><span data-line="2023">    <span class="c1"># mypy disallows plain property override of variable</span>
</span><span data-line="2024">    <span class="nd">@property</span>  <span class="c1"># type: ignore</span>
</span><span data-line="2025">    <span class="k">def</span> <span class="nf">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="2026">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
</span><span data-line="2027">
</span><span data-line="2028">    <span class="nd">@cls</span><span class="o">.</span><span class="n">setter</span>
</span><span data-line="2029">    <span class="k">def</span> <span class="nf">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2030">        <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_config_cls</span><span class="p">)</span>
</span><span data-line="2031">        <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
</span><span data-line="2032">
</span><span data-line="2033">    <span class="nd">@classmethod</span>
</span><span data-line="2034">    <span class="k">def</span> <span class="nf">_remove_config_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2035">        <span class="bp">cls</span><span class="o">.</span><span class="n">_configs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="2036">
</span><span data-line="2037">    <span class="nd">@classmethod</span>
</span><span data-line="2038">    <span class="k">def</span> <span class="nf">has_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="2039">        <span class="c1"># 2.6 fails on weakref if class_ is an old style class</span>
</span><span data-line="2040">        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_configs</span>
</span><span data-line="2041">
</span><span data-line="2042">    <span class="nd">@classmethod</span>
</span><span data-line="2043">    <span class="k">def</span> <span class="nf">raise_unmapped_for_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span data-line="2044">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="s2">&quot;_sa_raise_deferred_config&quot;</span><span class="p">):</span>
</span><span data-line="2045">            <span class="n">class_</span><span class="o">.</span><span class="n">_sa_raise_deferred_config</span><span class="p">()</span>
</span><span data-line="2046">
</span><span data-line="2047">        <span class="k">raise</span> <span class="n">orm_exc</span><span class="o">.</span><span class="n">UnmappedClassError</span><span class="p">(</span>
</span><span data-line="2048">            <span class="n">class_</span><span class="p">,</span>
</span><span data-line="2049">            <span class="n">msg</span><span class="o">=</span><span class="p">(</span>
</span><span data-line="2050">                <span class="sa">f</span><span class="s2">&quot;Class </span><span class="si">{</span><span class="n">orm_exc</span><span class="o">.</span><span class="n">_safe_cls_name</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span><span class="si">}</span><span class="s2"> has a deferred &quot;</span>
</span><span data-line="2051">                <span class="s2">&quot;mapping on it.  It is not yet usable as a mapped class.&quot;</span>
</span><span data-line="2052">            <span class="p">),</span>
</span><span data-line="2053">        <span class="p">)</span>
</span><span data-line="2054">
</span><span data-line="2055">    <span class="nd">@classmethod</span>
</span><span data-line="2056">    <span class="k">def</span> <span class="nf">config_for_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">_DeferredMapperConfig</span><span class="p">:</span>
</span><span data-line="2057">        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_configs</span><span class="p">[</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">class_</span><span class="p">)]</span>
</span><span data-line="2058">
</span><span data-line="2059">    <span class="nd">@classmethod</span>
</span><span data-line="2060">    <span class="k">def</span> <span class="nf">classes_for_base</span><span class="p">(</span>
</span><span data-line="2061">        <span class="bp">cls</span><span class="p">,</span> <span class="n">base_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="2062">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_DeferredMapperConfig</span><span class="p">]:</span>
</span><span data-line="2063">        <span class="n">classes_for_base</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="2064">            <span class="n">m</span>
</span><span data-line="2065">            <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">cls_</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_configs</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</span><span data-line="2066">            <span class="k">if</span> <span class="n">cls_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="n">base_cls</span><span class="p">)</span>
</span><span data-line="2067">        <span class="p">]</span>
</span><span data-line="2068">
</span><span data-line="2069">        <span class="k">if</span> <span class="ow">not</span> <span class="n">sort</span><span class="p">:</span>
</span><span data-line="2070">            <span class="k">return</span> <span class="n">classes_for_base</span>
</span><span data-line="2071">
</span><span data-line="2072">        <span class="n">all_m_by_cls</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="o">.</span><span class="n">cls</span><span class="p">:</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">classes_for_base</span><span class="p">}</span>
</span><span data-line="2073">
</span><span data-line="2074">        <span class="n">tuples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_DeferredMapperConfig</span><span class="p">,</span> <span class="n">_DeferredMapperConfig</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="2075">        <span class="k">for</span> <span class="n">m_cls</span> <span class="ow">in</span> <span class="n">all_m_by_cls</span><span class="p">:</span>
</span><span data-line="2076">            <span class="n">tuples</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
</span><span data-line="2077">                <span class="p">(</span><span class="n">all_m_by_cls</span><span class="p">[</span><span class="n">base_cls</span><span class="p">],</span> <span class="n">all_m_by_cls</span><span class="p">[</span><span class="n">m_cls</span><span class="p">])</span>
</span><span data-line="2078">                <span class="k">for</span> <span class="n">base_cls</span> <span class="ow">in</span> <span class="n">m_cls</span><span class="o">.</span><span class="vm">__bases__</span>
</span><span data-line="2079">                <span class="k">if</span> <span class="n">base_cls</span> <span class="ow">in</span> <span class="n">all_m_by_cls</span>
</span><span data-line="2080">            <span class="p">)</span>
</span><span data-line="2081">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">topological</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tuples</span><span class="p">,</span> <span class="n">classes_for_base</span><span class="p">))</span>
</span><span data-line="2082">
</span><span data-line="2083">    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span data-line="2084">        <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="2085">        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span data-line="2086">
</span><span data-line="2087">
</span><span data-line="2088"><span class="k">def</span> <span class="nf">_add_attribute</span><span class="p">(</span>
</span><span data-line="2089">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">MapperProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span data-line="2090"><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2091"><span class="w">    </span><span class="sd">&quot;&quot;&quot;add an attribute to an existing declarative class.</span>
</span><span data-line="2092">
</span><span data-line="2093"><span class="sd">    This runs through the logic to determine MapperProperty,</span>
</span><span data-line="2094"><span class="sd">    adds it to the Mapper, adds a column to the mapped Table, etc.</span>
</span><span data-line="2095">
</span><span data-line="2096"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2097">
</span><span data-line="2098">    <span class="k">if</span> <span class="s2">&quot;__mapper__&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span data-line="2099">        <span class="n">mapped_cls</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;MappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span data-line="2100">
</span><span data-line="2101">        <span class="k">def</span> <span class="nf">_table_or_raise</span><span class="p">(</span><span class="n">mc</span><span class="p">:</span> <span class="n">MappedClassProtocol</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
</span><span data-line="2102">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">__table__</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
</span><span data-line="2103">                <span class="k">return</span> <span class="n">mc</span><span class="o">.</span><span class="n">__table__</span>
</span><span data-line="2104">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span data-line="2105">                <span class="sa">f</span><span class="s2">&quot;Cannot add a new attribute to mapped class </span><span class="si">{</span><span class="n">mc</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2"> &quot;</span>
</span><span data-line="2106">                <span class="s2">&quot;because it&#39;s not mapped against a table.&quot;</span>
</span><span data-line="2107">            <span class="p">)</span>
</span><span data-line="2108">
</span><span data-line="2109">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
</span><span data-line="2110">            <span class="n">_undefer_column_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="2111">            <span class="n">_table_or_raise</span><span class="p">(</span><span class="n">mapped_cls</span><span class="p">)</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span>
</span><span data-line="2112">                <span class="n">value</span><span class="p">,</span> <span class="n">replace_existing</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="2113">            <span class="p">)</span>
</span><span data-line="2114">            <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="2115">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_MapsColumns</span><span class="p">):</span>
</span><span data-line="2116">            <span class="n">mp</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">mapper_property_to_assign</span>
</span><span data-line="2117">            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">columns_to_assign</span><span class="p">:</span>
</span><span data-line="2118">                <span class="n">_undefer_column_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
</span><span data-line="2119">                <span class="n">_table_or_raise</span><span class="p">(</span><span class="n">mapped_cls</span><span class="p">)</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span>
</span><span data-line="2120">                    <span class="n">col</span><span class="p">,</span> <span class="n">replace_existing</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="2121">                <span class="p">)</span>
</span><span data-line="2122">                <span class="k">if</span> <span class="ow">not</span> <span class="n">mp</span><span class="p">:</span>
</span><span data-line="2123">                    <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
</span><span data-line="2124">            <span class="k">if</span> <span class="n">mp</span><span class="p">:</span>
</span><span data-line="2125">                <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mp</span><span class="p">)</span>
</span><span data-line="2126">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">):</span>
</span><span data-line="2127">            <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="2128">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">QueryableAttribute</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">key</span><span class="p">:</span>
</span><span data-line="2129">            <span class="c1"># detect a QueryableAttribute that&#39;s already mapped being</span>
</span><span data-line="2130">            <span class="c1"># assigned elsewhere in userland, turn into a synonym()</span>
</span><span data-line="2131">            <span class="n">value</span> <span class="o">=</span> <span class="n">SynonymProperty</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="2132">            <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="2133">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2134">            <span class="nb">type</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="2135">            <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">_expire_memoizations</span><span class="p">()</span>
</span><span data-line="2136">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="2137">        <span class="nb">type</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span data-line="2138">
</span><span data-line="2139">
</span><span data-line="2140"><span class="k">def</span> <span class="nf">_del_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2141">    <span class="k">if</span> <span class="p">(</span>
</span><span data-line="2142">        <span class="s2">&quot;__mapper__&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
</span><span data-line="2143">        <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
</span><span data-line="2144">        <span class="ow">and</span> <span class="ow">not</span> <span class="n">cast</span><span class="p">(</span>
</span><span data-line="2145">            <span class="s2">&quot;MappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">cls</span>
</span><span data-line="2146">        <span class="p">)</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">_dispose_called</span>
</span><span data-line="2147">    <span class="p">):</span>
</span><span data-line="2148">        <span class="n">value</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="2149">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span data-line="2150">            <span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">_MapsColumns</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">,</span> <span class="n">QueryableAttribute</span><span class="p">)</span>
</span><span data-line="2151">        <span class="p">):</span>
</span><span data-line="2152">            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span data-line="2153">                <span class="s2">&quot;Can&#39;t un-map individual mapped attributes on a mapped class.&quot;</span>
</span><span data-line="2154">            <span class="p">)</span>
</span><span data-line="2155">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="2156">            <span class="nb">type</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span data-line="2157">            <span class="n">cast</span><span class="p">(</span>
</span><span data-line="2158">                <span class="s2">&quot;MappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">cls</span>
</span><span data-line="2159">            <span class="p">)</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">_expire_memoizations</span><span class="p">()</span>
</span><span data-line="2160">    <span class="k">else</span><span class="p">:</span>
</span><span data-line="2161">        <span class="nb">type</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span data-line="2162">
</span><span data-line="2163">
</span><span data-line="2164"><span class="k">def</span> <span class="nf">_declarative_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2165"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple constructor that allows initialization from kwargs.</span>
</span><span data-line="2166">
</span><span data-line="2167"><span class="sd">    Sets attributes on the constructed instance using the names and</span>
</span><span data-line="2168"><span class="sd">    values in ``kwargs``.</span>
</span><span data-line="2169">
</span><span data-line="2170"><span class="sd">    Only keys that are present as</span>
</span><span data-line="2171"><span class="sd">    attributes of the instance&#39;s class are allowed. These could be,</span>
</span><span data-line="2172"><span class="sd">    for example, any mapped columns or relationships.</span>
</span><span data-line="2173"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="2174">    <span class="n">cls_</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="2175">    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span data-line="2176">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span><span data-line="2177">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span data-line="2178">                <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is an invalid keyword argument for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">cls_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span data-line="2179">            <span class="p">)</span>
</span><span data-line="2180">        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</span><span data-line="2181">
</span><span data-line="2182">
</span><span data-line="2183"><span class="n">_declarative_constructor</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s2">&quot;__init__&quot;</span>
</span><span data-line="2184">
</span><span data-line="2185">
</span><span data-line="2186"><span class="k">def</span> <span class="nf">_undefer_column_name</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2187">    <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2188">        <span class="n">column</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
</span><span data-line="2189">    <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="2190">        <span class="n">column</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">key</span>
</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2024, Litestar Organization</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials">
<a href="https://github.com/litestar-org/advanced-alchemy" aria-label="GitHub">
  <iconify-icon icon="simple-icons:github"></iconify-icon>
</a>
<a href="https://twitter.com/LitestarAPI" aria-label="X (Twitter)">
  <iconify-icon icon="prime:twitter"></iconify-icon>
</a>
<a href="https://discord.gg/litestar" aria-label="Discord">
  <iconify-icon icon="simple-icons:discord"></iconify-icon>
</a>
<a href="https://www.reddit.com/r/LitestarAPI" aria-label="Reddit">
  <iconify-icon icon="simple-icons:reddit"></iconify-icon>
</a></div>
    </div>
  </div>
</footer>
      <script src="../../../_static/documentation_options.js?v=c6cf4326"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../_static/litestar-theme.js?v=ab2dcc9e"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../../../_static/shibuya.js?v=e2e99575"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../../../_static/versioning.js"></script></body>
</html>