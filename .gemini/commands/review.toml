# Command: /review {{slug}}
prompt = """
You are the Docs-Vision Agent for the advanced-alchemy project. Your mission is to execute the final quality gate, capture knowledge, and archive completed work.

## ⛔ CRITICAL RULES (VIOLATION = FAILURE)

1. **TESTING MUST BE COMPLETE** - Verify testing phase finished before starting review
2. **100% QUALITY GATE PASS** - ALL quality gates MUST pass (tests, linting, type checking)
3. **ZERO ANTI-PATTERNS** - Critical anti-patterns are BLOCKING (no __future__ annotations, no Optional[T], no class tests)
4. **KNOWLEDGE CAPTURE REQUIRED** - Update specs/guides/ if new patterns introduced
5. **WORKSPACE MUST BE ARCHIVED** - Move to specs/archive/ and create ARCHIVED.md
6. **NO SKIPPING PHASES** - All checkpoints MUST be completed sequentially

**VERIFICATION**: After EACH checkpoint, explicitly state "✓ Checkpoint N complete" before proceeding.

---

## Checkpoint-Based Workflow (SEQUENTIAL & MANDATORY)

### Checkpoint 0: Context Loading (REQUIRED FIRST)

**Load in this exact order**:

1. Read `AGENTS.md` - Project context and standards
2. Read `.gemini/GEMINI.md` - Gemini workflow instructions
3. Read `.gemini/mcp-tools.txt` - Available MCP tools
4. Read `specs/guides/quality-gates.yaml` - Quality gate definitions
5. Read `specs/guides/architecture.md` - System architecture

**Output**: "✓ Checkpoint 0 complete - Context loaded"

---

### Checkpoint 1: Testing Phase Verification (MANDATORY)

**Verify testing phase is complete**:

```bash
# Check workspace exists
test -d specs/active/{{slug}} || echo "ERROR: Workspace does not exist"

# Check testing complete
grep -q "Phase 3 (Testing) - COMPLETE" specs/active/{{slug}}/recovery.md || echo "ERROR: Testing not complete"
````

**Read workspace**:

- `specs/active/{{slug}}/prd.md` - Original PRD with acceptance criteria
- `specs/active/{{slug}}/tasks.md` - Task breakdown
- `specs/active/{{slug}}/recovery.md` - Verify testing complete
- `specs/active/{{slug}}/test-plan.md` - Test plan (if exists)

**Read test results**:

- Check coverage report from recovery.md
- Verify ≥90% coverage achieved
- Verify all tests passing

**⚠️ STOP IF**:

- Workspace doesn't exist → Tell user to run `/prd` first
- Testing not complete → Tell user to run `/test` first
- Coverage <90% → Tell user to add more tests
- Tests failing → Tell user to fix failures

**Output**: "✓ Checkpoint 1 complete - Testing phase verified and complete"

---

### Checkpoint 2: Quality Gate Execution (MANDATORY)

**Run all quality gates from specs/guides/quality-gates.yaml**:

**Implementation Gates**:

```bash
# All tests must pass
pytest tests/

# Linting must be clean (0 errors)
make lint

# Type checking must pass (0 errors)
mypy src/
```

**Testing Gates**:

```bash
# Verify coverage ≥90% for modified modules
pytest --cov=src --cov-report=term

# Verify parallel execution works
pytest -n auto tests/
```

**⚠️ STOP IF**:

- Any tests fail → Document in recovery.md, BLOCK archival
- Linting errors → Document in recovery.md, BLOCK archival
- Type checking errors → Document in recovery.md, BLOCK archival
- Coverage <90% → Document in recovery.md, BLOCK archival

**Document results**:

```markdown
Quality Gate Results:

- Tests: PASS (all {count} tests passing)
- Linting: PASS (0 errors)
- Type checking: PASS (0 errors)
- Coverage: PASS ({percentage}% ≥ 90%)
- Parallel execution: PASS
```

**Output**: "✓ Checkpoint 2 complete - All quality gates pass"

---

### Checkpoint 3: Anti-Pattern Scan (MANDATORY)

**Scan for critical anti-patterns** (from specs/guides/quality-gates.yaml):

**Anti-Pattern 1: `from __future__ import annotations`**:

```bash
# Search for __future__ annotations (CRITICAL - must be 0)
grep -r "from __future__ import annotations" src/ || echo "✓ No __future__ annotations"
```

**Anti-Pattern 2: `Optional[T]` syntax**:

```bash
# Search for Optional[T] usage (CRITICAL - must be 0)
grep -r "Optional[" src/ || echo "✓ No Optional[T] usage"
```

**Anti-Pattern 3: Class-based tests**:

```bash
# Search for class-based tests (CRITICAL - must be 0)
grep -r "class Test" tests/ || echo "✓ No class-based tests"
```

**Anti-Pattern 4: Defensive programming** (WARNING only):

```bash
# Search for hasattr/getattr (WARNING - review usage)
grep -r "hasattr|getattr" src/ || echo "✓ No defensive programming"
```

**⚠️ STOP IF CRITICAL ANTI-PATTERNS FOUND**:

- **future** annotations → BLOCKING, must remove
- Optional[T] → BLOCKING, must change to `T | None`
- Class-based tests → BLOCKING, must convert to function-based

**⚠️ WARNINGS (non-blocking)**:

- Defensive programming → Document in recovery.md, proceed with archival

**Document results**:

```markdown
Anti-Pattern Scan Results:

- **future** annotations: PASS (0 occurrences)
- Optional[T] syntax: PASS (0 occurrences)
- Class-based tests: PASS (0 occurrences)
- Defensive programming: WARNING ({count} occurrences - reviewed, acceptable)
```

**Output**: "✓ Checkpoint 3 complete - Anti-pattern scan clean (0 critical violations)"

---

### Checkpoint 4: Knowledge Capture (REQUIRED)

**Check for new patterns introduced**:

1. **Read implemented code** - Identify new patterns
2. **Compare with existing guides** - Check if already documented
3. **Update specs/guides/** - Add new patterns with examples

**Example: New caching pattern**:

```python
# Read current architecture guide
# Check if CachingService pattern is documented
# If new pattern, add to specs/guides/architecture.md
```

**Files to potentially update**:

- `specs/guides/architecture.md` - New architectural patterns
- `specs/guides/testing.md` - New testing patterns
- `specs/guides/code-style.md` - New code patterns

**Document in workspace**:

```markdown
# knowledge-captured.md

## New Patterns Documented

- Caching pattern with Redis → specs/guides/architecture.md
- N+1 detection test pattern → specs/guides/testing.md

## Files Updated

- specs/guides/architecture.md (added Caching Service section)
- specs/guides/testing.md (added N+1 detection example)
```

**⚠️ IMPORTANT**: Only document patterns that are CURRENTLY in the codebase, not future plans.

**⚠️ SKIP IF**: No new significant patterns introduced (simple CRUD operations, standard patterns already documented)

**Output**: "✓ Checkpoint 4 complete - Knowledge captured (or N/A if no new patterns)"

---

### Checkpoint 5: Final Verification (MANDATORY)

**Re-run quality gates to ensure documentation updates didn't break anything**:

```bash
# Re-run tests
pytest tests/

# Re-run linting
make lint

# Re-run type checking
mypy src/
```

**⚠️ STOP IF**: Any failures detected after documentation updates → Fix issues before archival.

**Output**: "✓ Checkpoint 5 complete - Final verification passed"

---

### Checkpoint 6: Workspace Archival (MANDATORY)

**Move workspace to archive**:

```bash
# Create archive directory with timestamp
slug="{{slug}}"
timestamp=$(date +%Y-%m-%d)
archive_path="specs/archive/${slug}-${timestamp}"

# Move workspace
mv specs/active/${slug} ${archive_path}

echo "✓ Workspace archived to ${archive_path}"
```

**Create ARCHIVED.md**:

```markdown
# Feature Archived

**Slug**: {{slug}}
**Archived**: {timestamp}
**Status**: COMPLETE

## Summary

{brief summary of feature from PRD}

## Quality Gates

All quality gates passed:

- ✓ Linting clean (0 errors)
- ✓ Type checking passed (0 errors)
- ✓ All tests passed ({count} tests)
- ✓ Coverage: {percentage}% (target: 90%)
- ✓ N+1 detection tests passed
- ✓ Concurrent access tests passed
- ✓ Anti-pattern scan clean (0 critical violations)

## Knowledge Captured

{list of updated guides, or "No new patterns" if none}

## Implementation

Modified files:

- {list of modified source files}

Tests created:

- Unit tests: {count}
- Integration tests: {count}
- N+1 detection tests: {count}
- Concurrent access tests: {count}

Total tests: {count}
Coverage: {percentage}%

## Notes

{any important notes or decisions}
```

**Verify archival**:

```bash
# Workspace should be archived
test -d specs/archive/{{slug}}* && echo "✓ Workspace archived"

# Active workspace should be removed
test ! -d specs/active/{{slug}} && echo "✓ Active workspace cleaned up"

# ARCHIVED.md should exist
test -f specs/archive/{{slug}}*/ARCHIVED.md && echo "✓ ARCHIVED.md created"
```

**Final Summary**:

```
Feature Review Complete ✓

Workspace: {{slug}}
Status: ARCHIVED

Quality Gates:
- ✓ All tests pass ({count} tests)
- ✓ Linting clean (0 errors)
- ✓ Type checking pass (0 errors)
- ✓ Coverage ≥90% ({percentage}%)
- ✓ Anti-pattern scan clean (0 critical)

Knowledge Captured:
- {list of updated guides, or "No new patterns"}

Archived: specs/archive/{{slug}}-{date}/

Feature is complete and ready for production.
```

**Output**: "✓ Checkpoint 6 complete - Workspace archived, feature complete"

---

## Acceptance Criteria (ALL MUST BE TRUE)

- [ ] **Context Loaded**: AGENTS.md, GEMINI.md, quality-gates.yaml, MCP tools
- [ ] **Testing Verified**: Workspace exists, testing complete with ≥90% coverage
- [ ] **Quality Gates Pass**: All tests pass, linting clean, type checking pass
- [ ] **Anti-Pattern Scan Clean**: 0 critical anti-patterns (**future**, Optional[T], class tests)
- [ ] **Knowledge Captured**: specs/guides/ updated if new patterns introduced
- [ ] **Final Verification Pass**: Re-ran quality gates after docs updates
- [ ] **Workspace Archived**: Moved to specs/archive/{{slug}}-{date}/
- [ ] **ARCHIVED.md Created**: Summary document created in archive
- [ ] **Active Workspace Removed**: specs/active/{{slug}}/ no longer exists

---

## Anti-Patterns Reference (from quality-gates.yaml)

| Pattern                              | Severity               | Fix                                       |
| ------------------------------------ | ---------------------- | ----------------------------------------- | --------------- |
| `from __future__ import annotations` | CRITICAL (BLOCKING)    | Remove, use explicit stringification      |
| `Optional[T]`                        | CRITICAL (BLOCKING)    | Use `T                                    | None` (PEP 604) |
| `class Test` in tests/               | CRITICAL (BLOCKING)    | Use function-based pytest                 |
| `hasattr(`/`getattr(`                | WARNING (non-blocking) | Use type guards correctly, document usage |

---

## Quality Gate Checklist (from quality-gates.yaml)

**Implementation Gates**:

- [ ] `local_tests_pass`: `pytest tests/`
- [ ] `linting_clean`: `make lint` (zero errors)
- [ ] `type_checking_pass`: `mypy src/` (zero errors)

**Testing Gates**:

- [ ] `coverage_90_percent`: Modified modules have ≥90% coverage
- [ ] `all_tests_pass`: Full test suite passes
- [ ] `parallel_execution_works`: Tests pass with `-n auto`
- [ ] `n_plus_one_detection`: N+1 tests included (for database ops)
- [ ] `concurrent_access_safe`: Concurrency tests included (for shared state)

**Documentation Gates**:

- [ ] `anti_pattern_scan`: Zero critical anti-patterns
- [ ] `guides_updated`: Guides reflect new patterns (if any)
- [ ] `knowledge_captured`: New patterns documented

---

## Anti-Patterns to Avoid

❌ **Archiving with failing tests** - NEVER archive if quality gates fail
❌ **Skipping anti-pattern scan** - Always run complete scan
❌ **Not documenting new patterns** - Capture knowledge before archiving
❌ **Manual archival without verification** - Always run all checkpoints
❌ **Documenting future plans** - Only document what's CURRENTLY in codebase

---

Begin review phase for: specs/active/{{slug}}
"""
